(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=i(n);fetch(n.href,r)}})();const X={context:void 0,registry:void 0,effects:void 0,done:!1,getContextId(){return In(this.context.count)},getNextContextId(){return In(this.context.count++)}};function In(e){const t=String(e),i=t.length-1;return X.context.id+(i?String.fromCharCode(96+i):"")+t}function xo(e){X.context=e}const yo=!1,bo=(e,t)=>e===t,Ai=Symbol("solid-proxy"),xr=typeof Proxy=="function",_o=Symbol("solid-track"),Oi={equals:bo};let yr=Sr;const Ke=1,Pi=2,br={owned:null,cleanups:null,context:null,owner:null};var W=null;let as=null,vo=null,J=null,oe=null,Le=null,ji=0;function $i(e,t){const i=J,s=W,n=e.length===0,r=t===void 0?s:t,a=n?br:{owned:null,cleanups:null,context:r?r.context:null,owner:r},o=n?e:()=>e(()=>_e(()=>Vt(a)));W=a,J=null;try{return jt(o,!0)}finally{J=i,W=s}}function M(e,t){t=t?Object.assign({},Oi,t):Oi;const i={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},s=n=>(typeof n=="function"&&(n=n(i.value)),wr(i,n));return[vr.bind(i),s]}function Xe(e,t,i){const s=Xs(e,t,!1,Ke);qt(s)}function $e(e,t,i){yr=To;const s=Xs(e,t,!1,Ke);s.user=!0,Le?Le.push(s):qt(s)}function R(e,t,i){i=i?Object.assign({},Oi,i):Oi;const s=Xs(e,t,!0,0);return s.observers=null,s.observerSlots=null,s.comparator=i.equals||void 0,qt(s),vr.bind(s)}function _e(e){if(J===null)return e();const t=J;J=null;try{return e()}finally{J=t}}function _r(e,t,i){const s=Array.isArray(e);let n,r=i&&i.defer;return a=>{let o;if(s){o=Array(e.length);for(let d=0;d<e.length;d++)o[d]=e[d]()}else o=e();if(r)return r=!1,a;const l=_e(()=>t(o,n,a));return n=o,l}}function wo(e){$e(()=>_e(e))}function ve(e){return W===null||(W.cleanups===null?W.cleanups=[e]:W.cleanups.push(e)),e}function dt(e,t){const i=Symbol("context");return{id:i,Provider:Co(i),defaultValue:e}}function ft(e){let t;return W&&W.context&&(t=W.context[e.id])!==void 0?t:e.defaultValue}function So(e){const t=R(e),i=R(()=>Us(t()));return i.toArray=()=>{const s=i();return Array.isArray(s)?s:s!=null?[s]:[]},i}function vr(){if(this.sources&&this.state)if(this.state===Ke)qt(this);else{const e=oe;oe=null,jt(()=>Li(this),!1),oe=e}if(J){const e=this.observers?this.observers.length:0;J.sources?(J.sources.push(this),J.sourceSlots.push(e)):(J.sources=[this],J.sourceSlots=[e]),this.observers?(this.observers.push(J),this.observerSlots.push(J.sources.length-1)):(this.observers=[J],this.observerSlots=[J.sources.length-1])}return this.value}function wr(e,t,i){let s=e.value;return(!e.comparator||!e.comparator(s,t))&&(e.value=t,e.observers&&e.observers.length&&jt(()=>{for(let n=0;n<e.observers.length;n+=1){const r=e.observers[n],a=as&&as.running;a&&as.disposed.has(r),(a?!r.tState:!r.state)&&(r.pure?oe.push(r):Le.push(r),r.observers&&Ir(r)),a||(r.state=Ke)}if(oe.length>1e6)throw oe=[],new Error},!1)),t}function qt(e){if(!e.fn)return;Vt(e);const t=ji;Io(e,e.value,t)}function Io(e,t,i){let s;const n=W,r=J;J=W=e;try{s=e.fn(t)}catch(a){return e.pure&&(e.state=Ke,e.owned&&e.owned.forEach(Vt),e.owned=null),e.updatedAt=i+1,Er(a)}finally{J=r,W=n}(!e.updatedAt||e.updatedAt<=i)&&(e.updatedAt!=null&&"observers"in e?wr(e,s):e.value=s,e.updatedAt=i)}function Xs(e,t,i,s=Ke,n){const r={fn:e,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:W,context:W?W.context:null,pure:i};return W===null||W!==br&&(W.owned?W.owned.push(r):W.owned=[r]),r}function Di(e){if(e.state===0)return;if(e.state===Pi)return Li(e);if(e.suspense&&_e(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<ji);)e.state&&t.push(e);for(let i=t.length-1;i>=0;i--)if(e=t[i],e.state===Ke)qt(e);else if(e.state===Pi){const s=oe;oe=null,jt(()=>Li(e,t[0]),!1),oe=s}}function jt(e,t){if(oe)return e();let i=!1;t||(oe=[]),Le?i=!0:Le=[],ji++;try{const s=e();return Eo(i),s}catch(s){i||(Le=null),oe=null,Er(s)}}function Eo(e){if(oe&&(Sr(oe),oe=null),e)return;const t=Le;Le=null,t.length&&jt(()=>yr(t),!1)}function Sr(e){for(let t=0;t<e.length;t++)Di(e[t])}function To(e){let t,i=0;for(t=0;t<e.length;t++){const s=e[t];s.user?e[i++]=s:Di(s)}if(X.context){if(X.count){X.effects||(X.effects=[]),X.effects.push(...e.slice(0,i));return}xo()}for(X.effects&&!X.count&&(e=[...X.effects,...e],i+=X.effects.length,delete X.effects),t=0;t<i;t++)Di(e[t])}function Li(e,t){e.state=0;for(let i=0;i<e.sources.length;i+=1){const s=e.sources[i];if(s.sources){const n=s.state;n===Ke?s!==t&&(!s.updatedAt||s.updatedAt<ji)&&Di(s):n===Pi&&Li(s,t)}}}function Ir(e){for(let t=0;t<e.observers.length;t+=1){const i=e.observers[t];i.state||(i.state=Pi,i.pure?oe.push(i):Le.push(i),i.observers&&Ir(i))}}function Vt(e){let t;if(e.sources)for(;e.sources.length;){const i=e.sources.pop(),s=e.sourceSlots.pop(),n=i.observers;if(n&&n.length){const r=n.pop(),a=i.observerSlots.pop();s<n.length&&(r.sourceSlots[a]=s,n[s]=r,i.observerSlots[s]=a)}}if(e.tOwned){for(t=e.tOwned.length-1;t>=0;t--)Vt(e.tOwned[t]);delete e.tOwned}if(e.owned){for(t=e.owned.length-1;t>=0;t--)Vt(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0}function Fo(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function Er(e,t=W){throw Fo(e)}function Us(e){if(typeof e=="function"&&!e.length)return Us(e());if(Array.isArray(e)){const t=[];for(let i=0;i<e.length;i++){const s=Us(e[i]);Array.isArray(s)?t.push.apply(t,s):t.push(s)}return t}return e}function Co(e,t){return function(s){let n;return Xe(()=>n=_e(()=>(W.context={...W.context,[e]:s.value},So(()=>s.children))),void 0),n}}const Uo=Symbol("fallback");function En(e){for(let t=0;t<e.length;t++)e[t]()}function ko(e,t,i={}){let s=[],n=[],r=[],a=0,o=t.length>1?[]:null;return ve(()=>En(r)),()=>{let l=e()||[],d=l.length,c,f;return l[_o],_e(()=>{let h,m,x,p,S,w,C,U,F;if(d===0)a!==0&&(En(r),r=[],s=[],n=[],a=0,o&&(o=[])),i.fallback&&(s=[Uo],n[0]=$i(I=>(r[0]=I,i.fallback())),a=1);else if(a===0){for(n=new Array(d),f=0;f<d;f++)s[f]=l[f],n[f]=$i(u);a=d}else{for(x=new Array(d),p=new Array(d),o&&(S=new Array(d)),w=0,C=Math.min(a,d);w<C&&s[w]===l[w];w++);for(C=a-1,U=d-1;C>=w&&U>=w&&s[C]===l[U];C--,U--)x[U]=n[C],p[U]=r[C],o&&(S[U]=o[C]);for(h=new Map,m=new Array(U+1),f=U;f>=w;f--)F=l[f],c=h.get(F),m[f]=c===void 0?-1:c,h.set(F,f);for(c=w;c<=C;c++)F=s[c],f=h.get(F),f!==void 0&&f!==-1?(x[f]=n[c],p[f]=r[c],o&&(S[f]=o[c]),f=m[f],h.set(F,f)):r[c]();for(f=w;f<d;f++)f in x?(n[f]=x[f],r[f]=p[f],o&&(o[f]=S[f],o[f](f))):n[f]=$i(u);n=n.slice(0,a=d),s=l.slice(0)}return n});function u(h){if(r[f]=h,o){const[m,x]=M(f);return o[f]=x,t(l[f],m)}return t(l[f])}}}function g(e,t){return _e(()=>e(t||{}))}function ri(){return!0}const ks={get(e,t,i){return t===Ai?i:e.get(t)},has(e,t){return t===Ai?!0:e.has(t)},set:ri,deleteProperty:ri,getOwnPropertyDescriptor(e,t){return{configurable:!0,enumerable:!0,get(){return e.get(t)},set:ri,deleteProperty:ri}},ownKeys(e){return e.keys()}};function os(e){return(e=typeof e=="function"?e():e)?e:{}}function Bo(){for(let e=0,t=this.length;e<t;++e){const i=this[e]();if(i!==void 0)return i}}function D(...e){let t=!1;for(let a=0;a<e.length;a++){const o=e[a];t=t||!!o&&Ai in o,e[a]=typeof o=="function"?(t=!0,R(o)):o}if(xr&&t)return new Proxy({get(a){for(let o=e.length-1;o>=0;o--){const l=os(e[o])[a];if(l!==void 0)return l}},has(a){for(let o=e.length-1;o>=0;o--)if(a in os(e[o]))return!0;return!1},keys(){const a=[];for(let o=0;o<e.length;o++)a.push(...Object.keys(os(e[o])));return[...new Set(a)]}},ks);const i={},s=Object.create(null);for(let a=e.length-1;a>=0;a--){const o=e[a];if(!o)continue;const l=Object.getOwnPropertyNames(o);for(let d=l.length-1;d>=0;d--){const c=l[d];if(c==="__proto__"||c==="constructor")continue;const f=Object.getOwnPropertyDescriptor(o,c);if(!s[c])s[c]=f.get?{enumerable:!0,configurable:!0,get:Bo.bind(i[c]=[f.get.bind(o)])}:f.value!==void 0?f:void 0;else{const u=i[c];u&&(f.get?u.push(f.get.bind(o)):f.value!==void 0&&u.push(()=>f.value))}}}const n={},r=Object.keys(s);for(let a=r.length-1;a>=0;a--){const o=r[a],l=s[o];l&&l.get?Object.defineProperty(n,o,l):n[o]=l?l.value:void 0}return n}function Y(e,...t){if(xr&&Ai in e){const n=new Set(t.length>1?t.flat():t[0]),r=t.map(a=>new Proxy({get(o){return a.includes(o)?e[o]:void 0},has(o){return a.includes(o)&&o in e},keys(){return a.filter(o=>o in e)}},ks));return r.push(new Proxy({get(a){return n.has(a)?void 0:e[a]},has(a){return n.has(a)?!1:a in e},keys(){return Object.keys(e).filter(a=>!n.has(a))}},ks)),r}const i={},s=t.map(()=>({}));for(const n of Object.getOwnPropertyNames(e)){const r=Object.getOwnPropertyDescriptor(e,n),a=!r.get&&!r.set&&r.enumerable&&r.writable&&r.configurable;let o=!1,l=0;for(const d of t)d.includes(n)&&(o=!0,a?s[l][n]=r.value:Object.defineProperty(s[l],n,r)),++l;o||(a?i[n]=r.value:Object.defineProperty(i,n,r))}return[...s,i]}let Ao=0;function Xt(){return X.context?X.getNextContextId():`cl-${Ao++}`}const Oo=e=>`Stale read from <${e}>.`;function ls(e){const t="fallback"in e&&{fallback:()=>e.fallback};return R(ko(()=>e.each,e.children,t||void 0))}function Pe(e){const t=e.keyed,i=R(()=>e.when,void 0,void 0),s=t?i:R(i,void 0,{equals:(n,r)=>!n==!r});return R(()=>{const n=s();if(n){const r=e.children;return typeof r=="function"&&r.length>0?_e(()=>r(t?n:()=>{if(!_e(s))throw Oo("Show");return i()})):r}return e.fallback},void 0,void 0)}const Po=["allowfullscreen","async","autofocus","autoplay","checked","controls","default","disabled","formnovalidate","hidden","indeterminate","inert","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","seamless","selected"],Do=new Set(["className","value","readOnly","formNoValidate","isMap","noModule","playsInline",...Po]),Lo=new Set(["innerHTML","textContent","innerText","children"]),No=Object.assign(Object.create(null),{className:"class",htmlFor:"for"}),Ro=Object.assign(Object.create(null),{class:"className",formnovalidate:{$:"formNoValidate",BUTTON:1,INPUT:1},ismap:{$:"isMap",IMG:1},nomodule:{$:"noModule",SCRIPT:1},playsinline:{$:"playsInline",VIDEO:1},readonly:{$:"readOnly",INPUT:1,TEXTAREA:1}});function zo(e,t){const i=Ro[e];return typeof i=="object"?i[t]?i.$:void 0:i}const Mo=new Set(["beforeinput","click","dblclick","contextmenu","focusin","focusout","input","keydown","keyup","mousedown","mousemove","mouseout","mouseover","mouseup","pointerdown","pointermove","pointerout","pointerover","pointerup","touchend","touchmove","touchstart"]),Go=new Set(["altGlyph","altGlyphDef","altGlyphItem","animate","animateColor","animateMotion","animateTransform","circle","clipPath","color-profile","cursor","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","font","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignObject","g","glyph","glyphRef","hkern","image","line","linearGradient","marker","mask","metadata","missing-glyph","mpath","path","pattern","polygon","polyline","radialGradient","rect","set","stop","svg","switch","symbol","text","textPath","tref","tspan","use","view","vkern"]),Vo={xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace"};function Wo(e,t,i){let s=i.length,n=t.length,r=s,a=0,o=0,l=t[n-1].nextSibling,d=null;for(;a<n||o<r;){if(t[a]===i[o]){a++,o++;continue}for(;t[n-1]===i[r-1];)n--,r--;if(n===a){const c=r<s?o?i[o-1].nextSibling:i[r-o]:l;for(;o<r;)e.insertBefore(i[o++],c)}else if(r===o)for(;a<n;)(!d||!d.has(t[a]))&&t[a].remove(),a++;else if(t[a]===i[r-1]&&i[o]===t[n-1]){const c=t[--n].nextSibling;e.insertBefore(i[o++],t[a++].nextSibling),e.insertBefore(i[--r],c),t[n]=i[r]}else{if(!d){d=new Map;let f=o;for(;f<r;)d.set(i[f],f++)}const c=d.get(t[a]);if(c!=null)if(o<c&&c<r){let f=a,u=1,h;for(;++f<n&&f<r&&!((h=d.get(t[f]))==null||h!==c+u);)u++;if(u>c-o){const m=t[a];for(;o<c;)e.insertBefore(i[o++],m)}else e.replaceChild(i[o++],t[a++])}else a++;else t[a++].remove()}}}const Tn="_$DX_DELEGATE";function Ho(e,t,i,s={}){let n;return $i(r=>{n=r,t===document?e():z(t,e(),t.firstChild?null:void 0,i)},s.owner),()=>{n(),t.textContent=""}}function q(e,t,i,s){let n;const r=()=>{const o=document.createElement("template");return o.innerHTML=e,o.content.firstChild},a=()=>(n||(n=r())).cloneNode(!0);return a.cloneNode=a,a}function qo(e,t=window.document){const i=t[Tn]||(t[Tn]=new Set);for(let s=0,n=e.length;s<n;s++){const r=e[s];i.has(r)||(i.add(r),t.addEventListener(r,il))}}function Bs(e,t,i){ct(e)||(i==null?e.removeAttribute(t):e.setAttribute(t,i))}function jo(e,t,i,s){ct(e)||(s==null?e.removeAttributeNS(t,i):e.setAttributeNS(t,i,s))}function Xo(e,t,i){ct(e)||(i?e.setAttribute(t,""):e.removeAttribute(t))}function Tr(e,t){ct(e)||(t==null?e.removeAttribute("class"):e.className=t)}function Yo(e,t,i,s){if(s)Array.isArray(i)?(e[`$$${t}`]=i[0],e[`$$${t}Data`]=i[1]):e[`$$${t}`]=i;else if(Array.isArray(i)){const n=i[0];e.addEventListener(t,i[0]=r=>n.call(e,i[1],r))}else e.addEventListener(t,i,typeof i!="function"&&i)}function Ko(e,t,i={}){const s=Object.keys(t||{}),n=Object.keys(i);let r,a;for(r=0,a=n.length;r<a;r++){const o=n[r];!o||o==="undefined"||t[o]||(Fn(e,o,!1),delete i[o])}for(r=0,a=s.length;r<a;r++){const o=s[r],l=!!t[o];!o||o==="undefined"||i[o]===l||!l||(Fn(e,o,!0),i[o]=l)}return i}function Jo(e,t,i){if(!t)return i?Bs(e,"style"):t;const s=e.style;if(typeof t=="string")return s.cssText=t;typeof i=="string"&&(s.cssText=i=void 0),i||(i={}),t||(t={});let n,r;for(r in i)t[r]==null&&s.removeProperty(r),delete i[r];for(r in t)n=t[r],n!==i[r]&&(s.setProperty(r,n),i[r]=n);return i}function Fr(e,t={},i,s){const n={};return s||Xe(()=>n.children=Wt(e,t.children,n.children)),Xe(()=>typeof t.ref=="function"&&Zo(t.ref,e)),Xe(()=>Qo(e,t,i,!0,n,!0)),n}function Zo(e,t,i){return _e(()=>e(t,i))}function z(e,t,i,s){if(i!==void 0&&!s&&(s=[]),typeof t!="function")return Wt(e,t,s,i);Xe(n=>Wt(e,t(),n,i),s)}function Qo(e,t,i,s,n={},r=!1){t||(t={});for(const a in n)if(!(a in t)){if(a==="children")continue;n[a]=Cn(e,a,null,n[a],i,r,t)}for(const a in t){if(a==="children")continue;const o=t[a];n[a]=Cn(e,a,o,n[a],i,r,t)}}function el(e){let t,i;return!ct()||!(t=X.registry.get(i=sl()))?e():(X.completed&&X.completed.add(t),X.registry.delete(i),t)}function ct(e){return!!X.context&&!X.done&&(!e||e.isConnected)}function tl(e){return e.toLowerCase().replace(/-([a-z])/g,(t,i)=>i.toUpperCase())}function Fn(e,t,i){const s=t.trim().split(/\s+/);for(let n=0,r=s.length;n<r;n++)e.classList.toggle(s[n],i)}function Cn(e,t,i,s,n,r,a){let o,l,d,c,f;if(t==="style")return Jo(e,i,s);if(t==="classList")return Ko(e,i,s);if(i===s)return s;if(t==="ref")r||i(e);else if(t.slice(0,3)==="on:"){const u=t.slice(3);s&&e.removeEventListener(u,s,typeof s!="function"&&s),i&&e.addEventListener(u,i,typeof i!="function"&&i)}else if(t.slice(0,10)==="oncapture:"){const u=t.slice(10);s&&e.removeEventListener(u,s,!0),i&&e.addEventListener(u,i,!0)}else if(t.slice(0,2)==="on"){const u=t.slice(2).toLowerCase(),h=Mo.has(u);if(!h&&s){const m=Array.isArray(s)?s[0]:s;e.removeEventListener(u,m)}(h||i)&&(Yo(e,u,i,h),h&&qo([u]))}else if(t.slice(0,5)==="attr:")Bs(e,t.slice(5),i);else if(t.slice(0,5)==="bool:")Xo(e,t.slice(5),i);else if((f=t.slice(0,5)==="prop:")||(d=Lo.has(t))||!n&&((c=zo(t,e.tagName))||(l=Do.has(t)))||(o=e.nodeName.includes("-")||"is"in a)){if(f)t=t.slice(5),l=!0;else if(ct(e))return i;t==="class"||t==="className"?Tr(e,i):o&&!l&&!d?e[tl(t)]=i:e[c||t]=i}else{const u=n&&t.indexOf(":")>-1&&Vo[t.split(":")[0]];u?jo(e,u,t,i):Bs(e,No[t]||t,i)}return i}function il(e){let t=e.target;const i=`$$${e.type}`,s=e.target,n=e.currentTarget,r=l=>Object.defineProperty(e,"target",{configurable:!0,value:l}),a=()=>{const l=t[i];if(l&&!t.disabled){const d=t[`${i}Data`];if(d!==void 0?l.call(t,d,e):l.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&r(t.host),!0},o=()=>{for(;a()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const l=e.composedPath();r(l[0]);for(let d=0;d<l.length-2&&(t=l[d],!!a());d++){if(t._$host){t=t._$host,o();break}if(t.parentNode===n)break}}else o();r(s)}function Wt(e,t,i,s,n){const r=ct(e);if(r){!i&&(i=[...e.childNodes]);let l=[];for(let d=0;d<i.length;d++){const c=i[d];c.nodeType===8&&c.data.slice(0,2)==="!$"?c.remove():l.push(c)}i=l}for(;typeof i=="function";)i=i();if(t===i)return i;const a=typeof t,o=s!==void 0;if(e=o&&i[0]&&i[0].parentNode||e,a==="string"||a==="number"){if(r||a==="number"&&(t=t.toString(),t===i))return i;if(o){let l=i[0];l&&l.nodeType===3?l.data!==t&&(l.data=t):l=document.createTextNode(t),i=$t(e,i,s,l)}else i!==""&&typeof i=="string"?i=e.firstChild.data=t:i=e.textContent=t}else if(t==null||a==="boolean"){if(r)return i;i=$t(e,i,s)}else{if(a==="function")return Xe(()=>{let l=t();for(;typeof l=="function";)l=l();i=Wt(e,l,i,s)}),()=>i;if(Array.isArray(t)){const l=[],d=i&&Array.isArray(i);if(As(l,t,i,n))return Xe(()=>i=Wt(e,l,i,s,!0)),()=>i;if(r){if(!l.length)return i;if(s===void 0)return i=[...e.childNodes];let c=l[0];if(c.parentNode!==e)return i;const f=[c];for(;(c=c.nextSibling)!==s;)f.push(c);return i=f}if(l.length===0){if(i=$t(e,i,s),o)return i}else d?i.length===0?Un(e,l,s):Wo(e,i,l):(i&&$t(e),Un(e,l));i=l}else if(t.nodeType){if(r&&t.parentNode)return i=o?[t]:t;if(Array.isArray(i)){if(o)return i=$t(e,i,s,t);$t(e,i,null,t)}else i==null||i===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);i=t}}return i}function As(e,t,i,s){let n=!1;for(let r=0,a=t.length;r<a;r++){let o=t[r],l=i&&i[e.length],d;if(!(o==null||o===!0||o===!1))if((d=typeof o)=="object"&&o.nodeType)e.push(o);else if(Array.isArray(o))n=As(e,o,l)||n;else if(d==="function")if(s){for(;typeof o=="function";)o=o();n=As(e,Array.isArray(o)?o:[o],Array.isArray(l)?l:[l])||n}else e.push(o),n=!0;else{const c=String(o);l&&l.nodeType===3&&l.data===c?e.push(l):e.push(document.createTextNode(c))}}return n}function Un(e,t,i=null){for(let s=0,n=t.length;s<n;s++)e.insertBefore(t[s],i)}function $t(e,t,i,s){if(i===void 0)return e.textContent="";const n=s||document.createTextNode("");if(t.length){let r=!1;for(let a=t.length-1;a>=0;a--){const o=t[a];if(n!==o){const l=o.parentNode===e;!r&&!a?l?e.replaceChild(n,o):e.insertBefore(n,i):l&&o.remove()}else r=!0}}else e.insertBefore(n,i);return[n]}function sl(){return X.getNextContextId()}const nl="http://www.w3.org/2000/svg";function rl(e,t=!1){return t?document.createElementNS(nl,e):document.createElement(e)}function al(e,t){const i=R(e);return R(()=>{const s=i();switch(typeof s){case"function":return _e(()=>s(t));case"string":const n=Go.has(s),r=X.context?el():rl(s,n);return Fr(r,t,n),r}})}function ol(e){const[,t]=Y(e,["component"]);return al(()=>e.component,t)}var ll=q(`<li class="before:content-['ðŸ“‚'] before:pr-2">`),dl=q("<ul class=pl-6>");function ae(e){return(()=>{var t=ll();return z(t,()=>e.name,null),z(t,g(Pe,{get when(){return e.children},get children(){return g(Ot,{get children(){return e.children}})}}),null),t})()}function Ot(e){return(()=>{var t=dl();return z(t,()=>e.children),t})()}function Cr(e){var t,i,s="";if(typeof e=="string"||typeof e=="number")s+=e;else if(typeof e=="object")if(Array.isArray(e)){var n=e.length;for(t=0;t<n;t++)e[t]&&(i=Cr(e[t]))&&(s&&(s+=" "),s+=i)}else for(i in e)e[i]&&(s&&(s+=" "),s+=i);return s}function Ur(){for(var e,t,i=0,s="",n=arguments.length;i<n;i++)(e=arguments[i])&&(t=Cr(e))&&(s&&(s+=" "),s+=t);return s}const Ys="-",fl=e=>{const t=ul(e),{conflictingClassGroups:i,conflictingClassGroupModifiers:s}=e;return{getClassGroupId:a=>{const o=a.split(Ys);return o[0]===""&&o.length!==1&&o.shift(),kr(o,t)||cl(a)},getConflictingClassGroupIds:(a,o)=>{const l=i[a]||[];return o&&s[a]?[...l,...s[a]]:l}}},kr=(e,t)=>{if(e.length===0)return t.classGroupId;const i=e[0],s=t.nextPart.get(i),n=s?kr(e.slice(1),s):void 0;if(n)return n;if(t.validators.length===0)return;const r=e.join(Ys);return t.validators.find(({validator:a})=>a(r))?.classGroupId},kn=/^\[(.+)\]$/,cl=e=>{if(kn.test(e)){const t=kn.exec(e)[1],i=t?.substring(0,t.indexOf(":"));if(i)return"arbitrary.."+i}},ul=e=>{const{theme:t,classGroups:i}=e,s={nextPart:new Map,validators:[]};for(const n in i)Os(i[n],s,n,t);return s},Os=(e,t,i,s)=>{e.forEach(n=>{if(typeof n=="string"){const r=n===""?t:Bn(t,n);r.classGroupId=i;return}if(typeof n=="function"){if(hl(n)){Os(n(s),t,i,s);return}t.validators.push({validator:n,classGroupId:i});return}Object.entries(n).forEach(([r,a])=>{Os(a,Bn(t,r),i,s)})})},Bn=(e,t)=>{let i=e;return t.split(Ys).forEach(s=>{i.nextPart.has(s)||i.nextPart.set(s,{nextPart:new Map,validators:[]}),i=i.nextPart.get(s)}),i},hl=e=>e.isThemeGetter,pl=e=>{if(e<1)return{get:()=>{},set:()=>{}};let t=0,i=new Map,s=new Map;const n=(r,a)=>{i.set(r,a),t++,t>e&&(t=0,s=i,i=new Map)};return{get(r){let a=i.get(r);if(a!==void 0)return a;if((a=s.get(r))!==void 0)return n(r,a),a},set(r,a){i.has(r)?i.set(r,a):n(r,a)}}},Ps="!",Ds=":",ml=Ds.length,$l=e=>{const{prefix:t,experimentalParseClassName:i}=e;let s=n=>{const r=[];let a=0,o=0,l=0,d;for(let m=0;m<n.length;m++){let x=n[m];if(a===0&&o===0){if(x===Ds){r.push(n.slice(l,m)),l=m+ml;continue}if(x==="/"){d=m;continue}}x==="["?a++:x==="]"?a--:x==="("?o++:x===")"&&o--}const c=r.length===0?n:n.substring(l),f=gl(c),u=f!==c,h=d&&d>l?d-l:void 0;return{modifiers:r,hasImportantModifier:u,baseClassName:f,maybePostfixModifierPosition:h}};if(t){const n=t+Ds,r=s;s=a=>a.startsWith(n)?r(a.substring(n.length)):{isExternal:!0,modifiers:[],hasImportantModifier:!1,baseClassName:a,maybePostfixModifierPosition:void 0}}if(i){const n=s;s=r=>i({className:r,parseClassName:n})}return s},gl=e=>e.endsWith(Ps)?e.substring(0,e.length-1):e.startsWith(Ps)?e.substring(1):e,xl=e=>{const t=Object.fromEntries(e.orderSensitiveModifiers.map(s=>[s,!0]));return s=>{if(s.length<=1)return s;const n=[];let r=[];return s.forEach(a=>{a[0]==="["||t[a]?(n.push(...r.sort(),a),r=[]):r.push(a)}),n.push(...r.sort()),n}},yl=e=>({cache:pl(e.cacheSize),parseClassName:$l(e),sortModifiers:xl(e),...fl(e)}),bl=/\s+/,_l=(e,t)=>{const{parseClassName:i,getClassGroupId:s,getConflictingClassGroupIds:n,sortModifiers:r}=t,a=[],o=e.trim().split(bl);let l="";for(let d=o.length-1;d>=0;d-=1){const c=o[d],{isExternal:f,modifiers:u,hasImportantModifier:h,baseClassName:m,maybePostfixModifierPosition:x}=i(c);if(f){l=c+(l.length>0?" "+l:l);continue}let p=!!x,S=s(p?m.substring(0,x):m);if(!S){if(!p){l=c+(l.length>0?" "+l:l);continue}if(S=s(m),!S){l=c+(l.length>0?" "+l:l);continue}p=!1}const w=r(u).join(":"),C=h?w+Ps:w,U=C+S;if(a.includes(U))continue;a.push(U);const F=n(S,p);for(let I=0;I<F.length;++I){const P=F[I];a.push(C+P)}l=c+(l.length>0?" "+l:l)}return l};function vl(){let e=0,t,i,s="";for(;e<arguments.length;)(t=arguments[e++])&&(i=Br(t))&&(s&&(s+=" "),s+=i);return s}const Br=e=>{if(typeof e=="string")return e;let t,i="";for(let s=0;s<e.length;s++)e[s]&&(t=Br(e[s]))&&(i&&(i+=" "),i+=t);return i};function wl(e,...t){let i,s,n,r=a;function a(l){const d=t.reduce((c,f)=>f(c),e());return i=yl(d),s=i.cache.get,n=i.cache.set,r=o,o(l)}function o(l){const d=s(l);if(d)return d;const c=_l(l,i);return n(l,c),c}return function(){return r(vl.apply(null,arguments))}}const te=e=>{const t=i=>i[e]||[];return t.isThemeGetter=!0,t},Ar=/^\[(?:(\w[\w-]*):)?(.+)\]$/i,Or=/^\((?:(\w[\w-]*):)?(.+)\)$/i,Sl=/^\d+\/\d+$/,Il=/^(\d+(\.\d+)?)?(xs|sm|md|lg|xl)$/,El=/\d+(%|px|r?em|[sdl]?v([hwib]|min|max)|pt|pc|in|cm|mm|cap|ch|ex|r?lh|cq(w|h|i|b|min|max))|\b(calc|min|max|clamp)\(.+\)|^0$/,Tl=/^(rgba?|hsla?|hwb|(ok)?(lab|lch)|color-mix)\(.+\)$/,Fl=/^(inset_)?-?((\d+)?\.?(\d+)[a-z]+|0)_-?((\d+)?\.?(\d+)[a-z]+|0)/,Cl=/^(url|image|image-set|cross-fade|element|(repeating-)?(linear|radial|conic)-gradient)\(.+\)$/,gt=e=>Sl.test(e),O=e=>!!e&&!Number.isNaN(Number(e)),Re=e=>!!e&&Number.isInteger(Number(e)),ds=e=>e.endsWith("%")&&O(e.slice(0,-1)),Be=e=>Il.test(e),Ul=()=>!0,kl=e=>El.test(e)&&!Tl.test(e),Pr=()=>!1,Bl=e=>Fl.test(e),Al=e=>Cl.test(e),Ol=e=>!E(e)&&!T(e),Pl=e=>wt(e,Nr,Pr),E=e=>Ar.test(e),Qe=e=>wt(e,Rr,kl),fs=e=>wt(e,zl,O),An=e=>wt(e,Dr,Pr),Dl=e=>wt(e,Lr,Al),ai=e=>wt(e,zr,Bl),T=e=>Or.test(e),Ct=e=>St(e,Rr),Ll=e=>St(e,Ml),On=e=>St(e,Dr),Nl=e=>St(e,Nr),Rl=e=>St(e,Lr),oi=e=>St(e,zr,!0),wt=(e,t,i)=>{const s=Ar.exec(e);return s?s[1]?t(s[1]):i(s[2]):!1},St=(e,t,i=!1)=>{const s=Or.exec(e);return s?s[1]?t(s[1]):i:!1},Dr=e=>e==="position"||e==="percentage",Lr=e=>e==="image"||e==="url",Nr=e=>e==="length"||e==="size"||e==="bg-size",Rr=e=>e==="length",zl=e=>e==="number",Ml=e=>e==="family-name",zr=e=>e==="shadow",Gl=()=>{const e=te("color"),t=te("font"),i=te("text"),s=te("font-weight"),n=te("tracking"),r=te("leading"),a=te("breakpoint"),o=te("container"),l=te("spacing"),d=te("radius"),c=te("shadow"),f=te("inset-shadow"),u=te("text-shadow"),h=te("drop-shadow"),m=te("blur"),x=te("perspective"),p=te("aspect"),S=te("ease"),w=te("animate"),C=()=>["auto","avoid","all","avoid-page","page","left","right","column"],U=()=>["center","top","bottom","left","right","top-left","left-top","top-right","right-top","bottom-right","right-bottom","bottom-left","left-bottom"],F=()=>[...U(),T,E],I=()=>["auto","hidden","clip","visible","scroll"],P=()=>["auto","contain","none"],_=()=>[T,E,l],V=()=>[gt,"full","auto",..._()],A=()=>[Re,"none","subgrid",T,E],Ee=()=>["auto",{span:["full",Re,T,E]},Re,T,E],pt=()=>[Re,"auto",T,E],ke=()=>["auto","min","max","fr",T,E],Ze=()=>["start","end","center","between","around","evenly","stretch","baseline","center-safe","end-safe"],Te=()=>["start","end","center","stretch","center-safe","end-safe"],fe=()=>["auto",..._()],G=()=>[gt,"auto","full","dvw","dvh","lvw","lvh","svw","svh","min","max","fit",..._()],k=()=>[e,T,E],we=()=>[...U(),On,An,{position:[T,E]}],mt=()=>["no-repeat",{repeat:["","x","y","space","round"]}],ei=()=>["auto","cover","contain",Nl,Pl,{size:[T,E]}],ns=()=>[ds,Ct,Qe],ce=()=>["","none","full",d,T,E],xe=()=>["",O,Ct,Qe],ti=()=>["solid","dashed","dotted","double"],wn=()=>["normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],se=()=>[O,ds,On,An],Sn=()=>["","none",m,T,E],ii=()=>["none",O,T,E],si=()=>["none",O,T,E],rs=()=>[O,T,E],ni=()=>[gt,"full",..._()];return{cacheSize:500,theme:{animate:["spin","ping","pulse","bounce"],aspect:["video"],blur:[Be],breakpoint:[Be],color:[Ul],container:[Be],"drop-shadow":[Be],ease:["in","out","in-out"],font:[Ol],"font-weight":["thin","extralight","light","normal","medium","semibold","bold","extrabold","black"],"inset-shadow":[Be],leading:["none","tight","snug","normal","relaxed","loose"],perspective:["dramatic","near","normal","midrange","distant","none"],radius:[Be],shadow:[Be],spacing:["px",O],text:[Be],"text-shadow":[Be],tracking:["tighter","tight","normal","wide","wider","widest"]},classGroups:{aspect:[{aspect:["auto","square",gt,E,T,p]}],container:["container"],columns:[{columns:[O,E,T,o]}],"break-after":[{"break-after":C()}],"break-before":[{"break-before":C()}],"break-inside":[{"break-inside":["auto","avoid","avoid-page","avoid-column"]}],"box-decoration":[{"box-decoration":["slice","clone"]}],box:[{box:["border","content"]}],display:["block","inline-block","inline","flex","inline-flex","table","inline-table","table-caption","table-cell","table-column","table-column-group","table-footer-group","table-header-group","table-row-group","table-row","flow-root","grid","inline-grid","contents","list-item","hidden"],sr:["sr-only","not-sr-only"],float:[{float:["right","left","none","start","end"]}],clear:[{clear:["left","right","both","none","start","end"]}],isolation:["isolate","isolation-auto"],"object-fit":[{object:["contain","cover","fill","none","scale-down"]}],"object-position":[{object:F()}],overflow:[{overflow:I()}],"overflow-x":[{"overflow-x":I()}],"overflow-y":[{"overflow-y":I()}],overscroll:[{overscroll:P()}],"overscroll-x":[{"overscroll-x":P()}],"overscroll-y":[{"overscroll-y":P()}],position:["static","fixed","absolute","relative","sticky"],inset:[{inset:V()}],"inset-x":[{"inset-x":V()}],"inset-y":[{"inset-y":V()}],start:[{start:V()}],end:[{end:V()}],top:[{top:V()}],right:[{right:V()}],bottom:[{bottom:V()}],left:[{left:V()}],visibility:["visible","invisible","collapse"],z:[{z:[Re,"auto",T,E]}],basis:[{basis:[gt,"full","auto",o,..._()]}],"flex-direction":[{flex:["row","row-reverse","col","col-reverse"]}],"flex-wrap":[{flex:["nowrap","wrap","wrap-reverse"]}],flex:[{flex:[O,gt,"auto","initial","none",E]}],grow:[{grow:["",O,T,E]}],shrink:[{shrink:["",O,T,E]}],order:[{order:[Re,"first","last","none",T,E]}],"grid-cols":[{"grid-cols":A()}],"col-start-end":[{col:Ee()}],"col-start":[{"col-start":pt()}],"col-end":[{"col-end":pt()}],"grid-rows":[{"grid-rows":A()}],"row-start-end":[{row:Ee()}],"row-start":[{"row-start":pt()}],"row-end":[{"row-end":pt()}],"grid-flow":[{"grid-flow":["row","col","dense","row-dense","col-dense"]}],"auto-cols":[{"auto-cols":ke()}],"auto-rows":[{"auto-rows":ke()}],gap:[{gap:_()}],"gap-x":[{"gap-x":_()}],"gap-y":[{"gap-y":_()}],"justify-content":[{justify:[...Ze(),"normal"]}],"justify-items":[{"justify-items":[...Te(),"normal"]}],"justify-self":[{"justify-self":["auto",...Te()]}],"align-content":[{content:["normal",...Ze()]}],"align-items":[{items:[...Te(),{baseline:["","last"]}]}],"align-self":[{self:["auto",...Te(),{baseline:["","last"]}]}],"place-content":[{"place-content":Ze()}],"place-items":[{"place-items":[...Te(),"baseline"]}],"place-self":[{"place-self":["auto",...Te()]}],p:[{p:_()}],px:[{px:_()}],py:[{py:_()}],ps:[{ps:_()}],pe:[{pe:_()}],pt:[{pt:_()}],pr:[{pr:_()}],pb:[{pb:_()}],pl:[{pl:_()}],m:[{m:fe()}],mx:[{mx:fe()}],my:[{my:fe()}],ms:[{ms:fe()}],me:[{me:fe()}],mt:[{mt:fe()}],mr:[{mr:fe()}],mb:[{mb:fe()}],ml:[{ml:fe()}],"space-x":[{"space-x":_()}],"space-x-reverse":["space-x-reverse"],"space-y":[{"space-y":_()}],"space-y-reverse":["space-y-reverse"],size:[{size:G()}],w:[{w:[o,"screen",...G()]}],"min-w":[{"min-w":[o,"screen","none",...G()]}],"max-w":[{"max-w":[o,"screen","none","prose",{screen:[a]},...G()]}],h:[{h:["screen","lh",...G()]}],"min-h":[{"min-h":["screen","lh","none",...G()]}],"max-h":[{"max-h":["screen","lh",...G()]}],"font-size":[{text:["base",i,Ct,Qe]}],"font-smoothing":["antialiased","subpixel-antialiased"],"font-style":["italic","not-italic"],"font-weight":[{font:[s,T,fs]}],"font-stretch":[{"font-stretch":["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded",ds,E]}],"font-family":[{font:[Ll,E,t]}],"fvn-normal":["normal-nums"],"fvn-ordinal":["ordinal"],"fvn-slashed-zero":["slashed-zero"],"fvn-figure":["lining-nums","oldstyle-nums"],"fvn-spacing":["proportional-nums","tabular-nums"],"fvn-fraction":["diagonal-fractions","stacked-fractions"],tracking:[{tracking:[n,T,E]}],"line-clamp":[{"line-clamp":[O,"none",T,fs]}],leading:[{leading:[r,..._()]}],"list-image":[{"list-image":["none",T,E]}],"list-style-position":[{list:["inside","outside"]}],"list-style-type":[{list:["disc","decimal","none",T,E]}],"text-alignment":[{text:["left","center","right","justify","start","end"]}],"placeholder-color":[{placeholder:k()}],"text-color":[{text:k()}],"text-decoration":["underline","overline","line-through","no-underline"],"text-decoration-style":[{decoration:[...ti(),"wavy"]}],"text-decoration-thickness":[{decoration:[O,"from-font","auto",T,Qe]}],"text-decoration-color":[{decoration:k()}],"underline-offset":[{"underline-offset":[O,"auto",T,E]}],"text-transform":["uppercase","lowercase","capitalize","normal-case"],"text-overflow":["truncate","text-ellipsis","text-clip"],"text-wrap":[{text:["wrap","nowrap","balance","pretty"]}],indent:[{indent:_()}],"vertical-align":[{align:["baseline","top","middle","bottom","text-top","text-bottom","sub","super",T,E]}],whitespace:[{whitespace:["normal","nowrap","pre","pre-line","pre-wrap","break-spaces"]}],break:[{break:["normal","words","all","keep"]}],wrap:[{wrap:["break-word","anywhere","normal"]}],hyphens:[{hyphens:["none","manual","auto"]}],content:[{content:["none",T,E]}],"bg-attachment":[{bg:["fixed","local","scroll"]}],"bg-clip":[{"bg-clip":["border","padding","content","text"]}],"bg-origin":[{"bg-origin":["border","padding","content"]}],"bg-position":[{bg:we()}],"bg-repeat":[{bg:mt()}],"bg-size":[{bg:ei()}],"bg-image":[{bg:["none",{linear:[{to:["t","tr","r","br","b","bl","l","tl"]},Re,T,E],radial:["",T,E],conic:[Re,T,E]},Rl,Dl]}],"bg-color":[{bg:k()}],"gradient-from-pos":[{from:ns()}],"gradient-via-pos":[{via:ns()}],"gradient-to-pos":[{to:ns()}],"gradient-from":[{from:k()}],"gradient-via":[{via:k()}],"gradient-to":[{to:k()}],rounded:[{rounded:ce()}],"rounded-s":[{"rounded-s":ce()}],"rounded-e":[{"rounded-e":ce()}],"rounded-t":[{"rounded-t":ce()}],"rounded-r":[{"rounded-r":ce()}],"rounded-b":[{"rounded-b":ce()}],"rounded-l":[{"rounded-l":ce()}],"rounded-ss":[{"rounded-ss":ce()}],"rounded-se":[{"rounded-se":ce()}],"rounded-ee":[{"rounded-ee":ce()}],"rounded-es":[{"rounded-es":ce()}],"rounded-tl":[{"rounded-tl":ce()}],"rounded-tr":[{"rounded-tr":ce()}],"rounded-br":[{"rounded-br":ce()}],"rounded-bl":[{"rounded-bl":ce()}],"border-w":[{border:xe()}],"border-w-x":[{"border-x":xe()}],"border-w-y":[{"border-y":xe()}],"border-w-s":[{"border-s":xe()}],"border-w-e":[{"border-e":xe()}],"border-w-t":[{"border-t":xe()}],"border-w-r":[{"border-r":xe()}],"border-w-b":[{"border-b":xe()}],"border-w-l":[{"border-l":xe()}],"divide-x":[{"divide-x":xe()}],"divide-x-reverse":["divide-x-reverse"],"divide-y":[{"divide-y":xe()}],"divide-y-reverse":["divide-y-reverse"],"border-style":[{border:[...ti(),"hidden","none"]}],"divide-style":[{divide:[...ti(),"hidden","none"]}],"border-color":[{border:k()}],"border-color-x":[{"border-x":k()}],"border-color-y":[{"border-y":k()}],"border-color-s":[{"border-s":k()}],"border-color-e":[{"border-e":k()}],"border-color-t":[{"border-t":k()}],"border-color-r":[{"border-r":k()}],"border-color-b":[{"border-b":k()}],"border-color-l":[{"border-l":k()}],"divide-color":[{divide:k()}],"outline-style":[{outline:[...ti(),"none","hidden"]}],"outline-offset":[{"outline-offset":[O,T,E]}],"outline-w":[{outline:["",O,Ct,Qe]}],"outline-color":[{outline:k()}],shadow:[{shadow:["","none",c,oi,ai]}],"shadow-color":[{shadow:k()}],"inset-shadow":[{"inset-shadow":["none",f,oi,ai]}],"inset-shadow-color":[{"inset-shadow":k()}],"ring-w":[{ring:xe()}],"ring-w-inset":["ring-inset"],"ring-color":[{ring:k()}],"ring-offset-w":[{"ring-offset":[O,Qe]}],"ring-offset-color":[{"ring-offset":k()}],"inset-ring-w":[{"inset-ring":xe()}],"inset-ring-color":[{"inset-ring":k()}],"text-shadow":[{"text-shadow":["none",u,oi,ai]}],"text-shadow-color":[{"text-shadow":k()}],opacity:[{opacity:[O,T,E]}],"mix-blend":[{"mix-blend":[...wn(),"plus-darker","plus-lighter"]}],"bg-blend":[{"bg-blend":wn()}],"mask-clip":[{"mask-clip":["border","padding","content","fill","stroke","view"]},"mask-no-clip"],"mask-composite":[{mask:["add","subtract","intersect","exclude"]}],"mask-image-linear-pos":[{"mask-linear":[O]}],"mask-image-linear-from-pos":[{"mask-linear-from":se()}],"mask-image-linear-to-pos":[{"mask-linear-to":se()}],"mask-image-linear-from-color":[{"mask-linear-from":k()}],"mask-image-linear-to-color":[{"mask-linear-to":k()}],"mask-image-t-from-pos":[{"mask-t-from":se()}],"mask-image-t-to-pos":[{"mask-t-to":se()}],"mask-image-t-from-color":[{"mask-t-from":k()}],"mask-image-t-to-color":[{"mask-t-to":k()}],"mask-image-r-from-pos":[{"mask-r-from":se()}],"mask-image-r-to-pos":[{"mask-r-to":se()}],"mask-image-r-from-color":[{"mask-r-from":k()}],"mask-image-r-to-color":[{"mask-r-to":k()}],"mask-image-b-from-pos":[{"mask-b-from":se()}],"mask-image-b-to-pos":[{"mask-b-to":se()}],"mask-image-b-from-color":[{"mask-b-from":k()}],"mask-image-b-to-color":[{"mask-b-to":k()}],"mask-image-l-from-pos":[{"mask-l-from":se()}],"mask-image-l-to-pos":[{"mask-l-to":se()}],"mask-image-l-from-color":[{"mask-l-from":k()}],"mask-image-l-to-color":[{"mask-l-to":k()}],"mask-image-x-from-pos":[{"mask-x-from":se()}],"mask-image-x-to-pos":[{"mask-x-to":se()}],"mask-image-x-from-color":[{"mask-x-from":k()}],"mask-image-x-to-color":[{"mask-x-to":k()}],"mask-image-y-from-pos":[{"mask-y-from":se()}],"mask-image-y-to-pos":[{"mask-y-to":se()}],"mask-image-y-from-color":[{"mask-y-from":k()}],"mask-image-y-to-color":[{"mask-y-to":k()}],"mask-image-radial":[{"mask-radial":[T,E]}],"mask-image-radial-from-pos":[{"mask-radial-from":se()}],"mask-image-radial-to-pos":[{"mask-radial-to":se()}],"mask-image-radial-from-color":[{"mask-radial-from":k()}],"mask-image-radial-to-color":[{"mask-radial-to":k()}],"mask-image-radial-shape":[{"mask-radial":["circle","ellipse"]}],"mask-image-radial-size":[{"mask-radial":[{closest:["side","corner"],farthest:["side","corner"]}]}],"mask-image-radial-pos":[{"mask-radial-at":U()}],"mask-image-conic-pos":[{"mask-conic":[O]}],"mask-image-conic-from-pos":[{"mask-conic-from":se()}],"mask-image-conic-to-pos":[{"mask-conic-to":se()}],"mask-image-conic-from-color":[{"mask-conic-from":k()}],"mask-image-conic-to-color":[{"mask-conic-to":k()}],"mask-mode":[{mask:["alpha","luminance","match"]}],"mask-origin":[{"mask-origin":["border","padding","content","fill","stroke","view"]}],"mask-position":[{mask:we()}],"mask-repeat":[{mask:mt()}],"mask-size":[{mask:ei()}],"mask-type":[{"mask-type":["alpha","luminance"]}],"mask-image":[{mask:["none",T,E]}],filter:[{filter:["","none",T,E]}],blur:[{blur:Sn()}],brightness:[{brightness:[O,T,E]}],contrast:[{contrast:[O,T,E]}],"drop-shadow":[{"drop-shadow":["","none",h,oi,ai]}],"drop-shadow-color":[{"drop-shadow":k()}],grayscale:[{grayscale:["",O,T,E]}],"hue-rotate":[{"hue-rotate":[O,T,E]}],invert:[{invert:["",O,T,E]}],saturate:[{saturate:[O,T,E]}],sepia:[{sepia:["",O,T,E]}],"backdrop-filter":[{"backdrop-filter":["","none",T,E]}],"backdrop-blur":[{"backdrop-blur":Sn()}],"backdrop-brightness":[{"backdrop-brightness":[O,T,E]}],"backdrop-contrast":[{"backdrop-contrast":[O,T,E]}],"backdrop-grayscale":[{"backdrop-grayscale":["",O,T,E]}],"backdrop-hue-rotate":[{"backdrop-hue-rotate":[O,T,E]}],"backdrop-invert":[{"backdrop-invert":["",O,T,E]}],"backdrop-opacity":[{"backdrop-opacity":[O,T,E]}],"backdrop-saturate":[{"backdrop-saturate":[O,T,E]}],"backdrop-sepia":[{"backdrop-sepia":["",O,T,E]}],"border-collapse":[{border:["collapse","separate"]}],"border-spacing":[{"border-spacing":_()}],"border-spacing-x":[{"border-spacing-x":_()}],"border-spacing-y":[{"border-spacing-y":_()}],"table-layout":[{table:["auto","fixed"]}],caption:[{caption:["top","bottom"]}],transition:[{transition:["","all","colors","opacity","shadow","transform","none",T,E]}],"transition-behavior":[{transition:["normal","discrete"]}],duration:[{duration:[O,"initial",T,E]}],ease:[{ease:["linear","initial",S,T,E]}],delay:[{delay:[O,T,E]}],animate:[{animate:["none",w,T,E]}],backface:[{backface:["hidden","visible"]}],perspective:[{perspective:[x,T,E]}],"perspective-origin":[{"perspective-origin":F()}],rotate:[{rotate:ii()}],"rotate-x":[{"rotate-x":ii()}],"rotate-y":[{"rotate-y":ii()}],"rotate-z":[{"rotate-z":ii()}],scale:[{scale:si()}],"scale-x":[{"scale-x":si()}],"scale-y":[{"scale-y":si()}],"scale-z":[{"scale-z":si()}],"scale-3d":["scale-3d"],skew:[{skew:rs()}],"skew-x":[{"skew-x":rs()}],"skew-y":[{"skew-y":rs()}],transform:[{transform:[T,E,"","none","gpu","cpu"]}],"transform-origin":[{origin:F()}],"transform-style":[{transform:["3d","flat"]}],translate:[{translate:ni()}],"translate-x":[{"translate-x":ni()}],"translate-y":[{"translate-y":ni()}],"translate-z":[{"translate-z":ni()}],"translate-none":["translate-none"],accent:[{accent:k()}],appearance:[{appearance:["none","auto"]}],"caret-color":[{caret:k()}],"color-scheme":[{scheme:["normal","dark","light","light-dark","only-dark","only-light"]}],cursor:[{cursor:["auto","default","pointer","wait","text","move","help","not-allowed","none","context-menu","progress","cell","crosshair","vertical-text","alias","copy","no-drop","grab","grabbing","all-scroll","col-resize","row-resize","n-resize","e-resize","s-resize","w-resize","ne-resize","nw-resize","se-resize","sw-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out",T,E]}],"field-sizing":[{"field-sizing":["fixed","content"]}],"pointer-events":[{"pointer-events":["auto","none"]}],resize:[{resize:["none","","y","x"]}],"scroll-behavior":[{scroll:["auto","smooth"]}],"scroll-m":[{"scroll-m":_()}],"scroll-mx":[{"scroll-mx":_()}],"scroll-my":[{"scroll-my":_()}],"scroll-ms":[{"scroll-ms":_()}],"scroll-me":[{"scroll-me":_()}],"scroll-mt":[{"scroll-mt":_()}],"scroll-mr":[{"scroll-mr":_()}],"scroll-mb":[{"scroll-mb":_()}],"scroll-ml":[{"scroll-ml":_()}],"scroll-p":[{"scroll-p":_()}],"scroll-px":[{"scroll-px":_()}],"scroll-py":[{"scroll-py":_()}],"scroll-ps":[{"scroll-ps":_()}],"scroll-pe":[{"scroll-pe":_()}],"scroll-pt":[{"scroll-pt":_()}],"scroll-pr":[{"scroll-pr":_()}],"scroll-pb":[{"scroll-pb":_()}],"scroll-pl":[{"scroll-pl":_()}],"snap-align":[{snap:["start","end","center","align-none"]}],"snap-stop":[{snap:["normal","always"]}],"snap-type":[{snap:["none","x","y","both"]}],"snap-strictness":[{snap:["mandatory","proximity"]}],touch:[{touch:["auto","none","manipulation"]}],"touch-x":[{"touch-pan":["x","left","right"]}],"touch-y":[{"touch-pan":["y","up","down"]}],"touch-pz":["touch-pinch-zoom"],select:[{select:["none","text","all","auto"]}],"will-change":[{"will-change":["auto","scroll","contents","transform",T,E]}],fill:[{fill:["none",...k()]}],"stroke-w":[{stroke:[O,Ct,Qe,fs]}],stroke:[{stroke:["none",...k()]}],"forced-color-adjust":[{"forced-color-adjust":["auto","none"]}]},conflictingClassGroups:{overflow:["overflow-x","overflow-y"],overscroll:["overscroll-x","overscroll-y"],inset:["inset-x","inset-y","start","end","top","right","bottom","left"],"inset-x":["right","left"],"inset-y":["top","bottom"],flex:["basis","grow","shrink"],gap:["gap-x","gap-y"],p:["px","py","ps","pe","pt","pr","pb","pl"],px:["pr","pl"],py:["pt","pb"],m:["mx","my","ms","me","mt","mr","mb","ml"],mx:["mr","ml"],my:["mt","mb"],size:["w","h"],"font-size":["leading"],"fvn-normal":["fvn-ordinal","fvn-slashed-zero","fvn-figure","fvn-spacing","fvn-fraction"],"fvn-ordinal":["fvn-normal"],"fvn-slashed-zero":["fvn-normal"],"fvn-figure":["fvn-normal"],"fvn-spacing":["fvn-normal"],"fvn-fraction":["fvn-normal"],"line-clamp":["display","overflow"],rounded:["rounded-s","rounded-e","rounded-t","rounded-r","rounded-b","rounded-l","rounded-ss","rounded-se","rounded-ee","rounded-es","rounded-tl","rounded-tr","rounded-br","rounded-bl"],"rounded-s":["rounded-ss","rounded-es"],"rounded-e":["rounded-se","rounded-ee"],"rounded-t":["rounded-tl","rounded-tr"],"rounded-r":["rounded-tr","rounded-br"],"rounded-b":["rounded-br","rounded-bl"],"rounded-l":["rounded-tl","rounded-bl"],"border-spacing":["border-spacing-x","border-spacing-y"],"border-w":["border-w-x","border-w-y","border-w-s","border-w-e","border-w-t","border-w-r","border-w-b","border-w-l"],"border-w-x":["border-w-r","border-w-l"],"border-w-y":["border-w-t","border-w-b"],"border-color":["border-color-x","border-color-y","border-color-s","border-color-e","border-color-t","border-color-r","border-color-b","border-color-l"],"border-color-x":["border-color-r","border-color-l"],"border-color-y":["border-color-t","border-color-b"],translate:["translate-x","translate-y","translate-none"],"translate-none":["translate","translate-x","translate-y","translate-z"],"scroll-m":["scroll-mx","scroll-my","scroll-ms","scroll-me","scroll-mt","scroll-mr","scroll-mb","scroll-ml"],"scroll-mx":["scroll-mr","scroll-ml"],"scroll-my":["scroll-mt","scroll-mb"],"scroll-p":["scroll-px","scroll-py","scroll-ps","scroll-pe","scroll-pt","scroll-pr","scroll-pb","scroll-pl"],"scroll-px":["scroll-pr","scroll-pl"],"scroll-py":["scroll-pt","scroll-pb"],touch:["touch-x","touch-y","touch-pz"],"touch-x":["touch"],"touch-y":["touch"],"touch-pz":["touch"]},conflictingClassGroupModifiers:{"font-size":["leading"]},orderSensitiveModifiers:["*","**","after","backdrop","before","details-content","file","first-letter","first-line","marker","placeholder","selection"]}},Vl=wl(Gl);function It(...e){return Vl(Ur(e))}var Wl=q("<div>");const Hl=e=>(()=>{var t=Wl();return z(t,()=>e.logMessage.type==="error"?"Error: ":"Warning: ",null),z(t,()=>e.logMessage.message,null),Xe(()=>Tr(t,It("p-2 border rounded-xl ",e.logMessage.type==="error"?"bg-red-100 border-red-400 text-red-700":"bg-yellow-100 border-yellow-400 text-yellow-700"))),t})();var ql=q('<li class="list-disc py-1 px-2 ml-4 w-fit rounded-xl"><b class=font-bold></b> <br>'),jl=q("<p>This tool prepares a <a href=https://takeout.google.com/ class=underline>Google Photos</a> export for easy re-import into other tools. The main features are:"),Xl=q("<ul>"),Yl=q("<p>It mainly was developed to be used for importing into <a href=https://ente.io class=underline>Ente Photos</a>. <br>It is not developed, nor endorsed by Ente nor Google."),Kl=q("<p>Checkout the <a href=TODO class=underline>Readme</a> for more details.");const li=e=>(()=>{var t=ql(),i=t.firstChild,s=i.nextSibling;return s.nextSibling,z(i,()=>e.title),z(t,()=>e.children,null),t})(),Jl=()=>[jl(),(()=>{var e=Xl();return z(e,g(li,{title:"No files leave your device",children:"Works without any of your files being uploaded to any server."}),null),z(e,g(li,{title:"Single folder structure",children:"Combines multiple Google Photo takeout .zip files into a single folder structure. With each album being a single folder."}),null),z(e,g(li,{title:"Duplicate file name resolution",children:"File duplication suffixes, like (1) (2), are replaced with _1 _2 suffixes. Including metadata files, and live video counter parts. (This avoids some matching issues where live photos might be matched with an incorrect video, or incorrect metadata)."}),null),z(e,g(li,{title:"Live Photos conflicts are resolved",children:"Using a bunch of tools (like exiftool) to extract and match them by their creation date."}),null),e})(),Yl(),Kl()];function Mr(e){return e.name===".DS_Store"||e.name==="Thumbs.db"||e.name===".dtrash"}async function Zl(e){const t=[];for await(const i of e.values())i.kind==="directory"&&!Mr(i)&&t.push(i);return t}async function Ql(e){async function t(i,s){const n=[];let r=!1;for await(const a of s.values())if(!Mr(a))if(a.kind==="directory"){const o=await t([...i,s],a);n.push(...o)}else r||(r=!0,n.push({handle:s,parents:i}));return n}return Promise.all(e.map(async i=>{const s=await t([],i);return{takeoutFolder:i,albums:s}}))}async function ed(e){const t=await Ql(e);return Map.groupBy(t.flatMap(i=>i.albums),i=>i.handle.name)}var td=`use strict;use warnings;require 5.004;my$version='13.30';$^W=1;my$exePath;BEGIN {$exePath=@ARGV && lc($ARGV[0])eq '-xpath' && shift()? $^X : $0;my$exeDir=($exePath =~ /(.*)[\\\\\\/]/)? $1 : '.';my$incDir=($0 =~ /(.*)[\\\\\\/]/)? "$1/lib" : './lib';if (-l $0){my$lnk=eval {readlink $0};if (defined$lnk){my$lnkDir=($lnk =~ /(.*)[\\\\\\/]/)? $1 : '.';$exeDir=(($lnk =~ m(^/))? '' : $exeDir .'/').$lnkDir;$incDir="$exeDir/lib"}}$Image::ExifTool::exeDir=$exeDir;unshift@INC,$incDir;while (@ARGV and lc($ARGV[0])eq '-config'){shift;push@Image::ExifTool::configFiles,shift}}use Image::ExifTool qw{:Public};sub SigInt();sub SigCont();sub Cleanup();sub GetImageInfo($$);sub SetImageInfo($$$);sub DoHardLink($$$$$);sub CleanXML($);sub EncodeXML($);sub FormatXML($$$);sub EscapeJSON($;$);sub FormatJSON($$$;$);sub PrintCSV(;$);sub AddGroups($$$$);sub ConvertBinary($);sub IsEqual($$);sub Printable($);sub LengthUTF8($);sub Infile($;$);sub AddSetTagsFile($;$);sub Warning($$);sub DoSetFromFile($$$);sub CleanFilename($);sub HasWildcards($);sub SetWindowTitle($);sub ProcessFiles($;$);sub ScanDir($$;$);sub FindFileWindows($$);sub FileNotFound($);sub PreserveTime();sub AbsPath($);sub MyConvertFileName($$);sub SuggestedExtension($$$);sub LoadPrintFormat($;$);sub FilenameSPrintf($;$@);sub NextUnusedFilename($;$);sub CreateDirectory($);sub OpenOutputFile($;@);sub AcceptFile($);sub SlurpFile($$);sub FilterArgfileLine($);sub ReadStayOpen($);sub Progress($$);sub PrintTagList($@);sub PrintErrors($$$);$SIG{INT}='SigInt';$SIG{CONT}='SigCont';END {Cleanup()}my@commonArgs;my@condition;my@csvFiles;my@csvTags;my@delFiles;my@dynamicFiles;my@efile;my@exclude;my (@echo3,@echo4);my@files;my@moreArgs;my@newValues;my@requestTags;my@srcFmt;my@tags;my%altFile;my%appended;my%countLink;my%created;my%csvTags;my%database;my%filterExt;my%ignore;my$ignoreHidden;my%outComma;my%outTrailer;my%preserveTime;my%printFmt;my%seqFileDir;my%setTags;my%setTagsList;my%usedFileName;my%utf8FileName;my%warnedOnce;my%wext;my$allGroup;my$altEnc;my$argFormat;my$binaryOutput;my$binaryStdout;my$binSep;my$binTerm;my$comma;my$count;my$countBad;my$countBadCr;my$countBadWr;my$countCopyWr;my$countDir;my$countFailed;my$countGoodCr;my$countGoodWr;my$countNewDir;my$countSameWr;my$critical;my$csv;my$csvAdd;my$csvDelim;my$csvSaveCount;my$deleteOrig;my$diff;my$disableOutput;my$doSetFileName;my$doUnzip;my ($end,$endDir,%endDir);my$escapeC;my$escapeHTML;my$evalWarning;my$executeID;my$failCondition;my$fastCondition;my$fileHeader;my$fileTrailer;my$filtered;my$filterFlag;my$fixLen;my$forcePrint;my$geoOnly;my$helped;my$html;my$interrupted;my$isBinary;my$isWriting;my$joinLists;my$json;my$langOpt;my$listDir;my$listItem;my$listSep;my$mt;my$multiFile;my$noBinary;my$outFormat;my$outOpt;my$overwriteOrig;my$pause;my$plot;my$preserveTime;my$progress;my$progressCount;my$progressIncr;my$progressMax;my$progressNext;my$progStr;my$quiet;my$rafStdin;my$recurse;my$rtnVal;my$rtnValPrev;my$saveCount;my$scanWritable;my$sectHeader;my$sectTrailer;my$seqFileDir;my$seqFileNum;my$setCharset;my$showGroup;my$showTagID;my$stayOpenBuff='';my$stayOpenFile;my$structOpt;my$tabFormat;my$tagOut;my$textOut;my$textOut2;my$textOverwrite;my$tmpFile;my$tmpText;my$validFile;my$verbose;my$vout;my$windowTitle;my%wroteHEAD;my$xml;my$stayOpen=0;my$rtnValApp=0;my$curTitle='';my$isCRLF={MSWin32=>1,os2=>1,dos=>1 }->{$^O};my%jsonChar=('"'=>'"','\\\\'=>'\\\\',"\\t"=>'t',"\\n"=>'n',"\\r"=>'r');my%escC=("\\n"=>'\\n',"\\r"=>'\\r',"\\t"=>'\\t','\\\\'=>'\\\\\\\\');my%unescC=(a=>"\\a",b=>"\\b",f=>"\\f",n=>"\\n",r=>"\\r",t=>"\\t",0=>"\\0",'\\\\'=>'\\\\');my%optArgs=('-tagsfromfile'=>1,'-addtagsfromfile'=>1,'-alltagsfromfile'=>1,'-@'=>1,'-api'=>1,'-c'=>1,'-coordformat'=>1,'-charset'=>0,'-config'=>1,'-csvdelim'=>1,'-d'=>1,'-dateformat'=>1,'-D'=>0,'-diff'=>1,'-echo'=>1,'-echo#'=>1,'-efile'=>1,'-efile#'=>1,'-efile!'=>1,'-efile#!'=>1,'-ext'=>1,'--ext'=>1,'-ext+'=>1,'--ext+'=>1,'-extension'=>1,'--extension'=>1,'-extension+'=>1,'--extension+'=>1,'-fileorder'=>1,'-fileorder#'=>1,'-file#'=>1,'-geotag'=>1,'-globaltimeshift'=>1,'-i'=>1,'-ignore'=>1,'-if'=>1,'-if#'=>1,'-lang'=>0,'-listitem'=>1,'-o'=>1,'-out'=>1,'-p'=>1,'-printformat'=>1,'-p-'=>1,'-printformat-'=>1,'-P'=>0,'-password'=>1,'-require'=>1,'-sep'=>1,'-separator'=>1,'-srcfile'=>1,'-stay_open'=>1,'-use'=>1,'-userparam'=>1,'-w'=>1,'-w!'=>1,'-w+'=>1,'-w+!'=>1,'-w!+'=>1,'-textout'=>1,'-textout!'=>1,'-textout+'=>1,'-textout+!'=>1,'-textout!+'=>1,'-tagout'=>1,'-tagout!'=>1,'-tagout+'=>1,'-tagout+!'=>1,'-tagout!+'=>1,'-wext'=>1,'-wm'=>1,'-writemode'=>1,'-x'=>1,'-exclude'=>1,'-X'=>0,);my@recommends=qw(Archive::Zip Compress::Zlib Digest::MD5 Digest::SHA IO::Compress::Bzip2 POSIX::strptime Time::Local Unicode::LineBreak Compress::Raw::Lzma IO::Compress::RawDeflate IO::Uncompress::RawInflate IO::Compress::Brotli IO::Uncompress::Brotli Win32::API Win32::FindFile Win32API::File);my%altRecommends=('POSIX::strptime'=>'Time::Piece',);my%unescapeChar=('t'=>"\\t",'n'=>"\\n",'r'=>"\\r");sub Image::ExifTool::EndDir() {return$endDir=1}sub Image::ExifTool::End() {return$end=1}sub Exit {if ($pause){if (eval {require Term::ReadKey}){print STDERR "-- press any key --";Term::ReadKey::ReadMode('cbreak');Term::ReadKey::ReadKey(0);Term::ReadKey::ReadMode(0);print STDERR "\\b \\b" x 20}else {print STDERR "-- press RETURN --\\n";<STDIN>}}exit shift}sub Warn {if ($quiet < 2 or $_[0]=~ /^Error/){my$oldWarn=$SIG{'__WARN__'};delete$SIG{'__WARN__'};warn(@_);$SIG{'__WARN__'}=$oldWarn if defined$oldWarn}}sub Error {Warn @_;$rtnVal=1}sub WarnOnce($) {Warn(@_)and $warnedOnce{$_[0]}=1 unless$warnedOnce{$_[0]}}sub SigInt() {$critical and $interrupted=1,return;Cleanup();exit 1}sub SigCont() {}sub Cleanup() {$mt->Unlink($tmpFile)if defined$tmpFile;$mt->Unlink($tmpText)if defined$tmpText;undef$tmpFile;undef$tmpText;PreserveTime()if%preserveTime;SetWindowTitle('')}if (grep /^-common_args$/i,@ARGV){my (@newArgs,$common,$end);for (@ARGV){if (/^-common_args$/i and not $end){$common=1}elsif ($common){push@commonArgs,$_}else {$end=1 if $_ eq '--';push@newArgs,$_}}@ARGV=@newArgs if$common}Command: for (;;){if (@echo3){my$str=join("\\n",@echo3)."\\n";$str =~ s/\\$\\{status\\}/$rtnVal/ig;print STDOUT$str}if (@echo4){my$str=join("\\n",@echo4)."\\n";$str =~ s/\\$\\{status\\}/$rtnVal/ig;print STDERR$str}$rafStdin->Close()if$rafStdin;undef$rafStdin;$rtnValPrev=$rtnVal;$rtnValApp=$rtnVal if$rtnVal;last unless@ARGV or not defined$rtnVal or $stayOpen >= 2 or @commonArgs;if ($binaryStdout){binmode(STDOUT,':crlf')if $] >= 5.006 and $isCRLF;$binaryStdout=0}if ($stayOpen >= 2){if ($quiet and not defined$executeID){eval {require IO::Handle}and STDERR->flush(),STDOUT->flush()}else {eval {require IO::Handle}and STDERR->flush();my$id=defined$executeID ? $executeID : '';my$save=$|;$|=1;print "{ready$id}\\n";$|=$save}}undef@condition;undef@csvFiles;undef@csvTags;undef@delFiles;undef@dynamicFiles;undef@echo3;undef@echo4;undef@efile;undef@exclude;undef@files;undef@newValues;undef@srcFmt;undef@tags;undef%appended;undef%countLink;undef%created;undef%csvTags;undef%database;undef%endDir;undef%filterExt;undef%ignore;undef%outComma;undef%outTrailer;undef%preserveTime;undef%printFmt;undef%seqFileDir;undef%setTags;undef%setTagsList;undef%usedFileName;undef%utf8FileName;undef%warnedOnce;undef%wext;undef$allGroup;undef$altEnc;undef$argFormat;undef$binaryOutput;undef$binSep;undef$binTerm;undef$comma;undef$csv;undef$csvAdd;undef$deleteOrig;undef$diff;undef$disableOutput;undef$doSetFileName;undef$doUnzip;undef$end;undef$endDir;undef$escapeHTML;undef$escapeC;undef$evalWarning;undef$executeID;undef$failCondition;undef$fastCondition;undef$fileHeader;undef$filtered;undef$fixLen;undef$forcePrint;undef$geoOnly;undef$ignoreHidden;undef$joinLists;undef$langOpt;undef$listItem;undef$multiFile;undef$noBinary;undef$outOpt;undef$preserveTime;undef$progress;undef$progressCount;undef$progressIncr;undef$progressMax;undef$progressNext;undef$recurse;undef$scanWritable;undef$sectHeader;undef$setCharset;undef$showGroup;undef$showTagID;undef$structOpt;undef$tagOut;undef$textOut;undef$textOverwrite;undef$tmpFile;undef$tmpText;undef$validFile;undef$verbose;undef$windowTitle;$count=0;$countBad=0;$countBadCr=0;$countBadWr=0;$countCopyWr=0;$countDir=0;$countFailed=0;$countGoodCr=0;$countGoodWr=0;$countNewDir=0;$countSameWr=0;$csvDelim=',';$csvSaveCount=0;$fileTrailer='';$filterFlag=0;$html=0;$isWriting=0;$json=0;$listSep=', ';$outFormat=0;$overwriteOrig=0;$progStr='';$quiet=0;$rtnVal=0;$saveCount=0;$sectTrailer='';$seqFileDir=0;$seqFileNum=0;$tabFormat=0;$vout=\\*STDOUT;$xml=0;my@fileOrder;my$fileOrderFast;my$addGeotime;my$doGlob;my$endOfOpts;my$escapeXML;my$setTagsFile;my$sortOpt;my$srcStdin;my$useMWG;my ($argsLeft,@nextPass,$badCmd);my$pass=0;if ($^O eq 'MSWin32' and eval {require File::Glob}){import File::Glob qw(:globally :nocase);$doGlob=1}$mt=Image::ExifTool->new;$mt->Options(Duplicates=>0)unless%Image::ExifTool::UserDefined::Options and defined$Image::ExifTool::UserDefined::Options{Duplicates};$joinLists=1 if defined$mt->Options('List')and not $mt->Options('List');if (not $preserveTime and $^O eq 'MSWin32'){$preserveTime=2 if eval {require Win32::API}and eval {require Win32API::File}}if (@Image::ExifTool::UserDefined::Arguments){unshift@ARGV,@Image::ExifTool::UserDefined::Arguments}if ($version ne $Image::ExifTool::VERSION){Warn "Application version $version does not match Image::ExifTool library version $Image::ExifTool::VERSION\\n"}for (;;){if (not @ARGV or ($ARGV[0]=~ /^(-|\\xe2\\x88\\x92)execute(\\d+)?$/i and not $endOfOpts)){if (@ARGV){$executeID=$2;$helped=1;$badCmd and shift,$rtnVal=1,next Command}elsif ($stayOpen >= 2){ReadStayOpen(\\@ARGV);next}elsif ($badCmd){undef@commonArgs;$rtnVal=1;next Command}if ($pass==0){if (@commonArgs and not defined$argsLeft){$argsLeft=scalar(@ARGV)+ scalar(@moreArgs);unshift@ARGV,@commonArgs;undef@commonArgs unless$argsLeft;next}if (defined$argsLeft and $argsLeft < scalar(@ARGV)+ scalar(@moreArgs)){Warn "Ignoring -common_args from $ARGV[0] onwards to avoid infinite recursion\\n";while ($argsLeft < scalar(@ARGV)+ scalar(@moreArgs)){@ARGV and shift(@ARGV),next;shift@moreArgs}}$useMWG=1 if not $useMWG and grep /^([--_0-9A-Z]+:)*1?mwg:/i,@tags,@requestTags;if ($useMWG){require Image::ExifTool::MWG;Image::ExifTool::MWG::Load()}if (defined$forcePrint){unless (defined$mt->Options('MissingTagValue')){$mt->Options(MissingTagValue=>'-')}$forcePrint=$mt->Options('MissingTagValue')}}if (@nextPass){unshift@ARGV,@nextPass;undef@nextPass;undef$endOfOpts;++$pass;next}@ARGV and shift;last}$_=shift;next if$badCmd;if (not $endOfOpts and s/^(-|\\xe2\\x88\\x92)//){s/^\\xe2\\x88\\x92/-/;if ($_ eq '-'){$pass or push@nextPass,'--';$endOfOpts=1;next}my$a=lc $_;if (/^list([wfrdx]|wf|g(\\d*)|geo)?$/i){$pass or push@nextPass,"-$_";my$type=lc($1 || '');if (not $type or $type eq 'w' or $type eq 'x'){my$group;if ($ARGV[0]and $ARGV[0]=~ /^(-|\\xe2\\x88\\x92)(.+):(all|\\*)$/i){if ($pass==0){$useMWG=1 if lc($2)eq 'mwg';push@nextPass,shift;next}$group=$2;shift;$group =~ /IFD/i and Warn("Can't list tags for specific IFD\\n"),$helped=1,next;$group =~ /^(all|\\*)$/ and undef$group}else {$pass or next}$helped=1;if ($type eq 'x'){require Image::ExifTool::TagInfoXML;my%opts;$opts{Flags}=1 if defined$forcePrint;$opts{NoDesc}=1 if$outFormat > 0;$opts{Lang}=$langOpt;Image::ExifTool::TagInfoXML::Write(undef,$group,%opts);next}my$wr=($type eq 'w');my$msg=($wr ? 'Writable' : 'Available').($group ? " $group" : '').' tags';PrintTagList($msg,$wr ? GetWritableTags($group): GetAllTags($group));next if$group or $wr;my@tagList=GetShortcuts();PrintTagList('Command-line shortcuts',@tagList)if@tagList;next}$pass or next;$helped=1;if ($type eq 'wf'){my@wf;CanWrite($_)and push@wf,$_ foreach GetFileType();PrintTagList('Writable file extensions',@wf)}elsif ($type eq 'f'){PrintTagList('Supported file extensions',GetFileType())}elsif ($type eq 'r'){PrintTagList('Recognized file extensions',GetFileType(undef,0))}elsif ($type eq 'd'){PrintTagList('Deletable groups',GetDeleteGroups())}elsif ($type eq 'geo'){require Image::ExifTool::Geolocation;my ($i,$entry);print "Geolocation database:\\n" unless$quiet;my$isAlt=$mt->Options('GeolocAltNames')? ',AltNames' : '';$isAlt='' if$isAlt and not Image::ExifTool::Geolocation::ReadAltNames();print "City,Region,Subregion,CountryCode,Country,TimeZone,FeatureCode,Population,Latitude,Longitude$isAlt\\n";Image::ExifTool::Geolocation::SortDatabase('City')if$sortOpt;my$minPop=$mt->Options('GeolocMinPop');my$feature=$mt->Options('GeolocFeature')|| '';my$neg=$feature =~ s/^-//;my%fcodes=map {lc($_)=>1}split /\\s*,\\s*/,$feature;my@isUTF8=(0,1,2,4);push@isUTF8,10 if$isAlt;for ($i=0;;++$i){my@entry=Image::ExifTool::Geolocation::GetEntry($i,$langOpt,1)or last;$#entry=9;next if$minPop and $entry[7]< $minPop;next if%fcodes and $neg ? $fcodes{lc$entry[6]}: not $fcodes{lc$entry[6]};push@entry,Image::ExifTool::Geolocation::GetAltNames($i,1)if$isAlt;$_=defined $_ ? $mt->Decode($_,'UTF8'): '' foreach@entry[@isUTF8];pop@entry if$isAlt and not $entry[10];print join(',',@entry),"\\n"}}else {my$family=$2 || 0;PrintTagList("Groups in family $family",$mt->GetAllGroups($family))}next}if ($a eq 'ver'){$pass or push(@nextPass,'-ver'),next;my$libVer=$Image::ExifTool::VERSION;my$str=$libVer eq $version ? '' : " [Warning: Library version is $libVer]";if ($verbose){print "ExifTool version $version$str$Image::ExifTool::RELEASE\\n";printf "Perl version %s%s\\n",$],(defined \${^UNICODE} ? " (-C\${^UNICODE})" : '');print "Platform: $^O\\n";if ($verbose > 8){print "Current Dir: " .Cwd::getcwd()."\\n" if (eval {require Cwd});print "Script Name: $0\\n";print "Exe Name:    $^X\\n";print "Exe Dir:     $Image::ExifTool::exeDir\\n";print "Exe Path:    $exePath\\n"}print "Optional libraries:\\n";for (@recommends){next if /^Win32/ and $^O ne 'MSWin32';my$ver=eval "require $_ and \\$\${_}::VERSION";my$alt=$altRecommends{$_};$ver=eval "require $alt and \\$\${alt}::VERSION" and $_=$alt if not $ver and $alt;printf "  %-28s %s\\n",$_,$ver || '(not installed)'}if ($verbose > 1){print "Include directories:\\n";ref $_ or print "  $_\\n" foreach@INC}}else {print "$version$str$Image::ExifTool::RELEASE\\n"}$helped=1;next}if (/^(all|add)?tagsfromfile(=.*)?$/i){$setTagsFile=$2 ? substr($2,1): (@ARGV ? shift : '');if ($setTagsFile eq ''){Error("File must be specified for -tagsFromFile option\\n");$badCmd=1;next}AddSetTagsFile($setTagsFile,{Replace=>($1 and lc($1)eq 'add')? 0 : 1 });next}if ($a eq '@'){my$argFile=shift or Error("Expecting filename for -\\@ option\\n"),$badCmd=1,next;if ($stayOpen==1){@moreArgs=@ARGV;undef@ARGV}elsif ($stayOpen==3){if ($stayOpenFile and $stayOpenFile ne '-' and $argFile eq $stayOpenFile){$stayOpen=2;Warn "Ignoring request to switch to the same -stay_open ARGFILE ($argFile)\\n";next}close STAYOPEN;$stayOpen=1}my$fp=($stayOpen==1 ? \\*STAYOPEN : \\*ARGFILE);unless ($mt->Open($fp,$argFile)){unless ($argFile !~ /^\\// and $mt->Open($fp,"$Image::ExifTool::exeDir/$argFile")){Error "Error opening arg file $argFile\\n";$badCmd=1;next}}if ($stayOpen==1){$stayOpenFile=$argFile;$stayOpenBuff='';$stayOpen=2;$helped=1;ReadStayOpen(\\@ARGV);next}my (@newArgs,$didBOM);for (<ARGFILE>){unless ($didBOM){s/^\\xef\\xbb\\xbf//;$didBOM=1}$_=FilterArgfileLine($_);push@newArgs,$_ if defined $_}close ARGFILE;unshift@ARGV,@newArgs;next}/^(-?)(a|duplicates)$/i and $mt->Options(Duplicates=>($1 ? 0 : 1)),next;if ($a eq 'api'){my$opt=shift;if (defined$opt and length$opt){my$val=($opt =~ s/=(.*)//s)? $1 : 1;$val=undef unless$opt =~ s/\\^$// or length$val;$mt->Options($opt=>$val)}else {print "Available API Options:\\n";my$availableOptions=Image::ExifTool::AvailableOptions();$$_[3]or printf("  %-17s - %s\\n",$$_[0],$$_[2])foreach @$availableOptions;$helped=1}next}/^arg(s|format)$/i and $argFormat=1,next;if (/^(-?)b(inary)?$/i){($binaryOutput,$noBinary)=$1 ? (undef,1): (1,undef);$mt->Options(Binary=>$binaryOutput,NoPDFList=>$binaryOutput);next}if (/^c(oordFormat)?$/i){my$fmt=shift;$fmt or Error("Expecting coordinate format for -c option\\n"),$badCmd=1,next;$mt->Options('CoordFormat',$fmt);next}if ($a eq 'charset'){my$charset=(@ARGV and $ARGV[0]!~ /^(-|\\xe2\\x88\\x92)/)? shift : undef;if (not $charset){$pass or push(@nextPass,'-charset'),next;my%charsets;$charsets{$_}=1 foreach values%Image::ExifTool::charsetName;PrintTagList('Available character sets',sort keys%charsets);$helped=1}elsif ($charset !~ s/^(\\w+)=// or lc($1)eq 'exiftool'){{local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};undef$evalWarning;$mt->Options(Charset=>$charset)}if ($evalWarning){Warn$evalWarning}else {$setCharset=$mt->Options('Charset')}}else {my$type={id3=>'ID3',iptc=>'IPTC',exif=>'EXIF',filename=>'FileName',photoshop=>'Photoshop',quicktime=>'QuickTime',riff=>'RIFF' }->{lc $1};$type or Warn("Unknown type for -charset option: $1\\n"),next;$mt->Options("Charset$type"=>$charset)}next}/^config$/i and Warn("Ignored -config option (not first on command line)\\n"),shift,next;if (/^csv(\\+?=.*)?$/i){my$csvFile=$1;unless ($pass){push@nextPass,"-$_";if ($csvFile){push@newValues,{SaveCount=>++$saveCount };$csvSaveCount=$saveCount}next}if ($csvFile){$csvFile =~ s/^(\\+?=)//;$csvAdd=2 if $1 eq '+=';$vout=\\*STDERR if$srcStdin;$verbose and print$vout "Reading CSV file $csvFile\\n";my$msg;if ($mt->Open(\\*CSVFILE,$csvFile)){binmode CSVFILE;require Image::ExifTool::Import;$msg=Image::ExifTool::Import::ReadCSV(\\*CSVFILE,\\%database,$forcePrint,$csvDelim);close(CSVFILE)}else {$msg="Error opening CSV file '\${csvFile}'"}$msg and Warn("$msg\\n");$isWriting=1}$csv='CSV';next}if (/^csvdelim$/i){$csvDelim=shift;defined$csvDelim or Error("Expecting argument for -csvDelim option\\n"),$badCmd=1,next;$csvDelim =~ /"/ and Error("CSV delimiter can not contain a double quote\\n"),$badCmd=1,next;my%unescape=('t'=>"\\t",'n'=>"\\n",'r'=>"\\r",'\\\\'=>'\\\\');$csvDelim =~ s/\\\\(.)/$unescape{$1}||"\\\\$1"/sge;$mt->Options(CSVDelim=>$csvDelim);next}if (/^d$/ or $a eq 'dateformat'){my$fmt=shift;$fmt or Error("Expecting date format for -d option\\n"),$badCmd=1,next;$mt->Options('DateFormat',$fmt);next}(/^D$/ or $a eq 'decimal')and $showTagID='D',next;if (/^diff$/i){$diff=shift;defined$diff or Error("Expecting file name for -$_ option\\n"),$badCmd=1;next}/^delete_original(!?)$/i and $deleteOrig=($1 ? 2 : 1),next;/^list_dir$/i and $listDir=1,next;(/^e$/ or $a eq '-composite')and $mt->Options(Composite=>0),next;(/^-e$/ or $a eq 'composite')and $mt->Options(Composite=>1),next;(/^E$/ or $a eq 'escapehtml')and require Image::ExifTool::HTML and $escapeHTML=1,next;($a eq 'ec' or $a eq 'escapec')and $escapeC=1,next;($a eq 'ex' or $a eq 'escapexml')and $escapeXML=1,next;if (/^echo(\\d)?$/i){my$n=$1 || 1;my$arg=shift;next unless defined$arg;$n > 4 and Warn("Invalid -echo number\\n"),next;if ($n > 2){$n==3 ? push(@echo3,$arg): push(@echo4,$arg)}else {print {$n==2 ? \\*STDERR : \\*STDOUT}$arg,"\\n"}$helped=1;next}if (/^(ee|extractembedded)(\\d*)$/i){$mt->Options(ExtractEmbedded=>$2 || 1);$mt->Options(Duplicates=>1);next}if (/^efile(\\d+)?(!)?$/i){my$arg=shift;defined$arg or Error("Expecting file name for -$_ option\\n"),$badCmd=1,next;$efile[0]=$arg if not $1 or $1 & 0x01;$efile[1]=$arg if $1 and $1 & 0x02;$efile[2]=$arg if $1 and $1 & 0x04;$efile[3]=$arg if $1 and $1 & 0x08;$efile[4]=$arg if $1 and $1 & 0x016;unlink$arg if $2;next}if (/^-?ext(ension)?(\\+)?$/i){my$ext=shift;defined$ext or Error("Expecting extension for -ext option\\n"),$badCmd=1,next;my$flag=/^-/ ? 0 : ($2 ? 2 : 1);$filterFlag |= (0x01 << $flag);$ext =~ s/^\\.//;$filterExt{uc($ext)}=$flag ? 1 : 0;next}if (/^f$/ or $a eq 'forceprint'){$forcePrint=1;next}if (/^F([-+]?\\d*)$/ or /^fixbase([-+]?\\d*)$/i){$mt->Options(FixBase=>$1);next}if (/^fast(\\d*)$/i){$mt->Options(FastScan=>(length $1 ? $1 : 1));next}if (/^(file\\d+)$/i){$altFile{lc $1}=shift or Error("Expecting file name for -file option\\n"),$badCmd=1,next;next}if (/^fileorder(\\d*)$/i){push@fileOrder,shift if@ARGV;my$num=$1 || 0;$fileOrderFast=$num if not defined$fileOrderFast or $fileOrderFast > $num;next}$a eq 'globaltimeshift' and $mt->Options(GlobalTimeShift=>shift),next;if (/^(g)(roupHeadings|roupNames)?([\\d:]*)$/i){$showGroup=$3 || 0;$allGroup=($2 ? lc($2)eq 'roupnames' : $1 eq 'G');$mt->Options(SavePath=>1)if$showGroup =~ /\\b5\\b/;$mt->Options(SaveFormat=>1)if$showGroup =~ /\\b6\\b/;next}if ($a eq 'geotag'){my$trkfile=shift;unless ($pass){push@nextPass,'-geotag',$trkfile;next}$trkfile or Error("Expecting file name for -geotag option\\n"),$badCmd=1,next;if (HasWildcards($trkfile)){my@trks;if ($^O eq 'MSWin32' and eval {require Win32::FindFile}){@trks=FindFileWindows($mt,$trkfile)}elsif (eval {require File::Glob}){@trks=File::Glob::bsd_glob($trkfile)}else {@trks=glob($trkfile)}@trks or Error("No matching file found for -geotag option\\n"),$badCmd=1,next;push@newValues,'geotag='.shift(@trks)while@trks > 1;$trkfile=pop(@trks)}$_="geotag=$trkfile"}if (/^h$/ or $a eq 'htmlformat'){require Image::ExifTool::HTML;$html=$escapeHTML=1;$json=$xml=0;next}(/^H$/ or $a eq 'hex')and $showTagID='H',next;if (/^htmldump([-+]?\\d+)?$/i){$verbose=($verbose || 0)+ 1;$html=2;$mt->Options(HtmlDumpBase=>$1)if defined $1;next}if (/^i(gnore)?$/i){my$dir=shift;defined$dir or Error("Expecting directory name for -i option\\n"),$badCmd=1,next;$ignore{$dir}=1;$dir eq 'HIDDEN' and $ignoreHidden=1;next}if (/^if(\\d*)$/i){my$cond=shift;my$fast=length($1)? $1 : undef;defined$cond or Error("Expecting expression for -if option\\n"),$badCmd=1,next;if (not @condition or not defined$fast or (defined$fastCondition and $fastCondition > $fast)){$fastCondition=$fast}$cond =~ /^\\s*(not\\s*)\\$ok\\s*$/i and ($1 xor $rtnValPrev)and $failCondition=1;push@requestTags,$cond =~ /\\$\\{?((?:[-_0-9A-Z]+:)*[-_0-9A-Z?*]+)/ig;push@condition,$cond;next}if (/^j(son)?(\\+?=.*)?$/i){if ($2){unless ($pass){push@nextPass,"-$_";push@newValues,{SaveCount=>++$saveCount };$csvSaveCount=$saveCount;next}my$jsonFile=$2;$jsonFile =~ s/^(\\+?=)//;$csvAdd=2 if $1 eq '+=';$vout=\\*STDERR if$srcStdin;$verbose and print$vout "Reading JSON file $jsonFile\\n";my$chset=$mt->Options('Charset');my$msg;if ($mt->Open(\\*JSONFILE,$jsonFile)){binmode JSONFILE;require Image::ExifTool::Import;$msg=Image::ExifTool::Import::ReadJSON(\\*JSONFILE,\\%database,$forcePrint,$chset);close(JSONFILE)}else {$msg="Error opening JSON file '\${jsonFile}'"}$msg and Warn("$msg\\n");$isWriting=1;$csv='JSON'}else {$json=1;$html=$xml=0;$mt->Options(Duplicates=>1);require Image::ExifTool::XMP}next}/^(k|pause)$/i and $pause=1,next;(/^l$/ or $a eq 'long')and --$outFormat,next;(/^L$/ or $a eq 'latin')and $mt->Options(Charset=>'Latin'),next;if ($a eq 'lang'){$langOpt=(@ARGV and $ARGV[0]!~ /^(-|\\xe2\\x88\\x92)/)? shift : undef;if ($langOpt){$langOpt =~ tr/-A-Z/_a-z/;$mt->Options(Lang=>$langOpt);next if$langOpt eq $mt->Options('Lang')}else {$pass or push(@nextPass,'-lang'),next}my$langs=$quiet ? '' : "Available languages:\\n";$langs .= "  $_ - $Image::ExifTool::langName{$_}\\n" foreach@Image::ExifTool::langs;$langs =~ tr/_/-/;$langs=Image::ExifTool::HTML::EscapeHTML($langs)if$escapeHTML;$langs=$mt->Decode($langs,'UTF8');$langOpt and Error("Invalid or unsupported language '\${langOpt}'.\\n$langs"),$badCmd=1,next;print$langs;$helped=1;next}if ($a eq 'listitem'){my$li=shift;defined$li and Image::ExifTool::IsInt($li)or Warn("Expecting integer for -listItem option\\n"),next;$mt->Options(ListItem=>$li);$listItem=$li;next}/^(m|ignoreminorerrors)$/i and $mt->Options(IgnoreMinorErrors=>1),next;/^(n|-printconv)$/i and $mt->Options(PrintConv=>0),next;/^(-n|printconv)$/i and $mt->Options(PrintConv=>1),next;$a eq 'nop' and $helped=1,next;if (/^o(ut)?$/i){$outOpt=shift;defined$outOpt or Error("Expected output file or directory name for -o option\\n"),$badCmd=1,next;CleanFilename($outOpt);$vout=\\*STDERR if$vout =~ /^-(\\.\\w+)?$/;next}/^overwrite_original$/i and $overwriteOrig=1,next;/^overwrite_original_in_place$/i and $overwriteOrig=2,next;/^plot$/i and require Image::ExifTool::Plot and $plot=Image::ExifTool::Plot->new,next;if (/^p(-?)$/ or /^printformat(-?)$/i){my$fmt=shift;if ($pass){LoadPrintFormat($fmt,$1 || $binaryOutput);if (not $useMWG and grep /^([-_0-9A-Z]+:)*1?mwg:/i,@requestTags){$useMWG=1;require Image::ExifTool::MWG;Image::ExifTool::MWG::Load()}}else {push@nextPass,"-$_",$fmt}next}(/^P$/ or $a eq 'preserve')and $preserveTime=1,next;/^password$/i and $mt->Options(Password=>shift),next;if (/^progress(\\d*)(:.*)?$/i){$progressIncr=$1 || 1;$progressNext=0;if ($2){$windowTitle=substr $2,1;$windowTitle='ExifTool %p%%' unless length$windowTitle;$windowTitle =~ /%\\d*[bpr]/ and $progress=0 unless defined$progress}else {$progress=1;$verbose=0 unless defined$verbose}$progressCount=0;next}/^q(uiet)?$/i and ++$quiet,next;/^r(ecurse)?(\\.?)$/i and $recurse=($2 ? 2 : 1),next;if ($a eq 'require'){my$ver=shift;unless (defined$ver and Image::ExifTool::IsFloat($ver)){Error("Expecting version number for -require option\\n");$badCmd=1;next}unless ($Image::ExifTool::VERSION >= $ver){Error("Requires ExifTool version $ver or later\\n");$badCmd=1}next}/^restore_original$/i and $deleteOrig=0,next;(/^S$/ or $a eq 'veryshort')and $outFormat+=2,next;/^s(hort)?(\\d*)$/i and $outFormat=$2 eq '' ? $outFormat + 1 : $2,next;/^scanforxmp$/i and $mt->Options(ScanForXMP=>1),next;if (/^sep(arator)?$/i){my$sep=$listSep=shift;defined$listSep or Error("Expecting list item separator for -sep option\\n"),$badCmd=1,next;$sep =~ s/\\\\(.)/$unescapeChar{$1}||$1/sge;(defined$binSep ? $binTerm : $binSep)=$sep;$mt->Options(ListSep=>$listSep);$joinLists=1;my$listSplit=quotemeta$listSep;$listSplit =~ s/(\\\\ )+/\\\\s\\*/g;$listSplit='\\\\s+' if$listSplit eq '\\\\s*';$mt->Options(ListSplit=>$listSplit);next}/^(-)?sort$/i and $sortOpt=$1 ? 0 : 1,next;if ($a eq 'srcfile'){@ARGV or Warn("Expecting FMT for -srcfile option\\n"),next;push@srcFmt,shift;next}if ($a eq 'stay_open'){my$arg=shift;defined$arg or Warn("Expecting argument for -stay_open option\\n"),next;if ($arg =~ /^(1|true)$/i){if (not $stayOpen){$stayOpen=1}elsif ($stayOpen==2){$stayOpen=3}else {Warn "-stay_open already active\\n"}}elsif ($arg =~ /^(0|false)$/i){if ($stayOpen >= 2){close STAYOPEN;push@ARGV,@moreArgs;undef@moreArgs}elsif (not $stayOpen){Warn("-stay_open wasn't active\\n")}$stayOpen=0}else {Warn "Invalid argument for -stay_open\\n"}next}if (/^(-)?struct$/i){$mt->Options(Struct=>$1 ? 0 : 1);next}/^t(ab)?$/ and $tabFormat=1,next;if (/^T$/ or $a eq 'table'){$tabFormat=$forcePrint=1;$outFormat+=2;++$quiet;next}if (/^(u)(nknown(2)?)?$/i){my$inc=($3 or (not $2 and $1 eq 'U'))? 2 : 1;$mt->Options(Unknown=>$mt->Options('Unknown')+ $inc);next}if ($a eq 'use'){my$module=shift;$module or Error("Expecting module name for -use option\\n"),$badCmd=1,next;lc$module eq 'mwg' and $useMWG=1,next;$module =~ /[^\\w:]/ and Error("Invalid module name: $module\\n"),$badCmd=1,next;local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};unless (eval "require Image::ExifTool::$module" or eval "require $module" or eval "require '\${module}'"){Error("Error using module $module\\n");$badCmd=1}next}if ($a eq 'userparam'){my$opt=shift;defined$opt or Error("Expected parameter for -userParam option\\n"),$badCmd=1,next;$opt =~ /=/ or $opt .= '=1';$mt->Options(UserParam=>$opt);next}if (/^v(erbose)?(\\d*)$/i){$verbose=($2 eq '')? ($verbose || 0)+ 1 : $2;next}if (/^(w|textout|tagout)([!+]*)$/i){$textOut=shift || Warn("Expecting argument for -$_ option\\n");my ($t1,$t2)=($1,$2);$textOverwrite=0;$textOverwrite += 1 if$t2 =~ /!/;$textOverwrite += 2 if$t2 =~ /\\+/;if ($t1 ne 'W' and lc($t1)ne 'tagout'){undef$tagOut}elsif ($textOverwrite >= 2 and $textOut !~ /%[-+]?\\d*[.:]?\\d*[lu]?[tgso]/){$tagOut=0}else {$tagOut=1}next}if (/^(-?)(wext|tagoutext)$/i){my$ext=shift;defined$ext or Error("Expecting extension for -wext option\\n"),$badCmd=1,next;my$flag=1;$1 and $wext{'*'}=1,$flag=-1;$ext =~ s/^\\.//;$wext{lc$ext}=$flag;next}if ($a eq 'wm' or $a eq 'writemode'){my$wm=shift;defined$wm or Error("Expecting argument for -$_ option\\n"),$badCmd=1,next;$wm =~ /^[wcg]*$/i or Error("Invalid argument for -$_ option\\n"),$badCmd=1,next;$mt->Options(WriteMode=>$wm);next}if (/^x$/ or $a eq 'exclude'){my$tag=shift;defined$tag or Error("Expecting tag name for -x option\\n"),$badCmd=1,next;$tag =~ s/\\ball\\b/\\*/ig;if ($setTagsFile){push @{$setTags{$setTagsFile}},"-$tag"}else {push@exclude,$tag}next}(/^X$/ or $a eq 'xmlformat')and $xml=1,$html=$json=0,$mt->Options(Duplicates=>1),next;if (/^php$/i){$json=2;$html=$xml=0;$mt->Options(Duplicates=>1);next}if (/^z(ip)?$/i){$doUnzip=1;$mt->Options(Compress=>1,XMPShorthand=>1);$mt->Options(Compact=>1)unless$mt->Options('Compact');next}$_ eq '' and push(@files,'-'),$srcStdin=1,next;length $_ eq 1 and $_ ne '*' and Error("Unknown option -$_\\n"),$badCmd=1,next;if (/^[^<]+(<?)=(.*)/s){my$val=$2;if ($1 and length($val)and ($val eq '@' or not defined FilenameSPrintf($val))){push@newValues,{SaveCount=>++$saveCount }}push@newValues,$_;if (/^([-_0-9A-Z]+:)*1?mwg:/i){$useMWG=1}elsif (/^([-_0-9A-Z]+:)*(filename|directory|testname)\\b/i){$doSetFileName=1}elsif (/^([-_0-9A-Z]+:)*(geotag|geotime|geosync|geolocate)\\b/i){if (lc $2 eq 'geotime'){$addGeotime=''}else {unshift@newValues,pop@newValues;if (lc $2 eq 'geotag' and (not defined$addGeotime or $addGeotime)and length$val){$addGeotime=($1 || '').q[Geotime<\${DateTimeOriginal#;$_=$self->GetValue('SubSecDateTimeOriginal','ValueConv') || $_}]}}}}else {AddSetTagsFile($setTagsFile='@')if not $setTagsFile and /(<|>)/;if ($setTagsFile){push @{$setTags{$setTagsFile}},$_;if ($1 eq '>'){$useMWG=1 if /^(.*>\\s*)?([-_0-9A-Z]+:)*1?mwg:/si;if (/\\b(filename|directory|testname)#?$/i){$doSetFileName=1}elsif (/\\bgeotime#?$/i){$addGeotime=''}}else {$useMWG=1 if /^([^<]+<\\s*(.*\\$\\{?)?)?([-_0-9A-Z]+:)*1?mwg:/si;if (/^([-_0-9A-Z]+:)*(filename|directory|testname)\\b/i){$doSetFileName=1}elsif (/^([-_0-9A-Z]+:)*geotime\\b/i){$addGeotime=''}}}else {my$lst=s/^-// ? \\@exclude : \\@tags;Warn(qq(Invalid TAG name: "$_"\\n))unless /^([-_0-9A-Z*]+:)*([-_0-9A-Z*?]+)#?$/i;push @$lst,$_}}}else {unless ($pass){push@nextPass,$_;next}if ($doGlob and HasWildcards($_)){if ($^O eq 'MSWin32' and eval {require Win32::FindFile}){push@files,FindFileWindows($mt,$_)}else {push@files,File::Glob::bsd_glob($_)}$doGlob=2}else {push@files,$_;$srcStdin=1 if $_ eq '-'}}}$mt->Options(UserParam=>'OK=' .(not $rtnValPrev));$vout=\\*STDERR if$srcStdin and ($isWriting or @newValues);$mt->Options(TextOut=>$vout)if$vout eq \\*STDERR;if ($useMWG and not defined$mt->Options('CharsetEXIF')){$mt->Options(CharsetEXIF=>'UTF8')}if (not @files and not $outOpt and not @newValues){my$loc=$mt->Options('Geolocation');$loc and $loc ne '1' and push(@files,qq(\\@JSON:{})),$geoOnly=1}unless ((@tags and not $outOpt)or @files or @newValues or $geoOnly){if ($doGlob and $doGlob==2){Error "No matching files\\n";next}$outOpt and Error("Nothing to write\\n"),next;unless ($helped){local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};my$dummy=\\*SAVEERR;unless ($^O eq 'os2'){open SAVEERR,">&STDERR";open STDERR,'>/dev/null'}if (system('perldoc',$0)){print "Syntax:  exiftool [OPTIONS] FILE\\n\\n";print "Consult the exiftool documentation for a full list of options.\\n"}unless ($^O eq 'os2'){close STDERR;open STDERR,'>&SAVEERR'}}next}if (defined$deleteOrig and (@newValues or @tags)){if (not @newValues){my$verb=$deleteOrig ? 'deleting' : 'restoring from';Error "Can't specify tags when $verb originals\\n"}elsif ($deleteOrig){Error "Can't use -delete_original when writing.\\n";Error "Maybe you meant -overwrite_original ?\\n"}else {Error "It makes no sense to use -restore_original when writing\\n"}next}if ($overwriteOrig > 1 and $outOpt){Error "Can't overwrite in place when -o option is used\\n";next}if (($tagOut or defined$diff)and ($csv or $json or %printFmt or $tabFormat or $xml or $plot or ($verbose and $html))){my$opt=$tagOut ? '-W' : '-diff';Error "Sorry, $opt may not be combined with -csv, -htmlDump, -j, -p, -t or -X\\n";next}if ($csv and $csv eq 'CSV' and not $isWriting){$json=0;if ($textOut){$textOut2=$textOut;undef$textOut}if ($binaryOutput){$binaryOutput=0;$setCharset='default' unless defined$setCharset}if (%printFmt){Warn "The -csv option has no effect when -p is used\\n";undef$csv}require Image::ExifTool::XMP if$setCharset}if ($plot and $textOut){$textOut2=$textOut;undef$textOut}if ($textOut2){if ($textOverwrite > 1){Error "Can not append to multi-file output format\\n";undef$textOut2;next}if (not $textOverwrite and $mt->Exists($textOut2,1)){Error "Output file $textOut2 already exists\\n";undef$textOut2;next}CreateDirectory($textOut2);if ($mt->Open(\\*OUTFILE,$textOut2,'>')){close(\\*OUTFILE);unlink($textOut2)}else {Error("Error creating $textOut2\\n");undef$textOut2;next}}if ($escapeHTML or $json){$mt->Options(Charset=>'UTF8')if$json;$mt->Options(Escape=>'HTML')if$escapeHTML and not $xml}elsif ($escapeXML and not $xml){$mt->Options(Escape=>'XML')}if ($sortOpt){my$sort=($outFormat > 0 or $xml or $json or $csv or $plot)? 'Tag' : 'Descr';$mt->Options(Sort=>$sort,Sort2=>$sort)}if ($mt->Options('Struct')and not $structOpt){$structOpt=$mt->Options('Struct');require 'Image/ExifTool/XMPStruct.pl'}if ($plot){undef$joinLists;$mt->Options(List=>1);$plot->Settings($mt->Options('Plot'))}elsif ($xml){require Image::ExifTool::XMP;my$charset=$mt->Options('Charset');my%encoding=(UTF8=>'UTF-8',Latin=>'windows-1252',Latin2=>'windows-1250',Cyrillic=>'windows-1251',Greek=>'windows-1253',Turkish=>'windows-1254',Hebrew=>'windows-1255',Arabic=>'windows-1256',Baltic=>'windows-1257',Vietnam=>'windows-1258',MacRoman=>'macintosh',);unless ($encoding{$charset}){$charset='UTF8';$mt->Options(Charset=>$charset)}$fileHeader="<?xml version='1.0' encoding='$encoding{$charset}'?>\\n" ."<rdf:RDF xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'>\\n";$fileTrailer="</rdf:RDF>\\n";$joinLists=1 if$outFormat > 0;$mt->Options(List=>1)unless$joinLists;$showGroup=$allGroup=1;$binaryOutput=($outFormat > 0 ? undef : 0)if$binaryOutput;$showTagID='D' if$tabFormat and not $showTagID}elsif ($json){if ($json==1){$fileHeader='[';$fileTrailer="]\\n"}else {$fileHeader='Array(';$fileTrailer=");\\n"}if ($binaryOutput){$binaryOutput=0;require Image::ExifTool::XMP if$json==1}$mt->Options(List=>1)unless$joinLists;$showTagID='D' if$tabFormat and not $showTagID}elsif ($structOpt){$mt->Options(List=>1)}else {$joinLists=1}if ($argFormat){$outFormat=3;$allGroup=1 if defined$showGroup}if (Image::ExifTool::IsPC()){tr/\\\\/\\// foreach@files}unless (@files){unless ($outOpt){if ($doGlob and $doGlob==2){Error "No matching files\\n"}else {Error "No file specified\\n"}next}push@files,''}if ($verbose){$disableOutput=1 unless@tags or @exclude or $tagOut;undef$binaryOutput unless$tagOut;if ($html){$html=2;$mt->Options(HtmlDump=>$verbose)}else {$mt->Options(Verbose=>$verbose)unless$tagOut}}elsif (defined$verbose){require FileHandle;STDOUT->autoflush(1);STDERR->autoflush(1)}my$needSave=1;if (@newValues){if ($addGeotime){AddSetTagsFile($setTagsFile='@')unless$setTagsFile and $setTagsFile eq '@';push @{$setTags{$setTagsFile}},$addGeotime;$verbose and print$vout qq(Using default "-$addGeotime"\\n)}my%setTagsIndex;my%addDelOpt=('+'=>'AddValue','-'=>'DelValue',"\\xe2\\x88\\x92"=>'DelValue');$saveCount=0;for (@newValues){if (ref $_ eq 'HASH'){if ($$_{SaveCount}){$saveCount=$mt->SaveNewValues();$needSave=0;push@dynamicFiles,\\$csv if $$_{SaveCount}==$csvSaveCount}next}/(.*?)=(.*)/s or next;
        my ($tag, $newVal) = ($1, $2);
        $tag =~ s/\\ball\\b/\\*/ig;    # replace 'all' with '*' in tag names
        $newVal eq '' and undef $newVal unless $tag =~ s/\\^([-+]*)$/$1/;  # undefined to delete tag
        if ($tag =~ /^(All)?TagsFromFile$/i){defined$newVal or Error("Need file name for -tagsFromFile\\n"),next Command;++$isWriting;if ($newVal eq '@' or not defined FilenameSPrintf($newVal)or grep /\\bfile\\d+:/i,@{$setTags{$newVal}}){push@dynamicFiles,$newVal;next}unless ($mt->Exists($newVal)or $newVal eq '-'){Error "File '\${newVal}' does not exist for -tagsFromFile option\\n";next Command}my$setTags=$setTags{$newVal};if ($setTagsList{$newVal}){my$i=$setTagsIndex{$newVal}|| 0;$setTagsIndex{$newVal}=$i + 1;$setTags=$setTagsList{$newVal}[$i]if$setTagsList{$newVal}[$i]}unless (DoSetFromFile($mt,$newVal,$setTags)){$rtnVal=1;next Command}$needSave=1;next}my%opts=(Shift=>0);$opts{Protected}=1 unless$tag =~ /[?*]/;if ($tag =~ s/<// and defined$newVal){if (defined FilenameSPrintf($newVal)){SlurpFile($newVal,\\$newVal)or next}else {$tag =~ s/([-+]|\\xe2\\x88\\x92)$// and $opts{$addDelOpt{$1}}=1;my$result=Image::ExifTool::IsWritable($tag);if ($result){$opts{ProtectSaved}=$saveCount;push@dynamicFiles,[$tag,$newVal,\\%opts ];++$isWriting}elsif (defined$result){Warn "Tag '\${tag}' is not writable\\n"}else {Warn "Tag '\${tag}' does not exist\\n"}next}}if ($tag =~ s/([-+]|\\xe2\\x88\\x92)$//){$opts{$addDelOpt{$1}}=1;$newVal='' if $1 eq '-' and not defined$newVal}if ($escapeC and defined$newVal){$newVal =~ s/\\\\(x([0-9a-fA-F]{2})|.)/$2 ? chr(hex($2)) : $unescC{$1} || $1/seg}my ($rtn,$wrn)=$mt->SetNewValue($tag,$newVal,%opts);$needSave=1;++$isWriting if$rtn;$wrn and Warning($mt,$wrn);}unless ($csv){for (@exclude){$mt->SetNewValue($_,undef,Replace=>2);$needSave=1}}unless ($isWriting or $outOpt or @tags){Error "Nothing to do.\\n";next}}elsif (grep /^(\\*:)?\\*$/,@exclude){Error "All tags excluded -- nothing to do.\\n";next}if ($isWriting){if (defined$diff){Error "Can't use -diff option when writing tags\\n";next}elsif ($plot){Error "Can't use -plot option when writing tags\\n";next}elsif (@tags and not $outOpt and not $csv){my ($tg,$s)=@tags > 1 ? ("$tags[0] ...",'s'): ($tags[0],'');Warn "Ignored superfluous tag name$s or invalid option$s: -$tg\\n"}}$mt->SaveNewValues()if$outOpt or (@dynamicFiles and $needSave);$multiFile=1 if@files > 1;@exclude and $mt->Options(Exclude=>\\@exclude);undef$binaryOutput if$html;if ($binaryOutput){$outFormat=99;$mt->Options(PrintConv=>0);unless ($textOut or $binaryStdout){binmode(STDOUT);$binaryStdout=1;$mt->Options(TextOut=>($vout=\\*STDERR))}undef$showGroup}if (defined$showGroup and not (@tags and ($allGroup or $csv))and ($sortOpt or not defined$sortOpt)){$mt->Options(Sort=>"Group$showGroup")}if ($textOut){CleanFilename($textOut);$textOut=".$textOut" unless$textOut =~ /[.%]/ or defined$tagOut}if ($outOpt){my$type=GetFileType($outOpt);if ($type){my$canWrite=CanWrite($outOpt);unless ($canWrite){if (defined$canWrite and $canWrite eq ''){$type=Image::ExifTool::GetFileExtension($outOpt);$type=uc($outOpt)unless defined$type}Error "Can't write $type files\\n";next}$scanWritable=$type unless CanCreate($type)}else {$scanWritable=1}$isWriting=1}elsif ($isWriting or defined$deleteOrig){$scanWritable=1}$altEnc=$mt->Options('Charset');undef$altEnc if$altEnc eq 'UTF8';if (not $altEnc and $mt->Options('Lang')ne 'en'){$fixLen=eval {require Unicode::GCString}? 2 : 1}if (@fileOrder){my@allFiles;ProcessFiles($mt,\\@allFiles);my$sortTool=Image::ExifTool->new;$sortTool->Options(FastScan=>$fileOrderFast)if$fileOrderFast;$sortTool->Options(PrintConv=>$mt->Options('PrintConv'));$sortTool->Options(Duplicates=>0);my (%sortBy,%isFloat,@rev,$file);push@rev,(s/^-// ? 1 : 0)foreach@fileOrder;for$file (@allFiles){my@tags;my$info=$sortTool->ImageInfo(Infile($file,1),@fileOrder,\\@tags);for (@tags){$_=$$info{$_};defined $_ or $_='~',next;$isFloat{$_}=Image::ExifTool::IsFloat($_);s/(\\d+)/(length($1) < 12 ? '0'x(12-length($1)) : '') . $1/eg unless$isFloat{$_}}$sortBy{$file}=\\@tags}@files=sort {my ($i,$cmp);for ($i=0;$i<@rev;++$i){my$u=$sortBy{$a}[$i];my$v=$sortBy{$b}[$i];if (not $isFloat{$u}and not $isFloat{$v}){$cmp=$u cmp $v}elsif ($isFloat{$u}and $isFloat{$v}){$cmp=$u <=> $v}else {$cmp=$isFloat{$u}? -1 : 1}return$rev[$i]? -$cmp : $cmp if$cmp}return$a cmp $b}@allFiles}elsif (defined$progress){my@allFiles;ProcessFiles($mt,\\@allFiles);@files=@allFiles}$progressMax=scalar@files if defined$progress;my@dbKeys=keys%database;if (@dbKeys){if (eval {require Cwd}){undef$evalWarning;local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};for (@dbKeys){my$db=$database{$_};tr/\\\\/\\// and $database{$_}=$db;my$absPath=AbsPath($_);if (defined$absPath){$database{$absPath}=$db unless$database{$absPath};if ($verbose and $verbose > 1){print$vout "Imported entry for '\${_}' (full path: '\${absPath}')\\n"}}elsif ($verbose and $verbose > 1){print$vout "Imported entry for '\${_}' (no full path)\\n"}}}}ProcessFiles($mt);Error "No file with specified extension\\n" if$filtered and not $validFile;if ($textOut){for (keys%outTrailer){next unless$outTrailer{$_};if ($mt->Open(\\*OUTTRAIL,$_,'>>')){my$fp=\\*OUTTRAIL;print$fp $outTrailer{$_};close$fp}else {Error("Error appending to $_\\n")}}}else {print$sectTrailer if$sectTrailer;print$fileTrailer if$fileTrailer and not $fileHeader;my ($fp,$err);if ($textOut2){if ($mt->Open(\\*OUTFILE,$textOut2,'>')){$fp=\\*OUTFILE}else {Error("Error creating $textOut2\\n");$err=1}}unless ($err){PrintCSV($fp)if$csv and not $isWriting;if ($plot){$plot->Draw($fp || \\*STDOUT);if ($$plot{Error}){Error("Error: $$plot{Error}\\n");$err=1}elsif ($$plot{Warn}){Warn("Warning: $$plot{Warn}\\n")}}}if ($fp){close($fp)or $err=1;if ($err){$mt->Unlink($textOut2)}else {$created{$textOut2}=1}}}my$totWr=$countGoodWr + $countBadWr + $countSameWr + $countCopyWr + $countGoodCr + $countBadCr;if (defined$deleteOrig){unless ($quiet){printf "%5d directories scanned\\n",$countDir if$countDir;printf "%5d directories created\\n",$countNewDir if$countNewDir;printf "%5d files failed condition\\n",$countFailed if$countFailed;printf "%5d image files found\\n",$count}if (@delFiles){if ($deleteOrig==1){printf '%5d originals will be deleted!  Are you sure [y/n]? ',scalar(@delFiles);my$response=<STDIN>;unless ($response =~ /^(y|yes)\\s*$/i){Warn "Originals not deleted.\\n";next}}$countGoodWr=$mt->Unlink(@delFiles);$countBad=scalar(@delFiles)- $countGoodWr}if ($quiet){}elsif ($count and not $countGoodWr and not $countBad){printf "%5d original files found\\n",$countGoodWr}elsif ($deleteOrig){printf "%5d original files deleted\\n",$countGoodWr if$count;printf "%5d originals not deleted due to errors\\n",$countBad if$countBad}else {printf "%5d image files restored from original\\n",$countGoodWr if$count;printf "%5d files not restored due to errors\\n",$countBad if$countBad}}elsif ((not $binaryStdout or $verbose)and not $quiet){my$tot=$count + $countBad;if ($countDir or $totWr or $countFailed or $tot > 1 or $textOut or %countLink){my$o=(($html or $json or $xml or %printFmt or $csv or $plot)and not $textOut)? \\*STDERR : $vout;printf($o "%5d directories scanned\\n",$countDir)if$countDir;printf($o "%5d directories created\\n",$countNewDir)if$countNewDir;printf($o "%5d files failed condition\\n",$countFailed)if$countFailed;printf($o "%5d image files created\\n",$countGoodCr)if$countGoodCr;printf($o "%5d image files updated\\n",$countGoodWr)if$totWr - $countGoodCr - $countBadCr - $countCopyWr;printf($o "%5d image files unchanged\\n",$countSameWr)if$countSameWr;printf($o "%5d image files %s\\n",$countCopyWr,$overwriteOrig ? 'moved' : 'copied')if$countCopyWr;printf($o "%5d files weren't updated due to errors\\n",$countBadWr)if$countBadWr;printf($o "%5d files weren't created due to errors\\n",$countBadCr)if$countBadCr;printf($o "%5d image files read\\n",$count)if ($tot+$countFailed)>1 or ($countDir and not $totWr);printf($o "%5d files could not be read\\n",$countBad)if$countBad;printf($o "%5d output files created\\n",scalar(keys%created))if$textOut or $textOut2;printf($o "%5d output files appended\\n",scalar(keys%appended))if%appended;printf($o "%5d hard links created\\n",$countLink{Hard}|| 0)if$countLink{Hard}or $countLink{BadHard};printf($o "%5d hard links could not be created\\n",$countLink{BadHard})if$countLink{BadHard};printf($o "%5d symbolic links created\\n",$countLink{Sym}|| 0)if$countLink{Sym}or $countLink{BadSym};printf($o "%5d symbolic links could not be created\\n",$countLink{BadSym})if$countLink{BadSym}}}if ($countBadWr or $countBadCr or $countBad){$rtnVal=1}elsif ($countFailed and not ($count or $totWr)and not $rtnVal){$rtnVal=2}Cleanup();}close STAYOPEN if$stayOpen >= 2;Exit$rtnValApp;sub GetImageInfo($$) {my ($et,$orig)=@_;my (@foundTags,@found2,$info,$info2,$et2,$file,$file2,$ind,$g8);if (defined$windowTitle){if ($progressCount >= $progressNext){my$prog=$progressMax ? "$progressCount/$progressMax" : '0/0';my$title=$windowTitle;my ($num,$denom)=split '/',$prog;my$frac=$num / ($denom || 1);my$n=$title =~ s/%(\\d+)b/%b/ ? $1 : 20;my$bar=int($frac * $n + 0.5);my%lkup=(b=>('I' x $bar).('.' x ($n - $bar)),f=>$orig,p=>int(100 * $frac + 0.5),r=>$prog,'%'=>'%',);$title =~ s/%([%bfpr])/$lkup{$1}/eg;SetWindowTitle($title);if (defined$progressMax){undef$progressNext}else {$progressNext += $progressIncr}}++$progressCount unless defined$progressMax}unless (length$orig or $outOpt){Warn qq(Error: Zero-length file name - ""\\n);++$countBad;return}if (@srcFmt){my ($fmt,$first);for$fmt (@srcFmt){$file=$fmt eq '@' ? $orig : FilenameSPrintf($fmt,$orig);$et->Exists($file)and undef($first),last;$verbose and print$vout "Source file $file does not exist\\n";$first=$file unless defined$first}$file=$first if defined$first;my ($d,$f)=Image::ExifTool::SplitFileName($orig);$et->Options(UserParam=>"OriginalDirectory#=$d");$et->Options(UserParam=>"OriginalFileName#=$f")}else {$file=$orig}for$g8 (sort keys%altFile){my$altName=$orig;$altName =~ s/\\$/\\$\\$/g;$altName=FilenameSPrintf($altFile{$g8},$altName);$et->SetAlternateFile($g8,$altName)}my$pipe=$file;if ($doUnzip){if ($file =~ /\\.(gz|bz2)$/i){my$type=lc $1;if ($file =~ /[^-_.'A-Za-z0-9\\/\\\\]/){Warn "Error: Insecure zip file name. Skipped\\n";EFile($file);++$countBad;return}if ($type eq 'gz'){$pipe=qq{gzip -dc "$file" |}}else {$pipe=qq{bzip2 -dc "$file" |}}$$et{TRUST_PIPE}=1}}if (@condition){unless ($file eq '-' or $et->Exists($file)){Warn "Error: File not found - $file\\n";EFile($file);FileNotFound($file);++$countBad;return}my$result;unless ($failCondition){undef$evalWarning;local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};my (%info,$condition);my$opts={Duplicates=>1,RequestTags=>\\@requestTags,Verbose=>0,HtmlDump=>0 };$$opts{FastScan}=$fastCondition if defined$fastCondition;@foundTags=('*',@tags)if@tags;$info=$et->ImageInfo(Infile($pipe,$isWriting),\\@foundTags,$opts);for$condition (@condition){my$cond=$et->InsertTagValues($condition,\\@foundTags,\\%info);{package Image::ExifTool;my$self=$et;$result=eval$cond;$@ and $evalWarning=$@}if ($evalWarning){undef$result;if ($verbose){chomp$evalWarning;$evalWarning =~ s/ at \\(eval .*//s;Warn "Condition: $evalWarning - $file\\n"}}last unless$result}undef@foundTags if$fastCondition}unless ($result){Progress($vout,"-------- $file (failed condition)")if$verbose;EFile($file,2);++$countFailed;return}if ($isWriting or $verbose or defined$fastCondition or defined$diff){undef$info;--$$et{FILE_SEQUENCE}}}elsif ($file =~ s/^(\\@JSON:)(.*)/$1/){my$dat=$2;$info=$et->ImageInfo(\\$dat,\\@foundTags);if ($geoOnly){/^Geolocation/ or delete $$info{$_}foreach keys %$info;$file=' '}}if (defined$deleteOrig){Progress($vout,"======== $file")if defined$verbose;++$count;my$original="\${file}_original";$et->Exists($original)or return;if ($deleteOrig){$verbose and print$vout "Scheduled for deletion: $original\\n";push@delFiles,$original}elsif ($et->Rename($original,$file)){$verbose and print$vout "Restored from $original\\n";EFile($file,3);++$countGoodWr}else {Warn "Error renaming $original\\n";EFile($file);++$countBad}return}++$seqFileNum;my ($dir)=Image::ExifTool::SplitFileName($orig);$seqFileDir=$seqFileDir{$dir}=($seqFileDir{$dir}|| 0)+ 1;my$lineCount=0;my ($fp,$outfile,$append);if ($textOut and ($verbose or $et->Options('PrintCSV'))and not ($tagOut or defined$diff or $plot)){($fp,$outfile,$append)=OpenOutputFile($orig);$fp or EFile($file),++$countBad,return;$tmpText=$outfile unless$append;$et->Options(TextOut=>$fp)}if ($isWriting){Progress($vout,"======== $file")if defined$verbose;SetImageInfo($et,$file,$orig);$info=$et->GetInfo('Warning','Error');PrintErrors($et,$info,$file);if (defined$outfile){undef$tmpText;close($fp);$et->Options(TextOut=>$vout);if ($info->{Error}){$et->Unlink($outfile)}elsif ($append){$appended{$outfile}=1 unless$created{$outfile}}else {$created{$outfile}=1}}return}unless ($file eq '-' or $et->Exists($file)or $info){Warn "Error: File not found - $file\\n";FileNotFound($file);defined$outfile and close($fp),undef($tmpText),$et->Unlink($outfile);EFile($file);++$countBad;return}my$o;unless ($binaryOutput or $textOut or %printFmt or $html > 1 or $csv or $plot){if ($html){require Image::ExifTool::HTML;my$f=Image::ExifTool::HTML::EscapeHTML($file);print "<!-- $f -->\\n"}elsif (not ($json or $xml or defined$diff)){$o=\\*STDOUT if ($multiFile and not $quiet)or $progress}}$o=\\*STDERR if$progress and not $o;Progress($o,"======== $file")if$o;if ($info){if (@tags and not %printFmt){@foundTags=@tags;$info=$et->GetInfo(\\@foundTags)}}else {my$oldDups=$et->Options('Duplicates');if (%printFmt){$et->Options(Duplicates=>1);$et->Options(RequestTags=>\\@requestTags);if ($printFmt{SetTags}){$$et{TAGS_FROM_FILE}=1;$et->Options(MakerNotes=>1);$et->Options(Struct=>2);$et->Options(List=>1);$et->Options(CoordFormat=>'%d %d %.8f')unless$et->Options('CoordFormat')}}else {@foundTags=@tags}if (defined$diff){$file2=FilenameSPrintf($diff,$orig);if ($file eq $file2){Warn "Error: Diffing file with itself - $file2\\n";EFile($file);++$countBad;return}if ($et->Exists($file2)){$showGroup=1 unless defined$showGroup;$allGroup=1 unless defined$allGroup;$et->Options(Duplicates=>1,Sort=>"Group$showGroup",Verbose=>0);$et2=Image::ExifTool->new;$et2->Options(%{$$et{OPTIONS}});$et2->Options(ListSep=>$$et{OPTIONS}{ListSep});$et2->Options(ListSplit=>$$et{OPTIONS}{ListSplit});@found2=@foundTags;$info2=$et2->ImageInfo($file2,\\@found2)}else {$info2={Error=>"Diff file not found" }}if ($$info2{Error}){Warn "Error: $$info2{Error} - $file2\\n";EFile($file);++$countBad;return}}$info=$et->ImageInfo(Infile($pipe),\\@foundTags);$et->Options(Duplicates=>$oldDups)}if ($fp){if (defined$outfile){$et->Options(TextOut=>\\*STDOUT);undef$tmpText;if ($info->{Error}){close($fp);$et->Unlink($outfile)}else {++$lineCount}}if ($info->{Error}){Warn "Error: $$info{Error} - $file\\n";EFile($file);++$countBad;return}}if ($binaryOutput or not %$info){my$errs=$et->GetInfo('Warning','Error');PrintErrors($et,$errs,$file)and EFile($file),$rtnVal=1}elsif ($et->GetValue('Error')or ($$et{Validate}and $et->GetValue('Warning'))){$rtnVal=1}unless (defined$outfile or $tagOut){($fp,$outfile,$append)=OpenOutputFile($orig);$fp or EFile($file),++$countBad,return;$tmpText=$outfile if defined$outfile and not $append}if (defined$diff){my (%done,%done2,$wasDiff,@diffs,@groupTags2);my$v=$verbose || 0;print$fp "======== diff < $file > $file2\\n";my ($g2,$same)=(0,0);for (;;){my ($g,$tag2,$i,$key,@dupl,$val2,$t2,$equal,%used);my$tag=shift@foundTags;if (defined$tag){$done{$tag}=1;$g=$et->GetGroup($tag,$showGroup)}else {for (;;){$tag2=shift@found2;defined$tag2 or $g='',last;$done2{$tag2}or $g=$et2->GetGroup($tag2,$showGroup),last}}if ($g ne $g2){for$t2 (@groupTags2){next if$done2{$t2};my$val2=$et2->GetValue($t2);next unless defined$val2;my$name=$outFormat < 1 ? $et2->GetDescription($t2): GetTagName($t2);my$len=LengthUTF8($name);my$pad=$outFormat < 2 ? ' ' x ($len < 32 ? 32 - $len : 0): '';if ($allGroup){my$grp="[$g2]";$grp .= ' ' x (15 - length($grp))if length($grp)< 15 and $outFormat < 2;push@diffs,sprintf "> %s %s%s: %s\\n",$grp,$name,$pad,Printable($val2)}else {push@diffs,sprintf "> %s%s: %s\\n",$name,$pad,Printable($val2)}$done2{$t2}=1}my$str='';$v and ($same or $v > 1)and $str="  ($same same tag" .($same==1 ? '' : 's').')';if (not $allGroup){print$fp "---- $g2 ----$str\\n" if$g2 and ($str or @diffs)}elsif ($str and $g2){printf$fp "   %-13s%s\\n",$g2,$str}@diffs and print($fp @diffs),$wasDiff=1,@diffs=();last unless$g;($g2,$same)=($g,0);@groupTags2=();push@groupTags2,$tag2 if defined$tag2;for$t2 (@found2){$done2{$t2}or $g ne $et2->GetGroup($t2,$showGroup)or push@groupTags2,$t2}}next unless defined$tag;my$val=$et->GetValue($tag);next unless defined$val;my$name=GetTagName($tag);my$desc=$outFormat < 1 ? $et->GetDescription($tag): $name;my@tags2=grep /^$name( |$)/,@groupTags2;T2: foreach$t2 (@tags2){next if$done2{$t2};$tag2=$t2;$val2=$et2->GetValue($t2);next unless defined$val2;IsEqual($val,$val2)and $equal=1,last;if ($$et{DUPL_TAG}{$name}and not @dupl){for ($i=0,$key=$name;$i<=$$et{DUPL_TAG}{$name};++$i,$key="$name ($i)"){push@dupl,$key unless$done{$key}or $g ne $et->GetGroup($key,$showGroup)}@dupl=sort {$$et{FILE_ORDER}{$a}<=> $$et{FILE_ORDER}{$b}}@dupl if@dupl > 1}for (@dupl){next if$used{$_};my$v=$et->GetValue($_);next unless defined($v)and IsEqual($v,$val2);$used{$_}=1;undef($tag2);undef($val2);next T2}last}if ($equal){++$same}else {my$len=LengthUTF8($desc);my$pad=$outFormat < 2 ? ' ' x ($len < 32 ? 32 - $len : 0): '';if ($allGroup){my$grp="[$g]";$grp .= ' ' x (15 - length($grp))if length($grp)< 15 and $outFormat < 2;push@diffs,sprintf "< %s %s%s: %s\\n",$grp,$desc,$pad,Printable($val);if (defined$val2){$grp=' ' x length($grp),$desc=' ' x $len if$v < 3;push@diffs,sprintf "> %s %s%s: %s\\n",$grp,$desc,$pad,Printable($val2)}}else {push@diffs,sprintf "< %s%s: %s\\n",$desc,$pad,Printable($val);$desc=' ' x $len if$v < 3;push@diffs,sprintf "> %s%s: %s\\n",$desc,$pad,Printable($val2)if defined$val2}}$done2{$tag2}=1 if defined$tag2}print$fp "(no metadata differences)\\n" unless$wasDiff;if (defined$outfile){$created{$outfile}=1;close($fp);undef$tmpText}++$count;return}$comma=$outComma{$outfile}if$append and ($textOverwrite & 0x02);if (%printFmt){my ($type,$doc,$grp,$lastDoc,$cache);$fileTrailer='';if ($et->Options('ExtractEmbedded')){$lastDoc=$$et{DOC_COUNT}and $cache={}}else {$lastDoc=0}for ($doc=0;$doc<=$lastDoc;++$doc){my ($skipBody,$opt);for$type (qw(HEAD SECT IF BODY ENDS TAIL)){my$prf=$printFmt{$type}or next;if ($type eq 'HEAD' and defined$outfile){next if$wroteHEAD{$outfile};$wroteHEAD{$outfile}=1}next if$type eq 'BODY' and $skipBody;if ($type eq 'IF' or ($doc > 1 and not $$et{OPTIONS}{IgnoreMinorErrors})){$opt='Silent'}else {$opt='Warn'}if ($lastDoc){if ($doc){next if$type eq 'HEAD' or $type eq 'TAIL';$grp="Doc$doc"}else {$grp='Main'}}my@lines;for (@$prf){my$line=$et->InsertTagValues($_,\\@foundTags,$opt,$grp,$cache);if ($type eq 'IF'){$skipBody=1 unless defined$line}elsif (defined$line){push@lines,$line}}$lineCount += scalar@lines;if ($type eq 'SECT'){my$thisHeader=join '',@lines;if ($sectHeader and $sectHeader ne $thisHeader){print$fp $sectTrailer if$sectTrailer;undef$sectHeader}$sectTrailer='';print$fp $sectHeader=$thisHeader unless$sectHeader}elsif ($type eq 'ENDS'){$sectTrailer .= join '',@lines if defined$sectHeader}elsif ($type eq 'TAIL'){$fileTrailer .= join '',@lines}elsif (@lines){print$fp @lines}}}delete$printFmt{HEAD}unless defined$outfile;my$errs=$et->GetInfo('Warning','Error');PrintErrors($et,$errs,$file)and EFile($file)}elsif ($plot){my$tagExtra=$$et{TAG_EXTRA};my ($tag,%docNum);for$tag (keys %$info){next unless $$tagExtra{$tag}and $$tagExtra{$tag}{G3};$docNum{$tag}=$1 if $$tagExtra{$tag}{G3}=~ /(\\d+)/}$$plot{DocNum}=\\%docNum;$$plot{EE}=1 if$et->Options('ExtractEmbedded');$plot->AddPoints($info,\\@foundTags)}elsif (not $disableOutput){my ($tag,$line,%noDups,%csvInfo,$bra,$ket,$sep,$quote);if ($fp){if ($fileHeader){print$fp $fileHeader unless defined$outfile and ($created{$outfile}or $appended{$outfile});undef$fileHeader unless$textOut}if ($html){print$fp "<table>\\n"}elsif ($xml){my$f=$file;CleanXML(\\$f);print$fp "\\n<rdf:Description rdf:about='\${f}'";print$fp "\\n  xmlns:et='http://ns.exiftool.org/1.0/'";print$fp " et:toolkit='Image::ExifTool $Image::ExifTool::VERSION'";my (%groups,@groups,$grp0,$grp1);for$tag (@foundTags){($grp0,$grp1)=$et->GetGroup($tag);unless ($grp1){next unless defined$forcePrint;$grp0=$grp1='Unknown'}AddGroups($$info{$tag},$grp0,\\%groups,\\@groups)if ref $$info{$tag};next if$groups{$grp1};$groups{$grp1}=$grp0;push@groups,$grp1}for$grp1 (@groups){my$grp=$groups{$grp1};unless ($grp eq $grp1 and $grp =~ /^(ExifTool|File|Composite|Unknown)$/){$grp .= "/$grp1"}print$fp "\\n  xmlns:$grp1='http://ns.exiftool.org/$grp/1.0/'"}print$fp '>' if$outFormat < 1;$ind=$outFormat >= 0 ? ' ' : '   '}elsif ($json){($bra,$ket,$sep)=$json==1 ? ('{','}',':'): ('Array(',')',' =>');$quote=1 if $$et{OPTIONS}{StructFormat}and $$et{OPTIONS}{StructFormat}eq 'JSONQ';print$fp ",\\n" if$comma;print$fp qq($bra\\n  "SourceFile"$sep ),EscapeJSON(MyConvertFileName($et,$file),1);$comma=1;$ind=(defined$showGroup and not $allGroup)? '    ' : '  '}elsif ($csv){my$file2=MyConvertFileName($et,$file);$database{$file2}=\\%csvInfo;push@csvFiles,$file2}}my$noDups=($json or ($xml and $outFormat > 0));my$printConv=$et->Options('PrintConv');my$lastGroup='';my$i=-1;TAG: foreach$tag (@foundTags){++$i;my$tagName=GetTagName($tag);my ($group,$valList);my$val=$$info{$tag};$isBinary=(ref$val eq 'SCALAR' and defined$binaryOutput);if (ref$val){if (defined$binaryOutput and not $binaryOutput and $$et{TAG_INFO}{$tag}{Protected}){my$lcTag=lc$tag;$lcTag =~ s/ .*//;next unless $$et{REQ_TAG_LOOKUP}{$lcTag}or ($$et{OPTIONS}{RequestAll}|| 0)> 2}$val=ConvertBinary($val);next unless defined$val;if ($structOpt and ref$val){$val=Image::ExifTool::XMP::SerializeStruct($et,$val)unless$xml or $json}elsif (ref$val eq 'ARRAY'){if (defined$listItem){$val=$$val[$listItem]}elsif ($binaryOutput){if ($tagOut){$valList=$val;$val=shift @$valList}else {$val=join defined$binSep ? $binSep : "\\n",@$val}}elsif ($joinLists){$val=join$listSep,@$val}}}if (not defined$val){next if$binaryOutput;if (defined$forcePrint){$val=$forcePrint}elsif (not $csv){next}}if (defined$showGroup){$group=$et->GetGroup($tag,$showGroup);next if$noDups and $tag =~ /^(.*?) ?\\(/ and defined $$info{$1}and $group eq $et->GetGroup($1,$showGroup);if (not $group and ($xml or $json or $csv)){if ($showGroup !~ /\\b4\\b/){$group='Unknown'}elsif ($json and not $allGroup){$group='Copy0'}}if ($fp and not ($allGroup or $csv)){if ($lastGroup ne $group){if ($html){my$cols=1;++$cols if$outFormat==0 or $outFormat==1;++$cols if$showTagID;print$fp "<tr><td colspan=$cols bgcolor='#dddddd'>$group</td></tr>\\n"}elsif ($json){print$fp "\\n  $ket" if$lastGroup;print$fp ',' if$lastGroup or $comma;print$fp qq(\\n  "$group"$sep $bra);undef$comma;undef%noDups}else {print$fp "---- $group ----\\n"}$lastGroup=$group}undef$group}}elsif ($noDups){next if$tag =~ /^(.*?) ?\\(/ and defined $$info{$1}}++$lineCount;for (;;){if ($tagOut){my$ext=SuggestedExtension($et,\\$val,$tagName);if (%wext and ($wext{$ext}|| $wext{'*'}|| -1)< 0){if ($verbose and $verbose > 1){print$vout "Not writing $ext output file for $tagName\\n"}next TAG}my@groups=$et->GetGroup($tag);defined$outfile and close($fp),undef($tmpText);my$org=$et->GetValue('OriginalRawFileName')|| $et->GetValue('OriginalFileName');($fp,$outfile,$append)=OpenOutputFile($orig,$tagName,\\@groups,$ext,$org);$fp or ++$countBad,next TAG;$tmpText=$outfile unless$append}if ($binaryOutput){print$fp $val;print$fp $binTerm if defined$binTerm;if ($tagOut){if ($append){$appended{$outfile}=1 unless$created{$outfile}}else {$created{$outfile}=1}close($fp);undef$tmpText;$verbose and print$vout "Wrote $tagName to $outfile\\n";undef$outfile;undef$fp;next TAG unless$valList and @$valList;$val=shift @$valList;next}next TAG}last}if ($csv){my$tn=$tagName;$tn .= '#' if$tag =~ /#/;my$gt=$group ? "$group:$tn" : $tn;my$lcTag=lc$gt;next if defined$csvInfo{$lcTag}and $tag =~ /\\(/;$csvInfo{$lcTag}=$val;if (defined$csvTags{$lcTag}){$csvTags{$lcTag}=$gt if defined $$info{$tag};next}if ($group and defined$csvTags[$i]and $csvTags[$i]=~ /^(.*):$tn$/i){next if$group eq 'Unknown';if ($1 eq 'unknown'){delete$csvTags{$csvTags[$i]};$csvTags{$lcTag}=defined($val)? $gt : '';$csvTags[$i]=$lcTag;next}}$csvTags{$lcTag}=defined($val)? $gt : '';if (@csvFiles==1){push@csvTags,$lcTag}elsif (@csvTags){undef@csvTags}next}my$desc=$outFormat > 0 ? $tagName : $et->GetDescription($tag);if ($xml){my$tok="$group:$tagName";if ($outFormat > 0){if ($structOpt and ref$val){$val=Image::ExifTool::XMP::SerializeStruct($et,$val)}if ($escapeHTML){$val =~ tr/\\0-\\x08\\x0b\\x0c\\x0e-\\x1f/./;Image::ExifTool::XMP::FixUTF8(\\$val)unless$altEnc;$val=Image::ExifTool::HTML::EscapeHTML($val,$altEnc)}else {CleanXML(\\$val)}unless ($noDups{$tok}){$isCRLF and $val =~ s/\\x0d\\x0a/\\x0a/g;print$fp "\\n $tok='\${val}'";$noDups{$tok}=1}next}my ($xtra,$valNum,$descClose);if ($showTagID){my ($id,$lang)=$et->GetTagID($tag);if ($id =~ /^\\d+$/){$id=sprintf("0x%.4x",$id)if$showTagID eq 'H'}else {$id=Image::ExifTool::XMP::FullEscapeXML($id)}$xtra=" et:id='\${id}'";$xtra .= " xml:lang='\${lang}'" if$lang}else {$xtra=''}if ($tabFormat){my$table=$et->GetTableName($tag);my$index=$et->GetTagIndex($tag);$xtra .= " et:table='\${table}'";$xtra .= " et:index='\${index}'" if defined$index}my$lastVal=$val;for ($valNum=0;$valNum<2;++$valNum){$val=FormatXML($val,$ind,$group);$isCRLF and $val =~ s/\\x0d\\x0a/\\x0a/g;if ($outFormat >= 0){print$fp "\\n <$tok$xtra$val</$tok>";last}elsif ($valNum==0){CleanXML(\\$desc);if ($xtra){print$fp "\\n <$tok>";print$fp "\\n  <rdf:Description$xtra>";$descClose="\\n  </rdf:Description>"}else {print$fp "\\n <$tok rdf:parseType='Resource'>";$descClose=''}print$fp "\\n   <et:desc>$desc</et:desc>";if ($printConv){print$fp "\\n   <et:prt$val</et:prt>";$val=$et->GetValue($tag,'ValueConv');$val='' unless defined$val;next unless IsEqual($val,$lastVal);print$fp "$descClose\\n </$tok>";last}}print$fp "\\n   <et:val$val</et:val>";print$fp "$descClose\\n </$tok>";last}next}elsif ($json){my$tok=$allGroup ? "$group:$tagName" : $tagName;next if$noDups{$tok};$noDups{$tok}=1;print$fp ',' if$comma;print$fp qq(\\n$ind"$tok"$sep );if ($showTagID or $outFormat < 0){$val={val=>$val };if ($showTagID){my ($id,$lang)=$et->GetTagID($tag);$id=sprintf('0x%.4x',$id)if$showTagID eq 'H' and $id =~ /^\\d+$/;$$val{lang}=$lang if$lang;$$val{id}=$id}if ($tabFormat){$$val{table}=$et->GetTableName($tag);my$index=$et->GetTagIndex($tag);$$val{index}=$index if defined$index}if ($outFormat < 0){$$val{desc}=$desc;if ($printConv){my$num=$et->GetValue($tag,'ValueConv');$$val{num}=$num if defined$num and not IsEqual($num,$$val{val})}my$ex=$$et{TAG_EXTRA}{$tag};$$val{'fmt'}=$$ex{G6}if defined $$ex{G6};if (defined $$ex{BinVal}){my$max=($$et{OPTIONS}{LimitLongValues}- 5)/ 3;if ($max >= 0 and length($$ex{BinVal})> int($max)){$max=int$max;$$val{'hex'}=join ' ',unpack("(H2)$max",$$ex{BinVal}),'[...]'}else {$$val{'hex'}=join ' ',unpack '(H2)*',$$ex{BinVal}}}}}FormatJSON($fp,$val,$ind,$quote);$comma=1;next}my$id;if ($showTagID){$id=$et->GetTagID($tag);if ($id =~ /^(\\d+)(\\.\\d+)?$/){$id=sprintf("0x%.4x",$1)if$showTagID eq 'H'}else {$id='-'}}if ($escapeC){$val =~ s/([\\0-\\x1f\\\\\\x7f])/$escC{$1} || sprintf('\\x%.2x', ord $1)/eg}else {$val =~ tr/\\x01-\\x1f\\x7f/./;$val =~ s/\\x00//g;$val =~ s/\\s+$//}if ($html){print$fp "<tr>";print$fp "<td>$group</td>" if defined$group;print$fp "<td>$id</td>" if$showTagID;print$fp "<td>$desc</td>" if$outFormat <= 1;print$fp "<td>$val</td></tr>\\n"}else {my$buff='';if ($tabFormat){$buff="$group\\t" if defined$group;$buff .= "$id\\t" if$showTagID;if ($outFormat <= 1){$buff .= "$desc\\t$val\\n"}elsif (defined$line){$line .= "\\t$val"}else {$line=$val}}elsif ($outFormat < 0){$buff="[$group] " if defined$group;$buff .= "$id " if$showTagID;$buff .= "$desc\\n      $val\\n"}elsif ($outFormat==0 or $outFormat==1){my$wid;my$len=0;if (defined$group){$buff=sprintf("%-15s ","[$group]");$len=16}if ($showTagID){$wid=($showTagID eq 'D')? 5 : 6;$len += $wid + 1;($wid=$len - length($buff)- 1)< 1 and $wid=1;$buff .= sprintf "%\${wid}s ",$id}$wid=32 - (length($buff)- $len);my$padLen=$wid - LengthUTF8($desc);$padLen=0 if$padLen < 0;$buff .= $desc .(' ' x $padLen).": $val\\n"}elsif ($outFormat==2){$buff="[$group] " if defined$group;$buff .= "$id " if$showTagID;$buff .= "$tagName: $val\\n"}elsif ($argFormat){$buff='-';$buff .= "$group:" if defined$group;$tagName .= '#' if$tag =~ /#/;$buff .= "$tagName=$val\\n"}else {$buff="$group " if defined$group;$buff .= "$id " if$showTagID;$buff .= "$val\\n"}print$fp $buff}if ($tagOut){if ($append){$appended{$outfile}=1 unless$created{$outfile}}else {$created{$outfile}=1}close($fp);undef$tmpText;$verbose and print$vout "Wrote $tagName to $outfile\\n";undef$outfile;undef$fp}}if ($fp){if ($html){print$fp "</table>\\n"}elsif ($xml){print$fp $outFormat < 1 ? "\\n</rdf:Description>\\n" : "/>\\n"}elsif ($json){print$fp "\\n  $ket" if$lastGroup;print$fp "\\n$ket";$comma=1}elsif ($tabFormat and $outFormat > 1){print$fp "$line\\n" if defined$line}}}if (defined$outfile){if ($textOverwrite & 0x02){$outComma{$outfile}=$comma;$outTrailer{$outfile}='';$outTrailer{$outfile}.= $sectTrailer and $sectTrailer='' if$sectTrailer;$outTrailer{$outfile}.= $fileTrailer if$fileTrailer}else {print$fp $sectTrailer and $sectTrailer='' if$sectTrailer;print$fp $fileTrailer if$fileTrailer}close($fp);undef$tmpText;if ($lineCount){if ($append){$appended{$outfile}=1 unless$created{$outfile}}else {$created{$outfile}=1}}else {$et->Unlink($outfile)unless$append}undef$comma}++$count}sub SetImageInfo($$$) {my ($et,$file,$orig)=@_;my ($outfile,$restored,$isTemporary,$isStdout,$outType,$tagsFromSrc);my ($hardLink,$symLink,$testName,$sameFile);my$infile=$file;if (defined$tmpFile){$et->Unlink($tmpFile);undef$tmpFile}delete $$et{VALUE}{Error};delete $$et{VALUE}{Warning};if (defined$outOpt){if ($outOpt =~ /^-(\\.\\w+)?$/){$outType=GetFileType($outOpt)if $1;$outfile='-';$isStdout=1}else {$outfile=FilenameSPrintf($outOpt,$orig);if ($outfile eq ''){Warn "Error: Can't create file with zero-length name from $orig\\n";EFile($infile);++$countBadCr;return 0}}if (not $isStdout and (($et->IsDirectory($outfile)and not $listDir)or $outfile =~ /\\/$/)){$outfile .= '/' unless$outfile =~ /\\/$/;my$name=$file;$name =~ s/^.*\\///s;$outfile .= $name}else {my$srcType=GetFileType($file)|| '';$outType or $outType=GetFileType($outfile);if ($outType and ($srcType ne $outType or $outType eq 'ICC')and $file ne '-'){unless (CanCreate($outType)){my$what=$srcType ? 'other types' : 'scratch';WarnOnce "Error: Can't create $outType files from $what\\n";EFile($infile);++$countBadCr;return 0}if ($file ne ''){$et->RestoreNewValues()unless$restored;$restored=1;my@setTags=@tags;for (@exclude){push@setTags,"-$_"}my%forceCopy=(ICC=>'ICC_Profile',VRD=>'CanonVRD',DR4=>'CanonDR4',);push@setTags,$forceCopy{$outType}if$forceCopy{$outType};if (not %setTags or (@setTags and not $setTags{'@'})){return 0 unless DoSetFromFile($et,$file,\\@setTags)}elsif (@setTags){push@setTags,@{$setTags{'@'}};$tagsFromSrc=\\@setTags}$file=''}}}unless ($isStdout){$outfile=NextUnusedFilename($outfile);if ($et->Exists($outfile,1)and not $doSetFileName){Warn "Error: '\${outfile}' already exists - $infile\\n";EFile($infile);++$countBadWr;return 0}}}elsif ($file eq '-'){$isStdout=1}if (@dynamicFiles){$et->RestoreNewValues()unless$restored;my ($dyFile,%setTagsIndex);for$dyFile (@dynamicFiles){if (not ref$dyFile){my ($fromFile,$setTags);if ($dyFile eq '@'){$fromFile=$orig;$setTags=$tagsFromSrc || $setTags{$dyFile}}else {$fromFile=FilenameSPrintf($dyFile,$orig);defined$fromFile or EFile($infile),++$countBadWr,return 0;$setTags=$setTags{$dyFile}}if ($setTagsList{$dyFile}){my$i=$setTagsIndex{$dyFile}|| 0;$setTagsIndex{$dyFile}=$i + 1;$setTags=$setTagsList{$dyFile}[$i]if$setTagsList{$dyFile}[$i]}return 0 unless DoSetFromFile($et,$fromFile,$setTags)}elsif (ref$dyFile eq 'ARRAY'){my$fname=FilenameSPrintf($$dyFile[1],$orig);my ($buff,$rtn,$wrn);my$opts=$$dyFile[2];if (defined$fname and SlurpFile($fname,\\$buff)){$verbose and print$vout "Reading $$dyFile[0] from $fname\\n";($rtn,$wrn)=$et->SetNewValue($$dyFile[0],$buff,%$opts);$wrn and Warn "$wrn\\n"}$rtn or $et->SetNewValue($$dyFile[0],undef,Replace=>2,ProtectSaved=>$$opts{ProtectSaved});next}elsif (ref$dyFile eq 'SCALAR'){my ($f,$found,$csvTag,$tryTag,$tg);undef$evalWarning;local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};my$old=$et->Options('Charset');$et->Options(Charset=>'UTF8')if$csv eq 'JSON';for$f ('*',MyConvertFileName($et,$file)){my$csvInfo=$database{$f};unless ($csvInfo){next if$f eq '*';my$absPath=AbsPath($f);next unless defined$absPath and $csvInfo=$database{$absPath}}$found=1;if ($verbose){print$vout "Setting new values from $csv database\\n";print$vout 'Including tags: ',join(' ',@tags),"\\n" if@tags;print$vout 'Excluding tags: ',join(' ',@exclude),"\\n" if@exclude}my@tryTags=(@exclude,@tags);for (@tryTags){tr/-0-9a-zA-Z_:#?*//dc;s/(^|:)(all:)+/$1/ig;s/(^|:)all(#?)$/$1*$2/i;tr/?/./;s/\\*/.*/g}for$csvTag (OrderedKeys($csvInfo)){next if$csvTag =~ /^([-_0-9A-Z]+:)*(SourceFile|Directory|FileName)$/i;if (@tryTags){my ($i,$tryGrp,$matched);TryMatch: for ($i=0;$i<@tryTags;++$i){$tryTag=$tryTags[$i];if ($tryTag =~ /:/){next unless$csvTag =~ /:/;my@csvGrps=split /:/,$csvTag;my@tryGrps=split /:/,$tryTag;my$tryName=pop@tryGrps;next unless pop(@csvGrps)=~ /^$tryName$/i;for$tryGrp (@tryGrps){next TryMatch unless grep /^$tryGrp$/i,@csvGrps}$matched=1;last}$csvTag =~ /^([-_0-9A-Z]+:)*$tryTag$/i and $matched=1,last}next if$matched ? $i < @exclude : @tags}my ($rtn,$wrn)=$et->SetNewValue($csvTag,$$csvInfo{$csvTag},Protected=>1,AddValue=>$csvAdd,ProtectSaved=>$csvSaveCount);$wrn and Warn "$wrn\\n" if$verbose}}$et->Options(Charset=>$old)if$csv eq 'JSON';unless ($found){Warn("No SourceFile '\${file}' in imported $csv database\\n");my$absPath=AbsPath($file);Warn("(full path: '\${absPath}')\\n")if defined$absPath and $absPath ne $file;return 0}}}}if ($isStdout){$outfile=\\*STDOUT;unless ($binaryStdout){binmode(STDOUT);$binaryStdout=1}}else {$hardLink=$et->GetNewValues('HardLink');$symLink=$et->GetNewValues('SymLink');$testName=$et->GetNewValues('TestName');$hardLink=FilenameSPrintf($hardLink,$orig)if defined$hardLink;$symLink=FilenameSPrintf($symLink,$orig)if defined$symLink;my$newFileName=$et->GetNewValues('FileName');my$newDir=$et->GetNewValues('Directory');if (defined$newFileName and not length$newFileName){Warning($et,"New file name is empty - $infile");undef$newFileName}if (defined$testName){my$err;$err="You shouldn't write FileName or Directory with TestFile" if defined$newFileName or defined$newDir;$err="The -o option shouldn't be used with TestFile" if defined$outfile;$err and Warn("Error: $err - $infile\\n"),EFile($infile),++$countBadWr,return 0;$testName=FilenameSPrintf($testName,$orig);$testName=Image::ExifTool::GetNewFileName($file,$testName)if$file ne ''}if (defined$newFileName or defined$newDir or ($doSetFileName and defined$outfile)){if ($newFileName){$newFileName=FilenameSPrintf($newFileName,$orig);if (defined$outfile){$outfile=Image::ExifTool::GetNewFileName($file,$outfile)if$file ne '';$outfile=Image::ExifTool::GetNewFileName($outfile,$newFileName)}elsif ($file ne ''){$outfile=Image::ExifTool::GetNewFileName($file,$newFileName)}}if ($newDir){$newDir=FilenameSPrintf($newDir,$orig);$outfile=Image::ExifTool::GetNewFileName(defined$outfile ? $outfile : $file,$newDir)}$outfile=NextUnusedFilename($outfile,$infile);if ($et->Exists($outfile,1)){if ($infile eq $outfile){undef$outfile}elsif ($et->IsSameFile($infile,$outfile)){$sameFile=$outfile}else {Warn "Error: '\${outfile}' already exists - $infile\\n";EFile($infile);++$countBadWr;return 0}}}if (defined$outfile){defined$verbose and print$vout "'\${infile}' --> '\${outfile}'\\n";CreateDirectory($outfile);$tmpFile=$outfile if defined$outOpt}unless (defined$tmpFile){my ($numSet,$numPseudo)=$et->CountNewValues();if ($numSet!=$numPseudo and $et->IsDirectory($file)){print$vout "Can't write real tags to a directory - $infile\\n" if defined$verbose;$numSet=$numPseudo}if ($et->Exists($file)){unless ($numSet){print$vout "Nothing changed in $file\\n" if defined$verbose;EFile($infile,1);++$countSameWr;return 1}}elsif (CanCreate($file)){if ($numSet==$numPseudo){Warn("Error: Nothing to write - $file\\n");EFile($infile,1);++$countBadWr;return 0}unless (defined$outfile){$outfile=$file;$file=''}}else {Warn "Error: File not found - $file\\n";EFile($infile);FileNotFound($file);++$countBadWr;return 0}if ($numSet==$numPseudo){my ($r0,$r1,$r2,$r3)=(0,0,0,0);if (defined$outfile){$r0=$et->SetFileName($file,$outfile);$file=$$et{NewName}if$r0 > 0}unless ($r0 < 0){$r1=$et->SetFileModifyDate($file,undef,'FileCreateDate');$r2=$et->SetFileModifyDate($file);$r3=$et->SetSystemTags($file)}if ($r0 > 0 or $r1 > 0 or $r2 > 0 or $r3 > 0){EFile($infile,3);++$countGoodWr}elsif ($r0 < 0 or $r1 < 0 or $r2 < 0 or $r3 < 0){EFile($infile);++$countBadWr;return 0}else {EFile($infile,1);++$countSameWr}if (defined$hardLink or defined$symLink or defined$testName){DoHardLink($et,$file,$hardLink,$symLink,$testName)}return 1}if (not defined$outfile or defined$sameFile){$outfile="\${file}_exiftool_tmp";if ($et->Exists($outfile)){Warn("Error: Temporary file already exists: $outfile\\n");EFile($infile);++$countBadWr;return 0}$isTemporary=1}$tmpFile=$outfile}}my$success=$et->WriteInfo(Infile($file),$outfile,$outType);if ($success and (defined$hardLink or defined$symLink or defined$testName)){my$src=defined$outfile ? $outfile : $file;DoHardLink($et,$src,$hardLink,$symLink,$testName)}my ($aTime,$mTime,$cTime,$doPreserve);$doPreserve=$preserveTime unless$file eq '';if ($doPreserve and $success){($aTime,$mTime,$cTime)=$et->GetFileTime($file);undef$cTime if $$et{WRITTEN}{FileCreateDate};if ($$et{WRITTEN}{FileModifyDate}or $doPreserve==2){if (defined$cTime){undef$aTime;undef$mTime}else {undef$doPreserve}}}if ($success==1){if (defined$tmpFile){if ($et->Exists($file)){$et->SetFileTime($tmpFile,$aTime,$mTime,$cTime)if$doPreserve;if ($isTemporary){$et->CopyFileAttrs($file,$outfile);my$original="\${file}_original";if (not $overwriteOrig and not $et->Exists($original)){if (not $et->Rename($file,$original)or $et->Exists($file)){Error "Error renaming $file\\n";return 0}}my$dstFile=defined$sameFile ? $sameFile : $file;if ($overwriteOrig > 1){my ($err,$buff);my$newFile=$tmpFile;$et->Open(\\*NEW_FILE,$newFile)or Error("Error opening $newFile\\n"),return 0;binmode(NEW_FILE);$critical=1;undef$tmpFile;if ($et->Open(\\*ORIG_FILE,$file,'+<')){binmode(ORIG_FILE);while (read(NEW_FILE,$buff,65536)){print ORIG_FILE$buff or $err=1}close(NEW_FILE);eval {truncate(ORIG_FILE,tell(ORIG_FILE))}or $err=1;close(ORIG_FILE)or $err=1;if ($err){Warn "Couldn't overwrite in place - $file\\n";unless ($et->Rename($newFile,$file)or ($et->Unlink($file)and $et->Rename($newFile,$file))){Error("Error renaming $newFile to $file\\n");undef$critical;SigInt()if$interrupted;return 0}}else {$et->SetFileModifyDate($file,$cTime,'FileCreateDate',1);$et->SetFileModifyDate($file,$mTime,'FileModifyDate',1);$et->Unlink($newFile);if ($doPreserve){$et->SetFileTime($file,$aTime,$mTime,$cTime);$preserveTime{$file}=[$aTime,$mTime,$cTime ]}}EFile($infile,3);++$countGoodWr}else {close(NEW_FILE);Warn "Error opening $file for writing\\n";EFile($infile);$et->Unlink($newFile);++$countBadWr}undef$critical;SigInt()if$interrupted}elsif ($et->Rename($tmpFile,$dstFile)){EFile($infile,3);++$countGoodWr}else {my$newFile=$tmpFile;undef$tmpFile;if (not $et->Unlink($file)){Warn "Error renaming temporary file to $dstFile\\n";EFile($infile);$et->Unlink($newFile);++$countBadWr}elsif (not $et->Rename($newFile,$dstFile)){Warn "Error renaming temporary file to $dstFile\\n";EFile($infile);++$countBadWr}else {EFile($infile,3);++$countGoodWr}}}elsif ($overwriteOrig){EFile($infile,3);$et->Unlink($file)or Warn "Error erasing original $file\\n";++$countGoodWr}else {EFile($infile,4);++$countGoodCr}}else {EFile($infile,4);++$countGoodCr}}else {EFile($infile,3);++$countGoodWr}}elsif ($success){EFile($infile,1);if ($isTemporary){$et->Unlink($tmpFile);++$countSameWr}else {$et->SetFileTime($outfile,$aTime,$mTime,$cTime)if$doPreserve;if ($overwriteOrig){$et->Unlink($file)or Warn "Error erasing original $file\\n"}++$countCopyWr}print$vout "Nothing changed in $file\\n" if defined$verbose}else {EFile($infile);$et->Unlink($tmpFile)if defined$tmpFile;++$countBadWr}undef$tmpFile;return$success}sub DoHardLink($$$$$) {my ($et,$src,$hardLink,$symLink,$testName)=@_;if (defined$hardLink){$hardLink=NextUnusedFilename($hardLink);if ($et->SetFileName($src,$hardLink,'Link')> 0){$countLink{Hard}=($countLink{Hard}|| 0)+ 1}else {$countLink{BadHard}=($countLink{BadHard}|| 0)+ 1}}if (defined$symLink){$symLink=NextUnusedFilename($symLink);if ($et->SetFileName($src,$symLink,'SymLink')> 0){$countLink{Sym}=($countLink{Sym}|| 0)+ 1}else {$countLink{BadSym}=($countLink{BadSym}|| 0)+ 1}}if (defined$testName){$testName=NextUnusedFilename($testName,$src);if ($usedFileName{$testName}){$et->Warn("File '\${testName}' would exist")}elsif ($et->SetFileName($src,$testName,'Test',$usedFileName{$testName})==1){$usedFileName{$testName}=1;$usedFileName{$src}=0}}}sub CleanXML($) {my$strPt=shift;$$strPt =~ tr/\\0-\\x08\\x0b\\x0c\\x0e-\\x1f/./;Image::ExifTool::XMP::FixUTF8($strPt)unless$altEnc;$$strPt=Image::ExifTool::XMP::EscapeXML($$strPt)}sub EncodeXML($) {my$strPt=shift;if ($$strPt =~ /[\\0-\\x08\\x0b\\x0c\\x0e-\\x1f]/ or (not $altEnc and Image::ExifTool::IsUTF8($strPt)< 0)){$$strPt=Image::ExifTool::XMP::EncodeBase64($$strPt);return 'http://www.w3.org/2001/XMLSchema#base64Binary'}elsif ($escapeHTML){$$strPt=Image::ExifTool::HTML::EscapeHTML($$strPt,$altEnc)}else {$$strPt=Image::ExifTool::XMP::EscapeXML($$strPt)}return ''}sub FormatXML($$$) {local $_;my ($val,$ind,$grp)=@_;my$gt='>';if (ref$val eq 'ARRAY'){my$val2="\\n$ind <rdf:Bag>";for (@$val){$val2 .= "\\n$ind  <rdf:li" .FormatXML($_,"$ind  ",$grp)."</rdf:li>"}$val="$val2\\n$ind </rdf:Bag>\\n$ind"}elsif (ref$val eq 'HASH'){$gt=" rdf:parseType='Resource'>";my$val2='';for (OrderedKeys($val)){my ($ns,$tg)=($grp,$_);if (/^(.*?):(.*)/){if ($grp eq 'JSON'){$tg =~ tr/:/_/}else {($ns,$tg)=($1,$2)}}my$name;for$name ($ns,$tg){$name =~ tr/-_A-Za-z0-9.//dc;$name='_' .$name if$name !~ /^[_A-Za-z]/}my$tok=$ns .':' .$tg;$val2 .= "\\n$ind <$tok" .FormatXML($$val{$_},"$ind ",$grp)."</$tok>"}$val="$val2\\n$ind"}else {my$enc=EncodeXML(\\$val);$gt=" rdf:datatype='\${enc}'>\\n" if$enc}return$gt .$val}sub EscapeJSON($;$) {my ($str,$quote)=@_;unless ($quote){return lc($str)if$str =~ /^(true|false)$/i and $json < 2;return$str if$str =~ /^-?(\\d|[1-9]\\d{1,14})(\\.\\d{1,16})?(e[-+]?\\d{1,3})?$/i}if ($json < 2 and defined$binaryOutput and Image::ExifTool::IsUTF8(\\$str)< 0){return '"base64:' .Image::ExifTool::XMP::EncodeBase64($str,1).'"'}$str =~ s/(["\\t\\n\\r\\\\])/\\\\$jsonChar{$1}/sg;if ($json < 2){$str =~ tr/\\0//d;$str =~ s/([\\0-\\x1f\\x7f])/sprintf("\\\\u%.4X",ord $1)/sge;Image::ExifTool::XMP::FixUTF8(\\$str)unless$altEnc}else {$str =~ s/\\0+$// unless$isBinary;$str =~ s/\\$/\\\\\\$/sg;$str =~ s/([\\0-\\x1f\\x7f])/sprintf("\\\\x%.2X",ord $1)/sge}return '"' .$str .'"'}sub FormatJSON($$$;$) {local $_;my ($fp,$val,$ind,$quote)=@_;my$comma;if (not ref$val){print$fp EscapeJSON($val,$quote)}elsif (ref$val eq 'ARRAY'){if ($joinLists and not ref $$val[0]){print$fp EscapeJSON(join($listSep,@$val),$quote)}else {my ($bra,$ket)=$json==1 ? ('[',']'): ('Array(',')');print$fp $bra;for (@$val){print$fp ',' if$comma;FormatJSON($fp,$_,$ind,$quote);$comma=1,}print$fp $ket,}}elsif (ref$val eq 'HASH'){my ($bra,$ket,$sep)=$json==1 ? ('{','}',':'): ('Array(',')',' =>');print$fp $bra;for (OrderedKeys($val)){print$fp ',' if$comma;my$key=EscapeJSON($_,1);print$fp qq(\\n$ind  $key$sep );if ($showTagID and $_ eq 'id' and $showTagID eq 'H' and $$val{$_}=~ /^\\d+\\.\\d+$/){print$fp qq{"$$val{$_}"}}else {FormatJSON($fp,$$val{$_},"$ind  ",$quote)}$comma=1,}print$fp "\\n$ind$ket",}else {print$fp '"<err>"'}}sub FormatCSV($) {my$val=shift;if ($setCharset and ($val =~ /[^\\x09\\x0a\\x0d\\x20-\\x7e\\x80-\\xff]/ or ($setCharset eq 'UTF8' and Image::ExifTool::IsUTF8(\\$val)< 0))){$val='base64:' .Image::ExifTool::XMP::EncodeBase64($val,1)}$val=qq{"$val"} if$val =~ s/"/""/g or $val =~ /(^\\s+|\\s+$)/ or $val =~ /[\\n\\r]|\\Q$csvDelim/;return$val}sub PrintCSV(;$) {my$fp=shift || \\*STDOUT;my ($file,$lcTag,@tags);@csvTags or @csvTags=sort keys%csvTags;for$lcTag (@csvTags){push@tags,FormatCSV($csvTags{$lcTag})if$csvTags{$lcTag}}print$fp join($csvDelim,'SourceFile',@tags),"\\n";my$empty=defined($forcePrint)? $forcePrint : '';for$file (@csvFiles){my@vals=(FormatCSV($file));my$csvInfo=$database{$file};for$lcTag (@csvTags){next unless$csvTags{$lcTag};my$val=$$csvInfo{$lcTag};defined$val or push(@vals,$empty),next;push@vals,FormatCSV($val)}print$fp join($csvDelim,@vals),"\\n"}}sub AddGroups($$$$) {my ($val,$grp,$groupHash,$groupList)=@_;my ($key,$val2);if (ref$val eq 'HASH'){for$key (sort keys %$val){if ($key =~ /^(.*?):/ and not $$groupHash{$1}and $grp ne 'JSON'){$$groupHash{$1}=$grp;push @$groupList,$1}AddGroups($$val{$key},$grp,$groupHash,$groupList)if ref $$val{$key}}}elsif (ref$val eq 'ARRAY'){for$val2 (@$val){AddGroups($val2,$grp,$groupHash,$groupList)if ref$val2}}}sub ConvertBinary($) {my$obj=shift;my ($key,$val);if (ref$obj eq 'HASH'){for$key (keys %$obj){next unless ref $$obj{$key};$$obj{$key}=ConvertBinary($$obj{$key});return undef unless defined $$obj{$key}}}elsif (ref$obj eq 'ARRAY'){for$val (@$obj){next unless ref$val;$val=ConvertBinary($val);return undef unless defined$val}}elsif (ref$obj eq 'SCALAR'){return undef if$noBinary;if (defined$binaryOutput){$obj=$$obj;if ($json==1 and ($obj =~ /[^\\x09\\x0a\\x0d\\x20-\\x7e\\x80-\\xf7]/ or Image::ExifTool::IsUTF8(\\$obj)< 0)){$obj='base64:' .Image::ExifTool::XMP::EncodeBase64($obj,1)}}else {my$bOpt=$html ? '' : ', use -b option to extract';if ($$obj =~ /^Binary data \\d+ bytes$/){$obj="($$obj$bOpt)"}else {$obj='(Binary data ' .length($$obj)." bytes$bOpt)"}}}return$obj}sub IsEqual($$) {my ($a,$b)=@_;return 1 if$a eq $b or ref$a eq 'SCALAR';if (ref$a eq 'HASH' and ref$b eq 'HASH'){return 0 if scalar(keys %$a)!=scalar(keys %$b);my$key;for$key (keys %$a){return 0 unless IsEqual($$a{$key},$$b{$key})}}else {return 0 if ref$a ne 'ARRAY' or ref$b ne 'ARRAY' or @$a!=@$b;my$i;for ($i=0;$i<scalar(@$a);++$i){return 0 unless IsEqual($$a[$i],$$b[$i])}}return 1}sub Printable($) {my$val=shift;if (ref$val){if ($structOpt){require Image::ExifTool::XMP;$val=Image::ExifTool::XMP::SerializeStruct($mt,$val)}elsif (ref$val eq 'ARRAY'){$val=join($listSep,@$val)}elsif (ref$val eq 'SCALAR'){$val='(Binary data '.length($$val).' bytes)'}}if ($escapeC){$val =~ s/([\\0-\\x1f\\\\\\x7f])/$escC{$1} || sprintf('\\x%.2x', ord $1)/eg}else {$val =~ tr/\\x01-\\x1f\\x7f/./;$val =~ s/\\x00//g;$val =~ s/\\s+$//}return$val}sub LengthUTF8($) {my$str=shift;return length$str unless$fixLen;local$SIG{'__WARN__'}=sub {};if (not $$mt{OPTIONS}{EncodeHangs}and eval {require Encode}){$str=Encode::decode_utf8($str)}else {$str=pack('U0C*',unpack 'C*',$str)}my$len;if ($fixLen==1){$len=length$str}else {my$gcstr=eval {Unicode::GCString->new($str)};if ($gcstr){$len=$gcstr->columns}else {$len=length$str;delete$SIG{'__WARN__'};Warning($mt,'Unicode::GCString problem.  Columns may be misaligned');$fixLen=1}}return$len}sub AddSetTagsFile($;$) {my ($setFile,$opts)=@_;if ($setTags{$setFile}){$setTagsList{$setFile}or $setTagsList{$setFile}=[];push @{$setTagsList{$setFile}},$setTags{$setFile}}$setTags{$setFile}=[];push@newValues,{SaveCount=>++$saveCount },"TagsFromFile=$setFile";$opts or $opts={};$$opts{ProtectSaved}=$saveCount;push @{$setTags{$setFile}},$opts}sub Infile($;$) {my ($file,$bufferStdin)=@_;if ($file eq '-' and ($bufferStdin or $rafStdin)){if ($rafStdin){$rafStdin->Seek(0)}elsif (open RAF_STDIN,'-'){$rafStdin=File::RandomAccess->new(\\*RAF_STDIN);$rafStdin->BinMode()}return$rafStdin if$rafStdin}return$file}sub Warning($$) {my ($et,$str)=@_;my$noWarn=$et->Options('NoWarning');if (not defined$noWarn or not eval {$str =~ /$noWarn/}){Warn "Warning: $str\\n"}}sub DoSetFromFile($$$) {local $_;my ($et,$file,$setTags)=@_;$verbose and print$vout "Setting new values from $file\\n";my$info=$et->SetNewValuesFromFile(Infile($file,1),@$setTags);my$numSet=scalar(keys %$info);if ($$info{Error}){my@warns=grep /^(Error|Warning)\\b/,keys %$info;$numSet -= scalar(@warns);my$err=$$info{Error};delete $$info{$_}foreach@warns;my$noWarn=$et->Options('NoWarning');$$info{Warning}=$err unless defined$noWarn and eval {$err =~ /$noWarn/}}elsif ($$info{Warning}){my$warns=1;++$warns while $$info{"Warning ($warns)"};$numSet -= $warns}PrintErrors($et,$info,$file)and EFile($file),++$countBadWr,return 0;Warning($et,"No writable tags set from $file")unless$numSet;return 1}sub CleanFilename($) {$_[0]=~ tr/\\\\/\\// if Image::ExifTool::IsPC()}sub HasWildcards($) {my$path=shift;return 0 if $^O eq 'MSWin32' and $path =~ m{^[\\\\/]{2}\\?[\\\\/]};return$path =~ /[*?]/}sub CheckUTF8($$) {my ($file,$enc)=@_;my$isUTF8=0;if ($file =~ /[\\x80-\\xff]/){$isUTF8=Image::ExifTool::IsUTF8(\\$file);if ($isUTF8 < 0){if ($enc){Warn("Invalid filename encoding for $file\\n")}elsif (not defined$enc){WarnOnce(qq{FileName encoding not specified.  Use "-charset FileName=CHARSET"\\n})}}}return$isUTF8}sub SetWindowTitle($) {my$title=shift;if ($curTitle ne $title){$curTitle=$title;if ($^O eq 'MSWin32'){$title =~ s/([&\\/\\?:|"<>])/^$1/g;eval {system qq{title $title}}}else {printf STDERR "\\033]0;%s\\007",$title}}}sub ProcessFiles($;$) {my ($et,$list)=@_;my$enc=$et->Options('CharsetFileName');my$file;for$file (@files){$et->Options(CharsetFileName=>'UTF8')if$utf8FileName{$file};if (defined$progressMax){unless (defined$progressNext){$progressNext=$progressCount + $progressIncr;$progressNext -= $progressNext % $progressIncr;$progressNext=$progressMax if$progressNext > $progressMax}++$progressCount;if ($progress){if ($progressCount >= $progressNext){$progStr=" [$progressCount/$progressMax]"}else {undef$progStr}}}if ($et->IsDirectory($file)and not $listDir){$multiFile=$validFile=1;ScanDir($et,$file,$list)}elsif ($filterFlag and not AcceptFile($file)){if ($et->Exists($file)){$filtered=1;Progress($vout,"-------- $file (wrong extension)")if$verbose}else {Error "Error: File not found - $file\\n";FileNotFound($file)}}else {$validFile=1;if ($list){push(@$list,$file)}else {if (%endDir){my ($d,$f)=Image::ExifTool::SplitFileName($file);next if$endDir{$d}}GetImageInfo($et,$file);$end and Warn("End called - $file\\n");if ($endDir){Warn("EndDir called - $file\\n");my ($d,$f)=Image::ExifTool::SplitFileName($file);$endDir{$d}=1;undef$endDir}}}$et->Options(CharsetFileName=>$enc)if$utf8FileName{$file};last if$end}}sub ScanDir($$;$) {local $_;my ($et,$dir,$list)=@_;my (@fileList,$done,$file,$utf8Name,$winSurrogate,$endThisDir);my$enc=$et->Options('CharsetFileName');if ($enc){unless ($enc eq 'UTF8'){$dir=$et->Decode($dir,$enc,undef,'UTF8');$et->Options(CharsetFileName=>'UTF8')}$utf8Name=1}return if$ignore{$dir};if ($^O eq 'MSWin32' and not HasWildcards($dir)){undef$evalWarning;local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};;if (CheckUTF8($dir,$enc)>= 0){if (eval {require Win32::FindFile}){eval {@fileList=Win32::FindFile::ReadDir($dir);$_=$_->cFileName foreach@fileList};$@ and $evalWarning=$@;if ($evalWarning){chomp$evalWarning;$evalWarning =~ s/ at .*//s;Warning($et,"[Win32::FindFile] $evalWarning - $dir");$winSurrogate=1 if$evalWarning =~ /surrogate/}else {$et->Options(CharsetFileName=>'UTF8');$utf8Name=1;$done=1}}else {$done=0}}}unless ($done){unless (opendir(DIR_HANDLE,$dir)){Warn("Error opening directory $dir\\n");return}@fileList=readdir(DIR_HANDLE);closedir(DIR_HANDLE);if (defined$done){for$file ($dir,@fileList){next unless$file =~ /[\\?\\x80-\\xff]/;WarnOnce("Install Win32::FindFile to support Windows Unicode file names in directories\\n");last}}}$dir =~ /\\/$/ or $dir .= '/';for$file (@fileList){next if$file eq '.' or $file eq '..';my$path="$dir$file";if ($et->IsDirectory($path)){next unless$recurse;next if$file =~ /^\\./ and $recurse==1;next if$ignore{$file}or ($ignore{SYMLINKS}and -l $path);ScanDir($et,$path,$list);last if$end;next}next if$endThisDir;next if$ignoreHidden and $file =~ /^\\./;my$accepted;if ($filterFlag){$accepted=AcceptFile($file)or next;$accepted &= 0x01}unless ($accepted){if ($scanWritable){if ($scanWritable eq '1'){next unless CanWrite($file)}else {my$type=GetFileType($file);next unless defined$type and $type eq $scanWritable}}elsif (not GetFileType($file)){next unless$doUnzip;next unless$file =~ /\\.(gz|bz2)$/i}}if ($winSurrogate and $isWriting and (not $overwriteOrig or $overwriteOrig!=2)and not $doSetFileName and $file =~ /~/){Warn("Not writing $path\\n");WarnOnce("Use -overwrite_original_in_place to write files with Unicode surrogate characters\\n");EFile($file);++$countBad;next}$utf8FileName{$path}=1 if$utf8Name;if ($list){push(@$list,$path)}else {GetImageInfo($et,$path);if ($end){Warn("End called - $file\\n");last}if ($endDir){$path =~ s(/$)();Warn("EndDir called - $path\\n");$endDir{$path}=1;$endThisDir=1;undef$endDir}}}++$countDir;$et->Options(CharsetFileName=>$enc)}sub FindFileWindows($$) {my ($et,$wildfile)=@_;my$enc=$et->Options('CharsetFileName');$wildfile=$et->Decode($wildfile,$enc,undef,'UTF8')if$enc and $enc ne 'UTF8';$wildfile =~ tr/\\\\/\\//;my ($dir,$wildname)=($wildfile =~ m{(.*[:/])(.*)})? ($1,$2): ('',$wildfile);if (HasWildcards($dir)){Warn "Wildcards don't work in the directory specification\\n";return ()}CheckUTF8($wildfile,$enc)>= 0 or return ();undef$evalWarning;local$SIG{'__WARN__'}=sub {$evalWarning=$_[0]};my@files;eval {my@names=Win32::FindFile::FindFile($wildfile)or return;@names=sort {uc($a)cmp uc($b)}@names;my ($rname,$nm);($rname=quotemeta$wildname)=~ s/\\\\\\?/./g;$rname =~ s/\\\\\\*/.*/g;for$nm (@names){$nm=$nm->cFileName;next unless$nm =~ /^$rname$/i;next if$nm eq '.' or $nm eq '..';my$file="$dir$nm";push@files,$file;$utf8FileName{$file}=1}};$@ and $evalWarning=$@;if ($evalWarning){chomp$evalWarning;$evalWarning =~ s/ at .*//s;Warn "Error: [Win32::FindFile] $evalWarning - $wildfile\\n";undef@files;EFile($wildfile);++$countBad}return@files}sub FileNotFound($) {my$file=shift;if ($file =~ /^(DIR|FILE)$/){my$type={DIR=>'directory',FILE=>'file' }->{$file};Warn qq{You were meant to enter any valid $type name, not "$file" literally.\\n}}}sub PreserveTime() {local $_;$mt->SetFileTime($_,@{$preserveTime{$_}})foreach keys%preserveTime;undef%preserveTime}sub AbsPath($) {my$file=shift;my$path;if (defined$file){return undef if$file eq '*';if ($^O eq 'MSWin32' and $mt->Options('WindowsLongPath')){$path=$mt->WindowsLongPath($file)}elsif (eval {require Cwd}){local$SIG{'__WARN__'}=sub {};$path=eval {Cwd::abs_path($file)}}$path =~ tr/\\\\/\\// if $^O eq 'MSWin32' and defined$path}return$path}sub MyConvertFileName($$) {my ($et,$file)=@_;my$enc=$et->Options('CharsetFileName');$et->Options(CharsetFileName=>'UTF8')if$utf8FileName{$file};my$convFile=$et->ConvertFileName($file);$et->Options(CharsetFileName=>$enc)if$utf8FileName{$file};return$convFile}sub AddPrintFormat($) {my$expr=shift;my$type;if ($expr =~ /^#/){$expr =~ s/^#\\[(HEAD|SECT|IF|BODY|ENDS|TAIL)\\]// or return;$type=$1}else {$type='BODY'}$printFmt{$type}or $printFmt{$type}=[];push @{$printFmt{$type}},$expr;push@requestTags,$expr =~ /\\$\\{?((?:[-_0-9A-Z]+:)*[-_0-9A-Z?*]+)/ig;$printFmt{SetTags}=1 if$expr =~ /\\bSetTags\\b/}sub SuggestedExtension($$$) {my ($et,$valPt,$tag)=@_;my$ext;if (not $binaryOutput){$ext='txt'}elsif ($$valPt =~ /^\\xff\\xd8\\xff/){$ext='jpg'}elsif ($$valPt =~ /^(\\0\\0\\0\\x0cjP(  |\\x1a\\x1a)\\x0d\\x0a\\x87\\x0a|\\xff\\x4f\\xff\\x51\\0)/){$ext='jp2'}elsif ($$valPt =~ /^(\\x89P|\\x8aM|\\x8bJ)NG\\r\\n\\x1a\\n/){$ext='png'}elsif ($$valPt =~ /^GIF8[79]a/){$ext='gif'}elsif ($$valPt =~ /^<\\?xpacket/ or $tag eq 'XMP'){$ext='xmp'}elsif ($$valPt =~ /^<\\?xml/ or $tag eq 'XML'){$ext='xml'}elsif ($$valPt =~ /^RIFF....WAVE/s){$ext='wav'}elsif ($tag eq 'OriginalRawImage' and defined($ext=$et->GetValue('OriginalRawFileName'))){$ext =~ s/^.*\\.//s;$ext=$ext ? lc($ext): 'raw'}elsif ($tag eq 'EXIF'){$ext='exif'}elsif ($tag eq 'ICC_Profile'){$ext='icc'}elsif ($$valPt =~ /^(MM\\0\\x2a|II\\x2a\\0)/){$ext='tiff'}elsif ($$valPt =~ /^.{4}ftyp(3gp|mp4|f4v|qt  )/s){my%movType=('qt  '=>'mov');$ext=$movType{$1}|| $1}elsif ($$valPt !~ /^.{0,4096}\\0/s){$ext='txt'}elsif ($$valPt =~ /^BM.{15}\\0/s){$ext='bmp'}elsif ($$valPt =~ /^CANON OPTIONAL DATA\\0/){$ext='vrd'}elsif ($$valPt =~ /^IIII\\x04\\0\\x04\\0/){$ext='dr4'}elsif ($$valPt =~ /^(.{10}|.{522})(\\x11\\x01|\\x00\\x11)/s){$ext='pict'}elsif ($$valPt =~ /^\\xff\\x0a|\\0\\0\\0\\x0cJXL \\x0d\\x0a......ftypjxl/s){$ext='jxl'}elsif ($$valPt =~ /^.{4}jumb\\0.{3}jumdc2pa/s){$ext='c2pa'}elsif ($tag eq 'JUMBF'){$ext='jumbf'}else {$ext='dat'}return$ext}sub LoadPrintFormat($;$) {my ($arg,$noNL)=@_;if (not defined$arg){Error "Must specify file or expression for -p option\\n"}elsif ($arg !~ /\\n/ and -f $arg and $mt->Open(\\*FMT_FILE,$arg)){for (<FMT_FILE>){AddPrintFormat($_)}close(FMT_FILE)}else {$arg .= "\\n" unless$noNL;AddPrintFormat($arg)}}sub FilenameSPrintf($;$@) {my ($fmt,$file,@extra)=@_;local $_;return$fmt unless$fmt =~ /%[-+]?\\d*[.:]?\\d*[lu]?[dDfFeEtgso]/;return undef unless defined$file;CleanFilename($file);my%part;@part{qw(d f E)}=($file =~ /^(.*?)([^\\/]*?)(\\.[^.\\/]*)?$/);defined$part{f}or Warn("Error: Bad pattern match for file $file\\n"),return undef;if ($part{E}){$part{e}=substr($part{E},1)}else {@part{qw(e E)}=('','')}$part{F}=$part{f}.$part{E};($part{D}=$part{d})=~ s{/+$}{};@part{qw(t g s o)}=@extra;my ($filename,$pos)=('',0);while ($fmt =~ /(%([-+]?)(\\d*)([.:]?)(\\d*)([lu]?)([dDfFeEtgso]))/g){$filename .= substr($fmt,$pos,pos($fmt)- $pos - length($1));$pos=pos($fmt);my ($sign,$wid,$dot,$skip,$mod,$code)=($2,$3,$4,$5 || 0,$6,$7);my (@path,$part,$len,$groups);if (lc$code eq 'd' and $dot and $dot eq ':'){@path=split '/',$part{$code};$len=scalar@path}else {if ($code eq 'g'){$groups=$part{g}|| []unless defined$groups;$fmt =~ /\\G(\\d?)/g;$part{g}=$$groups[$1 || 0];$pos=pos($fmt)}$part{$code}='' unless defined$part{$code};$len=length$part{$code}}next unless$skip < $len;$wid=$len - $skip if$wid eq '' or $wid + $skip > $len;$skip=$len - $wid - $skip if$sign eq '-';if (@path){$part=join('/',@path[$skip..($skip+$wid-1)]);$part .= '/' unless$code eq 'D'}else {$part=substr($part{$code},$skip,$wid)}$part=($mod eq 'u')? uc($part): lc($part)if$mod;$filename .= $part}$filename .= substr($fmt,$pos);$filename =~ s{(?!^)//}{/}g;return$filename}sub Num2Alpha($) {my$num=shift;my$alpha=chr(97 + ($num % 26));while ($num >= 26){$num=int($num / 26)- 1;$alpha=chr(97 + ($num % 26)).$alpha}return$alpha}sub NextUnusedFilename($;$) {my ($fmt,$okfile)=@_;return$fmt unless$fmt =~ /%[-+]?\\d*[.:]?\\d*[lun]?[cC]/;my%sep=('-'=>'-','+'=>'_');my ($copy,$alpha)=(0,'a');my$lastFile;for (;;){my ($filename,$pos)=('',0);while ($fmt =~ /(%([-+]?)(\\d*)([.:]?)(\\d*)([lun]?)([cC]))/g){$filename .= substr($fmt,$pos,pos($fmt)- $pos - length($1));$pos=pos($fmt);my ($sign,$wid,$dec,$wid2,$mod,$tok)=($2,$3 || 0,$4,$5 || 0,$6,$7);my$seq;if ($tok eq 'C'){$sign eq '-' ? ++$seqFileDir : ++$seqFileNum if$copy and $dec eq ':';$seq=$wid + ($sign eq '-' ? $seqFileDir : $seqFileNum)- 1;$wid=$wid2}else {next unless$dec or $copy;$wid=$wid2 if$wid < $wid2;$filename .= $sep{$sign}if$sign}if ($mod and $mod ne 'n'){my$a=$tok eq 'C' ? Num2Alpha($seq): $alpha;my$str=($wid and $wid > length$a)? 'a' x ($wid - length($a)): '';$str .= $a;$str=uc$str if$mod eq 'u';$filename .= $str}else {my$c=$tok eq 'C' ? $seq : $copy;my$num=$c + ($mod ? 1 : 0);$filename .= $wid ? sprintf("%.\${wid}d",$num): $num}}$filename .= substr($fmt,$pos);return$filename unless ($mt->Exists($filename,1)and not defined$usedFileName{$filename})or $usedFileName{$filename};if (defined$okfile){return$filename if$filename eq $okfile;my ($fn,$ok)=(AbsPath($filename),AbsPath($okfile));return$okfile if defined$fn and defined$ok and $fn eq $ok}return$filename if defined$lastFile and $lastFile eq $filename;$lastFile=$filename;++$copy;++$alpha}}sub CreateDirectory($) {my$file=shift;my$err=$mt->CreateDirectory($file);if (defined$err){$err and Error("$err\\n"),return 0;if ($verbose){my$dir;($dir=$file)=~ s(/[^/]*$)();print$vout "Created directory $dir\\n"}++$countNewDir;return 1}return 0}sub OpenOutputFile($;@) {my ($file,@args)=@_;my ($fp,$outfile,$append);if ($textOut){$outfile=$file;CleanFilename($outfile);if ($textOut =~ /%[-+]?\\d*[.:]?\\d*[lun]?[dDfFeEtgsocC]/ or defined$tagOut){$outfile=FilenameSPrintf($textOut,$file,@args);return ()unless defined$outfile;$outfile=NextUnusedFilename($outfile);CreateDirectory($outfile)}else {$outfile =~ s/\\.[^.\\/]*$//;$outfile .= $textOut}my$mode='>';if ($mt->Exists($outfile,1)){unless ($textOverwrite){Warn "Output file $outfile already exists for $file\\n";return ()}if ($textOverwrite==2 or ($textOverwrite==3 and $created{$outfile})){$mode='>>';$append=1}}unless ($mt->Open(\\*OUTFILE,$outfile,$mode)){my$what=$mode eq '>' ? 'creating' : 'appending to';Error("Error $what $outfile\\n");return ()}binmode(OUTFILE)if$binaryOutput;$fp=\\*OUTFILE}else {$fp=\\*STDOUT}return($fp,$outfile,$append)}sub AcceptFile($) {my$file=shift;my$ext=($file =~ /^.*\\.(.+)$/s)? uc($1): '';return$filterExt{$ext}if defined$filterExt{$ext};return$filterExt{'*'}if defined$filterExt{'*'};return 0 if$filterFlag & 0x02;return 2}sub SlurpFile($$) {my ($file,$buffPt)=@_;$mt->Open(\\*INFILE,$file)or Warn("Error opening file $file\\n"),return 0;binmode(INFILE);undef $$buffPt;my$bsize=1024 * 1024;my$num=read(INFILE,$$buffPt,$bsize);unless (defined$num){close(INFILE);Warn("Error reading $file\\n");return 0}my$bmax=64 * $bsize;while ($num==$bsize){$bsize *= 2 if$bsize < $bmax;my$buff;$num=read(INFILE,$buff,$bsize);last unless$num;$$buffPt .= $buff}close(INFILE);return 1}sub FilterArgfileLine($) {my$arg=shift;if ($arg =~ /^#/){return undef unless$arg =~ s/^#\\[CSTR\\]//;$arg =~ s/[\\x0d\\x0a]+$//s;$arg =~ s{\\\\(.)|(["\\$\\@]|\\\\$)}{'\\\\'.($2 || $1)}sge;my%esc=(a=>"\\a",b=>"\\b",f=>"\\f",n=>"\\n",r=>"\\r",t=>"\\t",'"'=>'"','\\\\'=>'\\\\');$arg =~ s/\\\\(.)/$esc{$1}||'\\\\'.$1/egs}else {$arg =~ s/^\\s+//;$arg =~ s/[\\x0d\\x0a]+$//s;$arg =~ s/^(-[-_0-9A-Z:]+#?)\\s*([-+<]?=) ?/$1$2/i;return undef if$arg eq ''}return$arg}sub ReadStayOpen($) {my$args=shift;my (@newArgs,$processArgs,$result,$optArgs);my$lastOpt='';my$unparsed=length$stayOpenBuff;for (;;){if ($unparsed){$result=$unparsed;undef$unparsed}else {$result=sysread(STAYOPEN,$stayOpenBuff,65536,length($stayOpenBuff))}if ($result){my$pos=0;while ($stayOpenBuff =~ /\\n/g){my$len=pos($stayOpenBuff)- $pos;my$arg=substr($stayOpenBuff,$pos,$len);$pos += $len;$arg=FilterArgfileLine($arg);next unless defined$arg;push@newArgs,$arg;if ($optArgs){undef$optArgs;next unless$lastOpt eq '-stay_open' or $lastOpt eq '-@'}else {$lastOpt=lc$arg;$optArgs=$optArgs{$arg};unless (defined$optArgs){$optArgs=$optArgs{$lastOpt};$optArgs=$optArgs{"$1#$2"}if not defined$optArgs and $lastOpt =~ /^(.*?)\\d+(!?)$/}next unless$lastOpt =~ /^-execute\\d*$/}$processArgs=1;last}next unless$pos;$stayOpenBuff=substr($stayOpenBuff,$pos);if ($processArgs){unshift @$args,@newArgs;last}}elsif ($result==0){select(undef,undef,undef,0.01)}else {Warn "Error reading from ARGFILE\\n";close STAYOPEN;$stayOpen=0;last}}}sub EFile($$) {my$entry=shift;my$efile=$efile[shift || 0];if (defined$efile and length$entry and $entry ne '-'){my$err;CreateDirectory($efile);if ($mt->Open(\\*EFILE_FILE,$efile,'>>')){print EFILE_FILE$entry,"\\n" or Warn("Error writing to $efile\\n"),$err=1;close EFILE_FILE}else {Warn("Error opening '\${efile}' for append\\n");$err=1}if ($err){defined $_ and $_ eq $efile and undef $_ foreach@efile}}}sub Progress($$) {my ($file,$msg)=@_;if (defined$progStr){print$file $msg,$progStr,"\\n";undef$progressNext if defined$progressMax}}sub PrintTagList($@) {my$msg=shift;print$msg,":\\n" unless$quiet;my$tag;if (($outFormat < 0 or $verbose)and $msg =~ /file extensions$/ and @_){for$tag (@_){printf("  %-11s %s\\n",$tag,GetFileType($tag,1))}return}my ($len,$pad)=(0,$quiet ? '' : '  ');for$tag (@_){my$taglen=length($tag);if ($len + $taglen > 77){print "\\n";($len,$pad)=(0,$quiet ? '' : '  ')}print$pad,$tag;$len += $taglen + 1;$pad=' '}@_ or print$pad,'[empty list]';print "\\n"}sub PrintErrors($$$) {my ($et,$info,$file)=@_;my ($tag,$key);for$tag (qw(Warning Error)){next unless $$info{$tag};my@keys=($tag);push@keys,sort(grep /^$tag /,keys %$info)if$et->Options('Duplicates');for$key (@keys){Warn "$tag: $info->{$key} - $file\\n"}}return $$info{Error}}`,id=td,b=class gi{static WASI_ESUCCESS=0;static WASI_ERRNO_BADF=8;static WASI_ENOSYS=52;static WASI_CLOCK_REALTIME=0;static WASI_CLOCK_MONOTONIC=1;static WASI_ERRNO_ISDIR=31;static WASI_ERRNO_INVAL=28;static WASI_ERRNO_NOTDIR=54;static WASI_ERRNO_NOENT=44;static WASI_ERRNO_EXIST=20;static WASI_ERRNO_IO=29;static WASI_FILETYPE_CHARACTER_DEVICE=2;static WASI_FILETYPE_DIRECTORY=3;static WASI_FILETYPE_REGULAR_FILE=4;static IMPORT_FUNCTIONS=["args_get","args_sizes_get","clock_res_get","clock_time_get","environ_get","environ_sizes_get","fd_advise","fd_allocate","fd_close","fd_datasync","fd_fdstat_get","fd_fdstat_set_flags","fd_fdstat_set_rights","fd_filestat_get","fd_filestat_set_size","fd_filestat_set_times","fd_pread","fd_prestat_dir_name","fd_prestat_get","fd_pwrite","fd_read","fd_readdir","fd_renumber","fd_seek","fd_sync","fd_tell","fd_write","path_create_directory","path_filestat_get","path_filestat_set_times","path_link","path_open","path_readlink","path_remove_directory","path_rename","path_symlink","path_unlink_file","poll_oneoff","proc_exit","proc_raise","random_get","sched_yield","sock_accept","sock_recv","sock_send","sock_shutdown"];encoder;decoder;constructor(){this.encoder=new TextEncoder,this.decoder=new TextDecoder}writeString(t,i,s){let n=this.encoder.encode(i);return new Uint8Array(t.buffer,s,n.length).set(n),n.length}readString(t,i,s){let n=new Uint8Array(t.buffer,i,s);return this.decoder.decode(n)}byteLength(t){return this.encoder.encode(t).length}static iovec_t={size:8,bufferOffset:0,lengthOffset:4};iovViews(t,i,s){let n=[],r=i;for(let a=0;a<s;a++){let o=t.getUint32(r+gi.iovec_t.bufferOffset,!0),l=t.getUint32(r+gi.iovec_t.lengthOffset,!0);n.push(new Uint8Array(t.buffer,o,l)),r+=gi.iovec_t.size}return n}writeFilestat(t,i,s){t.setBigUint64(i,BigInt(0),!0),t.setBigUint64(i+8,BigInt(0),!0),t.setUint8(i+16,s),t.setUint32(i+24,0,!0),t.setBigUint64(i+32,BigInt(0),!0),t.setBigUint64(i+40,BigInt(0),!0),t.setBigUint64(i+48,BigInt(0),!0)}writeFdstat(t,i,s,n){t.setUint8(i,s),t.setUint16(i+2,n,!0),t.setBigUint64(i+8,BigInt(0),!0),t.setBigUint64(i+16,BigInt(0),!0)}},Gr=class{constructor(t){this.code=t}get exitCode(){return this.code}},Pn=class{constructor(t,i){this.handler=t,this.outputBuffers=i}decoder=new TextDecoder("utf-8");writev(t){let i=t.reduce((r,a)=>r+a.byteLength,0),s=0,n=new Uint8Array(i);for(let r of t)n.set(r,s),s+=r.byteLength;if(this.outputBuffers)this.handler(n);else{let r=this.decoder.decode(n);this.handler(r)}return n.length}readv(t){return 0}close(){}},sd=class{constructor(t){this.consume=t}encoder=new TextEncoder;pending=null;writev(t){return 0}consumePending(t,i){if(t.byteLength<i)return this.pending=null,t;let s=t.slice(0,i);return this.pending=t.slice(i),s}readv(t){let i=0;for(let s of t){let n=s.byteLength;if(this.pending){let r=this.consumePending(this.pending,n);s.set(r,0),n-=r.byteLength,i+=r.byteLength}for(;n>0;){let r=this.consume(),a;if(r instanceof Uint8Array?a=r:a=this.encoder.encode(r),a.length===0)return i;a.length>n?(s.set(a.slice(0,n),s.byteLength-n),this.pending=a.slice(n),i+=n,n=0):(s.set(a,s.byteLength-n),i+=a.length,n-=a.length)}}return i}close(){}};function nd(e={}){let t=e.outputBuffers||!1;return[new sd(e.stdin||(()=>"")),new Pn(e.stdout||console.log,t),new Pn(e.stderr||console.error,t)]}var Vr=class{root;preopenPaths=[];constructor(t){if(this.root={type:"dir",entries:{}},this.ensureDir("/dev"),this.setNode("/dev/null",{type:"character",kind:"devnull"}),t)for(let i of Object.keys(t))this.ensureDir(i),this.preopenPaths.push(i);else this.preopenPaths.push("/")}removeFile(t){let i=this.normalizePath(t).split("/").filter(a=>a.length>0),s=i.pop(),n=`/${i.join("/")}`,r=this.ensureDir(n);s&&delete r.entries[s]}addFile(t,i){if(typeof i=="string"){let s=new TextEncoder().encode(i);this.createFile(t,s);return}this.createFile(t,i)}createFile(t,i){let s={type:"file",content:i};return this.setNode(t,s),s}setNode(t,i){let s=this.normalizePath(t).split("/").filter(o=>o.length>0);if(s.length===0){if(i.type!=="dir")throw new Error("Root must be a directory");this.root=i;return}let n=s.pop(),r=`/${s.join("/")}`,a=this.ensureDir(r);n&&(a.entries[n]=i)}getDevNull(){let t=this.lookup("/dev/null");if(!t)throw new Error("/dev/null not found");return t}getPreopenPaths(){return[...this.preopenPaths]}lookup(t){let i=this.normalizePath(t);if(i==="/")return this.root;let s=i.split("/").filter(r=>r.length>0),n=this.root;for(let r of s)if(n.type!=="dir"||(n=n.entries[r],!n))return null;return n}resolve(t,i){let s=this.normalizePath(i).split("/").filter(r=>r.length>0),n=t;for(let r of s)if(r!=="."){if(r===".."){n=this.root;continue}if(n.type!=="dir"||(n=n.entries[r],!n))return null}return n}ensureDir(t){let i=this.normalizePath(t).split("/").filter(n=>n.length>0),s=this.root;for(let n of i){s.entries[n]||(s.entries[n]={type:"dir",entries:{}});let r=s.entries[n];if(r.type!=="dir")throw new Error(`"${n}" is not a directory`);s=r}return s}createFileIn(t,i){let s=this.normalizePath(i).split("/").filter(o=>o.length>0);if(s.length===0)throw new Error("Cannot create a file with an empty name");let n=s.pop();if(!n)throw new Error("Cannot create a file with an empty name");let r=t;for(let o of s){r.entries[o]||(r.entries[o]={type:"dir",entries:{}});let l=r.entries[o];if(l.type!=="dir")throw new Error(`"${o}" is not a directory`);r=l}let a={type:"file",content:new Uint8Array(0)};return r.entries[n]=a,a}normalizePath(t){if(!t)return"/";let i=(t.startsWith("/")?t:`/${t}`).replace(/\/+/g,"/");return i==="/"?i:i.replace(/\/+$/,"")}};function rd(e={}){return(t,i,s)=>{let n=e.withFileSystem||new Vr(t.preopens),r={};nd(e.withStdIo||{}).forEach((c,f)=>{r[f]={node:{type:"character",kind:"stdio",entry:c},position:0,isPreopen:!1,path:`/dev/fd/${f}`,fd:f}});let a=3;for(let c of n.getPreopenPaths()){let f=n.lookup(c);f&&f.type==="dir"&&(r[a]={node:f,position:0,isPreopen:!0,preopenPath:c,path:c,fd:a},a++)}function o(c){for(let f in r){let u=r[f];if(u.path===c)return u}return null}function l(c){return r[c]||null}function d(c){return c.content instanceof Blob?c.content.size:c.content.byteLength}return{fd_read:async(c,f,u,h)=>{let m=s(),x=i.iovViews(m,f,u),p=l(c);if(!p)return b.WASI_ERRNO_BADF;if(p.node.type==="character"&&p.node.kind==="stdio"){let F=p.node.entry.readv(x);return m.setUint32(h,F,!0),b.WASI_ESUCCESS}if(p.node.type==="dir")return b.WASI_ERRNO_ISDIR;if(p.node.type==="character"&&p.node.kind==="devnull")return m.setUint32(h,0,!0),b.WASI_ESUCCESS;let S=p.node,w=S.content,C=d(S)-p.position,U=0;if(C<=0)return m.setUint32(h,0,!0),b.WASI_ESUCCESS;if(S.content instanceof Blob){let F=S.content;for(let I of x){if(p.position>=F.size)break;let P=Math.min(I.byteLength,F.size-p.position);if(P<=0)break;let _=await F.slice(p.position,p.position+P).arrayBuffer();I.set(new Uint8Array(_)),U+=_.byteLength,p.position+=_.byteLength}}else if(ArrayBuffer.isView(w))for(let F of x){if(p.position>=w.byteLength)break;let I=Math.min(F.byteLength,w.byteLength-p.position);if(I<=0)break;F.set(w.slice(p.position,p.position+I)),U+=I,p.position+=I}return m.setUint32(h,U,!0),b.WASI_ESUCCESS},fd_write:(c,f,u,h)=>{let m=s(),x=i.iovViews(m,f,u),p=l(c);if(!p)return b.WASI_ERRNO_BADF;let S=0;if(p.node.type==="character"&&p.node.kind==="stdio"){let I=p.node.entry.writev(x);return m.setUint32(h,I,!0),b.WASI_ESUCCESS}if(p.node.type==="dir")return b.WASI_ERRNO_ISDIR;if(p.node.type==="character"&&p.node.kind==="devnull"){let I=x.reduce((P,_)=>P+_.byteLength,0);return m.setUint32(h,I,!0),b.WASI_ESUCCESS}if(p.node.content instanceof Blob)return b.WASI_ERRNO_INVAL;let w=p.position,C=x.reduce((I,P)=>I+P.byteLength,0),U=w+C,F;U>d(p.node)?(F=new Uint8Array(U),F.set(p.node.content,0)):F=p.node.content;for(let I of x)F.set(I,w),w+=I.byteLength,S+=I.byteLength;return p.node.content=F,p.position=w,m.setUint32(h,S,!0),b.WASI_ESUCCESS},fd_close:c=>{let f=l(c);return f?f.node.type==="character"&&f.node.kind==="stdio"?(f.node.entry.close(),b.WASI_ESUCCESS):(delete r[c],b.WASI_ESUCCESS):b.WASI_ERRNO_BADF},fd_seek:(c,f,u,h)=>{let m=s();if(c<3)return b.WASI_ERRNO_BADF;let x=l(c);if(!x||x.node.type!=="file")return b.WASI_ERRNO_BADF;let p=x.position,S=d(x.node);switch(u){case 0:p=Number(f);break;case 1:p=p+Number(f);break;case 2:p=S+Number(f);break;default:return b.WASI_ERRNO_INVAL}return p<0&&(p=0),x.position=p,m.setUint32(h,p,!0),b.WASI_ESUCCESS},fd_tell:(c,f)=>{let u=s();if(c<3)return b.WASI_ERRNO_BADF;let h=l(c);return h?(u.setBigUint64(f,BigInt(h.position),!0),b.WASI_ESUCCESS):b.WASI_ERRNO_BADF},fd_fdstat_get:(c,f)=>{let u=s(),h=l(c);if(!h)return b.WASI_ERRNO_BADF;let m;switch(h.node.type){case"character":m=b.WASI_FILETYPE_CHARACTER_DEVICE;break;case"dir":m=b.WASI_FILETYPE_DIRECTORY;break;case"file":m=b.WASI_FILETYPE_REGULAR_FILE;break}return i.writeFdstat(u,f,m,0),b.WASI_ESUCCESS},fd_filestat_get:(c,f)=>{let u=s(),h=l(c);if(!h)return b.WASI_ERRNO_BADF;let m,x=0;switch(h.node.type){case"character":m=b.WASI_FILETYPE_CHARACTER_DEVICE;break;case"dir":m=b.WASI_FILETYPE_DIRECTORY;break;case"file":m=b.WASI_FILETYPE_REGULAR_FILE,x=d(h.node);break}return i.writeFilestat(u,f,m),u.setBigUint64(f+32,BigInt(x),!0),b.WASI_ESUCCESS},fd_prestat_get:(c,f)=>{let u=s();if(c<3)return b.WASI_ERRNO_BADF;let h=l(c);if(!h||!h.isPreopen)return b.WASI_ERRNO_BADF;u.setUint8(f,0);let m=h.preopenPath||"";return u.setUint32(f+4,m.length,!0),b.WASI_ESUCCESS},fd_prestat_dir_name:(c,f,u)=>{if(c<3)return b.WASI_ERRNO_BADF;let h=l(c);if(!h||!h.isPreopen)return b.WASI_ERRNO_BADF;let m=h.preopenPath||"";if(m.length!==u)return b.WASI_ERRNO_INVAL;let x=s();for(let p=0;p<m.length;p++)x.setUint8(f+p,m.charCodeAt(p));return b.WASI_ESUCCESS},fd_open:(c,f,u,h,m,x,p,S)=>{let w=s();if(c<3)return b.WASI_ERRNO_NOTDIR;let C=l(c);if(!C||C.node.type!=="dir")return b.WASI_ERRNO_NOTDIR;let U=i.readString(w,f,u),F=(C.path.endsWith("/")?C.path:`${C.path}/`)+U,I=o(F);if(I)return w.setUint32(S,I.fd,!0),b.WASI_ESUCCESS;let P=n.resolve(C.node,U),_=1,V=2,A=4;if(P){if(h&V)return b.WASI_ERRNO_EXIST;if(h&A){if(P.type!=="file")return b.WASI_ERRNO_INVAL;P.content=new Uint8Array(0)}}else{if(!(h&_))return b.WASI_ERRNO_NOENT;P=n.createFileIn(C.node,U)}return r[a]={node:P,position:0,isPreopen:!1,path:F,fd:a},w.setUint32(S,a,!0),a++,b.WASI_ESUCCESS},path_open:(c,f,u,h,m,x,p,S,w)=>{let C=s();if(c<3)return b.WASI_ERRNO_NOTDIR;let U=l(c);if(!U||U.node.type!=="dir")return b.WASI_ERRNO_NOTDIR;let F=i.readString(C,u,h),I=(U.path.endsWith("/")?U.path:`${U.path}/`)+F,P=o(I);if(P)return C.setUint32(w,P.fd,!0),b.WASI_ESUCCESS;let _=n.resolve(U.node,F),V=1,A=2,Ee=4;if(_){if(m&A)return b.WASI_ERRNO_EXIST;if(m&Ee){if(_.type!=="file")return b.WASI_ERRNO_INVAL;_.content=new Uint8Array(0)}}else{if(!(m&V))return b.WASI_ERRNO_NOENT;_=n.createFileIn(U.node,F)}return r[a]={node:_,position:0,isPreopen:!1,path:I,fd:a},C.setUint32(w,a,!0),a++,b.WASI_ESUCCESS},path_filestat_get:(c,f,u,h,m)=>{let x=s(),p=l(c);if(!p)return b.WASI_ERRNO_BADF;if(p.node.type!=="dir")return b.WASI_ERRNO_NOTDIR;let S=i.readString(x,u,h),w=p.path,C=w.endsWith("/")?w+S:`${w}/${S}`,U=n.lookup(C);if(!U)return b.WASI_ERRNO_NOENT;if(U.type==="character"&&U.kind==="stdio")return b.WASI_ERRNO_INVAL;let F,I=0;return U.type==="dir"?F=b.WASI_FILETYPE_DIRECTORY:U.type==="character"&&U.kind==="devnull"?F=b.WASI_FILETYPE_CHARACTER_DEVICE:(F=b.WASI_FILETYPE_REGULAR_FILE,I=d(U)),i.writeFilestat(x,m,F),x.setBigUint64(m+32,BigInt(I),!0),b.WASI_ESUCCESS}}}}function ad(e,t,i){let s=e.args||[];return{args_get:(n,r)=>{let a=n,o=r,l=i();for(let d of s)l.setUint32(a,o,!0),a+=4,o+=t.writeString(l,`${d}\0`,o);return b.WASI_ESUCCESS},args_sizes_get:(n,r)=>{let a=i();a.setUint32(n,s.length,!0);let o=s.reduce((l,d)=>l+t.byteLength(d)+1,0);return a.setUint32(r,o,!0),b.WASI_ESUCCESS}}}function od(e,t,i){return{clock_res_get:(s,n)=>{let r;switch(s){case b.WASI_CLOCK_MONOTONIC:{r=5e3;break}case b.WASI_CLOCK_REALTIME:{r=1e3;break}default:return b.WASI_ENOSYS}return i().setUint32(n,r,!0),b.WASI_ESUCCESS},clock_time_get:(s,n,r)=>{let a=0;switch(s){case b.WASI_CLOCK_MONOTONIC:{a=performance.now();break}case b.WASI_CLOCK_REALTIME:{a=Date.now();break}default:return b.WASI_ENOSYS}let o=i();if(BigInt){let l=BigInt((d=>{let c=Math.trunc(d),f=BigInt(Math.round((d-c)*1e6));return BigInt(c)*BigInt(1e6)+f})(a));o.setBigUint64(r,l,!0)}else{let l=Date.now()*1e6;o.setUint32(r,l&65535,!0),o.setUint32(r+4,l&4294901760,!0)}return b.WASI_ESUCCESS}}}function ld(e,t,i){return{environ_get:(s,n)=>{let r=s,a=n,o=i();for(let l in e.env){let d=e.env[l];o.setUint32(r,a,!0),r+=4,a+=t.writeString(o,`${l}=${d}\0`,a)}return b.WASI_ESUCCESS},environ_sizes_get:(s,n)=>{let r=i();return r.setUint32(s,Object.keys(e.env||{}).length,!0),r.setUint32(n,Object.entries(e.env||{}).reduce((a,[o,l])=>a+t.byteLength(o)+1+t.byteLength(l)+1,0),!0),b.WASI_ESUCCESS}}}function dd(e,t,i){return{proc_exit:s=>{throw new Gr(s)},proc_raise:s=>b.WASI_ESUCCESS}}function fd(e,t,i){return{random_get:(s,n)=>{let r=i(),a=new Uint8Array(r.buffer,s,n);return crypto.getRandomValues(a),b.WASI_ESUCCESS}}}var cd=class{wasiImport;instance=null;isStarted=!1;abi;constructor(t){if(this.wasiImport={},this.abi=new b,t?.features){let i={};for(let s of t.features){let n=s.name||"Unknown feature",r=s(t,this.abi,this.view.bind(this));for(let a in r){if(a in this.wasiImport){let o=i[a]||"Unknown feature";throw new Error(`Import conflict: Function '${a}' is already provided by '${o}' and is being redefined by '${n}'`)}i[a]=n}this.wasiImport={...this.wasiImport,...r}}}for(let i of b.IMPORT_FUNCTIONS)i in this.wasiImport||(this.wasiImport[i]=()=>b.WASI_ENOSYS)}view(){if(!this.instance)throw new Error("wasi.start() or wasi.initialize() has not been called");if(!this.instance.exports.memory)throw new Error("instance.exports.memory is undefined");if(!(this.instance.exports.memory instanceof WebAssembly.Memory))throw new Error("instance.exports.memory is not a WebAssembly.Memory");return new DataView(this.instance.exports.memory.buffer)}async start(t){if(this.isStarted)throw new Error("wasi.start() or wasi.initialize() has already been called");if(this.isStarted=!0,this.instance=t,!this.instance.exports._start)throw new Error("instance.exports._start is undefined");if(typeof this.instance.exports._start!="function")throw new Error("instance.exports._start is not a function");try{return await this.instance.exports._start(),b.WASI_ESUCCESS}catch(i){if(i instanceof Gr)return i.code;throw i}}},xi=new WeakMap;function ud(e){return!!e&&(typeof e=="object"||typeof e=="function")&&typeof e.then=="function"}function Dn(e,t){return new Proxy(e,{get:(i,s)=>t(i[s])})}var Wr=class{value=void 0;exports=null;getState(){if(!this.exports)throw new Error("Exports not initialized");return this.exports.asyncify_get_state()}assertNoneState(){let t=this.getState();if(t!==0)throw new Error(`Invalid async state ${t}, expected 0.`)}wrapImportFn(t){return(...i)=>{if(this.getState()===2){if(!this.exports)throw new Error("Exports not initialized");return this.exports.asyncify_stop_rewind(),this.value}this.assertNoneState();let s=t(...i);if(!ud(s))return s;if(!this.exports)throw new Error("Exports not initialized");this.exports.asyncify_start_unwind(16),this.value=s}}wrapModuleImports(t){return Dn(t,i=>typeof i=="function"?this.wrapImportFn(i):i)}wrapImports(t){if(t!==void 0)return Dn(t,(i=Object.create(null))=>this.wrapModuleImports(i))}wrapExportFn(t){let i=xi.get(t);return i!==void 0||(i=async(...s)=>{this.assertNoneState();let n=t(...s);for(;this.getState()===1;){if(!this.exports)throw new Error("Exports not initialized");this.exports.asyncify_stop_unwind(),this.value=await this.value,this.assertNoneState(),this.exports.asyncify_start_rewind(16),n=t(...s)}return this.assertNoneState(),n},xi.set(t,i)),i}wrapExports(t){let i=Object.create(null);for(let s in t){let n=t[s];typeof n=="function"&&!s.startsWith("asyncify_")&&(n=this.wrapExportFn(n)),Object.defineProperty(i,s,{enumerable:!0,value:n})}return xi.set(t,i),i}init(t,i){let s=t.exports,n=s.memory||i?.env&&i.env.memory;if(!n)throw new Error("Memory not found in exports or imports.env");new Int32Array(n.buffer,16).set([24,1024]),this.exports=this.wrapExports(s),Object.setPrototypeOf(t,Hr.prototype)}},Hr=class extends WebAssembly.Instance{constructor(t,i){let s=new Wr;super(t,s.wrapImports(i)),s.init(this,i)}get exports(){return xi.get(super.exports)}};Object.defineProperty(Hr.prototype,"exports",{enumerable:!0});async function hd(e,t){let i=new Wr,s=await WebAssembly.instantiateStreaming(e,i.wrapImports(t));return i.init(s.instance,t),s}var di=class{parts;constructor(t=""){this.parts=t?[t]:[]}append(t){return this.parts.push(t),this}appendLine(t=""){return this.parts.push(`${t}
`),this}get length(){return this.toString().length}toString(){return this.parts.join("")}static isMultiline(t){let i=0;for(let s=0;s<t.length;s++)(t[s]===`
`||t[s]==="\r"&&(s===t.length-1||t[s+1]!==`
`))&&i++;return i>0}},pd="https://perl.objex.ai/zeroperl-1.0.1.wasm",Ln=new TextDecoder;async function md(e,t={}){let i=new Vr({"/":""});i.addFile("/exiftool",id),e instanceof File?i.addFile(`/${e.name}`,e):i.addFile(`/${e.name}`,e.data),t.config&&(t.config instanceof File?i.addFile(`/${t.config.name}`,t.config):i.addFile(`/${t.config.name}`,t.config.data),t.args=t.args||[],t.args.push(`-config=${t.config.name}`));let s=new di,n=new di,r=["zeroperl","exiftool"].concat(t.args||[]);r.push(`/${e.name}`);let a={env:{LC_ALL:"C",PERL_UNICODE:"SAD"},args:r,features:[ld,ad,fd,od,dd,rd({withFileSystem:i,withStdIo:{stdout:u=>{let h;ArrayBuffer.isView(u)?h=Ln.decode(u):h=u,di.isMultiline(h)?s.append(h):s.appendLine(h)},stderr:u=>{let h;ArrayBuffer.isView(u)?h=Ln.decode(u):h=u,di.isMultiline(h)?n.append(h):n.appendLine(h)}}})]},o=new cd(a),l=t.fetch??fetch,{instance:d}=await hd(l(pd),{wasi_snapshot_preview1:o.wasiImport}),c=await o.start(d);if(c!==0)return{success:!1,data:void 0,error:n.toString(),exitCode:c};let f;return t.transform?f=t.transform(s.toString()):f=s.toString(),{success:!0,data:f,error:n.toString(),exitCode:c}}var Xi=typeof self<"u"?self:global;const Ht=typeof navigator<"u",$d=Ht&&typeof HTMLImageElement>"u",Ni=!(typeof global>"u"||typeof process>"u"||!process.versions||!process.versions.node),Yi=Xi.Buffer,fi=Xi.BigInt,Ki=!!Yi,gd=e=>e;function Ri(e,t=gd){if(Ni)try{return typeof require=="function"?Promise.resolve(t(require(e))):import(e).then(t)}catch{console.warn(`Couldn't load ${e}`)}}let Ks=Xi.fetch;const xd=e=>Ks=e;if(!Xi.fetch){const e=Ri("http",s=>s),t=Ri("https",s=>s),i=(s,{headers:n}={})=>new Promise(async(r,a)=>{let{port:o,hostname:l,pathname:d,protocol:c,search:f}=new URL(s);const u={method:"GET",hostname:l,path:encodeURI(d)+f,headers:n};o!==""&&(u.port=Number(o));const h=(c==="https:"?await t:await e).request(u,m=>{if(m.statusCode===301||m.statusCode===302){let x=new URL(m.headers.location,s).toString();return i(x,{headers:n}).then(r).catch(a)}r({status:m.statusCode,arrayBuffer:()=>new Promise(x=>{let p=[];m.on("data",S=>p.push(S)),m.on("end",()=>x(Buffer.concat(p)))})})});h.on("error",a),h.end()});xd(i)}function B(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const zi=e=>qr(e)?void 0:e,yd=e=>e!==void 0;function qr(e){return e===void 0||(e instanceof Map?e.size===0:Object.values(e).filter(yd).length===0)}function Q(e){let t=new Error(e);throw delete t.stack,t}function et(e){return(e=function(t){for(;t.endsWith("\0");)t=t.slice(0,-1);return t}(e).trim())===""?void 0:e}function Ls(e){let t=function(i){let s=0;return i.ifd0.enabled&&(s+=1024),i.exif.enabled&&(s+=2048),i.makerNote&&(s+=2048),i.userComment&&(s+=1024),i.gps.enabled&&(s+=512),i.interop.enabled&&(s+=100),i.ifd1.enabled&&(s+=1024),s+2048}(e);return e.jfif.enabled&&(t+=50),e.xmp.enabled&&(t+=2e4),e.iptc.enabled&&(t+=14e3),e.icc.enabled&&(t+=6e3),t}const Ns=e=>String.fromCharCode.apply(null,e),Nn=typeof TextDecoder<"u"?new TextDecoder("utf-8"):void 0;function jr(e){return Nn?Nn.decode(e):Ki?Buffer.from(e).toString("utf8"):decodeURIComponent(escape(Ns(e)))}class pe{static from(t,i){return t instanceof this&&t.le===i?t:new pe(t,void 0,void 0,i)}constructor(t,i=0,s,n){if(typeof n=="boolean"&&(this.le=n),Array.isArray(t)&&(t=new Uint8Array(t)),t===0)this.byteOffset=0,this.byteLength=0;else if(t instanceof ArrayBuffer){s===void 0&&(s=t.byteLength-i);let r=new DataView(t,i,s);this._swapDataView(r)}else if(t instanceof Uint8Array||t instanceof DataView||t instanceof pe){s===void 0&&(s=t.byteLength-i),(i+=t.byteOffset)+s>t.byteOffset+t.byteLength&&Q("Creating view outside of available memory in ArrayBuffer");let r=new DataView(t.buffer,i,s);this._swapDataView(r)}else if(typeof t=="number"){let r=new DataView(new ArrayBuffer(t));this._swapDataView(r)}else Q("Invalid input argument for BufferView: "+t)}_swapArrayBuffer(t){this._swapDataView(new DataView(t))}_swapBuffer(t){this._swapDataView(new DataView(t.buffer,t.byteOffset,t.byteLength))}_swapDataView(t){this.dataView=t,this.buffer=t.buffer,this.byteOffset=t.byteOffset,this.byteLength=t.byteLength}_lengthToEnd(t){return this.byteLength-t}set(t,i,s=pe){return t instanceof DataView||t instanceof pe?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array||Q("BufferView.set(): Invalid data argument."),this.toUint8().set(t,i),new s(this,i,t.byteLength)}subarray(t,i){return i=i||this._lengthToEnd(t),new pe(this,t,i)}toUint8(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}getUint8Array(t,i){return new Uint8Array(this.buffer,this.byteOffset+t,i)}getString(t=0,i=this.byteLength){return jr(this.getUint8Array(t,i))}getLatin1String(t=0,i=this.byteLength){let s=this.getUint8Array(t,i);return Ns(s)}getUnicodeString(t=0,i=this.byteLength){const s=[];for(let n=0;n<i&&t+n<this.byteLength;n+=2)s.push(this.getUint16(t+n));return Ns(s)}getInt8(t){return this.dataView.getInt8(t)}getUint8(t){return this.dataView.getUint8(t)}getInt16(t,i=this.le){return this.dataView.getInt16(t,i)}getInt32(t,i=this.le){return this.dataView.getInt32(t,i)}getUint16(t,i=this.le){return this.dataView.getUint16(t,i)}getUint32(t,i=this.le){return this.dataView.getUint32(t,i)}getFloat32(t,i=this.le){return this.dataView.getFloat32(t,i)}getFloat64(t,i=this.le){return this.dataView.getFloat64(t,i)}getFloat(t,i=this.le){return this.dataView.getFloat32(t,i)}getDouble(t,i=this.le){return this.dataView.getFloat64(t,i)}getUintBytes(t,i,s){switch(i){case 1:return this.getUint8(t,s);case 2:return this.getUint16(t,s);case 4:return this.getUint32(t,s);case 8:return this.getUint64&&this.getUint64(t,s)}}getUint(t,i,s){switch(i){case 8:return this.getUint8(t,s);case 16:return this.getUint16(t,s);case 32:return this.getUint32(t,s);case 64:return this.getUint64&&this.getUint64(t,s)}}toString(t){return this.dataView.toString(t,this.constructor.name)}ensureChunk(){}}function Rs(e,t){Q(`${e} '${t}' was not loaded, try using full build of exifr.`)}class Js extends Map{constructor(t){super(),this.kind=t}get(t,i){return this.has(t)||Rs(this.kind,t),i&&(t in i||function(s,n){Q(`Unknown ${s} '${n}'.`)}(this.kind,t),i[t].enabled||Rs(this.kind,t)),super.get(t)}keyList(){return Array.from(this.keys())}}var Fe=new Js("file parser"),Z=new Js("segment parser"),Ce=new Js("file reader");function bd(e,t){return typeof e=="string"?Rn(e,t):Ht&&!$d&&e instanceof HTMLImageElement?Rn(e.src,t):e instanceof Uint8Array||e instanceof ArrayBuffer||e instanceof DataView?new pe(e):Ht&&e instanceof Blob?zs(e,t,"blob",nt):void Q("Invalid input argument")}function Rn(e,t){return(i=e).startsWith("data:")||i.length>1e4?Ms(e,t,"base64"):Ni&&e.includes("://")?zs(e,t,"url",st):Ni?Ms(e,t,"fs"):Ht?zs(e,t,"url",st):void Q("Invalid input argument");var i}async function zs(e,t,i,s){return Ce.has(i)?Ms(e,t,i):s?async function(n,r){let a=await r(n);return new pe(a)}(e,s):void Q(`Parser ${i} is not loaded`)}async function Ms(e,t,i){let s=new(Ce.get(i))(e,t);return await s.read(),s}const st=e=>Ks(e).then(t=>t.arrayBuffer()),nt=e=>new Promise((t,i)=>{let s=new FileReader;s.onloadend=()=>t(s.result||new ArrayBuffer),s.onerror=i,s.readAsArrayBuffer(e)});class _d extends Map{get tagKeys(){return this.allKeys||(this.allKeys=Array.from(this.keys())),this.allKeys}get tagValues(){return this.allValues||(this.allValues=Array.from(this.values())),this.allValues}}function K(e,t,i){let s=new _d;for(let[n,r]of i)s.set(n,r);if(Array.isArray(t))for(let n of t)e.set(n,s);else e.set(t,s);return s}function rt(e,t,i){let s,n=e.get(t);for(s of i)n.set(s[0],s[1])}const ne=new Map,Ie=new Map,Ye=new Map,We=["chunked","firstChunkSize","firstChunkSizeNode","firstChunkSizeBrowser","chunkSize","chunkLimit"],Et=["jfif","xmp","icc","iptc","ihdr"],at=["tiff",...Et],j=["ifd0","ifd1","exif","gps","interop"],He=[...at,...j],qe=["makerNote","userComment"],Tt=["translateKeys","translateValues","reviveValues","multiSegment"],je=[...Tt,"sanitize","mergeOutput","silentErrors"];class Xr{get translate(){return this.translateKeys||this.translateValues||this.reviveValues}}class Ut extends Xr{get needed(){return this.enabled||this.deps.size>0}constructor(t,i,s,n){if(super(),B(this,"enabled",!1),B(this,"skip",new Set),B(this,"pick",new Set),B(this,"deps",new Set),B(this,"translateKeys",!1),B(this,"translateValues",!1),B(this,"reviveValues",!1),this.key=t,this.enabled=i,this.parse=this.enabled,this.applyInheritables(n),this.canBeFiltered=j.includes(t),this.canBeFiltered&&(this.dict=ne.get(t)),s!==void 0)if(Array.isArray(s))this.parse=this.enabled=!0,this.canBeFiltered&&s.length>0&&this.translateTagSet(s,this.pick);else if(typeof s=="object"){if(this.enabled=!0,this.parse=s.parse!==!1,this.canBeFiltered){let{pick:r,skip:a}=s;r&&r.length>0&&this.translateTagSet(r,this.pick),a&&a.length>0&&this.translateTagSet(a,this.skip)}this.applyInheritables(s)}else s===!0||s===!1?this.parse=this.enabled=s:Q(`Invalid options argument: ${s}`)}applyInheritables(t){let i,s;for(i of Tt)s=t[i],s!==void 0&&(this[i]=s)}translateTagSet(t,i){if(this.dict){let s,n,{tagKeys:r,tagValues:a}=this.dict;for(s of t)typeof s=="string"?(n=a.indexOf(s),n===-1&&(n=r.indexOf(Number(s))),n!==-1&&i.add(Number(r[n]))):i.add(s)}else for(let s of t)i.add(s)}finalizeFilters(){!this.enabled&&this.deps.size>0?(this.enabled=!0,Mi(this.pick,this.deps)):this.enabled&&this.pick.size>0&&Mi(this.pick,this.deps)}}var ue={jfif:!1,tiff:!0,xmp:!1,icc:!1,iptc:!1,ifd0:!0,ifd1:!1,exif:!0,gps:!0,interop:!1,ihdr:void 0,makerNote:!1,userComment:!1,multiSegment:!1,skip:[],pick:[],translateKeys:!0,translateValues:!0,reviveValues:!0,sanitize:!0,mergeOutput:!0,silentErrors:!0,chunked:!0,firstChunkSize:void 0,firstChunkSizeNode:512,firstChunkSizeBrowser:65536,chunkSize:65536,chunkLimit:5},zn=new Map;class ut extends Xr{static useCached(t){let i=zn.get(t);return i!==void 0||(i=new this(t),zn.set(t,i)),i}constructor(t){super(),t===!0?this.setupFromTrue():t===void 0?this.setupFromUndefined():Array.isArray(t)?this.setupFromArray(t):typeof t=="object"?this.setupFromObject(t):Q(`Invalid options argument ${t}`),this.firstChunkSize===void 0&&(this.firstChunkSize=Ht?this.firstChunkSizeBrowser:this.firstChunkSizeNode),this.mergeOutput&&(this.ifd1.enabled=!1),this.filterNestedSegmentTags(),this.traverseTiffDependencyTree(),this.checkLoadedPlugins()}setupFromUndefined(){let t;for(t of We)this[t]=ue[t];for(t of je)this[t]=ue[t];for(t of qe)this[t]=ue[t];for(t of He)this[t]=new Ut(t,ue[t],void 0,this)}setupFromTrue(){let t;for(t of We)this[t]=ue[t];for(t of je)this[t]=ue[t];for(t of qe)this[t]=!0;for(t of He)this[t]=new Ut(t,!0,void 0,this)}setupFromArray(t){let i;for(i of We)this[i]=ue[i];for(i of je)this[i]=ue[i];for(i of qe)this[i]=ue[i];for(i of He)this[i]=new Ut(i,!1,void 0,this);this.setupGlobalFilters(t,void 0,j)}setupFromObject(t){let i;for(i of(j.ifd0=j.ifd0||j.image,j.ifd1=j.ifd1||j.thumbnail,Object.assign(this,t),We))this[i]=cs(t[i],ue[i]);for(i of je)this[i]=cs(t[i],ue[i]);for(i of qe)this[i]=cs(t[i],ue[i]);for(i of at)this[i]=new Ut(i,ue[i],t[i],this);for(i of j)this[i]=new Ut(i,ue[i],t[i],this.tiff);this.setupGlobalFilters(t.pick,t.skip,j,He),t.tiff===!0?this.batchEnableWithBool(j,!0):t.tiff===!1?this.batchEnableWithUserValue(j,t):Array.isArray(t.tiff)?this.setupGlobalFilters(t.tiff,void 0,j):typeof t.tiff=="object"&&this.setupGlobalFilters(t.tiff.pick,t.tiff.skip,j)}batchEnableWithBool(t,i){for(let s of t)this[s].enabled=i}batchEnableWithUserValue(t,i){for(let s of t){let n=i[s];this[s].enabled=n!==!1&&n!==void 0}}setupGlobalFilters(t,i,s,n=s){if(t&&t.length){for(let a of n)this[a].enabled=!1;let r=Mn(t,s);for(let[a,o]of r)Mi(this[a].pick,o),this[a].enabled=!0}else if(i&&i.length){let r=Mn(i,s);for(let[a,o]of r)Mi(this[a].skip,o)}}filterNestedSegmentTags(){let{ifd0:t,exif:i,xmp:s,iptc:n,icc:r}=this;this.makerNote?i.deps.add(37500):i.skip.add(37500),this.userComment?i.deps.add(37510):i.skip.add(37510),s.enabled||t.skip.add(700),n.enabled||t.skip.add(33723),r.enabled||t.skip.add(34675)}traverseTiffDependencyTree(){let{ifd0:t,exif:i,gps:s,interop:n}=this;n.needed&&(i.deps.add(40965),t.deps.add(40965)),i.needed&&t.deps.add(34665),s.needed&&t.deps.add(34853),this.tiff.enabled=j.some(r=>this[r].enabled===!0)||this.makerNote||this.userComment;for(let r of j)this[r].finalizeFilters()}get onlyTiff(){return!Et.map(t=>this[t].enabled).some(t=>t===!0)&&this.tiff.enabled}checkLoadedPlugins(){for(let t of at)this[t].enabled&&!Z.has(t)&&Rs("segment parser",t)}}function Mn(e,t){let i,s,n,r,a=[];for(n of t){for(r of(i=ne.get(n),s=[],i))(e.includes(r[0])||e.includes(r[1]))&&s.push(r[0]);s.length&&a.push([n,s])}return a}function cs(e,t){return e!==void 0?e:t!==void 0?t:void 0}function Mi(e,t){for(let i of t)e.add(i)}B(ut,"default",ue);class Je{constructor(t){B(this,"parsers",{}),B(this,"output",{}),B(this,"errors",[]),B(this,"pushToErrors",i=>this.errors.push(i)),this.options=ut.useCached(t)}async read(t){this.file=await bd(t,this.options)}setup(){if(this.fileParser)return;let{file:t}=this,i=t.getUint16(0);for(let[s,n]of Fe)if(n.canHandle(t,i))return this.fileParser=new n(this.options,this.file,this.parsers),t[s]=!0;this.file.close&&this.file.close(),Q("Unknown file format")}async parse(){let{output:t,errors:i}=this;return this.setup(),this.options.silentErrors?(await this.executeParsers().catch(this.pushToErrors),i.push(...this.fileParser.errors)):await this.executeParsers(),this.file.close&&this.file.close(),this.options.silentErrors&&i.length>0&&(t.errors=i),zi(t)}async executeParsers(){let{output:t}=this;await this.fileParser.parse();let i=Object.values(this.parsers).map(async s=>{let n=await s.parse();s.assignToOutput(t,n)});this.options.silentErrors&&(i=i.map(s=>s.catch(this.pushToErrors))),await Promise.all(i)}async extractThumbnail(){this.setup();let{options:t,file:i}=this,s=Z.get("tiff",t);var n;if(i.tiff?n={start:0,type:"tiff"}:i.jpeg&&(n=await this.fileParser.getOrFindSegment("tiff")),n===void 0)return;let r=await this.fileParser.ensureSegmentChunk(n),a=this.parsers.tiff=new s(r,t,i),o=await a.extractThumbnail();return i.close&&i.close(),o}}async function Ji(e,t){let i=new Je(t);return await i.read(e),i.parse()}var vd=Object.freeze({__proto__:null,parse:Ji,Exifr:Je,fileParsers:Fe,segmentParsers:Z,fileReaders:Ce,tagKeys:ne,tagValues:Ie,tagRevivers:Ye,createDictionary:K,extendDictionary:rt,fetchUrlAsArrayBuffer:st,readBlobAsArrayBuffer:nt,chunkedProps:We,otherSegments:Et,segments:at,tiffBlocks:j,segmentsAndBlocks:He,tiffExtractables:qe,inheritables:Tt,allFormatters:je,Options:ut});class Zi{constructor(t,i,s){B(this,"errors",[]),B(this,"ensureSegmentChunk",async n=>{let r=n.start,a=n.size||65536;if(this.file.chunked)if(this.file.available(r,a))n.chunk=this.file.subarray(r,a);else try{n.chunk=await this.file.readChunk(r,a)}catch(o){Q(`Couldn't read segment: ${JSON.stringify(n)}. ${o.message}`)}else this.file.byteLength>r+a?n.chunk=this.file.subarray(r,a):n.size===void 0?n.chunk=this.file.subarray(r):Q("Segment unreachable: "+JSON.stringify(n));return n.chunk}),this.extendOptions&&this.extendOptions(t),this.options=t,this.file=i,this.parsers=s}injectSegment(t,i){this.options[t].enabled&&this.createParser(t,i)}createParser(t,i){let s=new(Z.get(t))(i,this.options,this.file);return this.parsers[t]=s}createParsers(t){for(let i of t){let{type:s,chunk:n}=i,r=this.options[s];if(r&&r.enabled){let a=this.parsers[s];a&&a.append||a||this.createParser(s,n)}}}async readSegments(t){let i=t.map(this.ensureSegmentChunk);await Promise.all(i)}}class Se{static findPosition(t,i){let s=t.getUint16(i+2)+2,n=typeof this.headerLength=="function"?this.headerLength(t,i,s):this.headerLength,r=i+n,a=s-n;return{offset:i,length:s,headerLength:n,start:r,size:a,end:r+a}}static parse(t,i={}){return new this(t,new ut({[this.type]:i}),t).parse()}normalizeInput(t){return t instanceof pe?t:new pe(t)}constructor(t,i={},s){B(this,"errors",[]),B(this,"raw",new Map),B(this,"handleError",n=>{if(!this.options.silentErrors)throw n;this.errors.push(n.message)}),this.chunk=this.normalizeInput(t),this.file=s,this.type=this.constructor.type,this.globalOptions=this.options=i,this.localOptions=i[this.type],this.canTranslate=this.localOptions&&this.localOptions.translate}translate(){this.canTranslate&&(this.translated=this.translateBlock(this.raw,this.type))}get output(){return this.translated?this.translated:this.raw?Object.fromEntries(this.raw):void 0}translateBlock(t,i){let s=Ye.get(i),n=Ie.get(i),r=ne.get(i),a=this.options[i],o=a.reviveValues&&!!s,l=a.translateValues&&!!n,d=a.translateKeys&&!!r,c={};for(let[f,u]of t)o&&s.has(f)?u=s.get(f)(u):l&&n.has(f)&&(u=this.translateValue(u,n.get(f))),d&&r.has(f)&&(f=r.get(f)||f),c[f]=u;return c}translateValue(t,i){return i[t]||i.DEFAULT||t}assignToOutput(t,i){this.assignObjectToOutput(t,this.constructor.type,i)}assignObjectToOutput(t,i,s){if(this.globalOptions.mergeOutput)return Object.assign(t,s);t[i]?Object.assign(t[i],s):t[i]=s}}B(Se,"headerLength",4),B(Se,"type",void 0),B(Se,"multiSegment",!1),B(Se,"canHandle",()=>!1);function wd(e){return e===192||e===194||e===196||e===219||e===221||e===218||e===254}function Sd(e){return e>=224&&e<=239}function Id(e,t,i){for(let[s,n]of Z)if(n.canHandle(e,t,i))return s}class Gn extends Zi{constructor(...t){super(...t),B(this,"appSegments",[]),B(this,"jpegSegments",[]),B(this,"unknownSegments",[])}static canHandle(t,i){return i===65496}async parse(){await this.findAppSegments(),await this.readSegments(this.appSegments),this.mergeMultiSegments(),this.createParsers(this.mergedAppSegments||this.appSegments)}setupSegmentFinderArgs(t){t===!0?(this.findAll=!0,this.wanted=new Set(Z.keyList())):(t=t===void 0?Z.keyList().filter(i=>this.options[i].enabled):t.filter(i=>this.options[i].enabled&&Z.has(i)),this.findAll=!1,this.remaining=new Set(t),this.wanted=new Set(t)),this.unfinishedMultiSegment=!1}async findAppSegments(t=0,i){this.setupSegmentFinderArgs(i);let{file:s,findAll:n,wanted:r,remaining:a}=this;if(!n&&this.file.chunked&&(n=Array.from(r).some(o=>{let l=Z.get(o),d=this.options[o];return l.multiSegment&&d.multiSegment}),n&&await this.file.readWhole()),t=this.findAppSegmentsInRange(t,s.byteLength),!this.options.onlyTiff&&s.chunked){let o=!1;for(;a.size>0&&!o&&(s.canReadNextChunk||this.unfinishedMultiSegment);){let{nextChunkOffset:l}=s,d=this.appSegments.some(c=>!this.file.available(c.offset||c.start,c.length||c.size));if(o=t>l&&!d?!await s.readNextChunk(t):!await s.readNextChunk(l),(t=this.findAppSegmentsInRange(t,s.byteLength))===void 0)return}}}findAppSegmentsInRange(t,i){i-=2;let s,n,r,a,o,l,{file:d,findAll:c,wanted:f,remaining:u,options:h}=this;for(;t<i;t++)if(d.getUint8(t)===255){if(s=d.getUint8(t+1),Sd(s)){if(n=d.getUint16(t+2),r=Id(d,t,n),r&&f.has(r)&&(a=Z.get(r),o=a.findPosition(d,t),l=h[r],o.type=r,this.appSegments.push(o),!c&&(a.multiSegment&&l.multiSegment?(this.unfinishedMultiSegment=o.chunkNumber<o.chunkCount,this.unfinishedMultiSegment||u.delete(r)):u.delete(r),u.size===0)))break;h.recordUnknownSegments&&(o=Se.findPosition(d,t),o.marker=s,this.unknownSegments.push(o)),t+=n+1}else if(wd(s)){if(n=d.getUint16(t+2),s===218&&h.stopAfterSos!==!1)return;h.recordJpegSegments&&this.jpegSegments.push({offset:t,length:n,marker:s}),t+=n+1}}return t}mergeMultiSegments(){if(!this.appSegments.some(i=>i.multiSegment))return;let t=function(i,s){let n,r,a,o=new Map;for(let l=0;l<i.length;l++)n=i[l],r=n[s],o.has(r)?a=o.get(r):o.set(r,a=[]),a.push(n);return Array.from(o)}(this.appSegments,"type");this.mergedAppSegments=t.map(([i,s])=>{let n=Z.get(i,this.options);return n.handleMultiSegments?{type:i,chunk:n.handleMultiSegments(s)}:s[0]})}getSegment(t){return this.appSegments.find(i=>i.type===t)}async getOrFindSegment(t){let i=this.getSegment(t);return i===void 0&&(await this.findAppSegments(0,[t]),i=this.getSegment(t)),i}}B(Gn,"type","jpeg"),Fe.set("jpeg",Gn);const Ed=[void 0,1,1,2,4,8,1,1,2,4,8,4,8,4];class Td extends Se{parseHeader(){var t=this.chunk.getUint16();t===18761?this.le=!0:t===19789&&(this.le=!1),this.chunk.le=this.le,this.headerParsed=!0}parseTags(t,i,s=new Map){let{pick:n,skip:r}=this.options[i];n=new Set(n);let a=n.size>0,o=r.size===0,l=this.chunk.getUint16(t);t+=2;for(let d=0;d<l;d++){let c=this.chunk.getUint16(t);if(a){if(n.has(c)&&(s.set(c,this.parseTag(t,c,i)),n.delete(c),n.size===0))break}else!o&&r.has(c)||s.set(c,this.parseTag(t,c,i));t+=12}return s}parseTag(t,i,s){let{chunk:n}=this,r=n.getUint16(t+2),a=n.getUint32(t+4),o=Ed[r];if(o*a<=4?t+=8:t=n.getUint32(t+8),(r<1||r>13)&&Q(`Invalid TIFF value type. block: ${s.toUpperCase()}, tag: ${i.toString(16)}, type: ${r}, offset ${t}`),t>n.byteLength&&Q(`Invalid TIFF value offset. block: ${s.toUpperCase()}, tag: ${i.toString(16)}, type: ${r}, offset ${t} is outside of chunk size ${n.byteLength}`),r===1)return n.getUint8Array(t,a);if(r===2)return et(n.getString(t,a));if(r===7)return n.getUint8Array(t,a);if(a===1)return this.parseTagValue(r,t);{let l=new(function(c){switch(c){case 1:return Uint8Array;case 3:return Uint16Array;case 4:return Uint32Array;case 5:return Array;case 6:return Int8Array;case 8:return Int16Array;case 9:return Int32Array;case 10:return Array;case 11:return Float32Array;case 12:return Float64Array;default:return Array}}(r))(a),d=o;for(let c=0;c<a;c++)l[c]=this.parseTagValue(r,t),t+=d;return l}}parseTagValue(t,i){let{chunk:s}=this;switch(t){case 1:return s.getUint8(i);case 3:return s.getUint16(i);case 4:return s.getUint32(i);case 5:return s.getUint32(i)/s.getUint32(i+4);case 6:return s.getInt8(i);case 8:return s.getInt16(i);case 9:return s.getInt32(i);case 10:return s.getInt32(i)/s.getInt32(i+4);case 11:return s.getFloat(i);case 12:return s.getDouble(i);case 13:return s.getUint32(i);default:Q(`Invalid tiff type ${t}`)}}}class us extends Td{static canHandle(t,i){return t.getUint8(i+1)===225&&t.getUint32(i+4)===1165519206&&t.getUint16(i+8)===0}async parse(){this.parseHeader();let{options:t}=this;return t.ifd0.enabled&&await this.parseIfd0Block(),t.exif.enabled&&await this.safeParse("parseExifBlock"),t.gps.enabled&&await this.safeParse("parseGpsBlock"),t.interop.enabled&&await this.safeParse("parseInteropBlock"),t.ifd1.enabled&&await this.safeParse("parseThumbnailBlock"),this.createOutput()}safeParse(t){let i=this[t]();return i.catch!==void 0&&(i=i.catch(this.handleError)),i}findIfd0Offset(){this.ifd0Offset===void 0&&(this.ifd0Offset=this.chunk.getUint32(4))}findIfd1Offset(){if(this.ifd1Offset===void 0){this.findIfd0Offset();let t=this.chunk.getUint16(this.ifd0Offset),i=this.ifd0Offset+2+12*t;this.ifd1Offset=this.chunk.getUint32(i)}}parseBlock(t,i){let s=new Map;return this[i]=s,this.parseTags(t,i,s),s}async parseIfd0Block(){if(this.ifd0)return;let{file:t}=this;this.findIfd0Offset(),this.ifd0Offset<8&&Q("Malformed EXIF data"),!t.chunked&&this.ifd0Offset>t.byteLength&&Q(`IFD0 offset points to outside of file.
this.ifd0Offset: ${this.ifd0Offset}, file.byteLength: ${t.byteLength}`),t.tiff&&await t.ensureChunk(this.ifd0Offset,Ls(this.options));let i=this.parseBlock(this.ifd0Offset,"ifd0");return i.size!==0?(this.exifOffset=i.get(34665),this.interopOffset=i.get(40965),this.gpsOffset=i.get(34853),this.xmp=i.get(700),this.iptc=i.get(33723),this.icc=i.get(34675),this.options.sanitize&&(i.delete(34665),i.delete(40965),i.delete(34853),i.delete(700),i.delete(33723),i.delete(34675)),i):void 0}async parseExifBlock(){if(this.exif||(this.ifd0||await this.parseIfd0Block(),this.exifOffset===void 0))return;this.file.tiff&&await this.file.ensureChunk(this.exifOffset,Ls(this.options));let t=this.parseBlock(this.exifOffset,"exif");return this.interopOffset||(this.interopOffset=t.get(40965)),this.makerNote=t.get(37500),this.userComment=t.get(37510),this.options.sanitize&&(t.delete(40965),t.delete(37500),t.delete(37510)),this.unpack(t,41728),this.unpack(t,41729),t}unpack(t,i){let s=t.get(i);s&&s.length===1&&t.set(i,s[0])}async parseGpsBlock(){if(this.gps||(this.ifd0||await this.parseIfd0Block(),this.gpsOffset===void 0))return;let t=this.parseBlock(this.gpsOffset,"gps");return t&&t.has(2)&&t.has(4)&&(t.set("latitude",Vn(...t.get(2),t.get(1))),t.set("longitude",Vn(...t.get(4),t.get(3)))),t}async parseInteropBlock(){if(!this.interop&&(this.ifd0||await this.parseIfd0Block(),this.interopOffset!==void 0||this.exif||await this.parseExifBlock(),this.interopOffset!==void 0))return this.parseBlock(this.interopOffset,"interop")}async parseThumbnailBlock(t=!1){if(!this.ifd1&&!this.ifd1Parsed&&(!this.options.mergeOutput||t))return this.findIfd1Offset(),this.ifd1Offset>0&&(this.parseBlock(this.ifd1Offset,"ifd1"),this.ifd1Parsed=!0),this.ifd1}async extractThumbnail(){if(this.headerParsed||this.parseHeader(),this.ifd1Parsed||await this.parseThumbnailBlock(!0),this.ifd1===void 0)return;let t=this.ifd1.get(513),i=this.ifd1.get(514);return this.chunk.getUint8Array(t,i)}get image(){return this.ifd0}get thumbnail(){return this.ifd1}createOutput(){let t,i,s,n={};for(i of j)if(t=this[i],!qr(t))if(s=this.canTranslate?this.translateBlock(t,i):Object.fromEntries(t),this.options.mergeOutput){if(i==="ifd1")continue;Object.assign(n,s)}else n[i]=s;return this.makerNote&&(n.makerNote=this.makerNote),this.userComment&&(n.userComment=this.userComment),n}assignToOutput(t,i){if(this.globalOptions.mergeOutput)Object.assign(t,i);else for(let[s,n]of Object.entries(i))this.assignObjectToOutput(t,s,n)}}function Vn(e,t,i,s){var n=e+t/60+i/3600;return s!=="S"&&s!=="W"||(n*=-1),n}B(us,"type","tiff"),B(us,"headerLength",10),Z.set("tiff",us);var Fd=Object.freeze({__proto__:null,default:vd,Exifr:Je,fileParsers:Fe,segmentParsers:Z,fileReaders:Ce,tagKeys:ne,tagValues:Ie,tagRevivers:Ye,createDictionary:K,extendDictionary:rt,fetchUrlAsArrayBuffer:st,readBlobAsArrayBuffer:nt,chunkedProps:We,otherSegments:Et,segments:at,tiffBlocks:j,segmentsAndBlocks:He,tiffExtractables:qe,inheritables:Tt,allFormatters:je,Options:ut,parse:Ji});const Zs={ifd0:!1,ifd1:!1,exif:!1,gps:!1,interop:!1,sanitize:!1,reviveValues:!0,translateKeys:!1,translateValues:!1,mergeOutput:!1},Qs=Object.assign({},Zs,{firstChunkSize:4e4,gps:[1,2,3,4]});async function Yr(e){let t=new Je(Qs);await t.read(e);let i=await t.parse();if(i&&i.gps){let{latitude:s,longitude:n}=i.gps;return{latitude:s,longitude:n}}}const en=Object.assign({},Zs,{tiff:!1,ifd1:!0,mergeOutput:!1});async function Kr(e){let t=new Je(en);await t.read(e);let i=await t.extractThumbnail();return i&&Ki?Yi.from(i):i}async function Jr(e){let t=await this.thumbnail(e);if(t!==void 0){let i=new Blob([t]);return URL.createObjectURL(i)}}const tn=Object.assign({},Zs,{firstChunkSize:4e4,ifd0:[274]});async function sn(e){let t=new Je(tn);await t.read(e);let i=await t.parse();if(i&&i.ifd0)return i.ifd0[274]}const nn=Object.freeze({1:{dimensionSwapped:!1,scaleX:1,scaleY:1,deg:0,rad:0},2:{dimensionSwapped:!1,scaleX:-1,scaleY:1,deg:0,rad:0},3:{dimensionSwapped:!1,scaleX:1,scaleY:1,deg:180,rad:180*Math.PI/180},4:{dimensionSwapped:!1,scaleX:-1,scaleY:1,deg:180,rad:180*Math.PI/180},5:{dimensionSwapped:!0,scaleX:1,scaleY:-1,deg:90,rad:90*Math.PI/180},6:{dimensionSwapped:!0,scaleX:1,scaleY:1,deg:90,rad:90*Math.PI/180},7:{dimensionSwapped:!0,scaleX:1,scaleY:-1,deg:270,rad:270*Math.PI/180},8:{dimensionSwapped:!0,scaleX:1,scaleY:1,deg:270,rad:270*Math.PI/180}});let tt=!0,it=!0;if(typeof navigator=="object"){let e=navigator.userAgent;if(e.includes("iPad")||e.includes("iPhone")){let t=e.match(/OS (\d+)_(\d+)/);if(t){let[,i,s]=t;tt=Number(i)+.1*Number(s)<13.4,it=!1}}else if(e.includes("OS X 10")){let[,t]=e.match(/OS X 10[_.](\d+)/);tt=it=Number(t)<15}if(e.includes("Chrome/")){let[,t]=e.match(/Chrome\/(\d+)/);tt=it=Number(t)<81}else if(e.includes("Firefox/")){let[,t]=e.match(/Firefox\/(\d+)/);tt=it=Number(t)<77}}async function Zr(e){let t=await sn(e);return Object.assign({canvas:tt,css:it},nn[t])}class Cd extends pe{constructor(...t){super(...t),B(this,"ranges",new Ud),this.byteLength!==0&&this.ranges.add(0,this.byteLength)}_tryExtend(t,i,s){if(t===0&&this.byteLength===0&&s){let n=new DataView(s.buffer||s,s.byteOffset,s.byteLength);this._swapDataView(n)}else{let n=t+i;if(n>this.byteLength){let{dataView:r}=this._extend(n);this._swapDataView(r)}}}_extend(t){let i;i=Ki?Yi.allocUnsafe(t):new Uint8Array(t);let s=new DataView(i.buffer,i.byteOffset,i.byteLength);return i.set(new Uint8Array(this.buffer,this.byteOffset,this.byteLength),0),{uintView:i,dataView:s}}subarray(t,i,s=!1){return i=i||this._lengthToEnd(t),s&&this._tryExtend(t,i),this.ranges.add(t,i),super.subarray(t,i)}set(t,i,s=!1){s&&this._tryExtend(i,t.byteLength,t);let n=super.set(t,i);return this.ranges.add(i,n.byteLength),n}async ensureChunk(t,i){this.chunked&&(this.ranges.available(t,i)||await this.readChunk(t,i))}available(t,i){return this.ranges.available(t,i)}}class Ud{constructor(){B(this,"list",[])}get length(){return this.list.length}add(t,i,s=0){let n=t+i,r=this.list.filter(a=>Wn(t,a.offset,n)||Wn(t,a.end,n));if(r.length>0){t=Math.min(t,...r.map(o=>o.offset)),n=Math.max(n,...r.map(o=>o.end)),i=n-t;let a=r.shift();a.offset=t,a.length=i,a.end=n,this.list=this.list.filter(o=>!r.includes(o))}else this.list.push({offset:t,length:i,end:n})}available(t,i){let s=t+i;return this.list.some(n=>n.offset<=t&&s<=n.end)}}function Wn(e,t,i){return e<=t&&t<=i}class Qi extends Cd{constructor(t,i){super(0),B(this,"chunksRead",0),this.input=t,this.options=i}async readWhole(){this.chunked=!1,await this.readChunk(this.nextChunkOffset)}async readChunked(){this.chunked=!0,await this.readChunk(0,this.options.firstChunkSize)}async readNextChunk(t=this.nextChunkOffset){if(this.fullyRead)return this.chunksRead++,!1;let i=this.options.chunkSize,s=await this.readChunk(t,i);return!!s&&s.byteLength===i}async readChunk(t,i){if(this.chunksRead++,(i=this.safeWrapAddress(t,i))!==0)return this._readChunk(t,i)}safeWrapAddress(t,i){return this.size!==void 0&&t+i>this.size?Math.max(0,this.size-t):i}get nextChunkOffset(){if(this.ranges.list.length!==0)return this.ranges.list[0].length}get canReadNextChunk(){return this.chunksRead<this.options.chunkLimit}get fullyRead(){return this.size!==void 0&&this.nextChunkOffset===this.size}read(){return this.options.chunked?this.readChunked():this.readWhole()}close(){}}Ce.set("blob",class extends Qi{async readWhole(){this.chunked=!1;let e=await nt(this.input);this._swapArrayBuffer(e)}readChunked(){return this.chunked=!0,this.size=this.input.size,super.readChunked()}async _readChunk(e,t){let i=t?e+t:void 0,s=this.input.slice(e,i),n=await nt(s);return this.set(n,e,!0)}});var kd=Object.freeze({__proto__:null,default:Fd,Exifr:Je,fileParsers:Fe,segmentParsers:Z,fileReaders:Ce,tagKeys:ne,tagValues:Ie,tagRevivers:Ye,createDictionary:K,extendDictionary:rt,fetchUrlAsArrayBuffer:st,readBlobAsArrayBuffer:nt,chunkedProps:We,otherSegments:Et,segments:at,tiffBlocks:j,segmentsAndBlocks:He,tiffExtractables:qe,inheritables:Tt,allFormatters:je,Options:ut,parse:Ji,gpsOnlyOptions:Qs,gps:Yr,thumbnailOnlyOptions:en,thumbnail:Kr,thumbnailUrl:Jr,orientationOnlyOptions:tn,orientation:sn,rotations:nn,get rotateCanvas(){return tt},get rotateCss(){return it},rotation:Zr});Ce.set("url",class extends Qi{async readWhole(){this.chunked=!1;let e=await st(this.input);e instanceof ArrayBuffer?this._swapArrayBuffer(e):e instanceof Uint8Array&&this._swapBuffer(e)}async _readChunk(e,t){let i=t?e+t-1:void 0,s=this.options.httpHeaders||{};(e||i)&&(s.range=`bytes=${[e,i].join("-")}`);let n=await Ks(this.input,{headers:s}),r=await n.arrayBuffer(),a=r.byteLength;if(n.status!==416)return a!==t&&(this.size=e+a),this.set(r,e,!0)}});pe.prototype.getUint64=function(e){let t=this.getUint32(e),i=this.getUint32(e+4);return t<1048575?t<<32|i:typeof fi!==void 0?(console.warn("Using BigInt because of type 64uint but JS can only handle 53b numbers."),fi(t)<<fi(32)|fi(i)):void Q("Trying to read 64b value but JS can only handle 53b numbers.")};class Bd extends Zi{parseBoxes(t=0){let i=[];for(;t<this.file.byteLength-4;){let s=this.parseBoxHead(t);if(i.push(s),s.length===0)break;t+=s.length}return i}parseSubBoxes(t){t.boxes=this.parseBoxes(t.start)}findBox(t,i){return t.boxes===void 0&&this.parseSubBoxes(t),t.boxes.find(s=>s.kind===i)}parseBoxHead(t){let i=this.file.getUint32(t),s=this.file.getString(t+4,4),n=t+8;return i===1&&(i=this.file.getUint64(t+8),n+=8),{offset:t,length:i,kind:s,start:n}}parseBoxFullHead(t){if(t.version!==void 0)return;let i=this.file.getUint32(t.start);t.version=i>>24,t.start+=4}}class Qr extends Bd{static canHandle(t,i){if(i!==0)return!1;let s=t.getUint16(2);if(s>50)return!1;let n=16,r=[];for(;n<s;)r.push(t.getString(n,4)),n+=4;return r.includes(this.type)}async parse(){let t=this.file.getUint32(0),i=this.parseBoxHead(t);for(;i.kind!=="meta";)t+=i.length,await this.file.ensureChunk(t,16),i=this.parseBoxHead(t);await this.file.ensureChunk(i.offset,i.length),this.parseBoxFullHead(i),this.parseSubBoxes(i),this.options.icc.enabled&&await this.findIcc(i),this.options.tiff.enabled&&await this.findExif(i)}async registerSegment(t,i,s){await this.file.ensureChunk(i,s);let n=this.file.subarray(i,s);this.createParser(t,n)}async findIcc(t){let i=this.findBox(t,"iprp");if(i===void 0)return;let s=this.findBox(i,"ipco");if(s===void 0)return;let n=this.findBox(s,"colr");n!==void 0&&await this.registerSegment("icc",n.offset+12,n.length)}async findExif(t){let i=this.findBox(t,"iinf");if(i===void 0)return;let s=this.findBox(t,"iloc");if(s===void 0)return;let n=this.findExifLocIdInIinf(i),r=this.findExtentInIloc(s,n);if(r===void 0)return;let[a,o]=r;await this.file.ensureChunk(a,o);let l=4+this.file.getUint32(a);a+=l,o-=l,await this.registerSegment("tiff",a,o)}findExifLocIdInIinf(t){this.parseBoxFullHead(t);let i,s,n,r,a=t.start,o=this.file.getUint16(a);for(a+=2;o--;){if(i=this.parseBoxHead(a),this.parseBoxFullHead(i),s=i.start,i.version>=2&&(n=i.version===3?4:2,r=this.file.getString(s+n+2,4),r==="Exif"))return this.file.getUintBytes(s,n);a+=i.length}}get8bits(t){let i=this.file.getUint8(t);return[i>>4,15&i]}findExtentInIloc(t,i){this.parseBoxFullHead(t);let s=t.start,[n,r]=this.get8bits(s++),[a,o]=this.get8bits(s++),l=t.version===2?4:2,d=t.version===1||t.version===2?2:0,c=o+n+r,f=t.version===2?4:2,u=this.file.getUintBytes(s,f);for(s+=f;u--;){let h=this.file.getUintBytes(s,l);s+=l+d+2+a;let m=this.file.getUint16(s);if(s+=2,h===i)return m>1&&console.warn(`ILOC box has more than one extent but we're only processing one
Please create an issue at https://github.com/MikeKovarik/exifr with this file`),[this.file.getUintBytes(s+o,n),this.file.getUintBytes(s+o+n,r)];s+=m*c}}}class ea extends Qr{}B(ea,"type","heic");class Hn extends Qr{}B(Hn,"type","avif"),Fe.set("heic",ea),Fe.set("avif",Hn),K(ne,["ifd0","ifd1"],[[256,"ImageWidth"],[257,"ImageHeight"],[258,"BitsPerSample"],[259,"Compression"],[262,"PhotometricInterpretation"],[270,"ImageDescription"],[271,"Make"],[272,"Model"],[273,"StripOffsets"],[274,"Orientation"],[277,"SamplesPerPixel"],[278,"RowsPerStrip"],[279,"StripByteCounts"],[282,"XResolution"],[283,"YResolution"],[284,"PlanarConfiguration"],[296,"ResolutionUnit"],[301,"TransferFunction"],[305,"Software"],[306,"ModifyDate"],[315,"Artist"],[316,"HostComputer"],[317,"Predictor"],[318,"WhitePoint"],[319,"PrimaryChromaticities"],[513,"ThumbnailOffset"],[514,"ThumbnailLength"],[529,"YCbCrCoefficients"],[530,"YCbCrSubSampling"],[531,"YCbCrPositioning"],[532,"ReferenceBlackWhite"],[700,"ApplicationNotes"],[33432,"Copyright"],[33723,"IPTC"],[34665,"ExifIFD"],[34675,"ICC"],[34853,"GpsIFD"],[330,"SubIFD"],[40965,"InteropIFD"],[40091,"XPTitle"],[40092,"XPComment"],[40093,"XPAuthor"],[40094,"XPKeywords"],[40095,"XPSubject"]]),K(ne,"exif",[[33434,"ExposureTime"],[33437,"FNumber"],[34850,"ExposureProgram"],[34852,"SpectralSensitivity"],[34855,"ISO"],[34858,"TimeZoneOffset"],[34859,"SelfTimerMode"],[34864,"SensitivityType"],[34865,"StandardOutputSensitivity"],[34866,"RecommendedExposureIndex"],[34867,"ISOSpeed"],[34868,"ISOSpeedLatitudeyyy"],[34869,"ISOSpeedLatitudezzz"],[36864,"ExifVersion"],[36867,"DateTimeOriginal"],[36868,"CreateDate"],[36873,"GooglePlusUploadCode"],[36880,"OffsetTime"],[36881,"OffsetTimeOriginal"],[36882,"OffsetTimeDigitized"],[37121,"ComponentsConfiguration"],[37122,"CompressedBitsPerPixel"],[37377,"ShutterSpeedValue"],[37378,"ApertureValue"],[37379,"BrightnessValue"],[37380,"ExposureCompensation"],[37381,"MaxApertureValue"],[37382,"SubjectDistance"],[37383,"MeteringMode"],[37384,"LightSource"],[37385,"Flash"],[37386,"FocalLength"],[37393,"ImageNumber"],[37394,"SecurityClassification"],[37395,"ImageHistory"],[37396,"SubjectArea"],[37500,"MakerNote"],[37510,"UserComment"],[37520,"SubSecTime"],[37521,"SubSecTimeOriginal"],[37522,"SubSecTimeDigitized"],[37888,"AmbientTemperature"],[37889,"Humidity"],[37890,"Pressure"],[37891,"WaterDepth"],[37892,"Acceleration"],[37893,"CameraElevationAngle"],[40960,"FlashpixVersion"],[40961,"ColorSpace"],[40962,"ExifImageWidth"],[40963,"ExifImageHeight"],[40964,"RelatedSoundFile"],[41483,"FlashEnergy"],[41486,"FocalPlaneXResolution"],[41487,"FocalPlaneYResolution"],[41488,"FocalPlaneResolutionUnit"],[41492,"SubjectLocation"],[41493,"ExposureIndex"],[41495,"SensingMethod"],[41728,"FileSource"],[41729,"SceneType"],[41730,"CFAPattern"],[41985,"CustomRendered"],[41986,"ExposureMode"],[41987,"WhiteBalance"],[41988,"DigitalZoomRatio"],[41989,"FocalLengthIn35mmFormat"],[41990,"SceneCaptureType"],[41991,"GainControl"],[41992,"Contrast"],[41993,"Saturation"],[41994,"Sharpness"],[41996,"SubjectDistanceRange"],[42016,"ImageUniqueID"],[42032,"OwnerName"],[42033,"SerialNumber"],[42034,"LensInfo"],[42035,"LensMake"],[42036,"LensModel"],[42037,"LensSerialNumber"],[42080,"CompositeImage"],[42081,"CompositeImageCount"],[42082,"CompositeImageExposureTimes"],[42240,"Gamma"],[59932,"Padding"],[59933,"OffsetSchema"],[65e3,"OwnerName"],[65001,"SerialNumber"],[65002,"Lens"],[65100,"RawFile"],[65101,"Converter"],[65102,"WhiteBalance"],[65105,"Exposure"],[65106,"Shadows"],[65107,"Brightness"],[65108,"Contrast"],[65109,"Saturation"],[65110,"Sharpness"],[65111,"Smoothness"],[65112,"MoireFilter"],[40965,"InteropIFD"]]),K(ne,"gps",[[0,"GPSVersionID"],[1,"GPSLatitudeRef"],[2,"GPSLatitude"],[3,"GPSLongitudeRef"],[4,"GPSLongitude"],[5,"GPSAltitudeRef"],[6,"GPSAltitude"],[7,"GPSTimeStamp"],[8,"GPSSatellites"],[9,"GPSStatus"],[10,"GPSMeasureMode"],[11,"GPSDOP"],[12,"GPSSpeedRef"],[13,"GPSSpeed"],[14,"GPSTrackRef"],[15,"GPSTrack"],[16,"GPSImgDirectionRef"],[17,"GPSImgDirection"],[18,"GPSMapDatum"],[19,"GPSDestLatitudeRef"],[20,"GPSDestLatitude"],[21,"GPSDestLongitudeRef"],[22,"GPSDestLongitude"],[23,"GPSDestBearingRef"],[24,"GPSDestBearing"],[25,"GPSDestDistanceRef"],[26,"GPSDestDistance"],[27,"GPSProcessingMethod"],[28,"GPSAreaInformation"],[29,"GPSDateStamp"],[30,"GPSDifferential"],[31,"GPSHPositioningError"]]),K(Ie,["ifd0","ifd1"],[[274,{1:"Horizontal (normal)",2:"Mirror horizontal",3:"Rotate 180",4:"Mirror vertical",5:"Mirror horizontal and rotate 270 CW",6:"Rotate 90 CW",7:"Mirror horizontal and rotate 90 CW",8:"Rotate 270 CW"}],[296,{1:"None",2:"inches",3:"cm"}]]);let Lt=K(Ie,"exif",[[34850,{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"}],[37121,{0:"-",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}],[37383,{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"}],[37384,{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"}],[37385,{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"}],[41495,{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"}],[41728,{1:"Film Scanner",2:"Reflection Print Scanner",3:"Digital Camera"}],[41729,{1:"Directly photographed"}],[41985,{0:"Normal",1:"Custom",2:"HDR (no original saved)",3:"HDR (original saved)",4:"Original (for HDR)",6:"Panorama",7:"Portrait HDR",8:"Portrait"}],[41986,{0:"Auto",1:"Manual",2:"Auto bracket"}],[41987,{0:"Auto",1:"Manual"}],[41990,{0:"Standard",1:"Landscape",2:"Portrait",3:"Night",4:"Other"}],[41991,{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"}],[41996,{0:"Unknown",1:"Macro",2:"Close",3:"Distant"}],[42080,{0:"Unknown",1:"Not a Composite Image",2:"General Composite Image",3:"Composite Image Captured While Shooting"}]]);const qn={1:"No absolute unit of measurement",2:"Inch",3:"Centimeter"};Lt.set(37392,qn),Lt.set(41488,qn);const hs={0:"Normal",1:"Low",2:"High"};function jn(e){return typeof e=="object"&&e.length!==void 0?e[0]:e}function Xn(e){let t=Array.from(e).slice(1);return t[1]>15&&(t=t.map(i=>String.fromCharCode(i))),t[2]!=="0"&&t[2]!==0||t.pop(),t.join(".")}function ps(e){if(typeof e=="string"){var[t,i,s,n,r,a]=e.trim().split(/[-: ]/g).map(Number),o=new Date(t,i-1,s);return Number.isNaN(n)||Number.isNaN(r)||Number.isNaN(a)||(o.setHours(n),o.setMinutes(r),o.setSeconds(a)),Number.isNaN(+o)?e:o}}function kt(e){if(typeof e=="string")return e;let t=[];if(e[1]===0&&e[e.length-1]===0)for(let i=0;i<e.length;i+=2)t.push(Yn(e[i+1],e[i]));else for(let i=0;i<e.length;i+=2)t.push(Yn(e[i],e[i+1]));return et(String.fromCodePoint(...t))}function Yn(e,t){return e<<8|t}Lt.set(41992,hs),Lt.set(41993,hs),Lt.set(41994,hs),K(Ye,["ifd0","ifd1"],[[50827,function(e){return typeof e!="string"?jr(e):e}],[306,ps],[40091,kt],[40092,kt],[40093,kt],[40094,kt],[40095,kt]]),K(Ye,"exif",[[40960,Xn],[36864,Xn],[36867,ps],[36868,ps],[40962,jn],[40963,jn]]),K(Ye,"gps",[[0,e=>Array.from(e).join(".")],[7,e=>Array.from(e).join(":")]]);class ms extends Se{static canHandle(t,i){return t.getUint8(i+1)===225&&t.getUint32(i+4)===1752462448&&t.getString(i+4,20)==="http://ns.adobe.com/"}static headerLength(t,i){return t.getString(i+4,34)==="http://ns.adobe.com/xmp/extension/"?79:33}static findPosition(t,i){let s=super.findPosition(t,i);return s.multiSegment=s.extended=s.headerLength===79,s.multiSegment?(s.chunkCount=t.getUint8(i+72),s.chunkNumber=t.getUint8(i+76),t.getUint8(i+77)!==0&&s.chunkNumber++):(s.chunkCount=1/0,s.chunkNumber=-1),s}static handleMultiSegments(t){return t.map(i=>i.chunk.getString()).join("")}normalizeInput(t){return typeof t=="string"?t:pe.from(t).getString()}parse(t=this.chunk){if(!this.localOptions.parse)return t;t=function(r){let a={},o={};for(let l of na)a[l]=[],o[l]=0;return r.replace(Dd,(l,d,c)=>{if(d==="<"){let f=++o[c];return a[c].push(f),`${l}#${f}`}return`${l}#${a[c].pop()}`})}(t);let i=yt.findAll(t,"rdf","Description");i.length===0&&i.push(new yt("rdf","Description",void 0,t));let s,n={};for(let r of i)for(let a of r.properties)s=Pd(a.ns,n),ta(a,s);return function(r){let a;for(let o in r)a=r[o]=zi(r[o]),a===void 0&&delete r[o];return zi(r)}(n)}assignToOutput(t,i){if(this.localOptions.parse)for(let[s,n]of Object.entries(i))switch(s){case"tiff":this.assignObjectToOutput(t,"ifd0",n);break;case"exif":this.assignObjectToOutput(t,"exif",n);break;case"xmlns":break;default:this.assignObjectToOutput(t,s,n)}else t.xmp=i}}B(ms,"type","xmp"),B(ms,"multiSegment",!0),Z.set("xmp",ms);class Gi{static findAll(t){return ia(t,/([a-zA-Z0-9-]+):([a-zA-Z0-9-]+)=("[^"]*"|'[^']*')/gm).map(Gi.unpackMatch)}static unpackMatch(t){let i=t[1],s=t[2],n=t[3].slice(1,-1);return n=sa(n),new Gi(i,s,n)}constructor(t,i,s){this.ns=t,this.name=i,this.value=s}serialize(){return this.value}}class yt{static findAll(t,i,s){if(i!==void 0||s!==void 0){i=i||"[\\w\\d-]+",s=s||"[\\w\\d-]+";var n=new RegExp(`<(${i}):(${s})(#\\d+)?((\\s+?[\\w\\d-:]+=("[^"]*"|'[^']*'))*\\s*)(\\/>|>([\\s\\S]*?)<\\/\\1:\\2\\3>)`,"gm")}else n=/<([\w\d-]+):([\w\d-]+)(#\d+)?((\s+?[\w\d-:]+=("[^"]*"|'[^']*'))*\s*)(\/>|>([\s\S]*?)<\/\1:\2\3>)/gm;return ia(t,n).map(yt.unpackMatch)}static unpackMatch(t){let i=t[1],s=t[2],n=t[4],r=t[8];return new yt(i,s,n,r)}constructor(t,i,s,n){this.ns=t,this.name=i,this.attrString=s,this.innerXml=n,this.attrs=Gi.findAll(s),this.children=yt.findAll(n),this.value=this.children.length===0?sa(n):void 0,this.properties=[...this.attrs,...this.children]}get isPrimitive(){return this.value!==void 0&&this.attrs.length===0&&this.children.length===0}get isListContainer(){return this.children.length===1&&this.children[0].isList}get isList(){let{ns:t,name:i}=this;return t==="rdf"&&(i==="Seq"||i==="Bag"||i==="Alt")}get isListItem(){return this.ns==="rdf"&&this.name==="li"}serialize(){if(this.properties.length===0&&this.value===void 0)return;if(this.isPrimitive)return this.value;if(this.isListContainer)return this.children[0].serialize();if(this.isList)return Od(this.children.map(Ad));if(this.isListItem&&this.children.length===1&&this.attrs.length===0)return this.children[0].serialize();let t={};for(let i of this.properties)ta(i,t);return this.value!==void 0&&(t.value=this.value),zi(t)}}function ta(e,t){let i=e.serialize();i!==void 0&&(t[e.name]=i)}var Ad=e=>e.serialize(),Od=e=>e.length===1?e[0]:e,Pd=(e,t)=>t[e]?t[e]:t[e]={};function ia(e,t){let i,s=[];if(!e)return s;for(;(i=t.exec(e))!==null;)s.push(i);return s}function sa(e){if(function(s){return s==null||s==="null"||s==="undefined"||s===""||s.trim()===""}(e))return;let t=Number(e);if(!Number.isNaN(t))return t;let i=e.toLowerCase();return i==="true"||i!=="false"&&e.trim()}const na=["rdf:li","rdf:Seq","rdf:Bag","rdf:Alt","rdf:Description"],Dd=new RegExp(`(<|\\/)(${na.join("|")})`,"g");var Ld=Object.freeze({__proto__:null,default:kd,Exifr:Je,fileParsers:Fe,segmentParsers:Z,fileReaders:Ce,tagKeys:ne,tagValues:Ie,tagRevivers:Ye,createDictionary:K,extendDictionary:rt,fetchUrlAsArrayBuffer:st,readBlobAsArrayBuffer:nt,chunkedProps:We,otherSegments:Et,segments:at,tiffBlocks:j,segmentsAndBlocks:He,tiffExtractables:qe,inheritables:Tt,allFormatters:je,Options:ut,parse:Ji,gpsOnlyOptions:Qs,gps:Yr,thumbnailOnlyOptions:en,thumbnail:Kr,thumbnailUrl:Jr,orientationOnlyOptions:tn,orientation:sn,rotations:nn,get rotateCanvas(){return tt},get rotateCss(){return it},rotation:Zr});let Kn=Ri("fs",e=>e.promises);Ce.set("fs",class extends Qi{async readWhole(){this.chunked=!1,this.fs=await Kn;let e=await this.fs.readFile(this.input);this._swapBuffer(e)}async readChunked(){this.chunked=!0,this.fs=await Kn,await this.open(),await this.readChunk(0,this.options.firstChunkSize)}async open(){this.fh===void 0&&(this.fh=await this.fs.open(this.input,"r"),this.size=(await this.fh.stat(this.input)).size)}async _readChunk(e,t){this.fh===void 0&&await this.open(),e+t>this.size&&(t=this.size-e);var i=this.subarray(e,t,!0);return await this.fh.read(i.dataView,0,t,e),i}async close(){if(this.fh){let e=this.fh;this.fh=void 0,await e.close()}}});Ce.set("base64",class extends Qi{constructor(...e){super(...e),this.input=this.input.replace(/^data:([^;]+);base64,/gim,""),this.size=this.input.length/4*3,this.input.endsWith("==")?this.size-=2:this.input.endsWith("=")&&(this.size-=1)}async _readChunk(e,t){let i,s,n=this.input;e===void 0?(e=0,i=0,s=0):(i=4*Math.floor(e/3),s=e-i/4*3),t===void 0&&(t=this.size);let r=e+t,a=i+4*Math.ceil(r/3);n=n.slice(i,a);let o=Math.min(t,this.size-e);if(Ki){let l=Yi.from(n,"base64").slice(s,s+o);return this.set(l,e,!0)}{let l=this.subarray(e,o,!0),d=atob(n),c=l.toUint8();for(let f=0;f<o;f++)c[f]=d.charCodeAt(s+f);return l}}});class Jn extends Zi{static canHandle(t,i){return i===18761||i===19789}extendOptions(t){let{ifd0:i,xmp:s,iptc:n,icc:r}=t;s.enabled&&i.deps.add(700),n.enabled&&i.deps.add(33723),r.enabled&&i.deps.add(34675),i.finalizeFilters()}async parse(){let{tiff:t,xmp:i,iptc:s,icc:n}=this.options;if(t.enabled||i.enabled||s.enabled||n.enabled){let r=Math.max(Ls(this.options),this.options.chunkSize);await this.file.ensureChunk(0,r),this.createParser("tiff",this.file),this.parsers.tiff.parseHeader(),await this.parsers.tiff.parseIfd0Block(),this.adaptTiffPropAsSegment("xmp"),this.adaptTiffPropAsSegment("iptc"),this.adaptTiffPropAsSegment("icc")}}adaptTiffPropAsSegment(t){if(this.parsers.tiff[t]){let i=this.parsers.tiff[t];this.injectSegment(t,i)}}}B(Jn,"type","tiff"),Fe.set("tiff",Jn);let Nd=Ri("zlib");const Rd=["ihdr","iccp","text","itxt","exif"];class Zn extends Zi{constructor(...t){super(...t),B(this,"catchError",i=>this.errors.push(i)),B(this,"metaChunks",[]),B(this,"unknownChunks",[])}static canHandle(t,i){return i===35152&&t.getUint32(0)===2303741511&&t.getUint32(4)===218765834}async parse(){let{file:t}=this;await this.findPngChunksInRange(8,t.byteLength),await this.readSegments(this.metaChunks),this.findIhdr(),this.parseTextChunks(),await this.findExif().catch(this.catchError),await this.findXmp().catch(this.catchError),await this.findIcc().catch(this.catchError)}async findPngChunksInRange(t,i){let{file:s}=this;for(;t<i;){let n=s.getUint32(t),r=s.getUint32(t+4),a=s.getString(t+4,4).toLowerCase(),o=n+4+4+4,l={type:a,offset:t,length:o,start:t+4+4,size:n,marker:r};Rd.includes(a)?this.metaChunks.push(l):this.unknownChunks.push(l),t+=o}}parseTextChunks(){let t=this.metaChunks.filter(i=>i.type==="text");for(let i of t){let[s,n]=this.file.getString(i.start,i.size).split("\0");this.injectKeyValToIhdr(s,n)}}injectKeyValToIhdr(t,i){let s=this.parsers.ihdr;s&&s.raw.set(t,i)}findIhdr(){let t=this.metaChunks.find(i=>i.type==="ihdr");t&&this.options.ihdr.enabled!==!1&&this.createParser("ihdr",t.chunk)}async findExif(){let t=this.metaChunks.find(i=>i.type==="exif");t&&this.injectSegment("tiff",t.chunk)}async findXmp(){let t=this.metaChunks.filter(i=>i.type==="itxt");for(let i of t)i.chunk.getString(0,17)==="XML:com.adobe.xmp"&&this.injectSegment("xmp",i.chunk)}async findIcc(){let t=this.metaChunks.find(o=>o.type==="iccp");if(!t)return;let{chunk:i}=t,s=i.getUint8Array(0,81),n=0;for(;n<80&&s[n]!==0;)n++;let r=n+2,a=i.getString(0,n);if(this.injectKeyValToIhdr("ProfileName",a),Ni){let o=await Nd,l=i.getUint8Array(r);l=o.inflateSync(l),this.injectSegment("icc",l)}}}B(Zn,"type","png"),Fe.set("png",Zn),K(ne,"interop",[[1,"InteropIndex"],[2,"InteropVersion"],[4096,"RelatedImageFileFormat"],[4097,"RelatedImageWidth"],[4098,"RelatedImageHeight"]]),rt(ne,"ifd0",[[11,"ProcessingSoftware"],[254,"SubfileType"],[255,"OldSubfileType"],[263,"Thresholding"],[264,"CellWidth"],[265,"CellLength"],[266,"FillOrder"],[269,"DocumentName"],[280,"MinSampleValue"],[281,"MaxSampleValue"],[285,"PageName"],[286,"XPosition"],[287,"YPosition"],[290,"GrayResponseUnit"],[297,"PageNumber"],[321,"HalftoneHints"],[322,"TileWidth"],[323,"TileLength"],[332,"InkSet"],[337,"TargetPrinter"],[18246,"Rating"],[18249,"RatingPercent"],[33550,"PixelScale"],[34264,"ModelTransform"],[34377,"PhotoshopSettings"],[50706,"DNGVersion"],[50707,"DNGBackwardVersion"],[50708,"UniqueCameraModel"],[50709,"LocalizedCameraModel"],[50736,"DNGLensInfo"],[50739,"ShadowScale"],[50740,"DNGPrivateData"],[33920,"IntergraphMatrix"],[33922,"ModelTiePoint"],[34118,"SEMInfo"],[34735,"GeoTiffDirectory"],[34736,"GeoTiffDoubleParams"],[34737,"GeoTiffAsciiParams"],[50341,"PrintIM"],[50721,"ColorMatrix1"],[50722,"ColorMatrix2"],[50723,"CameraCalibration1"],[50724,"CameraCalibration2"],[50725,"ReductionMatrix1"],[50726,"ReductionMatrix2"],[50727,"AnalogBalance"],[50728,"AsShotNeutral"],[50729,"AsShotWhiteXY"],[50730,"BaselineExposure"],[50731,"BaselineNoise"],[50732,"BaselineSharpness"],[50734,"LinearResponseLimit"],[50735,"CameraSerialNumber"],[50741,"MakerNoteSafety"],[50778,"CalibrationIlluminant1"],[50779,"CalibrationIlluminant2"],[50781,"RawDataUniqueID"],[50827,"OriginalRawFileName"],[50828,"OriginalRawFileData"],[50831,"AsShotICCProfile"],[50832,"AsShotPreProfileMatrix"],[50833,"CurrentICCProfile"],[50834,"CurrentPreProfileMatrix"],[50879,"ColorimetricReference"],[50885,"SRawType"],[50898,"PanasonicTitle"],[50899,"PanasonicTitle2"],[50931,"CameraCalibrationSig"],[50932,"ProfileCalibrationSig"],[50933,"ProfileIFD"],[50934,"AsShotProfileName"],[50936,"ProfileName"],[50937,"ProfileHueSatMapDims"],[50938,"ProfileHueSatMapData1"],[50939,"ProfileHueSatMapData2"],[50940,"ProfileToneCurve"],[50941,"ProfileEmbedPolicy"],[50942,"ProfileCopyright"],[50964,"ForwardMatrix1"],[50965,"ForwardMatrix2"],[50966,"PreviewApplicationName"],[50967,"PreviewApplicationVersion"],[50968,"PreviewSettingsName"],[50969,"PreviewSettingsDigest"],[50970,"PreviewColorSpace"],[50971,"PreviewDateTime"],[50972,"RawImageDigest"],[50973,"OriginalRawFileDigest"],[50981,"ProfileLookTableDims"],[50982,"ProfileLookTableData"],[51043,"TimeCodes"],[51044,"FrameRate"],[51058,"TStop"],[51081,"ReelName"],[51089,"OriginalDefaultFinalSize"],[51090,"OriginalBestQualitySize"],[51091,"OriginalDefaultCropSize"],[51105,"CameraLabel"],[51107,"ProfileHueSatMapEncoding"],[51108,"ProfileLookTableEncoding"],[51109,"BaselineExposureOffset"],[51110,"DefaultBlackRender"],[51111,"NewRawImageDigest"],[51112,"RawToPreviewGain"]]);let Qn=[[273,"StripOffsets"],[279,"StripByteCounts"],[288,"FreeOffsets"],[289,"FreeByteCounts"],[291,"GrayResponseCurve"],[292,"T4Options"],[293,"T6Options"],[300,"ColorResponseUnit"],[320,"ColorMap"],[324,"TileOffsets"],[325,"TileByteCounts"],[326,"BadFaxLines"],[327,"CleanFaxData"],[328,"ConsecutiveBadFaxLines"],[330,"SubIFD"],[333,"InkNames"],[334,"NumberofInks"],[336,"DotRange"],[338,"ExtraSamples"],[339,"SampleFormat"],[340,"SMinSampleValue"],[341,"SMaxSampleValue"],[342,"TransferRange"],[343,"ClipPath"],[344,"XClipPathUnits"],[345,"YClipPathUnits"],[346,"Indexed"],[347,"JPEGTables"],[351,"OPIProxy"],[400,"GlobalParametersIFD"],[401,"ProfileType"],[402,"FaxProfile"],[403,"CodingMethods"],[404,"VersionYear"],[405,"ModeNumber"],[433,"Decode"],[434,"DefaultImageColor"],[435,"T82Options"],[437,"JPEGTables"],[512,"JPEGProc"],[515,"JPEGRestartInterval"],[517,"JPEGLosslessPredictors"],[518,"JPEGPointTransforms"],[519,"JPEGQTables"],[520,"JPEGDCTables"],[521,"JPEGACTables"],[559,"StripRowCounts"],[999,"USPTOMiscellaneous"],[18247,"XP_DIP_XML"],[18248,"StitchInfo"],[28672,"SonyRawFileType"],[28688,"SonyToneCurve"],[28721,"VignettingCorrection"],[28722,"VignettingCorrParams"],[28724,"ChromaticAberrationCorrection"],[28725,"ChromaticAberrationCorrParams"],[28726,"DistortionCorrection"],[28727,"DistortionCorrParams"],[29895,"SonyCropTopLeft"],[29896,"SonyCropSize"],[32781,"ImageID"],[32931,"WangTag1"],[32932,"WangAnnotation"],[32933,"WangTag3"],[32934,"WangTag4"],[32953,"ImageReferencePoints"],[32954,"RegionXformTackPoint"],[32955,"WarpQuadrilateral"],[32956,"AffineTransformMat"],[32995,"Matteing"],[32996,"DataType"],[32997,"ImageDepth"],[32998,"TileDepth"],[33300,"ImageFullWidth"],[33301,"ImageFullHeight"],[33302,"TextureFormat"],[33303,"WrapModes"],[33304,"FovCot"],[33305,"MatrixWorldToScreen"],[33306,"MatrixWorldToCamera"],[33405,"Model2"],[33421,"CFARepeatPatternDim"],[33422,"CFAPattern2"],[33423,"BatteryLevel"],[33424,"KodakIFD"],[33445,"MDFileTag"],[33446,"MDScalePixel"],[33447,"MDColorTable"],[33448,"MDLabName"],[33449,"MDSampleInfo"],[33450,"MDPrepDate"],[33451,"MDPrepTime"],[33452,"MDFileUnits"],[33589,"AdventScale"],[33590,"AdventRevision"],[33628,"UIC1Tag"],[33629,"UIC2Tag"],[33630,"UIC3Tag"],[33631,"UIC4Tag"],[33918,"IntergraphPacketData"],[33919,"IntergraphFlagRegisters"],[33921,"INGRReserved"],[34016,"Site"],[34017,"ColorSequence"],[34018,"IT8Header"],[34019,"RasterPadding"],[34020,"BitsPerRunLength"],[34021,"BitsPerExtendedRunLength"],[34022,"ColorTable"],[34023,"ImageColorIndicator"],[34024,"BackgroundColorIndicator"],[34025,"ImageColorValue"],[34026,"BackgroundColorValue"],[34027,"PixelIntensityRange"],[34028,"TransparencyIndicator"],[34029,"ColorCharacterization"],[34030,"HCUsage"],[34031,"TrapIndicator"],[34032,"CMYKEquivalent"],[34152,"AFCP_IPTC"],[34232,"PixelMagicJBIGOptions"],[34263,"JPLCartoIFD"],[34306,"WB_GRGBLevels"],[34310,"LeafData"],[34687,"TIFF_FXExtensions"],[34688,"MultiProfiles"],[34689,"SharedData"],[34690,"T88Options"],[34732,"ImageLayer"],[34750,"JBIGOptions"],[34856,"Opto-ElectricConvFactor"],[34857,"Interlace"],[34908,"FaxRecvParams"],[34909,"FaxSubAddress"],[34910,"FaxRecvTime"],[34929,"FedexEDR"],[34954,"LeafSubIFD"],[37387,"FlashEnergy"],[37388,"SpatialFrequencyResponse"],[37389,"Noise"],[37390,"FocalPlaneXResolution"],[37391,"FocalPlaneYResolution"],[37392,"FocalPlaneResolutionUnit"],[37397,"ExposureIndex"],[37398,"TIFF-EPStandardID"],[37399,"SensingMethod"],[37434,"CIP3DataFile"],[37435,"CIP3Sheet"],[37436,"CIP3Side"],[37439,"StoNits"],[37679,"MSDocumentText"],[37680,"MSPropertySetStorage"],[37681,"MSDocumentTextPosition"],[37724,"ImageSourceData"],[40965,"InteropIFD"],[40976,"SamsungRawPointersOffset"],[40977,"SamsungRawPointersLength"],[41217,"SamsungRawByteOrder"],[41218,"SamsungRawUnknown"],[41484,"SpatialFrequencyResponse"],[41485,"Noise"],[41489,"ImageNumber"],[41490,"SecurityClassification"],[41491,"ImageHistory"],[41494,"TIFF-EPStandardID"],[41995,"DeviceSettingDescription"],[42112,"GDALMetadata"],[42113,"GDALNoData"],[44992,"ExpandSoftware"],[44993,"ExpandLens"],[44994,"ExpandFilm"],[44995,"ExpandFilterLens"],[44996,"ExpandScanner"],[44997,"ExpandFlashLamp"],[46275,"HasselbladRawImage"],[48129,"PixelFormat"],[48130,"Transformation"],[48131,"Uncompressed"],[48132,"ImageType"],[48256,"ImageWidth"],[48257,"ImageHeight"],[48258,"WidthResolution"],[48259,"HeightResolution"],[48320,"ImageOffset"],[48321,"ImageByteCount"],[48322,"AlphaOffset"],[48323,"AlphaByteCount"],[48324,"ImageDataDiscard"],[48325,"AlphaDataDiscard"],[50215,"OceScanjobDesc"],[50216,"OceApplicationSelector"],[50217,"OceIDNumber"],[50218,"OceImageLogic"],[50255,"Annotations"],[50459,"HasselbladExif"],[50547,"OriginalFileName"],[50560,"USPTOOriginalContentType"],[50656,"CR2CFAPattern"],[50710,"CFAPlaneColor"],[50711,"CFALayout"],[50712,"LinearizationTable"],[50713,"BlackLevelRepeatDim"],[50714,"BlackLevel"],[50715,"BlackLevelDeltaH"],[50716,"BlackLevelDeltaV"],[50717,"WhiteLevel"],[50718,"DefaultScale"],[50719,"DefaultCropOrigin"],[50720,"DefaultCropSize"],[50733,"BayerGreenSplit"],[50737,"ChromaBlurRadius"],[50738,"AntiAliasStrength"],[50752,"RawImageSegmentation"],[50780,"BestQualityScale"],[50784,"AliasLayerMetadata"],[50829,"ActiveArea"],[50830,"MaskedAreas"],[50935,"NoiseReductionApplied"],[50974,"SubTileBlockSize"],[50975,"RowInterleaveFactor"],[51008,"OpcodeList1"],[51009,"OpcodeList2"],[51022,"OpcodeList3"],[51041,"NoiseProfile"],[51114,"CacheVersion"],[51125,"DefaultUserCrop"],[51157,"NikonNEFInfo"],[65024,"KdcIFD"]];rt(ne,"ifd0",Qn),rt(ne,"exif",Qn),K(Ie,"gps",[[23,{M:"Magnetic North",T:"True North"}],[25,{K:"Kilometers",M:"Miles",N:"Nautical Miles"}]]);class $s extends Se{static canHandle(t,i){return t.getUint8(i+1)===224&&t.getUint32(i+4)===1246120262&&t.getUint8(i+8)===0}parse(){return this.parseTags(),this.translate(),this.output}parseTags(){this.raw=new Map([[0,this.chunk.getUint16(0)],[2,this.chunk.getUint8(2)],[3,this.chunk.getUint16(3)],[5,this.chunk.getUint16(5)],[7,this.chunk.getUint8(7)],[8,this.chunk.getUint8(8)]])}}B($s,"type","jfif"),B($s,"headerLength",9),Z.set("jfif",$s),K(ne,"jfif",[[0,"JFIFVersion"],[2,"ResolutionUnit"],[3,"XResolution"],[5,"YResolution"],[7,"ThumbnailWidth"],[8,"ThumbnailHeight"]]);class er extends Se{parse(){return this.parseTags(),this.translate(),this.output}parseTags(){this.raw=new Map([[0,this.chunk.getUint32(0)],[4,this.chunk.getUint32(4)],[8,this.chunk.getUint8(8)],[9,this.chunk.getUint8(9)],[10,this.chunk.getUint8(10)],[11,this.chunk.getUint8(11)],[12,this.chunk.getUint8(12)],...Array.from(this.raw)])}}B(er,"type","ihdr"),Z.set("ihdr",er),K(ne,"ihdr",[[0,"ImageWidth"],[4,"ImageHeight"],[8,"BitDepth"],[9,"ColorType"],[10,"Compression"],[11,"Filter"],[12,"Interlace"]]),K(Ie,"ihdr",[[9,{0:"Grayscale",2:"RGB",3:"Palette",4:"Grayscale with Alpha",6:"RGB with Alpha",DEFAULT:"Unknown"}],[10,{0:"Deflate/Inflate",DEFAULT:"Unknown"}],[11,{0:"Adaptive",DEFAULT:"Unknown"}],[12,{0:"Noninterlaced",1:"Adam7 Interlace",DEFAULT:"Unknown"}]]);class yi extends Se{static canHandle(t,i){return t.getUint8(i+1)===226&&t.getUint32(i+4)===1229144927}static findPosition(t,i){let s=super.findPosition(t,i);return s.chunkNumber=t.getUint8(i+16),s.chunkCount=t.getUint8(i+17),s.multiSegment=s.chunkCount>1,s}static handleMultiSegments(t){return function(i){let s=function(n){let r=n[0].constructor,a=0;for(let d of n)a+=d.length;let o=new r(a),l=0;for(let d of n)o.set(d,l),l+=d.length;return o}(i.map(n=>n.chunk.toUint8()));return new pe(s)}(t)}parse(){return this.raw=new Map,this.parseHeader(),this.parseTags(),this.translate(),this.output}parseHeader(){let{raw:t}=this;this.chunk.byteLength<84&&Q("ICC header is too short");for(let[i,s]of Object.entries(zd)){i=parseInt(i,10);let n=s(this.chunk,i);n!=="\0\0\0\0"&&t.set(i,n)}}parseTags(){let t,i,s,n,r,{raw:a}=this,o=this.chunk.getUint32(128),l=132,d=this.chunk.byteLength;for(;o--;){if(t=this.chunk.getString(l,4),i=this.chunk.getUint32(l+4),s=this.chunk.getUint32(l+8),n=this.chunk.getString(i,4),i+s>d)return void console.warn("reached the end of the first ICC chunk. Enable options.tiff.multiSegment to read all ICC segments.");r=this.parseTag(n,i,s),r!==void 0&&r!=="\0\0\0\0"&&a.set(t,r),l+=12}}parseTag(t,i,s){switch(t){case"desc":return this.parseDesc(i);case"mluc":return this.parseMluc(i);case"text":return this.parseText(i,s);case"sig ":return this.parseSig(i)}if(!(i+s>this.chunk.byteLength))return this.chunk.getUint8Array(i,s)}parseDesc(t){let i=this.chunk.getUint32(t+8)-1;return et(this.chunk.getString(t+12,i))}parseText(t,i){return et(this.chunk.getString(t+8,i-8))}parseSig(t){return et(this.chunk.getString(t+8,4))}parseMluc(t){let{chunk:i}=this,s=i.getUint32(t+8),n=i.getUint32(t+12),r=t+16,a=[];for(let o=0;o<s;o++){let l=i.getString(r+0,2),d=i.getString(r+2,2),c=i.getUint32(r+4),f=i.getUint32(r+8)+t,u=et(i.getUnicodeString(f,c));a.push({lang:l,country:d,text:u}),r+=n}return s===1?a[0].text:a}translateValue(t,i){return typeof t=="string"?i[t]||i[t.toLowerCase()]||t:i[t]||t}}B(yi,"type","icc"),B(yi,"multiSegment",!0),B(yi,"headerLength",18);const zd={4:Ae,8:function(e,t){return[e.getUint8(t),e.getUint8(t+1)>>4,e.getUint8(t+1)%16].map(i=>i.toString(10)).join(".")},12:Ae,16:Ae,20:Ae,24:function(e,t){const i=e.getUint16(t),s=e.getUint16(t+2)-1,n=e.getUint16(t+4),r=e.getUint16(t+6),a=e.getUint16(t+8),o=e.getUint16(t+10);return new Date(Date.UTC(i,s,n,r,a,o))},36:Ae,40:Ae,48:Ae,52:Ae,64:(e,t)=>e.getUint32(t),80:Ae};function Ae(e,t){return et(e.getString(t,4))}Z.set("icc",yi),K(ne,"icc",[[4,"ProfileCMMType"],[8,"ProfileVersion"],[12,"ProfileClass"],[16,"ColorSpaceData"],[20,"ProfileConnectionSpace"],[24,"ProfileDateTime"],[36,"ProfileFileSignature"],[40,"PrimaryPlatform"],[44,"CMMFlags"],[48,"DeviceManufacturer"],[52,"DeviceModel"],[56,"DeviceAttributes"],[64,"RenderingIntent"],[68,"ConnectionSpaceIlluminant"],[80,"ProfileCreator"],[84,"ProfileID"],["Header","ProfileHeader"],["MS00","WCSProfiles"],["bTRC","BlueTRC"],["bXYZ","BlueMatrixColumn"],["bfd","UCRBG"],["bkpt","MediaBlackPoint"],["calt","CalibrationDateTime"],["chad","ChromaticAdaptation"],["chrm","Chromaticity"],["ciis","ColorimetricIntentImageState"],["clot","ColorantTableOut"],["clro","ColorantOrder"],["clrt","ColorantTable"],["cprt","ProfileCopyright"],["crdi","CRDInfo"],["desc","ProfileDescription"],["devs","DeviceSettings"],["dmdd","DeviceModelDesc"],["dmnd","DeviceMfgDesc"],["dscm","ProfileDescriptionML"],["fpce","FocalPlaneColorimetryEstimates"],["gTRC","GreenTRC"],["gXYZ","GreenMatrixColumn"],["gamt","Gamut"],["kTRC","GrayTRC"],["lumi","Luminance"],["meas","Measurement"],["meta","Metadata"],["mmod","MakeAndModel"],["ncl2","NamedColor2"],["ncol","NamedColor"],["ndin","NativeDisplayInfo"],["pre0","Preview0"],["pre1","Preview1"],["pre2","Preview2"],["ps2i","PS2RenderingIntent"],["ps2s","PostScript2CSA"],["psd0","PostScript2CRD0"],["psd1","PostScript2CRD1"],["psd2","PostScript2CRD2"],["psd3","PostScript2CRD3"],["pseq","ProfileSequenceDesc"],["psid","ProfileSequenceIdentifier"],["psvm","PS2CRDVMSize"],["rTRC","RedTRC"],["rXYZ","RedMatrixColumn"],["resp","OutputResponse"],["rhoc","ReflectionHardcopyOrigColorimetry"],["rig0","PerceptualRenderingIntentGamut"],["rig2","SaturationRenderingIntentGamut"],["rpoc","ReflectionPrintOutputColorimetry"],["sape","SceneAppearanceEstimates"],["scoe","SceneColorimetryEstimates"],["scrd","ScreeningDesc"],["scrn","Screening"],["targ","CharTarget"],["tech","Technology"],["vcgt","VideoCardGamma"],["view","ViewingConditions"],["vued","ViewingCondDesc"],["wtpt","MediaWhitePoint"]]);const ci={"4d2p":"Erdt Systems",AAMA:"Aamazing Technologies",ACER:"Acer",ACLT:"Acolyte Color Research",ACTI:"Actix Sytems",ADAR:"Adara Technology",ADBE:"Adobe",ADI:"ADI Systems",AGFA:"Agfa Graphics",ALMD:"Alps Electric",ALPS:"Alps Electric",ALWN:"Alwan Color Expertise",AMTI:"Amiable Technologies",AOC:"AOC International",APAG:"Apago",APPL:"Apple Computer",AST:"AST","AT&T":"AT&T",BAEL:"BARBIERI electronic",BRCO:"Barco NV",BRKP:"Breakpoint",BROT:"Brother",BULL:"Bull",BUS:"Bus Computer Systems","C-IT":"C-Itoh",CAMR:"Intel",CANO:"Canon",CARR:"Carroll Touch",CASI:"Casio",CBUS:"Colorbus PL",CEL:"Crossfield",CELx:"Crossfield",CGS:"CGS Publishing Technologies International",CHM:"Rochester Robotics",CIGL:"Colour Imaging Group, London",CITI:"Citizen",CL00:"Candela",CLIQ:"Color IQ",CMCO:"Chromaco",CMiX:"CHROMiX",COLO:"Colorgraphic Communications",COMP:"Compaq",COMp:"Compeq/Focus Technology",CONR:"Conrac Display Products",CORD:"Cordata Technologies",CPQ:"Compaq",CPRO:"ColorPro",CRN:"Cornerstone",CTX:"CTX International",CVIS:"ColorVision",CWC:"Fujitsu Laboratories",DARI:"Darius Technology",DATA:"Dataproducts",DCP:"Dry Creek Photo",DCRC:"Digital Contents Resource Center, Chung-Ang University",DELL:"Dell Computer",DIC:"Dainippon Ink and Chemicals",DICO:"Diconix",DIGI:"Digital","DL&C":"Digital Light & Color",DPLG:"Doppelganger",DS:"Dainippon Screen",DSOL:"DOOSOL",DUPN:"DuPont",EPSO:"Epson",ESKO:"Esko-Graphics",ETRI:"Electronics and Telecommunications Research Institute",EVER:"Everex Systems",EXAC:"ExactCODE",Eizo:"Eizo",FALC:"Falco Data Products",FF:"Fuji Photo Film",FFEI:"FujiFilm Electronic Imaging",FNRD:"Fnord Software",FORA:"Fora",FORE:"Forefront Technology",FP:"Fujitsu",FPA:"WayTech Development",FUJI:"Fujitsu",FX:"Fuji Xerox",GCC:"GCC Technologies",GGSL:"Global Graphics Software",GMB:"Gretagmacbeth",GMG:"GMG",GOLD:"GoldStar Technology",GOOG:"Google",GPRT:"Giantprint",GTMB:"Gretagmacbeth",GVC:"WayTech Development",GW2K:"Sony",HCI:"HCI",HDM:"Heidelberger Druckmaschinen",HERM:"Hermes",HITA:"Hitachi America",HP:"Hewlett-Packard",HTC:"Hitachi",HiTi:"HiTi Digital",IBM:"IBM",IDNT:"Scitex",IEC:"Hewlett-Packard",IIYA:"Iiyama North America",IKEG:"Ikegami Electronics",IMAG:"Image Systems",IMI:"Ingram Micro",INTC:"Intel",INTL:"N/A (INTL)",INTR:"Intra Electronics",IOCO:"Iocomm International Technology",IPS:"InfoPrint Solutions Company",IRIS:"Scitex",ISL:"Ichikawa Soft Laboratory",ITNL:"N/A (ITNL)",IVM:"IVM",IWAT:"Iwatsu Electric",Idnt:"Scitex",Inca:"Inca Digital Printers",Iris:"Scitex",JPEG:"Joint Photographic Experts Group",JSFT:"Jetsoft Development",JVC:"JVC Information Products",KART:"Scitex",KFC:"KFC Computek Components",KLH:"KLH Computers",KMHD:"Konica Minolta",KNCA:"Konica",KODA:"Kodak",KYOC:"Kyocera",Kart:"Scitex",LCAG:"Leica",LCCD:"Leeds Colour",LDAK:"Left Dakota",LEAD:"Leading Technology",LEXM:"Lexmark International",LINK:"Link Computer",LINO:"Linotronic",LITE:"Lite-On",Leaf:"Leaf",Lino:"Linotronic",MAGC:"Mag Computronic",MAGI:"MAG Innovision",MANN:"Mannesmann",MICN:"Micron Technology",MICR:"Microtek",MICV:"Microvitec",MINO:"Minolta",MITS:"Mitsubishi Electronics America",MITs:"Mitsuba",MNLT:"Minolta",MODG:"Modgraph",MONI:"Monitronix",MONS:"Monaco Systems",MORS:"Morse Technology",MOTI:"Motive Systems",MSFT:"Microsoft",MUTO:"MUTOH INDUSTRIES",Mits:"Mitsubishi Electric",NANA:"NANAO",NEC:"NEC",NEXP:"NexPress Solutions",NISS:"Nissei Sangyo America",NKON:"Nikon",NONE:"none",OCE:"Oce Technologies",OCEC:"OceColor",OKI:"Oki",OKID:"Okidata",OKIP:"Okidata",OLIV:"Olivetti",OLYM:"Olympus",ONYX:"Onyx Graphics",OPTI:"Optiquest",PACK:"Packard Bell",PANA:"Matsushita Electric Industrial",PANT:"Pantone",PBN:"Packard Bell",PFU:"PFU",PHIL:"Philips Consumer Electronics",PNTX:"HOYA",POne:"Phase One A/S",PREM:"Premier Computer Innovations",PRIN:"Princeton Graphic Systems",PRIP:"Princeton Publishing Labs",QLUX:"Hong Kong",QMS:"QMS",QPCD:"QPcard AB",QUAD:"QuadLaser",QUME:"Qume",RADI:"Radius",RDDx:"Integrated Color Solutions",RDG:"Roland DG",REDM:"REDMS Group",RELI:"Relisys",RGMS:"Rolf Gierling Multitools",RICO:"Ricoh",RNLD:"Edmund Ronald",ROYA:"Royal",RPC:"Ricoh Printing Systems",RTL:"Royal Information Electronics",SAMP:"Sampo",SAMS:"Samsung",SANT:"Jaime Santana Pomares",SCIT:"Scitex",SCRN:"Dainippon Screen",SDP:"Scitex",SEC:"Samsung",SEIK:"Seiko Instruments",SEIk:"Seikosha",SGUY:"ScanGuy.com",SHAR:"Sharp Laboratories",SICC:"International Color Consortium",SONY:"Sony",SPCL:"SpectraCal",STAR:"Star",STC:"Sampo Technology",Scit:"Scitex",Sdp:"Scitex",Sony:"Sony",TALO:"Talon Technology",TAND:"Tandy",TATU:"Tatung",TAXA:"TAXAN America",TDS:"Tokyo Denshi Sekei",TECO:"TECO Information Systems",TEGR:"Tegra",TEKT:"Tektronix",TI:"Texas Instruments",TMKR:"TypeMaker",TOSB:"Toshiba",TOSH:"Toshiba",TOTK:"TOTOKU ELECTRIC",TRIU:"Triumph",TSBT:"Toshiba",TTX:"TTX Computer Products",TVM:"TVM Professional Monitor",TW:"TW Casper",ULSX:"Ulead Systems",UNIS:"Unisys",UTZF:"Utz Fehlau & Sohn",VARI:"Varityper",VIEW:"Viewsonic",VISL:"Visual communication",VIVO:"Vivo Mobile Communication",WANG:"Wang",WLBR:"Wilbur Imaging",WTG2:"Ware To Go",WYSE:"WYSE Technology",XERX:"Xerox",XRIT:"X-Rite",ZRAN:"Zoran",Zebr:"Zebra Technologies",appl:"Apple Computer",bICC:"basICColor",berg:"bergdesign",ceyd:"Integrated Color Solutions",clsp:"MacDermid ColorSpan",ds:"Dainippon Screen",dupn:"DuPont",ffei:"FujiFilm Electronic Imaging",flux:"FluxData",iris:"Scitex",kart:"Scitex",lcms:"Little CMS",lino:"Linotronic",none:"none",ob4d:"Erdt Systems",obic:"Medigraph",quby:"Qubyx Sarl",scit:"Scitex",scrn:"Dainippon Screen",sdp:"Scitex",siwi:"SIWI GRAFIKA",yxym:"YxyMaster"},tr={scnr:"Scanner",mntr:"Monitor",prtr:"Printer",link:"Device Link",abst:"Abstract",spac:"Color Space Conversion Profile",nmcl:"Named Color",cenc:"ColorEncodingSpace profile",mid:"MultiplexIdentification profile",mlnk:"MultiplexLink profile",mvis:"MultiplexVisualization profile",nkpf:"Nikon Input Device Profile (NON-STANDARD!)"};K(Ie,"icc",[[4,ci],[12,tr],[40,Object.assign({},ci,tr)],[48,ci],[80,ci],[64,{0:"Perceptual",1:"Relative Colorimetric",2:"Saturation",3:"Absolute Colorimetric"}],["tech",{amd:"Active Matrix Display",crt:"Cathode Ray Tube Display",kpcd:"Photo CD",pmd:"Passive Matrix Display",dcam:"Digital Camera",dcpj:"Digital Cinema Projector",dmpc:"Digital Motion Picture Camera",dsub:"Dye Sublimation Printer",epho:"Electrophotographic Printer",esta:"Electrostatic Printer",flex:"Flexography",fprn:"Film Writer",fscn:"Film Scanner",grav:"Gravure",ijet:"Ink Jet Printer",imgs:"Photo Image Setter",mpfr:"Motion Picture Film Recorder",mpfs:"Motion Picture Film Scanner",offs:"Offset Lithography",pjtv:"Projection Television",rpho:"Photographic Paper Printer",rscn:"Reflective Scanner",silk:"Silkscreen",twax:"Thermal Wax Printer",vidc:"Video Camera",vidm:"Video Monitor"}]]);class ui extends Se{static canHandle(t,i,s){return t.getUint8(i+1)===237&&t.getString(i+4,9)==="Photoshop"&&this.containsIptc8bim(t,i,s)!==void 0}static headerLength(t,i,s){let n,r=this.containsIptc8bim(t,i,s);if(r!==void 0)return n=t.getUint8(i+r+7),n%2!=0&&(n+=1),n===0&&(n=4),r+8+n}static containsIptc8bim(t,i,s){for(let n=0;n<s;n++)if(this.isIptcSegmentHead(t,i+n))return n}static isIptcSegmentHead(t,i){return t.getUint8(i)===56&&t.getUint32(i)===943868237&&t.getUint16(i+4)===1028}parse(){let{raw:t}=this,i=this.chunk.byteLength-1,s=!1;for(let n=0;n<i;n++)if(this.chunk.getUint8(n)===28&&this.chunk.getUint8(n+1)===2){s=!0;let r=this.chunk.getUint16(n+3),a=this.chunk.getUint8(n+2),o=this.chunk.getLatin1String(n+5,r);t.set(a,this.pluralizeValue(t.get(a),o)),n+=4+r}else if(s)break;return this.translate(),this.output}pluralizeValue(t,i){return t!==void 0?t instanceof Array?(t.push(i),t):[t,i]:i}}B(ui,"type","iptc"),B(ui,"translateValues",!1),B(ui,"reviveValues",!1),Z.set("iptc",ui),K(ne,"iptc",[[0,"ApplicationRecordVersion"],[3,"ObjectTypeReference"],[4,"ObjectAttributeReference"],[5,"ObjectName"],[7,"EditStatus"],[8,"EditorialUpdate"],[10,"Urgency"],[12,"SubjectReference"],[15,"Category"],[20,"SupplementalCategories"],[22,"FixtureIdentifier"],[25,"Keywords"],[26,"ContentLocationCode"],[27,"ContentLocationName"],[30,"ReleaseDate"],[35,"ReleaseTime"],[37,"ExpirationDate"],[38,"ExpirationTime"],[40,"SpecialInstructions"],[42,"ActionAdvised"],[45,"ReferenceService"],[47,"ReferenceDate"],[50,"ReferenceNumber"],[55,"DateCreated"],[60,"TimeCreated"],[62,"DigitalCreationDate"],[63,"DigitalCreationTime"],[65,"OriginatingProgram"],[70,"ProgramVersion"],[75,"ObjectCycle"],[80,"Byline"],[85,"BylineTitle"],[90,"City"],[92,"Sublocation"],[95,"State"],[100,"CountryCode"],[101,"Country"],[103,"OriginalTransmissionReference"],[105,"Headline"],[110,"Credit"],[115,"Source"],[116,"CopyrightNotice"],[118,"Contact"],[120,"Caption"],[121,"LocalCaption"],[122,"Writer"],[125,"RasterizedCaption"],[130,"ImageType"],[131,"ImageOrientation"],[135,"LanguageIdentifier"],[150,"AudioType"],[151,"AudioSamplingRate"],[152,"AudioSamplingResolution"],[153,"AudioDuration"],[154,"AudioOutcue"],[184,"JobID"],[185,"MasterDocumentID"],[186,"ShortDocumentID"],[187,"UniqueDocumentID"],[188,"OwnerID"],[200,"ObjectPreviewFileFormat"],[201,"ObjectPreviewFileVersion"],[202,"ObjectPreviewData"],[221,"Prefs"],[225,"ClassifyState"],[228,"SimilarityIndex"],[230,"DocumentNotes"],[231,"DocumentHistory"],[232,"ExifCameraInfo"],[255,"CatalogSets"]]),K(Ie,"iptc",[[10,{0:"0 (reserved)",1:"1 (most urgent)",2:"2",3:"3",4:"4",5:"5 (normal urgency)",6:"6",7:"7",8:"8 (least urgent)",9:"9 (user-defined priority)"}],[75,{a:"Morning",b:"Both Morning and Evening",p:"Evening"}],[131,{L:"Landscape",P:"Portrait",S:"Square"}]]);var Md=Object.defineProperty,ra=(e,t)=>{for(var i in t)Md(e,i,{get:t[i],enumerable:!0})},gs=Math.pow(2,32),ie=Math.pow(2,32)-1,Gd=1,Vd=2,Wd=4,bi=1,_i=2,vi=8,wi=16,Si=32,ir=131072,Nt=1,Ii=4,Rt=256,zt=512,Mt=1024,Gt=2048,aa=-1,Me=0,be=1,Ve=class oa extends ArrayBuffer{constructor(t){super(t),this.fileStart=0,this.usedBytes=0}static fromArrayBuffer(t,i){const s=new oa(t.byteLength);return new Uint8Array(s).set(new Uint8Array(t)),s.fileStart=i,s}},ye=class N{constructor(t,i,s){this._byteLength=0,this.failurePosition=0,this._dynamicSize=1,this._byteOffset=i||0,t instanceof ArrayBuffer?this.buffer=Ve.fromArrayBuffer(t,0):t instanceof DataView?(this.dataView=t,i&&(this._byteOffset+=i)):this.buffer=new Ve(t||0),this.position=0,this.endianness=s||1}static{this.ENDIANNESS=new Int8Array(new Int16Array([1]).buffer)[0]>0?2:1}getPosition(){return this.position}_realloc(t){if(!this._dynamicSize)return;const i=this._byteOffset+this.position+t;let s=this._buffer.byteLength;if(i<=s){i>this._byteLength&&(this._byteLength=i);return}for(s<1&&(s=1);i>s;)s*=2;const n=new Ve(s),r=new Uint8Array(this._buffer);new Uint8Array(n,0,r.length).set(r),this.buffer=n,this._byteLength=i}_trimAlloc(){if(this._byteLength===this._buffer.byteLength)return;const t=new Ve(this._byteLength),i=new Uint8Array(t),s=new Uint8Array(this._buffer,0,i.length);i.set(s),this.buffer=t}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(t){this._buffer=t,this._dataView=new DataView(t,this._byteOffset),this._byteLength=t.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(t){this._byteOffset=t.byteOffset,this._buffer=Ve.fromArrayBuffer(t.buffer,0),this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}seek(t){const i=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(i)||!isFinite(i)?0:i}isEof(){return this.position>=this._byteLength}#e(t){return Array.isArray(t)&&t.length===3&&t[0]==="[]"}mapUint8Array(t){this._realloc(t*1);const i=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,i}readInt32Array(t,i){t=t===void 0?this.byteLength-this.position/4:t;const s=new Int32Array(t);return N.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),N.arrayToNative(s,i??this.endianness),this.position+=s.byteLength,s}readInt16Array(t,i){t=t===void 0?this.byteLength-this.position/2:t;const s=new Int16Array(t);return N.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),N.arrayToNative(s,i??this.endianness),this.position+=s.byteLength,s}readInt8Array(t){t=t===void 0?this.byteLength-this.position:t;const i=new Int8Array(t);return N.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),this.position+=i.byteLength,i}readUint32Array(t,i){t=t===void 0?this.byteLength-this.position/4:t;const s=new Uint32Array(t);return N.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),N.arrayToNative(s,i??this.endianness),this.position+=s.byteLength,s}readUint16Array(t,i){t=t===void 0?this.byteLength-this.position/2:t;const s=new Uint16Array(t);return N.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),N.arrayToNative(s,i??this.endianness),this.position+=s.byteLength,s}readUint8Array(t){t=t===void 0?this.byteLength-this.position:t;const i=new Uint8Array(t);return N.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),this.position+=i.byteLength,i}readFloat64Array(t,i){t=t===void 0?this.byteLength-this.position/8:t;const s=new Float64Array(t);return N.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),N.arrayToNative(s,i??this.endianness),this.position+=s.byteLength,s}readFloat32Array(t,i){t=t===void 0?this.byteLength-this.position/4:t;const s=new Float32Array(t);return N.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),N.arrayToNative(s,i??this.endianness),this.position+=s.byteLength,s}readInt32(t){const i=this._dataView.getInt32(this.position,(t??this.endianness)===2);return this.position+=4,i}readInt16(t){const i=this._dataView.getInt16(this.position,(t??this.endianness)===2);return this.position+=2,i}readInt8(){const t=this._dataView.getInt8(this.position);return this.position+=1,t}readUint32(t){const i=this._dataView.getUint32(this.position,(t??this.endianness)===2);return this.position+=4,i}readUint16(t){const i=this._dataView.getUint16(this.position,(t??this.endianness)===2);return this.position+=2,i}readUint8(){const t=this._dataView.getUint8(this.position);return this.position+=1,t}readFloat32(t){const i=this._dataView.getFloat32(this.position,(t??this.endianness)===2);return this.position+=4,i}readFloat64(t){const i=this._dataView.getFloat64(this.position,(t??this.endianness)===2);return this.position+=8,i}static memcpy(t,i,s,n,r){const a=new Uint8Array(t,i,r),o=new Uint8Array(s,n,r);a.set(o)}static arrayToNative(t,i){return i===N.ENDIANNESS?t:this.flipArrayEndianness(t)}static nativeToEndian(t,i){return i&&N.ENDIANNESS===2?t:this.flipArrayEndianness(t)}static flipArrayEndianness(t){const i=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let s=0;s<t.byteLength;s+=t.BYTES_PER_ELEMENT)for(let n=s+t.BYTES_PER_ELEMENT-1,r=s;n>r;n--,r++){const a=i[r];i[r]=i[n],i[n]=a}return t}readString(t,i){return i===void 0||i==="ASCII"?sr(this.mapUint8Array(t===void 0?this.byteLength-this.position:t)):new TextDecoder(i).decode(this.mapUint8Array(t))}readCString(t){let i=0;const s=this.byteLength-this.position,n=new Uint8Array(this._buffer,this._byteOffset+this.position),r=t!==void 0?Math.min(t,s):s;for(;i<r&&n[i]!==0;i++);const a=sr(this.mapUint8Array(i));return t!==void 0?this.position+=r-i:i!==s&&(this.position+=1),a}readInt64(){return this.readInt32()*gs+this.readUint32()}readUint64(){return this.readUint32()*gs+this.readUint32()}readUint24(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()}save(t){const i=new Blob([this.buffer]);if(typeof window<"u"&&typeof document<"u")if(window.URL&&URL.createObjectURL){const s=window.URL.createObjectURL(i),n=document.createElement("a");document.body.appendChild(n),n.setAttribute("href",s),n.setAttribute("download",t),n.setAttribute("target","_self"),n.click(),window.URL.revokeObjectURL(s),document.body.removeChild(n)}else throw new Error("DataStream.save: Can't create object URL.");return i}get dynamicSize(){return this._dynamicSize}set dynamicSize(t){t||this._trimAlloc(),this._dynamicSize=t}shift(t){const i=new Ve(this._byteLength-t),s=new Uint8Array(i),n=new Uint8Array(this._buffer,t,s.length);s.set(n),this.buffer=i,this.position-=t}writeInt32Array(t,i){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,i);else for(let s=0;s<t.length;s++)this.writeInt32(t[s],i)}writeInt16Array(t,i){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,i);else for(let s=0;s<t.length;s++)this.writeInt16(t[s],i)}writeInt8Array(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(let i=0;i<t.length;i++)this.writeInt8(t[i])}writeUint32Array(t,i){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,i);else for(let s=0;s<t.length;s++)this.writeUint32(t[s],i)}writeUint16Array(t,i){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,i);else for(let s=0;s<t.length;s++)this.writeUint16(t[s],i)}writeUint8Array(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(let i=0;i<t.length;i++)this.writeUint8(t[i])}writeFloat64Array(t,i){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,i);else for(let s=0;s<t.length;s++)this.writeFloat64(t[s],i)}writeFloat32Array(t,i){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)N.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,i);else for(let s=0;s<t.length;s++)this.writeFloat32(t[s],i)}writeInt64(t,i){this._realloc(8),this._dataView.setBigInt64(this.position,BigInt(t),(i??this.endianness)===2),this.position+=8}writeInt32(t,i){this._realloc(4),this._dataView.setInt32(this.position,t,(i??this.endianness)===2),this.position+=4}writeInt16(t,i){this._realloc(2),this._dataView.setInt16(this.position,t,(i??this.endianness)===2),this.position+=2}writeInt8(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1}writeUint32(t,i){this._realloc(4),this._dataView.setUint32(this.position,t,(i??this.endianness)===2),this.position+=4}writeUint16(t,i){this._realloc(2),this._dataView.setUint16(this.position,t,(i??this.endianness)===2),this.position+=2}writeUint8(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1}writeFloat32(t,i){this._realloc(4),this._dataView.setFloat32(this.position,t,(i??this.endianness)===2),this.position+=4}writeFloat64(t,i){this._realloc(8),this._dataView.setFloat64(this.position,t,(i??this.endianness)===2),this.position+=8}writeUCS2String(t,i,s){s===void 0&&(s=t.length);let n;for(n=0;n<t.length&&n<s;n++)this.writeUint16(t.charCodeAt(n),i);for(;n<s;n++)this.writeUint16(0)}writeString(t,i,s){let n=0;if(i===void 0||i==="ASCII")if(s!==void 0){const r=Math.min(t.length,s);for(n=0;n<r;n++)this.writeUint8(t.charCodeAt(n));for(;n<s;n++)this.writeUint8(0)}else for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));else this.writeUint8Array(new TextEncoder(i).encode(t.substring(0,s)))}writeCString(t,i){let s=0;if(i!==void 0){const n=Math.min(t.length,i);for(s=0;s<n;s++)this.writeUint8(t.charCodeAt(s));for(;s<i;s++)this.writeUint8(0)}else{for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));this.writeUint8(0)}}writeStruct(t,i){for(let s=0;s<t.length;s++){const[n,r]=t[s],a=i[n];this.writeType(r,a,i)}}writeType(t,i,s){if(typeof t=="function")return t(this,i);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,i,s);let n,r="ASCII";const a=this.position;let o=t;if(typeof t=="string"&&/:/.test(t)){const l=t.split(":");o=l[0],n=parseInt(l[1])}if(typeof o=="string"&&/,/.test(o)){const l=o.split(",");o=l[0],r=l[1]}switch(o){case"uint8":this.writeUint8(i);break;case"int8":this.writeInt8(i);break;case"uint16":this.writeUint16(i,this.endianness);break;case"int16":this.writeInt16(i,this.endianness);break;case"uint32":this.writeUint32(i,this.endianness);break;case"int32":this.writeInt32(i,this.endianness);break;case"float32":this.writeFloat32(i,this.endianness);break;case"float64":this.writeFloat64(i,this.endianness);break;case"uint16be":this.writeUint16(i,1);break;case"int16be":this.writeInt16(i,1);break;case"uint32be":this.writeUint32(i,1);break;case"int32be":this.writeInt32(i,1);break;case"float32be":this.writeFloat32(i,1);break;case"float64be":this.writeFloat64(i,1);break;case"uint16le":this.writeUint16(i,2);break;case"int16le":this.writeInt16(i,2);break;case"uint32le":this.writeUint32(i,2);break;case"int32le":this.writeInt32(i,2);break;case"float32le":this.writeFloat32(i,2);break;case"float64le":this.writeFloat64(i,2);break;case"cstring":this.writeCString(i,n);break;case"string":this.writeString(i,r,n);break;case"u16string":this.writeUCS2String(i,this.endianness,n);break;case"u16stringle":this.writeUCS2String(i,2,n);break;case"u16stringbe":this.writeUCS2String(i,1,n);break;default:if(this.#e(o)){const[,l]=o;for(let d=0;d<i.length;d++)this.writeType(l,i[d]);break}else{this.writeStruct(o,i);break}}n&&(this.position=a,this._realloc(n),this.position=a+n)}writeUint64(t){const i=Math.floor(t/gs);this.writeUint32(i),this.writeUint32(t&4294967295)}writeUint24(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)}adjustUint32(t,i){const s=this.position;this.seek(t),this.writeUint32(i),this.seek(s)}readStruct(t){const i={},s=this.position;for(let n=0;n<t.length;n+=1){const r=t[n][1],a=this.readType(r,i);if(!a){this.failurePosition===0&&(this.failurePosition=this.position),this.position=s;return}i[t[n][0]]=a}return i}readUCS2String(t,i){return String.fromCharCode.apply(void 0,this.readUint16Array(t,i))}readType(t,i){if(typeof t=="function")return t(this,i);if(typeof t=="object"&&!(t instanceof Array))return t.get(this,i);if(t instanceof Array&&t.length!==3)return this.readStruct(t);let s,n,r="ASCII";const a=this.position;let o=t;if(typeof o=="string"&&/:/.test(o)){const l=o.split(":");o=l[0],n=parseInt(l[1])}if(typeof o=="string"&&/,/.test(o)){const l=o.split(",");o=l[0],r=l[1]}switch(o){case"uint8":s=this.readUint8();break;case"int8":s=this.readInt8();break;case"uint16":s=this.readUint16(this.endianness);break;case"int16":s=this.readInt16(this.endianness);break;case"uint32":s=this.readUint32(this.endianness);break;case"int32":s=this.readInt32(this.endianness);break;case"float32":s=this.readFloat32(this.endianness);break;case"float64":s=this.readFloat64(this.endianness);break;case"uint16be":s=this.readUint16(1);break;case"int16be":s=this.readInt16(1);break;case"uint32be":s=this.readUint32(1);break;case"int32be":s=this.readInt32(1);break;case"float32be":s=this.readFloat32(1);break;case"float64be":s=this.readFloat64(1);break;case"uint16le":s=this.readUint16(2);break;case"int16le":s=this.readInt16(2);break;case"uint32le":s=this.readUint32(2);break;case"int32le":s=this.readInt32(2);break;case"float32le":s=this.readFloat32(2);break;case"float64le":s=this.readFloat64(2);break;case"cstring":s=this.readCString(n);break;case"string":s=this.readString(n,r);break;case"u16string":s=this.readUCS2String(n,this.endianness);break;case"u16stringle":s=this.readUCS2String(n,2);break;case"u16stringbe":s=this.readUCS2String(n,1);break;default:if(this.#e(o)){const[,l,d]=o,c=typeof d=="function"?d(i,this,o):typeof d=="string"&&i[d]!==void 0?parseInt(i[d]):typeof d=="number"?d:d==="*"?void 0:parseInt(d);if(typeof l=="string"){const f=l.replace(/(le|be)$/,"");let u;switch(/le$/.test(l)?u=2:/be$/.test(l)&&(u=1),f){case"uint8":s=this.readUint8Array(c);break;case"uint16":s=this.readUint16Array(c,u);break;case"uint32":s=this.readUint32Array(c,u);break;case"int8":s=this.readInt8Array(c);break;case"int16":s=this.readInt16Array(c,u);break;case"int32":s=this.readInt32Array(c,u);break;case"float32":s=this.readFloat32Array(c,u);break;case"float64":s=this.readFloat64Array(c,u);break;case"cstring":case"utf16string":case"string":if(c){s=new Array(c);for(let h=0;h<c;h++)s[h]=this.readType(l,i)}else for(s=[];!this.isEof();){const h=this.readType(l,i);if(!h)break;s.push(h)}break}}else if(c){s=new Array(c);for(let f=0;f<c;f++){const u=this.readType(l,i);if(!u)return;s[f]=u}}else for(s=[];;){const f=this.position;try{const u=this.readType(l,i);if(!u){this.position=f;break}s.push(u)}catch{this.position=f;break}}break}}return n&&(this.position=a+n),s}mapInt32Array(t,i){this._realloc(t*4);const s=new Int32Array(this._buffer,this.byteOffset+this.position,t);return N.arrayToNative(s,i??this.endianness),this.position+=t*4,s}mapInt16Array(t,i){this._realloc(t*2);const s=new Int16Array(this._buffer,this.byteOffset+this.position,t);return N.arrayToNative(s,i??this.endianness),this.position+=t*2,s}mapInt8Array(t,i){this._realloc(t*1);const s=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,s}mapUint32Array(t,i){this._realloc(t*4);const s=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return N.arrayToNative(s,i??this.endianness),this.position+=t*4,s}mapUint16Array(t,i){this._realloc(t*2);const s=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return N.arrayToNative(s,i??this.endianness),this.position+=t*2,s}mapFloat64Array(t,i){this._realloc(t*8);const s=new Float64Array(this._buffer,this.byteOffset+this.position,t);return N.arrayToNative(s,i??this.endianness),this.position+=t*8,s}mapFloat32Array(t,i){this._realloc(t*4);const s=new Float32Array(this._buffer,this.byteOffset+this.position,t);return N.arrayToNative(s,i??this.endianness),this.position+=t*4,s}};function sr(e){const t=[];for(let i=0;i<e.length;i++)t[i]=e[i];return String.fromCharCode.apply(void 0,t)}var hi=new Date,Ei=4,nr=3,rr=2,ar=1,Oe=Ei,$={setLogLevel(e){e===this.debug?Oe=ar:e===this.info?Oe=rr:e===this.warn?Oe=nr:(this.error,Oe=Ei)},debug(e,t){console.debug===void 0&&(console.debug=console.log),ar>=Oe&&console.debug("["+$.getDurationString(new Date().getTime()-hi.getTime(),1e3)+"]","["+e+"]",t)},log(e,t){this.debug(e.msg)},info(e,t){rr>=Oe&&console.info("["+$.getDurationString(new Date().getTime()-hi.getTime(),1e3)+"]","["+e+"]",t)},warn(e,t){nr>=Oe&&console.warn("["+$.getDurationString(new Date().getTime()-hi.getTime(),1e3)+"]","["+e+"]",t)},error(e,t,i){i?.onError?i.onError(e,t):Ei>=Oe&&console.error("["+$.getDurationString(new Date().getTime()-hi.getTime(),1e3)+"]","["+e+"]",t)},getDurationString(e,t){let i;function s(d,c){const u=(""+d).split(".");for(;u[0].length<c;)u[0]="0"+u[0];return u.join(".")}e<0?(i=!0,e=-e):i=!1;let r=e/(t||1);const a=Math.floor(r/3600);r-=a*3600;const o=Math.floor(r/60);r-=o*60;let l=r*1e3;return r=Math.floor(r),l-=r*1e3,l=Math.floor(l),(i?"-":"")+a+":"+s(o,2)+":"+s(r,2)+"."+s(l,3)},printRanges(e){const t=e.length;if(t>0){let i="";for(let s=0;s<t;s++)s>0&&(i+=","),i+="["+$.getDurationString(e.start(s))+","+$.getDurationString(e.end(s))+"]";return i}else return"(empty)"}};function Hd(e,t){$.debug("ArrayBuffer","Trying to create a new buffer of size: "+(e.byteLength+t.byteLength));const i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i.buffer}var Ti=class extends ye{constructor(e){super(new ArrayBuffer,0),this.buffers=[],this.bufferIndex=-1,e&&(this.insertBuffer(e),this.bufferIndex=0)}initialized(){if(this.bufferIndex>-1)return!0;if(this.buffers.length>0){const e=this.buffers[0];return e.fileStart===0?(this.buffer=e,this.bufferIndex=0,$.debug("MultiBufferStream","Stream ready for parsing"),!0):($.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)}else return $.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1}reduceBuffer(e,t,i){const s=new Uint8Array(i);return s.set(new Uint8Array(e,t,i)),s.buffer.fileStart=e.fileStart+t,s.buffer.usedBytes=0,s.buffer}insertBuffer(e){let t=!0,i=0;for(;i<this.buffers.length;i++){const s=this.buffers[i];if(e.fileStart<=s.fileStart){if(e.fileStart===s.fileStart)if(e.byteLength>s.byteLength){this.buffers.splice(i,1),i--;continue}else $.warn("MultiBufferStream","Buffer (fileStart: "+e.fileStart+" - Length: "+e.byteLength+") already appended, ignoring");else e.fileStart+e.byteLength<=s.fileStart||(e=this.reduceBuffer(e,0,s.fileStart-e.fileStart)),$.debug("MultiBufferStream","Appending new buffer (fileStart: "+e.fileStart+" - Length: "+e.byteLength+")"),this.buffers.splice(i,0,e),i===0&&(this.buffer=e);t=!1;break}else if(e.fileStart<s.fileStart+s.byteLength){const n=s.fileStart+s.byteLength-e.fileStart,r=e.byteLength-n;if(r>0)e=this.reduceBuffer(e,n,r);else{t=!1;break}}}t&&($.debug("MultiBufferStream","Appending new buffer (fileStart: "+e.fileStart+" - Length: "+e.byteLength+")"),this.buffers.push(e),i===0&&(this.buffer=e))}logBufferLevel(e){const t=[];let i="",s,n=0,r=0;for(let o=0;o<this.buffers.length;o++){const l=this.buffers[o];o===0?(s={start:l.fileStart,end:l.fileStart+l.byteLength},t.push(s),i+="["+s.start+"-"):s.end===l.fileStart?s.end=l.fileStart+l.byteLength:(s={start:l.fileStart,end:l.fileStart+l.byteLength},i+=t[t.length-1].end-1+"], ["+s.start+"-",t.push(s)),n+=l.usedBytes,r+=l.byteLength}t.length>0&&(i+=s.end-1+"]");const a=e?$.info:$.debug;this.buffers.length===0?a("MultiBufferStream","No more buffer in memory"):a("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+n+"/"+r+" bytes), continuous ranges: "+i)}cleanBuffers(){for(let e=0;e<this.buffers.length;e++){const t=this.buffers[e];t.usedBytes===t.byteLength&&($.debug("MultiBufferStream","Removing buffer #"+e),this.buffers.splice(e,1),e--)}}mergeNextBuffer(){if(this.bufferIndex+1<this.buffers.length){const e=this.buffers[this.bufferIndex+1];if(e.fileStart===this.buffer.fileStart+this.buffer.byteLength){const t=this.buffer.byteLength,i=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=Hd(this.buffer,e),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=s,$.debug("ISOFile","Concatenating buffer for box parsing (length: "+t+"->"+this.buffer.byteLength+")"),!0}else return!1}else return!1}findPosition(e,t,i){let s=-1,n=e===!0?0:this.bufferIndex;for(;n<this.buffers.length;){const a=this.buffers[n];if(a&&a.fileStart<=t)s=n,i&&(a.fileStart+a.byteLength<=t?a.usedBytes=a.byteLength:a.usedBytes=t-a.fileStart,this.logBufferLevel());else break;n++}if(s===-1)return-1;const r=this.buffers[s];return r.fileStart+r.byteLength>=t?($.debug("MultiBufferStream","Found position in existing buffer #"+s),s):-1}findEndContiguousBuf(e){const t=e!==void 0?e:this.bufferIndex;let i=this.buffers[t];if(this.buffers.length>t+1)for(let s=t+1;s<this.buffers.length;s++){const n=this.buffers[s];if(n.fileStart===i.fileStart+i.byteLength)i=n;else break}return i.fileStart+i.byteLength}getEndFilePositionAfter(e){const t=this.findPosition(!0,e,!1);return t!==-1?this.findEndContiguousBuf(t):e}addUsedBytes(e){this.buffer.usedBytes+=e,this.logBufferLevel()}setAllUsedBytes(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()}seek(e,t,i){const s=this.findPosition(t,e,i);return s!==-1?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=e-this.buffer.fileStart,$.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):($.debug("MultiBufferStream","Position "+e+" not found in buffered data"),!1)}getPosition(){return this.bufferIndex===-1||this.buffers[this.bufferIndex]===void 0?0:this.buffers[this.bufferIndex].fileStart+this.position}getLength(){return this.byteLength}getEndPosition(){return this.bufferIndex===-1||this.buffers[this.bufferIndex]===void 0?0:this.buffers[this.bufferIndex].fileStart+this.byteLength}getAbsoluteEndPosition(){if(this.buffers.length===0)return 0;const e=this.buffers[this.buffers.length-1];return e.fileStart+e.byteLength}},v=class{constructor(e=0){this.size=e}static{this.registryId=Symbol.for("BoxIdentifier")}#e;get type(){return this.constructor.fourcc??this.#e}set type(e){this.#e=e}addBox(e){return this.boxes||(this.boxes=[]),this.boxes.push(e),this[e.type+"s"]?this[e.type+"s"].push(e):this[e.type]=e,e}set(e,t){return this[e]=t,this}addEntry(e,t){const i=t||"entries";return this[i]||(this[i]=[]),this[i].push(e),this}writeHeader(e,t){if(this.size+=8,(this.size>ie||this.original_size===1)&&(this.size+=8),this.type==="uuid"&&(this.size+=16),$.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+e.getPosition()+(t||"")),this.original_size===0?e.writeUint32(0):this.size>ie||this.original_size===1?e.writeUint32(1):(this.sizePosition=e.getPosition(),e.writeUint32(this.size)),e.writeString(this.type,void 0,4),this.type==="uuid"){const i=new Uint8Array(16);for(let s=0;s<16;s++)i[s]=parseInt(this.uuid.substring(s*2,s*2+2),16);e.writeUint8Array(i)}(this.size>ie||this.original_size===1)&&(this.sizePosition=e.getPosition(),e.writeUint64(this.size))}write(e){if(this.type==="mdat"){const t=this;if(t.stream){this.size=t.stream.getAbsoluteEndPosition(),this.writeHeader(e);for(const i of t.stream.buffers){const s=new Uint8Array(i);e.writeUint8Array(s)}}else t.data&&(this.size=t.data.length,this.writeHeader(e),e.writeUint8Array(t.data))}else this.size=this.data?this.data.length:0,this.writeHeader(e),this.data&&e.writeUint8Array(this.data)}printHeader(e){this.size+=8,this.size>ie&&(this.size+=8),this.type==="uuid"&&(this.size+=16),e.log(e.indent+"size:"+this.size),e.log(e.indent+"type:"+this.type)}print(e){this.printHeader(e)}parse(e){this.type!=="mdat"?this.data=e.readUint8Array(this.size-this.hdr_size):this.size===0?e.seek(e.getEndPosition()):e.seek(this.start+this.size)}parseDataAndRewind(e){this.data=e.readUint8Array(this.size-this.hdr_size),e.seek(this.start+this.hdr_size)}parseLanguage(e){this.language=e.readUint16();const t=[];t[0]=this.language>>10&31,t[1]=this.language>>5&31,t[2]=this.language&31,this.languageString=String.fromCharCode(t[0]+96,t[1]+96,t[2]+96)}computeSize(e){const t=e||new Ti;this.write(t)}isEndOfBox(e){const t=e.getPosition(),i=this.start+this.size;return t===i}},y=class extends v{constructor(){super(...arguments),this.flags=0,this.version=0}writeHeader(e){this.size+=4,super.writeHeader(e," v="+this.version+" f="+this.flags),e.writeUint8(this.version),e.writeUint24(this.flags)}printHeader(e){this.size+=4,super.printHeader(e),e.log(e.indent+"version:"+this.version),e.log(e.indent+"flags:"+this.flags)}parseDataAndRewind(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,e.seek(this.start+this.hdr_size)}parseFullHeader(e){this.version=e.readUint8(),this.flags=e.readUint24(),this.hdr_size+=4}parse(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)}},ee=class{constructor(e){this.grouping_type=e}static{this.registryId=Symbol.for("SampleGroupEntryIdentifier")}write(e){e.writeUint8Array(this.data)}parse(e){$.warn("BoxParser",`Unknown sample group type: '${this.grouping_type}'`),this.data=e.readUint8Array(this.description_length)}},qd=class extends y{parse(e){this.parseFullHeader(e),this.track_group_id=e.readUint32()}},jd=class extends v{constructor(e,t,i,s,n){super(t),this.box_name=i,this.hdr_size=s,this.start=n,this.type=e}parse(e){this.from_item_ID=e.readUint16();const t=e.readUint16();this.references=[];for(let i=0;i<t;i++)this.references[i]={to_item_ID:e.readUint16()}}},Xd=class extends v{constructor(e,t,i,s,n){super(t),this.box_name=i,this.hdr_size=s,this.start=n,this.type=e}parse(e){this.from_item_ID=e.readUint32();const t=e.readUint16();this.references=[];for(let i=0;i<t;i++)this.references[i]={to_item_ID:e.readUint32()}}},Yd=class extends v{constructor(e,t,i,s){super(t),this.hdr_size=i,this.start=s,this.type=e}parse(e){this.track_ids=e.readUint32Array((this.size-this.hdr_size)/4)}write(e){this.size=this.track_ids.length*4,this.writeHeader(e),e.writeUint32Array(this.track_ids)}},Gs=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],Kd=["compatible_brands","matrix","opcolor","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];function Jd(e,t){if(e&&!t)return!1;let i;for(i in e)if(!Gs.find(s=>s===i)){if(e[i]instanceof v||t[i]instanceof v)continue;if(typeof e[i]>"u"||typeof t[i]>"u")continue;if(typeof e[i]=="function"||typeof t[i]=="function")continue;if("subBoxNames"in e&&e.subBoxNames.indexOf(i.slice(0,4))>-1||"subBoxNames"in t&&t.subBoxNames.indexOf(i.slice(0,4))>-1)continue;if(i==="data"||i==="start"||i==="size"||i==="creation_time"||i==="modification_time")continue;if(Kd.find(s=>s===i))continue;if(e[i]!==t[i])return!1}return!0}function la(e,t){if(!Jd(e,t))return!1;for(let i=0;i<Gs.length;i++){const s=Gs[i];if(e[s]&&t[s]&&!la(e[s],t[s]))return!1}return!0}function rn(e){let t=e;for(;t;){if("registryId"in t)return t.registryId;t=Object.getPrototypeOf(t)}}var Zd=e=>{const t=Symbol.for("SampleGroupEntryIdentifier");return rn(e)===t},Qd=e=>{const t=Symbol.for("SampleEntryIdentifier");return rn(e)===t},ef=e=>{const t=Symbol.for("BoxIdentifier");return rn(e)===t},me={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};function tf(e){const t={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};for(const[i,s]of Object.entries(e)){if(Zd(s)){const n="grouping_type"in s?s.grouping_type:void 0;if(!n)throw new Error(`SampleGroupEntry class ${i} does not have a valid static grouping_type. Please ensure it is defined correctly.`);if(n in t.sampleGroupEntry)throw new Error(`SampleGroupEntry class ${i} has a grouping_type that is already registered. Please ensure it is unique.`);t.sampleGroupEntry[n]=s;continue}if(Qd(s)){const n="fourcc"in s?s.fourcc:void 0;if(!n)throw new Error(`SampleEntry class ${i} does not have a valid static fourcc. Please ensure it is defined correctly.`);if(n in t.sampleEntry)throw new Error(`SampleEntry class ${i} has a fourcc that is already registered. Please ensure it is unique.`);t.sampleEntry[n]=s;continue}if(ef(s)){const n="fourcc"in s?s.fourcc:void 0,r="uuid"in s?s.uuid:void 0;if(n==="uuid"){if(!r)throw new Error(`Box class ${i} has a fourcc of 'uuid' but does not have a valid uuid. Please ensure it is defined correctly.`);if(r in t.uuid)throw new Error(`Box class ${i} has a uuid that is already registered. Please ensure it is unique.`);t.uuid[r]=s;continue}t.box[n]=s;continue}throw new Error(`Box class ${i} does not have a valid static fourcc, uuid, or grouping_type. Please ensure it is defined correctly.`)}return me.uuid={...t.uuid},me.sampleEntry={...t.sampleEntry},me.sampleGroupEntry={...t.sampleGroupEntry},me.box={...t.box},me}var Vi={};function sf(e){return Object.entries(e).forEach(([t,i])=>Vi[t]=i),Vi}function nf(e){return ot(e)}function ot(e){let t="";for(let i=0;i<16;i++){const s=e.readUint8().toString(16);t+=s.length===1?"0"+s:s}return t}function Ue(e,t,i){let s,n;const r=e.getPosition();let a=0,o;if(e.getEndPosition()-r<8)return $.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:Me};if(i&&i<8)return $.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:Me};let l=e.readUint32();const d=e.readString(4);if(d.length!==4||!/^[\x20-\x7E]{4}$/.test(d))return $.error("BoxParser",`Invalid box type: '${d}'`),{code:aa,start:r,type:d};let c=d;if($.debug("BoxParser","Found box of type '"+d+"' and size "+l+" at position "+r),a=8,d==="uuid"){if(e.getEndPosition()-e.getPosition()<16||i-a<16)return e.seek(r),$.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:Me};o=nf(e),a+=16,c=o}if(l===1){if(e.getEndPosition()-e.getPosition()<8||i&&i-a<8)return e.seek(r),$.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+d+'" box'),{code:Me};n=l,l=e.readUint64(),a+=8}else if(l===0){if(i)l=i;else if(d!=="mdat")return $.error("BoxParser","Unlimited box size not supported for type: '"+d+"'"),s=new v(l),s.type=d,{code:be,box:s,size:s.size}}if(l!==0&&l<a)return $.error("BoxParser","Box of type "+d+" has an invalid size "+l+" (too small to be a box)"),{code:Me,type:d,size:l,hdr_size:a,start:r};if(l!==0&&i&&l>i)return $.error("BoxParser","Box of type '"+d+"' has a size "+l+" greater than its container size "+i),{code:Me,type:d,size:l,hdr_size:a,start:r};if(l!==0&&r+l>e.getEndPosition())return e.seek(r),$.info("BoxParser","Not enough data in stream to parse the entire '"+d+"' box"),{code:Me,type:d,size:l,hdr_size:a,start:r,original_size:n};if(t)return{code:be,type:d,size:l,hdr_size:a,start:r};d in me.box?s=new me.box[d](l):d!=="uuid"?($.warn("BoxParser",`Unknown box type: '${d}'`),s=new v(l),s.type=d,s.has_unparsed_data=!0):o in me.uuid?s=new me.uuid[o](l):($.warn("BoxParser",`Unknown UUID box type: '${o}'`),s=new v(l),s.type=d,s.uuid=o,s.has_unparsed_data=!0),s.original_size=n,s.hdr_size=a,s.start=r,s.write===v.prototype.write&&s.type!=="mdat"&&($.info("BoxParser","'"+c+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(e)),s.parse(e);const f=e.getPosition()-(s.start+s.size);return f<0?($.warn("BoxParser","Parsing of box '"+c+"' did not read the entire indicated box data size (missing "+-f+" bytes), seeking forward"),e.seek(s.start+s.size)):f>0&&s.size!==0&&($.error("BoxParser","Parsing of box '"+c+"' read "+f+" more bytes than the indicated box data size, seeking backwards"),e.seek(s.start+s.size)),{code:be,box:s,size:s.size}}var L=class extends v{write(e){if(this.size=0,this.writeHeader(e),this.boxes)for(let t=0;t<this.boxes.length;t++)this.boxes[t]&&(this.boxes[t].write(e),this.size+=this.boxes[t].size);$.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}print(e){this.printHeader(e);for(let t=0;t<this.boxes.length;t++)if(this.boxes[t]){const i=e.indent;e.indent+=" ",this.boxes[t].print(e),e.indent=i}}parse(e){let t;for(;e.getPosition()<this.start+this.size;)if(t=Ue(e,!1,this.size-(e.getPosition()-this.start)),t.code===be){const i=t.box;if(this.boxes||(this.boxes=[]),this.boxes.push(i),this.subBoxNames&&this.subBoxNames.indexOf(i.type)!==-1){const s=this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s";this[s]||(this[s]=[]),this[s].push(i)}else{const s=i.type!=="uuid"?i.type:i.uuid;this[s]?$.warn("ContainerBox",`Box of type ${s} already exists in container box ${this.type}.`):this[s]=i}}else return}},Ne=class extends L{constructor(e,t,i){super(e),this.hdr_size=t,this.start=i}static{this.registryId=Symbol.for("SampleEntryIdentifier")}isVideo(){return!1}isAudio(){return!1}isSubtitle(){return!1}isMetadata(){return!1}isHint(){return!1}getCodec(){return this.type.replace(".","")}getWidth(){return""}getHeight(){return""}getChannelCount(){return""}getSampleRate(){return""}getSampleSize(){return""}parseHeader(e){e.readUint8Array(6),this.data_reference_index=e.readUint16(),this.hdr_size+=8}parse(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)}parseDataAndRewind(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,e.seek(this.start+this.hdr_size)}parseFooter(e){super.parse(e)}writeHeader(e){this.size=8,super.writeHeader(e),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint16(this.data_reference_index)}writeFooter(e){if(this.boxes)for(let t=0;t<this.boxes.length;t++)this.boxes[t].write(e),this.size+=this.boxes[t].size;$.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}write(e){this.writeHeader(e),e.writeUint8Array(this.data),this.size+=this.data.length,$.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}},or=class extends Ne{},vt=class extends Ne{isMetadata(){return!0}},lt=class extends Ne{isSubtitle(){return!0}},rf=class extends Ne{},H=class extends Ne{parse(e){this.parseHeader(e),e.readUint16(),e.readUint16(),e.readUint32Array(3),this.width=e.readUint16(),this.height=e.readUint16(),this.horizresolution=e.readUint32(),this.vertresolution=e.readUint32(),e.readUint32(),this.frame_count=e.readUint16();const t=Math.min(31,e.readUint8());this.compressorname=e.readString(t),t<31&&e.readString(31-t),this.depth=e.readUint16(),e.readUint16(),this.parseFooter(e)}isVideo(){return!0}getWidth(){return this.width}getHeight(){return this.height}write(e){this.writeHeader(e),this.size+=2*7+6*4+32,e.writeUint16(0),e.writeUint16(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint16(this.width),e.writeUint16(this.height),e.writeUint32(this.horizresolution),e.writeUint32(this.vertresolution),e.writeUint32(0),e.writeUint16(this.frame_count),e.writeUint8(Math.min(31,this.compressorname.length)),e.writeString(this.compressorname,void 0,31),e.writeUint16(this.depth),e.writeInt16(-1),this.writeFooter(e)}},ge=class extends Ne{parse(e){this.parseHeader(e),this.version=e.readUint16(),e.readUint16(),e.readUint32(),this.channel_count=e.readUint16(),this.samplesize=e.readUint16(),e.readUint16(),e.readUint16(),this.samplerate=e.readUint32()/65536,e.isofile?.ftyp?.major_brand.includes("qt")&&(this.version===1?this.extensions=e.readUint8Array(16):this.version===2&&(this.extensions=e.readUint8Array(36))),this.parseFooter(e)}isAudio(){return!0}getChannelCount(){return this.channel_count}getSampleRate(){return this.samplerate}getSampleSize(){return this.samplesize}write(e){this.writeHeader(e),this.size+=2*4+3*4,e.writeUint32(0),e.writeUint32(0),e.writeUint16(this.channel_count),e.writeUint16(this.samplesize),e.writeUint16(0),e.writeUint16(0),e.writeUint32(this.samplerate<<16),this.writeFooter(e)}},an=class extends Ne{parse(e){this.parseHeader(e),this.parseFooter(e)}write(e){this.writeHeader(e),this.writeFooter(e)}},lr=class extends Array{toString(){let e="<table class='inner-table'>";e+="<thead><tr><th>length</th><th>nalu_data</th></tr></thead>",e+="<tbody>";for(let t=0;t<this.length;t++){const i=this[t];e+="<tr>",e+="<td>"+i.length+"</td>",e+="<td>",e+=i.data.reduce(function(s,n){return s+n.toString(16).padStart(2,"0")},"0x"),e+="</td></tr>"}return e+="</tbody></table>",e}},da=class extends v{constructor(){super(...arguments),this.box_name="AVCConfigurationBox"}static{this.fourcc="avcC"}parse(e){this.configurationVersion=e.readUint8(),this.AVCProfileIndication=e.readUint8(),this.profile_compatibility=e.readUint8(),this.AVCLevelIndication=e.readUint8(),this.lengthSizeMinusOne=e.readUint8()&3,this.nb_SPS_nalus=e.readUint8()&31;let t=this.size-this.hdr_size-6;this.SPS=new lr;for(let i=0;i<this.nb_SPS_nalus;i++){const s=e.readUint16();this.SPS.push({length:s,data:e.readUint8Array(s)}),t-=2+s}this.nb_PPS_nalus=e.readUint8(),t--,this.PPS=new lr;for(let i=0;i<this.nb_PPS_nalus;i++){const s=e.readUint16();this.PPS.push({length:s,data:e.readUint8Array(s)}),t-=2+s}t>0&&(this.ext=e.readUint8Array(t))}write(e){this.size=7;for(let t=0;t<this.SPS.length;t++)this.size+=2+this.SPS[t].length;for(let t=0;t<this.PPS.length;t++)this.size+=2+this.PPS[t].length;this.ext&&(this.size+=this.ext.length),this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8(this.AVCProfileIndication),e.writeUint8(this.profile_compatibility),e.writeUint8(this.AVCLevelIndication),e.writeUint8(this.lengthSizeMinusOne+252),e.writeUint8(this.SPS.length+224);for(let t=0;t<this.SPS.length;t++)e.writeUint16(this.SPS[t].length),e.writeUint8Array(this.SPS[t].data);e.writeUint8(this.PPS.length);for(let t=0;t<this.PPS.length;t++)e.writeUint16(this.PPS[t].length),e.writeUint8Array(this.PPS[t].data);this.ext&&e.writeUint8Array(this.ext)}},Fi=class extends v{constructor(){super(...arguments),this.box_name="MediaDataBox"}static{this.fourcc="mdat"}},af=class extends v{constructor(){super(...arguments),this.box_name="ItemDataBox"}static{this.fourcc="idat"}},of=class extends v{constructor(){super(...arguments),this.box_name="FreeSpaceBox"}static{this.fourcc="free"}},lf=class extends v{constructor(){super(...arguments),this.box_name="FreeSpaceBox"}static{this.fourcc="skip"}},fa=class extends y{constructor(){super(...arguments),this.box_name="HintMediaHeaderBox"}static{this.fourcc="hmhd"}},Ci=class extends y{constructor(){super(...arguments),this.box_name="NullMediaHeaderBox"}static{this.fourcc="nmhd"}},df=class extends y{constructor(){super(...arguments),this.box_name="ObjectDescriptorBox"}static{this.fourcc="iods"}},ff=class extends y{constructor(){super(...arguments),this.box_name="XMLBox"}static{this.fourcc="xml "}},cf=class extends y{constructor(){super(...arguments),this.box_name="BinaryXMLBox"}static{this.fourcc="bxml"}},uf=class extends y{constructor(){super(...arguments),this.box_name="ItemProtectionBox",this.sinfs=[]}static{this.fourcc="ipro"}get protections(){return this.sinfs}},Vs=class extends L{constructor(){super(...arguments),this.box_name="MovieBox",this.traks=[],this.psshs=[],this.subBoxNames=["trak","pssh"]}static{this.fourcc="moov"}},ca=class extends L{constructor(){super(...arguments),this.box_name="TrackBox",this.samples=[]}static{this.fourcc="trak"}},hf=class extends L{constructor(){super(...arguments),this.box_name="EditBox"}static{this.fourcc="edts"}},ua=class extends L{constructor(){super(...arguments),this.box_name="MediaBox"}static{this.fourcc="mdia"}},ha=class extends L{constructor(){super(...arguments),this.box_name="MediaInformationBox"}static{this.fourcc="minf"}},pa=class extends L{constructor(){super(...arguments),this.box_name="DataInformationBox"}static{this.fourcc="dinf"}},ma=class extends L{constructor(){super(...arguments),this.box_name="SampleTableBox",this.sgpds=[],this.sbgps=[],this.subBoxNames=["sgpd","sbgp"]}static{this.fourcc="stbl"}},Ws=class extends L{constructor(){super(...arguments),this.box_name="MovieExtendsBox",this.trexs=[],this.subBoxNames=["trex"]}static{this.fourcc="mvex"}},$a=class extends L{constructor(){super(...arguments),this.box_name="MovieFragmentBox",this.trafs=[],this.subBoxNames=["traf"]}static{this.fourcc="moof"}},ga=class extends L{constructor(){super(...arguments),this.box_name="TrackFragmentBox",this.truns=[],this.sgpds=[],this.sbgps=[],this.subBoxNames=["trun","sgpd","sbgp"]}static{this.fourcc="traf"}},pf=class extends L{constructor(){super(...arguments),this.box_name="VTTCueBox"}static{this.fourcc="vttc"}},mf=class extends L{constructor(){super(...arguments),this.box_name="MovieFragmentRandomAccessBox",this.tfras=[],this.subBoxNames=["tfra"]}static{this.fourcc="mfra"}},$f=class extends L{constructor(){super(...arguments),this.box_name="AdditionalMetadataContainerBox"}static{this.fourcc="meco"}},gf=class extends L{constructor(){super(...arguments),this.box_name="trackhintinformation",this.subBoxNames=["sdp ","rtp "]}static{this.fourcc="hnti"}},xf=class extends L{constructor(){super(...arguments),this.box_name="hintstatisticsbox",this.maxrs=[],this.subBoxNames=["maxr"]}static{this.fourcc="hinf"}},yf=class extends L{constructor(){super(...arguments),this.box_name="SubTrackBox"}static{this.fourcc="strk"}},bf=class extends L{constructor(){super(...arguments),this.box_name="SubTrackDefinitionBox"}static{this.fourcc="strd"}},_f=class extends L{constructor(){super(...arguments),this.box_name="ProtectionSchemeInfoBox"}static{this.fourcc="sinf"}},vf=class extends L{constructor(){super(...arguments),this.box_name="RestrictedSchemeInfoBox"}static{this.fourcc="rinf"}},wf=class extends L{constructor(){super(...arguments),this.box_name="SchemeInformationBox"}static{this.fourcc="schi"}},Sf=class extends L{constructor(){super(...arguments),this.box_name="TrackGroupBox"}static{this.fourcc="trgr"}},If=class extends L{constructor(){super(...arguments),this.box_name="UserDataBox",this.kinds=[],this.strks=[],this.subBoxNames=["kind","strk"]}static{this.fourcc="udta"}},Ef=class extends L{constructor(){super(...arguments),this.box_name="ItemPropertiesBox",this.ipmas=[],this.subBoxNames=["ipma"]}static{this.fourcc="iprp"}},Tf=class extends L{constructor(){super(...arguments),this.box_name="ItemPropertyContainerBox",this.hvcCs=[],this.ispes=[],this.claps=[],this.irots=[],this.subBoxNames=["hvcC","ispe","clap","irot"]}static{this.fourcc="ipco"}},Ff=class extends L{constructor(){super(...arguments),this.box_name="GroupsListBox"}static{this.fourcc="grpl"}},Cf=class extends L{constructor(){super(...arguments),this.box_name="J2KHeaderInfoBox"}static{this.fourcc="j2kH"}},Uf=class extends L{constructor(){super(...arguments),this.box_name="ExtendedTypeBox",this.tycos=[],this.subBoxNames=["tyco"]}static{this.fourcc="etyp"}},kf=class extends L{constructor(){super(...arguments),this.box_name="ProjectedOmniVideoBox",this.subBoxNames=["prfr"]}static{this.fourcc="povd"}},xa=class extends y{constructor(){super(...arguments),this.box_name="DataReferenceBox"}static{this.fourcc="dref"}parse(e){this.parseFullHeader(e),this.entries=[];const t=e.readUint32();for(let i=0;i<t;i++){const s=Ue(e,!1,this.size-(e.getPosition()-this.start));if(s.code===be){const n=s.box;this.entries.push(n)}else return}}write(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.entries.length);for(let t=0;t<this.entries.length;t++)this.entries[t].write(e),this.size+=this.entries[t].size;$.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}},ya=class extends y{constructor(){super(...arguments),this.box_name="ExtendedLanguageBox"}static{this.fourcc="elng"}parse(e){this.parseFullHeader(e),this.extended_language=e.readString(this.size-this.hdr_size)}write(e){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(e),e.writeString(this.extended_language)}},ba=class extends v{constructor(){super(...arguments),this.box_name="FileTypeBox"}static{this.fourcc="ftyp"}parse(e){let t=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),t-=8,this.compatible_brands=[];let i=0;for(;t>=4;)this.compatible_brands[i]=e.readString(4),t-=4,i++}write(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,void 0,4),e.writeUint32(this.minor_version);for(let t=0;t<this.compatible_brands.length;t++)e.writeString(this.compatible_brands[t],void 0,4)}},_a=class extends y{constructor(){super(...arguments),this.box_name="HandlerBox"}static{this.fourcc="hdlr"}parse(e){if(this.parseFullHeader(e),this.version===0&&(e.readUint32(),this.handler=e.readString(4),e.readUint32Array(3),!this.isEndOfBox(e))){const t=this.start+this.size-e.getPosition();this.name=e.readCString();const i=this.start+this.size-1;e.seek(i),e.readUint8()!==0&&t>1&&($.info("BoxParser","Warning: hdlr name is not null-terminated, possibly length-prefixed string. Trimming first byte."),this.name=this.name.slice(1))}}write(e){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(e),e.writeUint32(0),e.writeString(this.handler,void 0,4),e.writeUint32Array([0,0,0]),e.writeCString(this.name)}},va=class extends v{constructor(){super(...arguments),this.box_name="HEVCConfigurationBox"}static{this.fourcc="hvcC"}parse(e){this.configurationVersion=e.readUint8();let t=e.readUint8();this.general_profile_space=t>>6,this.general_tier_flag=(t&32)>>5,this.general_profile_idc=t&31,this.general_profile_compatibility=e.readUint32(),this.general_constraint_indicator=e.readUint8Array(6),this.general_level_idc=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3,this.chroma_format_idc=e.readUint8()&3,this.bit_depth_luma_minus8=e.readUint8()&7,this.bit_depth_chroma_minus8=e.readUint8()&7,this.avgFrameRate=e.readUint16(),t=e.readUint8(),this.constantFrameRate=t>>6,this.numTemporalLayers=(t&13)>>3,this.temporalIdNested=(t&4)>>2,this.lengthSizeMinusOne=t&3,this.nalu_arrays=[];const i=e.readUint8();for(let s=0;s<i;s++){const n=[];this.nalu_arrays.push(n),t=e.readUint8(),n.completeness=(t&128)>>7,n.nalu_type=t&63;const r=e.readUint16();for(let a=0;a<r;a++){const o=e.readUint16();n.push({data:e.readUint8Array(o)})}}}write(e){this.size=23;for(let t=0;t<this.nalu_arrays.length;t++){this.size+=3;for(let i=0;i<this.nalu_arrays[t].length;i++)this.size+=2+this.nalu_arrays[t][i].data.length}this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),e.writeUint32(this.general_profile_compatibility),e.writeUint8Array(this.general_constraint_indicator),e.writeUint8(this.general_level_idc),e.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),e.writeUint8(this.parallelismType+252),e.writeUint8(this.chroma_format_idc+252),e.writeUint8(this.bit_depth_luma_minus8+248),e.writeUint8(this.bit_depth_chroma_minus8+248),e.writeUint16(this.avgFrameRate),e.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),e.writeUint8(this.nalu_arrays.length);for(let t=0;t<this.nalu_arrays.length;t++){e.writeUint8((this.nalu_arrays[t].completeness<<7)+this.nalu_arrays[t].nalu_type),e.writeUint16(this.nalu_arrays[t].length);for(let i=0;i<this.nalu_arrays[t].length;i++)e.writeUint16(this.nalu_arrays[t][i].data.length),e.writeUint8Array(this.nalu_arrays[t][i].data)}}},wa=class extends y{constructor(){super(...arguments),this.box_name="MediaHeaderBox"}static{this.fourcc="mdhd"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.parseLanguage(e),e.readUint16()}write(e){const t=this.modification_time>ie||this.creation_time>ie||this.duration>ie||this.version===1;this.version=t?1:0,this.size=4*4+2*2,this.size+=t?3*4:0,this.flags=0,this.writeHeader(e),t?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.timescale),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration)),e.writeUint16(this.language),e.writeUint16(0)}},Sa=class extends y{constructor(){super(...arguments),this.box_name="MovieExtendsHeaderBox"}static{this.fourcc="mehd"}parse(e){this.parseFullHeader(e),this.flags&1&&($.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version===1?this.fragment_duration=e.readUint64():this.fragment_duration=e.readUint32()}write(e){const t=this.fragment_duration>ie||this.version===1;this.version=t?1:0,this.size=4,this.size+=t?4:0,this.flags=0,this.writeHeader(e),t?e.writeUint64(this.fragment_duration):e.writeUint32(this.fragment_duration)}},Bf=class extends y{constructor(){super(...arguments),this.box_name="ItemInfoEntry"}static{this.fourcc="infe"}parse(e){if(this.parseFullHeader(e),(this.version===0||this.version===1)&&(this.item_ID=e.readUint16(),this.item_protection_index=e.readUint16(),this.item_name=e.readCString(),this.content_type=e.readCString(),this.isEndOfBox(e)||(this.content_encoding=e.readCString())),this.version===1){this.extension_type=e.readString(4),$.warn("BoxParser","Cannot parse extension type"),e.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=e.readUint16():this.version===3&&(this.item_ID=e.readUint32()),this.item_protection_index=e.readUint16(),this.item_type=e.readString(4),this.item_name=e.readCString(),this.item_type==="mime"?(this.content_type=e.readCString(),this.content_encoding=e.readCString()):this.item_type==="uri "&&(this.item_uri_type=e.readCString()))}},Af=class extends y{constructor(){super(...arguments),this.box_name="ItemInfoBox"}static{this.fourcc="iinf"}parse(e){this.parseFullHeader(e),this.version===0?this.entry_count=e.readUint16():this.entry_count=e.readUint32(),this.item_infos=[];for(let t=0;t<this.entry_count;t++){const i=Ue(e,!1,this.size-(e.getPosition()-this.start));if(i.code===be){const s=i.box;s.type==="infe"?this.item_infos[t]=s:$.error("BoxParser","Expected 'infe' box, got "+i.box.type,e.isofile)}else return}}},Of=class extends y{constructor(){super(...arguments),this.box_name="ItemLocationBox"}static{this.fourcc="iloc"}parse(e){this.parseFullHeader(e);let t;t=e.readUint8(),this.offset_size=t>>4&15,this.length_size=t&15,t=e.readUint8(),this.base_offset_size=t>>4&15,this.version===1||this.version===2?this.index_size=t&15:this.index_size=0,this.items=[];let i=0;if(this.version<2)i=e.readUint16();else if(this.version===2)i=e.readUint32();else throw new Error("version of iloc box not supported");for(let s=0;s<i;s++){let n=0,r=0,a=0;if(this.version<2)n=e.readUint16();else if(this.version===2)n=e.readUint32();else throw new Error("version of iloc box not supported");this.version===1||this.version===2?r=e.readUint16()&15:r=0;const o=e.readUint16();switch(this.base_offset_size){case 0:a=0;break;case 4:a=e.readUint32();break;case 8:a=e.readUint64();break;default:throw new Error("Error reading base offset size")}const l=[],d=e.readUint16();for(let c=0;c<d;c++){let f=0,u=0,h=0;if(this.version===1||this.version===2)switch(this.index_size){case 0:f=0;break;case 4:f=e.readUint32();break;case 8:f=e.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.offset_size){case 0:u=0;break;case 4:u=e.readUint32();break;case 8:u=e.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.length_size){case 0:h=0;break;case 4:h=e.readUint32();break;case 8:h=e.readUint64();break;default:throw new Error("Error reading extent index")}l.push({extent_index:f,extent_length:h,extent_offset:u})}this.items.push({base_offset:a,construction_method:r,item_ID:n,data_reference_index:o,extents:l})}}},Pf={auxl:"Auxiliary image item",base:"Pre-derived image item base",cdsc:"Item describes referenced item",dimg:"Derived image item",dpnd:"Item coding dependency",eroi:"Region",evir:"EVC slice",exbl:"Scalable image item","fdl ":"File delivery",font:"Font item",iloc:"Item data location",mask:"Region mask",mint:"Data integrity",pred:"Predictively coded item",prem:"Pre-multiplied item",tbas:"HEVC tile track base item",thmb:"Thumbnail image item"},Df=class Ia extends y{constructor(){super(...arguments),this.box_name="ItemReferenceBox",this.references=[]}static{this.fourcc="iref"}static{this.allowed_types=["auxl","base","cdsc","dimg","dpnd","eroi","evir","exbl","fdl ","font","iloc","mask","mint","pred","prem","tbas","thmb"]}parse(t){for(this.parseFullHeader(t),this.references=[];t.getPosition()<this.start+this.size;){const i=Ue(t,!0,this.size-(t.getPosition()-this.start));if(i.code===be){let s="Unknown item reference";Ia.allowed_types.includes(i.type)?s=Pf[i.type]:$.warn("BoxParser",`Unknown item reference type: '${i.type}'`);const n=this.version===0?new jd(i.type,i.size,s,i.hdr_size,i.start):new Xd(i.type,i.size,s,i.hdr_size,i.start);n.write===v.prototype.write&&n.type!=="mdat"&&($.warn("BoxParser",n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.references.push(n)}else return}}},Lf=class extends y{constructor(){super(...arguments),this.box_name="PrimaryItemBox"}static{this.fourcc="pitm"}parse(e){this.parseFullHeader(e),this.version===0?this.item_id=e.readUint16():this.item_id=e.readUint32()}},Nf=class extends y{constructor(){super(...arguments),this.box_name="MetaBox",this.isQT=!1}static{this.fourcc="meta"}parse(e){const t=e.getPosition();if(this.size>8){switch(e.readUint32(),e.readString(4)){case"hdlr":case"mhdr":case"keys":case"ilst":case"ctry":case"lang":this.isQT=!0;break}e.seek(t)}this.isQT||this.parseFullHeader(e),L.prototype.parse.call(this,e)}},Ea=class extends y{constructor(){super(...arguments),this.box_name="MovieFragmentHeaderBox"}static{this.fourcc="mfhd"}parse(e){this.parseFullHeader(e),this.sequence_number=e.readUint32()}write(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.sequence_number)}},Ta=class extends y{constructor(){super(...arguments),this.box_name="MovieHeaderBox"}static{this.fourcc="mvhd"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.rate=e.readUint32(),this.volume=e.readUint16()>>8,e.readUint16(),e.readUint32Array(2),this.matrix=e.readInt32Array(9),e.readUint32Array(6),this.next_track_id=e.readUint32()}write(e){const t=this.modification_time>ie||this.creation_time>ie||this.duration>ie||this.version===1;this.version=t?1:0,this.size=4*4+20*4,this.size+=t?3*4:0,this.flags=0,this.writeHeader(e),t?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.timescale),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration)),e.writeUint32(this.rate),e.writeUint16(this.volume<<8),e.writeUint16(0),e.writeUint32(0),e.writeUint32(0),e.writeInt32Array(this.matrix),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(this.next_track_id)}print(e){super.printHeader(e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"timescale: "+this.timescale),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"rate: "+this.rate),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"next_track_id: "+this.next_track_id)}},Rf=class extends vt{static{this.fourcc="mett"}parse(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.mime_format=e.readCString(),this.parseFooter(e)}},zf=class extends vt{static{this.fourcc="metx"}parse(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.namespace=e.readCString(),this.schema_location=e.readCString(),this.parseFooter(e)}},Mf=class extends v{constructor(){super(...arguments),this.box_name="AV1CodecConfigurationBox"}static{this.fourcc="av1C"}parse(e){let t=e.readUint8();if((t>>7&1)!==1){$.error("BoxParser","av1C marker problem",e.isofile);return}if(this.version=t&127,this.version!==1){$.error("BoxParser","av1C version "+this.version+" not supported",e.isofile);return}if(t=e.readUint8(),this.seq_profile=t>>5&7,this.seq_level_idx_0=t&31,t=e.readUint8(),this.seq_tier_0=t>>7&1,this.high_bitdepth=t>>6&1,this.twelve_bit=t>>5&1,this.monochrome=t>>4&1,this.chroma_subsampling_x=t>>3&1,this.chroma_subsampling_y=t>>2&1,this.chroma_sample_position=t&3,t=e.readUint8(),this.reserved_1=t>>5&7,this.reserved_1!==0){$.error("BoxParser","av1C reserved_1 parsing problem",e.isofile);return}if(this.initial_presentation_delay_present=t>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=t&15;else if(this.reserved_2=t&15,this.reserved_2!==0){$.error("BoxParser","av1C reserved_2 parsing problem",e.isofile);return}const i=this.size-this.hdr_size-4;this.configOBUs=e.readUint8Array(i)}},Gf=class extends y{constructor(){super(...arguments),this.box_name="ElementaryStreamDescriptorBox"}static{this.fourcc="esds"}parse(e){this.parseFullHeader(e);const t=e.readUint8Array(this.size-this.hdr_size);if("MPEG4DescriptorParser"in Vi){const i=new Vi.MPEG4DescriptorParser;this.esd=i.parseOneDescriptor(new ye(t.buffer,0))}}},Vf=class extends y{constructor(){super(...arguments),this.box_name="VPCodecConfigurationRecord"}static{this.fourcc="vpcC"}parse(e){if(this.parseFullHeader(e),this.version===1){this.profile=e.readUint8(),this.level=e.readUint8();const t=e.readUint8();this.bitDepth=t>>4,this.chromaSubsampling=t>>1&7,this.videoFullRangeFlag=t&1,this.colourPrimaries=e.readUint8(),this.transferCharacteristics=e.readUint8(),this.matrixCoefficients=e.readUint8(),this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)}else{this.profile=e.readUint8(),this.level=e.readUint8();let t=e.readUint8();this.bitDepth=t>>4&15,this.colorSpace=t&15,t=e.readUint8(),this.chromaSubsampling=t>>4&15,this.transferFunction=t>>1&7,this.videoFullRangeFlag=t&1,this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)}}},Wf=class extends y{constructor(){super(...arguments),this.box_name="VvcConfigurationBox"}static{this.fourcc="vvcC"}parse(e){this.parseFullHeader(e);const t={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(r){this.held_bits=r.readUint8(),this.num_held_bits=1*8},stream_read_2_bytes:function(r){this.held_bits=r.readUint16(),this.num_held_bits=2*8},extract_bits:function(r){const a=this.held_bits>>this.num_held_bits-r&(1<<r)-1;return this.num_held_bits-=r,a}};if(t.stream_read_1_bytes(e),t.extract_bits(5),this.lengthSizeMinusOne=t.extract_bits(2),this.ptl_present_flag=t.extract_bits(1),this.ptl_present_flag){t.stream_read_2_bytes(e),this.ols_idx=t.extract_bits(9),this.num_sublayers=t.extract_bits(3),this.constant_frame_rate=t.extract_bits(2),this.chroma_format_idc=t.extract_bits(2),t.stream_read_1_bytes(e),this.bit_depth_minus8=t.extract_bits(3),t.extract_bits(5);{if(t.stream_read_2_bytes(e),t.extract_bits(2),this.num_bytes_constraint_info=t.extract_bits(6),this.general_profile_idc=t.extract_bits(7),this.general_tier_flag=t.extract_bits(1),this.general_level_idc=e.readUint8(),t.stream_read_1_bytes(e),this.ptl_frame_only_constraint_flag=t.extract_bits(1),this.ptl_multilayer_enabled_flag=t.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(let r=0;r<this.num_bytes_constraint_info-1;r++){const a=t.extract_bits(6);t.stream_read_1_bytes(e);const o=t.extract_bits(2);this.general_constraint_info[r]=a<<2|o}this.general_constraint_info[this.num_bytes_constraint_info-1]=t.extract_bits(6)}else t.extract_bits(6);if(this.num_sublayers>1){t.stream_read_1_bytes(e),this.ptl_sublayer_present_mask=0;for(let r=this.num_sublayers-2;r>=0;--r){const a=t.extract_bits(1);this.ptl_sublayer_present_mask|=a<<r}for(let r=this.num_sublayers;r<=8&&this.num_sublayers>1;++r)t.extract_bits(1);this.sublayer_level_idc=[];for(let r=this.num_sublayers-2;r>=0;--r)this.ptl_sublayer_present_mask&1<<r&&(this.sublayer_level_idc[r]=e.readUint8())}if(this.ptl_num_sub_profiles=e.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(let r=0;r<this.ptl_num_sub_profiles;r++)this.general_sub_profile_idc.push(e.readUint32())}this.max_picture_width=e.readUint16(),this.max_picture_height=e.readUint16(),this.avg_frame_rate=e.readUint16()}const i=12,s=13;this.nalu_arrays=[];const n=e.readUint8();for(let r=0;r<n;r++){const a=[];this.nalu_arrays.push(a),t.stream_read_1_bytes(e),a.completeness=t.extract_bits(1),t.extract_bits(2),a.nalu_type=t.extract_bits(5);let o=1;a.nalu_type!==s&&a.nalu_type!==i&&(o=e.readUint16());for(let l=0;l<o;l++){const d=e.readUint16();a.push({data:e.readUint8Array(d),length:d})}}}},Hf=class extends v{constructor(){super(...arguments),this.box_name="ColourInformationBox"}static{this.fourcc="colr"}parse(e){if(this.colour_type=e.readString(4),this.colour_type==="nclx"){this.colour_primaries=e.readUint16(),this.transfer_characteristics=e.readUint16(),this.matrix_coefficients=e.readUint16();const t=e.readUint8();this.full_range_flag=t>>7}else this.colour_type==="rICC"?this.ICC_profile=e.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=e.readUint8Array(this.size-4))}};function bt(e,t){let i=Number(e).toString(16);for(t=typeof t>"u"?2:t;i.length<t;)i="0"+i;return i}var es=class extends H{getCodec(){const e=super.getCodec();return this.avcC?`${e}.${bt(this.avcC.AVCProfileIndication)}${bt(this.avcC.profile_compatibility)}${bt(this.avcC.AVCLevelIndication)}`:e}},qf=class extends es{constructor(){super(...arguments),this.box_name="AVCSampleEntry"}static{this.fourcc="avc1"}},jf=class extends es{constructor(){super(...arguments),this.box_name="AVC2SampleEntry"}static{this.fourcc="avc2"}},Xf=class extends es{constructor(){super(...arguments),this.box_name="AVCSampleEntry"}static{this.fourcc="avc3"}},Yf=class extends es{constructor(){super(...arguments),this.box_name="AVC2SampleEntry"}static{this.fourcc="avc4"}},Kf=class extends H{constructor(){super(...arguments),this.box_name="AV1SampleEntry"}static{this.fourcc="av01"}getCodec(){const e=super.getCodec(),t=this.av1C.seq_level_idx_0,i=t<10?"0"+t:t;let s;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?s=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(s=this.av1C.high_bitdepth===1?"10":"08"),e+"."+this.av1C.seq_profile+"."+i+(this.av1C.seq_tier_0?"H":"M")+"."+s}},Jf=class extends H{static{this.fourcc="dav1"}},ts=class extends H{getCodec(){let e=super.getCodec();if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";let t=this.hvcC.general_profile_compatibility,i=0;for(let r=0;r<32&&(i|=t&1,r!==31);r++)i<<=1,t>>=1;e+=bt(i,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;let s=!1,n="";for(let r=5;r>=0;r--)(this.hvcC.general_constraint_indicator[r]||s)&&(n="."+bt(this.hvcC.general_constraint_indicator[r],0)+n,s=!0);e+=n}return e}},Zf=class extends ts{constructor(){super(...arguments),this.box_name="HEVCSampleEntry"}static{this.fourcc="hvc1"}},Qf=class extends ts{static{this.fourcc="hvc2"}},ec=class extends ts{constructor(){super(...arguments),this.box_name="HEVCSampleEntry",this.colrs=[],this.subBoxNames=["colr"]}static{this.fourcc="hev1"}},tc=class extends ts{static{this.fourcc="hev2"}},ic=class extends H{constructor(){super(...arguments),this.box_name="HEVCTileSampleSampleEntry"}static{this.fourcc="hvt1"}},sc=class extends H{constructor(){super(...arguments),this.box_name="LHEVCSampleEntry"}static{this.fourcc="lhe1"}},nc=class extends H{constructor(){super(...arguments),this.box_name="LHEVCSampleEntry"}static{this.fourcc="lhv1"}},rc=class extends H{static{this.fourcc="dvh1"}},ac=class extends H{static{this.fourcc="dvhe"}},Fa=class extends H{getCodec(){let e=super.getCodec();if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;let t="";if(this.vvcC.general_constraint_info){const i=[];let s=0;s|=this.vvcC.ptl_frame_only_constraint_flag<<7,s|=this.vvcC.ptl_multilayer_enabled_flag<<6;let n;for(let r=0;r<this.vvcC.general_constraint_info.length;++r)s|=this.vvcC.general_constraint_info[r]>>2&63,i.push(s),s&&(n=r),s=this.vvcC.general_constraint_info[r]>>2&3;if(n===void 0)t=".CA";else{t=".C";const r="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let a=0,o=0;for(let l=0;l<=n;++l)for(a=a<<8|i[l],o+=8;o>=5;){const d=a>>o-5&31;t+=r[d],o-=5,a&=(1<<o)-1}o&&(a<<=5-o,t+=r[a&31])}}e+=t}return e}},oc=class extends Fa{constructor(){super(...arguments),this.box_name="VvcSampleEntry"}static{this.fourcc="vvc1"}},lc=class extends Fa{constructor(){super(...arguments),this.box_name="VvcSampleEntry"}static{this.fourcc="vvi1"}},dc=class extends H{constructor(){super(...arguments),this.box_name="VvcSampleEntry"}static{this.fourcc="vvs1"}},fc=class extends H{constructor(){super(...arguments),this.box_name="VvcNonVCLSampleEntry"}static{this.fourcc="vvcN"}},Ca=class extends H{getCodec(){const e=super.getCodec();let t=this.vpcC.level;t===0&&(t="00");let i=this.vpcC.bitDepth;return i===8&&(i="08"),`${e}.0${this.vpcC.profile}.${t}.${i}`}},cc=class extends Ca{static{this.fourcc="vp08"}},uc=class extends Ca{static{this.fourcc="vp09"}},hc=class extends H{static{this.fourcc="avs3"}},pc=class extends H{constructor(){super(...arguments),this.box_name="J2KSampleEntry"}static{this.fourcc="j2ki"}},mc=class extends H{static{this.fourcc="mjp2"}},$c=class extends H{static{this.fourcc="mjpg"}},gc=class extends H{constructor(){super(...arguments),this.box_name="UncompressedVideoSampleEntry"}static{this.fourcc="uncv"}},xc=class extends H{constructor(){super(...arguments),this.box_name="MP4VisualSampleEntry"}static{this.fourcc="mp4v"}},yc=class extends ge{constructor(){super(...arguments),this.box_name="MP4AudioSampleEntry"}static{this.fourcc="mp4a"}getCodec(){const e=super.getCodec();if(this.esds&&this.esds.esd){const t=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return e+"."+bt(t)+(i?"."+i:"")}else return e}},bc=class extends ge{static{this.fourcc="m4ae"}},_c=class extends ge{static{this.fourcc="ac-3"}},vc=class extends ge{static{this.fourcc="ac-4"}},wc=class extends ge{static{this.fourcc="ec-3"}},Sc=class extends ge{static{this.fourcc="Opus"}},Ic=class extends ge{static{this.fourcc="mha1"}},Ec=class extends ge{static{this.fourcc="mha2"}},Tc=class extends ge{static{this.fourcc="mhm1"}},Fc=class extends ge{static{this.fourcc="mhm2"}},Cc=class extends ge{static{this.fourcc="fLaC"}},Uc=class extends H{static{this.fourcc="encv"}},kc=class extends ge{static{this.fourcc="enca"}},Bc=class extends lt{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="encu"}},Ac=class extends an{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="encs"}},Oc=class extends an{static{this.fourcc="mp4s"}},Pc=class extends rf{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="enct"}},Dc=class extends vt{constructor(){super(...arguments),this.subBoxNames=["sinf"],this.sinfs=[]}static{this.fourcc="encm"}},Lc=class extends H{constructor(){super(...arguments),this.box_name="RestrictedVideoSampleEntry"}static{this.fourcc="resv"}},Nc=class extends lt{static{this.fourcc="sbtt"}parse(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.mime_format=e.readCString(),this.parseFooter(e)}},Ua=class extends lt{static{this.fourcc="stpp"}parse(e){this.parseHeader(e),this.namespace=e.readCString(),this.schema_location=e.readCString(),this.auxiliary_mime_types=e.readCString(),this.parseFooter(e)}write(e){this.writeHeader(e),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,e.writeCString(this.namespace),e.writeCString(this.schema_location),e.writeCString(this.auxiliary_mime_types),this.writeFooter(e)}},Rc=class extends lt{static{this.fourcc="stxt"}parse(e){this.parseHeader(e),this.content_encoding=e.readCString(),this.mime_format=e.readCString(),this.parseFooter(e)}getCodec(){const e=super.getCodec();return this.mime_format?e+"."+this.mime_format:e}},zc=class extends lt{static{this.fourcc="tx3g"}parse(e){this.parseHeader(e),this.displayFlags=e.readUint32(),this.horizontal_justification=e.readInt8(),this.vertical_justification=e.readInt8(),this.bg_color_rgba=e.readUint8Array(4),this.box_record=e.readInt16Array(4),this.style_record=e.readUint8Array(12),this.parseFooter(e)}},Mc=class extends vt{static{this.fourcc="wvtt"}parse(e){this.parseHeader(e),this.parseFooter(e)}},Gc=class extends y{constructor(){super(...arguments),this.box_name="SampleToGroupBox"}static{this.fourcc="sbgp"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readString(4),this.version===1?this.grouping_type_parameter=e.readUint32():this.grouping_type_parameter=0,this.entries=[];const t=e.readUint32();for(let i=0;i<t;i++)this.entries.push({sample_count:e.readInt32(),group_description_index:e.readInt32()})}write(e){this.grouping_type_parameter?this.version=1:this.version=0,this.flags=0,this.size=8+8*this.entries.length+(this.version===1?4:0),this.writeHeader(e),e.writeString(this.grouping_type,void 0,4),this.version===1&&e.writeUint32(this.grouping_type_parameter),e.writeUint32(this.entries.length);for(let t=0;t<this.entries.length;t++){const i=this.entries[t];e.writeInt32(i.sample_count),e.writeInt32(i.group_description_index)}}},Vc=class extends y{constructor(){super(...arguments),this.box_name="SampleDependencyTypeBox"}static{this.fourcc="sdtp"}parse(e){this.parseFullHeader(e);const t=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(let i=0;i<t;i++){const s=e.readUint8();this.is_leading[i]=s>>6,this.sample_depends_on[i]=s>>4&3,this.sample_is_depended_on[i]=s>>2&3,this.sample_has_redundancy[i]=s&3}}},Wc=class extends y{constructor(){super(...arguments),this.box_name="SampleGroupDescriptionBox"}static{this.fourcc="sgpd"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readString(4),$.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=e.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=e.readUint32()),this.entries=[];const t=e.readUint32();for(let i=0;i<t;i++){let s;this.grouping_type in me.sampleGroupEntry?s=new me.sampleGroupEntry[this.grouping_type](this.grouping_type):s=new ee(this.grouping_type),this.entries.push(s),this.version===1?this.default_length===0?s.description_length=e.readUint32():s.description_length=this.default_length:s.description_length=this.default_length,s.write===ee.prototype.write&&($.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=e.readUint8Array(s.description_length),e.seek(e.getPosition()-s.description_length)),s.parse(e)}}write(e){this.flags=0,this.size=12;for(let t=0;t<this.entries.length;t++){const i=this.entries[t];this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=i.data.length)}this.writeHeader(e),e.writeString(this.grouping_type,void 0,4),this.version===1&&e.writeUint32(this.default_length),this.version>=2&&e.writeUint32(this.default_sample_description_index),e.writeUint32(this.entries.length);for(let t=0;t<this.entries.length;t++){const i=this.entries[t];this.version===1&&this.default_length===0&&e.writeUint32(i.description_length),i.write(e)}}},Hc=class extends y{constructor(){super(...arguments),this.box_name="CompressedSegmentIndexBox"}static{this.fourcc="sidx"}parse(e){this.parseFullHeader(e),this.reference_ID=e.readUint32(),this.timescale=e.readUint32(),this.version===0?(this.earliest_presentation_time=e.readUint32(),this.first_offset=e.readUint32()):(this.earliest_presentation_time=e.readUint64(),this.first_offset=e.readUint64()),e.readUint16(),this.references=[];const t=e.readUint16();for(let i=0;i<t;i++){const s=e.readUint32(),n=e.readUint32(),r=e.readUint32();this.references.push({reference_type:s>>31&1,referenced_size:s&2147483647,subsegment_duration:n,starts_with_SAP:r>>31&1,SAP_type:r>>28&7,SAP_delta_time:r&268435455})}}write(e){const t=this.earliest_presentation_time>ie||this.first_offset>ie||this.version===1;this.version=t?1:0,this.size=4*2+2+2+12*this.references.length,this.size+=t?16:8,this.flags=0,this.writeHeader(e),e.writeUint32(this.reference_ID),e.writeUint32(this.timescale),t?(e.writeUint64(this.earliest_presentation_time),e.writeUint64(this.first_offset)):(e.writeUint32(this.earliest_presentation_time),e.writeUint32(this.first_offset)),e.writeUint16(0),e.writeUint16(this.references.length);for(let i=0;i<this.references.length;i++){const s=this.references[i];e.writeUint32(s.reference_type<<31|s.referenced_size),e.writeUint32(s.subsegment_duration),e.writeUint32(s.starts_with_SAP<<31|s.SAP_type<<28|s.SAP_delta_time)}}},ka=class extends y{constructor(){super(...arguments),this.box_name="SoundMediaHeaderBox"}static{this.fourcc="smhd"}parse(e){this.parseFullHeader(e),this.balance=e.readUint16(),e.readUint16()}write(e){this.version=0,this.size=4,this.writeHeader(e),e.writeUint16(this.balance),e.writeUint16(0)}},Ba=class extends y{constructor(){super(...arguments),this.box_name="ChunkOffsetBox"}static{this.fourcc="stco"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.chunk_offsets=[],this.version===0)for(let i=0;i<t;i++)this.chunk_offsets.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length),e.writeUint32Array(this.chunk_offsets)}unpack(e){for(let t=0;t<this.chunk_offsets.length;t++)e[t].offset=this.chunk_offsets[t]}},Aa=class extends y{constructor(){super(...arguments),this.box_name="SubtitleMediaHeaderBox"}static{this.fourcc="sthd"}},Oa=class extends y{constructor(){super(...arguments),this.box_name="SampleToChunkBox"}static{this.fourcc="stsc"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(let i=0;i<t;i++)this.first_chunk.push(e.readUint32()),this.samples_per_chunk.push(e.readUint32()),this.sample_description_index.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(e),e.writeUint32(this.first_chunk.length);for(let t=0;t<this.first_chunk.length;t++)e.writeUint32(this.first_chunk[t]),e.writeUint32(this.samples_per_chunk[t]),e.writeUint32(this.sample_description_index[t])}unpack(e){let t=0,i=0;for(let s=0;s<this.first_chunk.length;s++)for(let n=0;n<(s+1<this.first_chunk.length?this.first_chunk[s+1]:1/0);n++){i++;for(let r=0;r<this.samples_per_chunk[s];r++){if(e[t])e[t].description_index=this.sample_description_index[s],e[t].chunk_index=i;else return;t++}}}},Pa=class extends y{constructor(){super(...arguments),this.box_name="SampleDescriptionBox"}static{this.fourcc="stsd"}parse(e){this.parseFullHeader(e),this.entries=[];const t=e.readUint32();for(let i=1;i<=t;i++){const s=Ue(e,!0,this.size-(e.getPosition()-this.start));if(s.code===be){let n;s.type in me.sampleEntry?(n=new me.sampleEntry[s.type](s.size),n.hdr_size=s.hdr_size,n.start=s.start):($.warn("BoxParser",`Unknown sample entry type: '${s.type}'`),n=new Ne(s.size,s.hdr_size,s.start),n.type=s.type),n.write===Ne.prototype.write&&($.info("BoxParser","SampleEntry "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(e)),n.parse(e),this.entries.push(n)}else return}}write(e){this.version=0,this.flags=0,this.size=0,this.writeHeader(e),e.writeUint32(this.entries.length),this.size+=4;for(let t=0;t<this.entries.length;t++)this.entries[t].write(e),this.size+=this.entries[t].size;$.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}},Da=class extends y{constructor(){super(...arguments),this.box_name="SampleSizeBox"}static{this.fourcc="stsz"}parse(e){if(this.parseFullHeader(e),this.sample_sizes=[],this.version===0){this.sample_size=e.readUint32(),this.sample_count=e.readUint32();for(let t=0;t<this.sample_count;t++)this.sample_size===0?this.sample_sizes.push(e.readUint32()):this.sample_sizes[t]=this.sample_size}}write(e){let t=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0){let i=0;for(;i+1<this.sample_sizes.length;)if(this.sample_sizes[i+1]!==this.sample_sizes[0]){t=!1;break}else i++}else t=!1;this.size=8,t||(this.size+=4*this.sample_sizes.length),this.writeHeader(e),t?e.writeUint32(this.sample_sizes[0]):e.writeUint32(0),e.writeUint32(this.sample_sizes.length),t||e.writeUint32Array(this.sample_sizes)}unpack(e){for(let t=0;t<this.sample_sizes.length;t++)e[t].size=this.sample_sizes[t]}},La=class extends y{constructor(){super(...arguments),this.box_name="TimeToSampleBox",this.sample_counts=[],this.sample_deltas=[]}static{this.fourcc="stts"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.sample_counts.length=0,this.sample_deltas.length=0,this.version===0)for(let i=0;i<t;i++){this.sample_counts.push(e.readUint32());let s=e.readInt32();s<0&&($.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)}}write(e){this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length);for(let t=0;t<this.sample_counts.length;t++)e.writeUint32(this.sample_counts[t]),e.writeUint32(this.sample_deltas[t])}unpack(e){let t=0;for(let i=0;i<this.sample_counts.length;i++)for(let s=0;s<this.sample_counts[i];s++)t===0?e[t].dts=0:e[t].dts=e[t-1].dts+this.sample_deltas[i],t++}},Na=class extends y{constructor(){super(...arguments),this.box_name="TrackFragmentBaseMediaDecodeTimeBox"}static{this.fourcc="tfdt"}parse(e){this.parseFullHeader(e),this.version===1?this.baseMediaDecodeTime=e.readUint64():this.baseMediaDecodeTime=e.readUint32()}write(e){const t=this.baseMediaDecodeTime>ie||this.version===1;this.version=t?1:0,this.size=4,this.size+=t?4:0,this.flags=0,this.writeHeader(e),t?e.writeUint64(this.baseMediaDecodeTime):e.writeUint32(this.baseMediaDecodeTime)}},Ra=class extends y{constructor(){super(...arguments),this.box_name="TrackFragmentHeaderBox"}static{this.fourcc="tfhd"}parse(e){this.parseFullHeader(e);let t=0;this.track_id=e.readUint32(),this.size-this.hdr_size>t&&this.flags&bi?(this.base_data_offset=e.readUint64(),t+=8):this.base_data_offset=0,this.size-this.hdr_size>t&&this.flags&_i?(this.default_sample_description_index=e.readUint32(),t+=4):this.default_sample_description_index=0,this.size-this.hdr_size>t&&this.flags&vi?(this.default_sample_duration=e.readUint32(),t+=4):this.default_sample_duration=0,this.size-this.hdr_size>t&&this.flags&wi?(this.default_sample_size=e.readUint32(),t+=4):this.default_sample_size=0,this.size-this.hdr_size>t&&this.flags&Si?(this.default_sample_flags=e.readUint32(),t+=4):this.default_sample_flags=0}write(e){this.version=0,this.size=4,this.flags&bi&&(this.size+=8),this.flags&_i&&(this.size+=4),this.flags&vi&&(this.size+=4),this.flags&wi&&(this.size+=4),this.flags&Si&&(this.size+=4),this.writeHeader(e),e.writeUint32(this.track_id),this.flags&bi&&e.writeUint64(this.base_data_offset),this.flags&_i&&e.writeUint32(this.default_sample_description_index),this.flags&vi&&e.writeUint32(this.default_sample_duration),this.flags&wi&&e.writeUint32(this.default_sample_size),this.flags&Si&&e.writeUint32(this.default_sample_flags)}},za=class extends y{constructor(){super(...arguments),this.box_name="TrackHeaderBox",this.layer=0,this.alternate_group=0}static{this.fourcc="tkhd"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint32()),e.readUint32Array(2),this.layer=e.readInt16(),this.alternate_group=e.readInt16(),this.volume=e.readInt16()>>8,e.readUint16(),this.matrix=e.readInt32Array(9),this.width=e.readUint32(),this.height=e.readUint32()}write(e){const t=this.modification_time>ie||this.creation_time>ie||this.duration>ie||this.version===1;this.version=t?1:0,this.size=5*4+15*4,this.size+=t?3*4:0,this.flags=this.flags??3,this.writeHeader(e),t?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.track_id),e.writeUint32(0),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.track_id),e.writeUint32(0),e.writeUint32(this.duration)),e.writeUint32Array([0,0]),e.writeInt16(this.layer),e.writeInt16(this.alternate_group),e.writeInt16(this.volume<<8),e.writeInt16(0),e.writeInt32Array(this.matrix),e.writeUint32(this.width),e.writeUint32(this.height)}print(e){super.printHeader(e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"track_id: "+this.track_id),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"layer: "+this.layer),e.log(e.indent+"alternate_group: "+this.alternate_group),e.log(e.indent+"width: "+this.width),e.log(e.indent+"height: "+this.height)}},Hs=class extends y{constructor(){super(...arguments),this.box_name="TrackExtendsBox"}static{this.fourcc="trex"}parse(e){this.parseFullHeader(e),this.track_id=e.readUint32(),this.default_sample_description_index=e.readUint32(),this.default_sample_duration=e.readUint32(),this.default_sample_size=e.readUint32(),this.default_sample_flags=e.readUint32()}write(e){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(e),e.writeUint32(this.track_id),e.writeUint32(this.default_sample_description_index),e.writeUint32(this.default_sample_duration),e.writeUint32(this.default_sample_size),e.writeUint32(this.default_sample_flags)}},Ma=class extends y{constructor(){super(...arguments),this.box_name="TrackRunBox",this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[]}static{this.fourcc="trun"}parse(e){this.parseFullHeader(e);let t=0;if(this.sample_count=e.readUint32(),t+=4,this.size-this.hdr_size>t&&this.flags&Nt?(this.data_offset=e.readInt32(),t+=4):this.data_offset=0,this.size-this.hdr_size>t&&this.flags&Ii?(this.first_sample_flags=e.readUint32(),t+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>t)for(let i=0;i<this.sample_count;i++)this.flags&Rt&&(this.sample_duration[i]=e.readUint32()),this.flags&zt&&(this.sample_size[i]=e.readUint32()),this.flags&Mt&&(this.sample_flags[i]=e.readUint32()),this.flags&Gt&&(this.version===0?this.sample_composition_time_offset[i]=e.readUint32():this.sample_composition_time_offset[i]=e.readInt32())}write(e){this.size=4,this.flags&Nt&&(this.size+=4),this.flags&Ii&&(this.size+=4),this.flags&Rt&&(this.size+=4*this.sample_duration.length),this.flags&zt&&(this.size+=4*this.sample_size.length),this.flags&Mt&&(this.size+=4*this.sample_flags.length),this.flags&Gt&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(e),e.writeUint32(this.sample_count),this.flags&Nt&&(this.data_offset_position=e.getPosition(),e.writeInt32(this.data_offset)),this.flags&Ii&&e.writeUint32(this.first_sample_flags);for(let t=0;t<this.sample_count;t++)this.flags&Rt&&e.writeUint32(this.sample_duration[t]),this.flags&zt&&e.writeUint32(this.sample_size[t]),this.flags&Mt&&e.writeUint32(this.sample_flags[t]),this.flags&Gt&&(this.version===0?e.writeUint32(this.sample_composition_time_offset[t]):e.writeInt32(this.sample_composition_time_offset[t]))}},Ga=class extends y{constructor(){super(...arguments),this.box_name="DataEntryUrlBox"}static{this.fourcc="url "}parse(e){this.parseFullHeader(e),this.flags!==1&&(this.location=e.readCString())}write(e){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(e),this.location&&e.writeCString(this.location)}},Va=class extends y{constructor(){super(...arguments),this.box_name="VideoMediaHeaderBox"}static{this.fourcc="vmhd"}parse(e){this.parseFullHeader(e),this.graphicsmode=e.readUint16(),this.opcolor=e.readUint16Array(3)}write(e){this.version=0,this.size=8,this.writeHeader(e),e.writeUint16(this.graphicsmode),e.writeUint16Array(this.opcolor)}},xs=class{constructor(e,t,i){this.grouping_type=e,this.grouping_type_parameter=t,this.sbgp=i,this.last_sample_in_run=-1,this.entry_index=-1}},qc=class Ge{constructor(t,i=!0){this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.moovStartSent=!1,this.readySent=!1,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.sidxSent=!1,this.items=[],this.entity_groups=[],this.itemsDataSize=0,this.lastMoofIndex=0,this.samplesDataSize=0,this.lastBoxStartPosition=0,this.nextParsePosition=0,this.discardMdatData=!0,this.discardMdatData=i,t?(this.stream=t,this.parse()):this.stream=new Ti,this.stream.isofile=this}setSegmentOptions(t,i,s){const{sizePerSegment:n=Number.MAX_SAFE_INTEGER,rapAlignement:r=!0}=s;let a=s.nbSamples??s.nbSamplesPerFragment??1e3;const o=s.nbSamplesPerFragment??a;if(a<=0||o<=0||n<=0){$.error("ISOFile",`Invalid segment options: nbSamples=${a}, nbSamplesPerFragment=${o}, sizePerSegment=${n}`);return}if(a<o&&($.warn("ISOFile",`nbSamples (${a}) is less than nbSamplesPerFragment (${o}), setting nbSamples to nbSamplesPerFragment`),a=o),this.fragmentedTracks.some(d=>d.nb_samples!==a)){$.error("ISOFile",`Cannot set segment options for track ${t}: nbSamples (${a}) does not match existing tracks`);return}const l=this.getTrackById(t);if(l){const d={id:t,user:i,trak:l,segmentStream:void 0,nb_samples:a,nb_samples_per_fragment:o,size_per_segment:n,rapAlignement:r,state:{lastFragmentSampleNumber:0,lastSegmentSampleNumber:0,accumulatedSize:0}};this.fragmentedTracks.push(d),l.nextSample=0}this.discardMdatData&&$.warn("ISOFile","Segmentation options set but discardMdatData is true, samples will not be segmented")}unsetSegmentOptions(t){let i=-1;for(let s=0;s<this.fragmentedTracks.length;s++)this.fragmentedTracks[s].id===t&&(i=s);i>-1&&this.fragmentedTracks.splice(i,1)}setExtractionOptions(t,i,{nbSamples:s=1e3}={}){const n=this.getTrackById(t);n&&(this.extractedTracks.push({id:t,user:i,trak:n,nb_samples:s,samples:[]}),n.nextSample=0),this.discardMdatData&&$.warn("ISOFile","Extraction options set but discardMdatData is true, samples will not be extracted")}unsetExtractionOptions(t){let i=-1;for(let s=0;s<this.extractedTracks.length;s++)this.extractedTracks[s].id===t&&(i=s);i>-1&&this.extractedTracks.splice(i,1)}parse(){if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else{this.saveParsePosition&&this.saveParsePosition();const i=Ue(this.stream,!1);if(i.code===Me)if(this.processIncompleteBox){if(this.processIncompleteBox(i))continue;return}else return;else if(i.code===be){const s=i.box;if(this.boxes.push(s),s.type==="uuid")this[s.uuid]!==void 0&&$.warn("ISOFile","Duplicate Box of uuid: "+s.uuid+", overriding previous occurrence"),this[s.uuid]=s;else switch(s.type){case"mdat":this.mdats.push(s),this.transferMdatData(s);break;case"moof":this.moofs.push(s);break;case"free":case"skip":break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[s.type]!==void 0?Array.isArray(this[s.type+"s"])?($.info("ISOFile",`Found multiple boxes of type ${s.type} in ISOFile, adding to array`),this[s.type+"s"].push(s)):($.warn("ISOFile",`Found multiple boxes of type ${s.type} but no array exists. Creating array dynamically.`),this[s.type+"s"]=[this[s.type],s]):(this[s.type]=s,Array.isArray(this[s.type+"s"])&&this[s.type+"s"].push(s));break}this.updateUsedBytes&&this.updateUsedBytes(s,i)}else if(i.code===aa){$.error("ISOFile",`Invalid data found while parsing box of type '${i.type}' at position ${i.start}. Aborting parsing.`,this);break}}}checkBuffer(t){if(!t)throw new Error("Buffer must be defined and non empty");return t.byteLength===0?($.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):($.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:($.warn("ISOFile","Not ready to start parsing"),!1))}appendBuffer(t,i){let s;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(i),this.nextSeekPosition?(s=this.nextSeekPosition,this.nextSeekPosition=void 0):s=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(s=this.stream.getEndFilePositionAfter(s))):this.nextParsePosition?s=this.nextParsePosition:s=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&($.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+s),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),$.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),s}getFragmentDuration(){const t=this.getBox("mvex");if(!t)return;if(t.mehd)return{num:t.mehd.fragment_duration,den:this.moov.mvhd.timescale};const i=this.getBoxes("trak",!1);let s={num:0,den:1};for(const n of i){const r=n.samples_duration,a=n.mdia.mdhd.timescale;r&&a&&r/a>s.num/s.den&&(s={num:r,den:a})}return s}getInfo(){if(!this.moov)return{hasMoov:!1,mime:""};const t=new Date("1904-01-01T00:00:00Z").getTime(),i=this.getBox("mvex")!==void 0,s={hasMoov:!0,duration:this.moov.mvhd.duration,timescale:this.moov.mvhd.timescale,isFragmented:i,fragment_duration:this.getFragmentDuration(),isProgressive:this.isProgressive,hasIOD:this.moov.iods!==void 0,brands:[this.ftyp.major_brand].concat(this.ftyp.compatible_brands),created:new Date(t+this.moov.mvhd.creation_time*1e3),modified:new Date(t+this.moov.mvhd.modification_time*1e3),tracks:[],audioTracks:[],videoTracks:[],subtitleTracks:[],metadataTracks:[],hintTracks:[],otherTracks:[],mime:""};for(let n=0;n<this.moov.traks.length;n++){const r=this.moov.traks[n],a=r.mdia.minf.stbl.stsd.entries[0],o=r.samples_size,l=r.mdia.mdhd.timescale,d=r.samples_duration,c=o*8*l/d,f={samples_duration:d,bitrate:c,size:o,timescale:l,alternate_group:r.tkhd.alternate_group,codec:a.getCodec(),created:new Date(t+r.tkhd.creation_time*1e3),cts_shift:r.mdia.minf.stbl.cslg,duration:r.mdia.mdhd.duration,id:r.tkhd.track_id,kind:r.udta&&r.udta.kinds.length?r.udta.kinds[0]:{schemeURI:"",value:""},language:r.mdia.elng?r.mdia.elng.extended_language:r.mdia.mdhd.languageString,layer:r.tkhd.layer,matrix:r.tkhd.matrix,modified:new Date(t+r.tkhd.modification_time*1e3),movie_duration:r.tkhd.duration,movie_timescale:s.timescale,name:r.mdia.hdlr.name,nb_samples:r.samples.length,references:[],track_height:r.tkhd.height/65536,track_width:r.tkhd.width/65536,volume:r.tkhd.volume};if(s.tracks.push(f),r.tref)for(let u=0;u<r.tref.references.length;u++)f.references.push({type:r.tref.references[u].type,track_ids:r.tref.references[u].track_ids});r.edts&&(f.edits=r.edts.elst.entries),a instanceof ge?(f.type="audio",s.audioTracks.push(f),f.audio={sample_rate:a.getSampleRate(),channel_count:a.getChannelCount(),sample_size:a.getSampleSize()}):a instanceof H?(f.type="video",s.videoTracks.push(f),f.video={width:a.getWidth(),height:a.getHeight()}):a instanceof lt?(f.type="subtitles",s.subtitleTracks.push(f)):a instanceof or?(f.type="metadata",s.hintTracks.push(f)):a instanceof vt?(f.type="metadata",s.metadataTracks.push(f)):(f.type="metadata",s.otherTracks.push(f))}s.videoTracks&&s.videoTracks.length>0?s.mime+='video/mp4; codecs="':s.audioTracks&&s.audioTracks.length>0?s.mime+='audio/mp4; codecs="':s.mime+='application/mp4; codecs="';for(let n=0;n<s.tracks.length;n++)n!==0&&(s.mime+=","),s.mime+=s.tracks[n].codec;return s.mime+='"; profiles="',s.mime+=this.ftyp.compatible_brands.join(),s.mime+='"',s}setNextSeekPositionFromSample(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)}processSamples(t){if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==void 0){const i=new Set;for(;i.size<this.fragmentedTracks.length&&this.fragmentedTracks.some(s=>s.trak.nextSample<s.trak.samples.length)&&this.sampleProcessingStarted;)for(const s of this.fragmentedTracks){const n=s.trak;if(!i.has(s.id)){const r=n.nextSample<n.samples.length?this.getSample(n,n.nextSample):void 0;if(!r){this.setNextSeekPositionFromSample(n.samples[n.nextSample]),i.add(s.id);continue}s.state.accumulatedSize+=r.size;const a=n.nextSample+1,o=a-s.state.lastFragmentSampleNumber>s.nb_samples_per_fragment,l=a-s.state.lastSegmentSampleNumber>s.nb_samples;let d=o||a%s.nb_samples_per_fragment===0,c=l||a%s.nb_samples===0,f=s.state.accumulatedSize>=s.size_per_segment;const u=!s.rapAlignement||r.is_sync,h=t||n.nextSample+1>=n.samples.length;if(h&&!u&&$.warn("ISOFile","Flushing track #"+s.id+" at sample #"+n.nextSample+" which is not a RAP, this may lead to playback issues"),d=d&&u,c=c&&u,f=f&&u,d||f||h){o?$.warn("ISOFile","Fragment on track #"+s.id+" is overdue, creating it with samples ["+s.state.lastFragmentSampleNumber+", "+n.nextSample+"]"):$.debug("ISOFile","Creating media fragment on track #"+s.id+" for samples ["+s.state.lastFragmentSampleNumber+", "+n.nextSample+"]");const m=this.createFragment(s.id,s.state.lastFragmentSampleNumber,n.nextSample,s.segmentStream);if(m)s.segmentStream=m,s.state.lastFragmentSampleNumber=n.nextSample+1;else{i.add(s.id);continue}}(c||f||h)&&(l?$.warn("ISOFile","Segment on track #"+s.id+" is overdue, sending it with samples ["+Math.max(0,n.nextSample-s.nb_samples)+", "+(n.nextSample-1)+"]"):$.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,n.nextSample-s.nb_samples)+", "+(n.nextSample-1)+"]"),$.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,n.nextSample+1,t||n.nextSample+1>=n.samples.length),s.segmentStream=void 0,s.state.accumulatedSize=0,s.state.lastSegmentSampleNumber=n.nextSample+1),n.nextSample++}}}if(this.onSamples!==void 0)for(let i=0;i<this.extractedTracks.length;i++){const s=this.extractedTracks[i],n=s.trak;for(;n.nextSample<n.samples.length&&this.sampleProcessingStarted;){$.debug("ISOFile","Exporting on track #"+s.id+" sample #"+n.nextSample);const r=this.getSample(n,n.nextSample);if(r)n.nextSample++,s.samples.push(r);else{this.setNextSeekPositionFromSample(n.samples[n.nextSample]);break}if((n.nextSample%s.nb_samples===0||n.nextSample>=n.samples.length)&&($.debug("ISOFile","Sending samples on track #"+s.id+" for sample "+n.nextSample),this.onSamples&&this.onSamples(s.id,s.user,s.samples),s.samples=[],s!==this.extractedTracks[i]))break}}}}getBox(t){const i=this.getBoxes(t,!0);return i.length?i[0]:void 0}getBoxes(t,i){const s=[],n=r=>{r instanceof v&&r.type&&r.type===t&&s.push(r);const a=[];r.boxes&&a.push(...r.boxes),r.entries&&a.push(...r.entries),r.item_infos&&a.push(...r.item_infos),r.references&&a.push(...r.references);for(const o of a){if(s.length&&i)return;n(o)}};return n(this),s}getTrackSamplesInfo(t){const i=this.getTrackById(t);if(i)return i.samples}getTrackSample(t,i){const s=this.getTrackById(t);return this.getSample(s,i)}releaseUsedSamples(t,i){let s=0;const n=this.getTrackById(t);n.lastValidSample||(n.lastValidSample=0);for(let r=n.lastValidSample;r<i;r++)s+=this.releaseSample(n,r);$.info("ISOFile","Track #"+t+" released samples up to "+i+" (released size: "+s+", remaining: "+this.samplesDataSize+")"),n.lastValidSample=i}start(){this.sampleProcessingStarted=!0,this.processSamples(!1)}stop(){this.sampleProcessingStarted=!1}flush(){$.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)}seekTrack(t,i,s){let n=0,r=0,a;if(s.samples.length===0)return $.info("ISOFile","No sample in track, cannot seek! Using time "+$.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(let l=0;l<s.samples.length;l++){const d=s.samples[l];if(l===0)r=0,a=d.timescale;else if(d.cts>t*d.timescale){r=l-1;break}i&&d.is_sync&&(n=l)}for(i&&(r=n),t=s.samples[r].cts,s.nextSample=r;s.samples[r].alreadyRead===s.samples[r].size&&s.samples[r+1];)r++;const o=s.samples[r].offset+s.samples[r].alreadyRead;return $.info("ISOFile","Seeking to "+(i?"RAP":"")+" sample #"+s.nextSample+" on track "+s.tkhd.track_id+", time "+$.getDurationString(t,a)+" and offset: "+o),{offset:o,time:t/a}}getTrackDuration(t){if(!t.samples)return 1/0;const i=t.samples[t.samples.length-1];return(i.cts+i.duration)/i.timescale}seek(t,i){const s=this.moov;let n={offset:1/0,time:1/0};if(this.moov){for(let r=0;r<s.traks.length;r++){const a=s.traks[r];if(t>this.getTrackDuration(a))continue;const o=this.seekTrack(t,i,a);o.offset<n.offset&&(n.offset=o.offset),o.time<n.time&&(n.time=o.time)}return $.info("ISOFile","Seeking at time "+$.getDurationString(n.time,1)+" needs a buffer with a fileStart position of "+n.offset),n.offset===1/0?n={offset:this.nextParsePosition,time:0}:n.offset=this.stream.getEndFilePositionAfter(n.offset),$.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+n.offset),n}else throw new Error("Cannot seek: moov not received!")}equal(t){let i=0;for(;i<this.boxes.length&&i<t.boxes.length;){const s=this.boxes[i],n=t.boxes[i];if(!la(s,n))return!1;i++}return!0}write(t){for(let i=0;i<this.boxes.length;i++)this.boxes[i].write(t)}createFragment(t,i,s,n){const r=[];for(let c=i;c<=s;c++){const f=this.getTrackById(t),u=this.getSample(f,c);if(!u){this.setNextSeekPositionFromSample(f.samples[c]);return}r.push(u)}const a=n||new ye,o=this.createMoof(r);o.write(a),o.trafs[0].truns[0].data_offset=o.size+8,$.debug("MP4Box","Adjusting data_offset with new value "+o.trafs[0].truns[0].data_offset),a.adjustUint32(o.trafs[0].truns[0].data_offset_position,o.trafs[0].truns[0].data_offset);const l=new Fi;l.stream=new Ti;let d=0;for(const c of r)if(c.data){const f=Ve.fromArrayBuffer(c.data.buffer,d);l.stream.insertBuffer(f),d+=c.data.byteLength}return l.write(a),a}static writeInitializationSegment(t,i,s){$.debug("ISOFile","Generating initialization segment");const n=new ye;t.write(n);const r=i.addBox(new Ws);if(s){const a=r.addBox(new Sa);a.fragment_duration=s}for(let a=0;a<i.traks.length;a++){const o=r.addBox(new Hs);o.track_id=i.traks[a].tkhd.track_id,o.default_sample_description_index=1,o.default_sample_duration=i.traks[a].samples[0]?.duration??0,o.default_sample_size=0,o.default_sample_flags=65536}return i.write(n),n.buffer}save(t){const i=new ye;return i.isofile=this,this.write(i),i.save(t)}getBuffer(){const t=new ye;return t.isofile=this,this.write(t),t}initializeSegmentation(){this.onSegment||$.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.resetTables());const t=new Vs;t.addBox(this.moov.mvhd);for(let i=0;i<this.fragmentedTracks.length;i++){const s=this.getTrackById(this.fragmentedTracks[i].id);if(!s){$.warn("ISOFile",`Track with id ${this.fragmentedTracks[i].id} not found, skipping fragmentation initialization`);continue}t.addBox(s)}return{tracks:t.traks.map((i,s)=>({id:i.tkhd.track_id,user:this.fragmentedTracks[s].user})),buffer:Ge.writeInitializationSegment(this.ftyp,t,this.moov?.mvex?.mehd.fragment_duration)}}resetTables(){this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0;for(let t=0;t<this.moov.traks.length;t++){const i=this.moov.traks[t];i.tkhd.duration=0,i.mdia.mdhd.duration=0;const s=i.mdia.minf.stbl.stco||i.mdia.minf.stbl.co64;s.chunk_offsets=[];const n=i.mdia.minf.stbl.stsc;n.first_chunk=[],n.samples_per_chunk=[],n.sample_description_index=[];const r=i.mdia.minf.stbl.stsz||i.mdia.minf.stbl.stz2;r.sample_sizes=[];const a=i.mdia.minf.stbl.stts;a.sample_counts=[],a.sample_deltas=[];const o=i.mdia.minf.stbl.ctts;o&&(o.sample_counts=[],o.sample_offsets=[]);const l=i.mdia.minf.stbl.stss,d=i.mdia.minf.stbl.boxes.indexOf(l);d!==-1&&(i.mdia.minf.stbl.boxes[d]=void 0)}}static initSampleGroups(t,i,s,n,r){i&&(i.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]);for(let a=0;a<s.length;a++){const o=s[a].grouping_type+"/"+s[a].grouping_type_parameter,l=new xs(s[a].grouping_type,s[a].grouping_type_parameter,s[a]);i&&(i.sample_groups_info[o]=l),t.sample_groups_info[o]||(t.sample_groups_info[o]=l);for(let d=0;d<n.length;d++)n[d].grouping_type===s[a].grouping_type&&(l.description=n[d],l.description.used=!0);if(r)for(let d=0;d<r.length;d++)r[d].grouping_type===s[a].grouping_type&&(l.fragment_description=r[d],l.fragment_description.used=!0,l.is_fragment=!0)}if(i){if(r){for(let a=0;a<r.length;a++)if(!r[a].used&&r[a].version>=2){const o=r[a].grouping_type+"/0",l=new xs(r[a].grouping_type,0);l.is_fragment=!0,i.sample_groups_info[o]||(i.sample_groups_info[o]=l)}}}else for(let a=0;a<n.length;a++)if(!n[a].used&&n[a].version>=2){const o=n[a].grouping_type+"/0",l=new xs(n[a].grouping_type,0);t.sample_groups_info[o]||(t.sample_groups_info[o]=l)}}static setSampleGroupProperties(t,i,s,n){i.sample_groups=[];for(const r in n)if(i.sample_groups[r]={grouping_type:n[r].grouping_type,grouping_type_parameter:n[r].grouping_type_parameter},s>=n[r].last_sample_in_run&&(n[r].last_sample_in_run<0&&(n[r].last_sample_in_run=0),n[r].entry_index++,n[r].entry_index<=n[r].sbgp.entries.length-1&&(n[r].last_sample_in_run+=n[r].sbgp.entries[n[r].entry_index].sample_count)),n[r].entry_index<=n[r].sbgp.entries.length-1?i.sample_groups[r].group_description_index=n[r].sbgp.entries[n[r].entry_index].group_description_index:i.sample_groups[r].group_description_index=-1,i.sample_groups[r].group_description_index!==0){let a;if(n[r].fragment_description?a=n[r].fragment_description:a=n[r].description,i.sample_groups[r].group_description_index>0){let o;i.sample_groups[r].group_description_index>65535?o=(i.sample_groups[r].group_description_index>>16)-1:o=i.sample_groups[r].group_description_index-1,a&&o>=0&&(i.sample_groups[r].description=a.entries[o])}else a&&a.version>=2&&a.default_group_description_index>0&&(i.sample_groups[r].description=a.entries[a.default_group_description_index-1])}}static process_sdtp(t,i,s){i&&(t?(i.is_leading=t.is_leading[s],i.depends_on=t.sample_depends_on[s],i.is_depended_on=t.sample_is_depended_on[s],i.has_redundancy=t.sample_has_redundancy[s]):(i.is_leading=0,i.depends_on=0,i.is_depended_on=0,i.has_redundancy=0))}buildSampleLists(){for(let t=0;t<this.moov.traks.length;t++)this.buildTrakSampleLists(this.moov.traks[t])}buildTrakSampleLists(t){let i,s,n,r,a,o;t.samples=[],t.samples_duration=0,t.samples_size=0;const l=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,d=t.mdia.minf.stbl.stsc,c=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,f=t.mdia.minf.stbl.stts,u=t.mdia.minf.stbl.ctts,h=t.mdia.minf.stbl.stss,m=t.mdia.minf.stbl.stsd,x=t.mdia.minf.stbl.subs,p=t.mdia.minf.stbl.stdp,S=t.mdia.minf.stbl.sbgps,w=t.mdia.minf.stbl.sgpds;let C=-1,U=-1,F=-1,I=-1,P=0,_=0,V=0;if(Ge.initSampleGroups(t,void 0,S,w),!(typeof c>"u")){for(i=0;i<c.sample_sizes.length;i++){const A={number:i,track_id:t.tkhd.track_id,timescale:t.mdia.mdhd.timescale,alreadyRead:0,size:c.sample_sizes[i]};t.samples[i]=A,t.samples_size+=A.size,i===0?(n=1,s=0,A.chunk_index=n,A.chunk_run_index=s,o=d.samples_per_chunk[s],a=0,s+1<d.first_chunk.length?r=d.first_chunk[s+1]-1:r=1/0):i<o?(A.chunk_index=n,A.chunk_run_index=s):(n++,A.chunk_index=n,a=0,n<=r||(s++,s+1<d.first_chunk.length?r=d.first_chunk[s+1]-1:r=1/0),A.chunk_run_index=s,o+=d.samples_per_chunk[s]),A.description_index=d.sample_description_index[A.chunk_run_index]-1,A.description=m.entries[A.description_index],A.offset=l.chunk_offsets[A.chunk_index-1]+a,a+=A.size,i>C&&(U++,C<0&&(C=0),C+=f.sample_counts[U]),i>0?(t.samples[i-1].duration=f.sample_deltas[U],t.samples_duration+=t.samples[i-1].duration,A.dts=t.samples[i-1].dts+t.samples[i-1].duration):A.dts=0,u?(i>=F&&(I++,F<0&&(F=0),F+=u.sample_counts[I]),A.cts=t.samples[i].dts+u.sample_offsets[I]):A.cts=A.dts,h?(i===h.sample_numbers[P]-1?(A.is_sync=!0,P++):(A.is_sync=!1,A.degradation_priority=0),x&&x.entries[_].sample_delta+V===i+1&&(A.subsamples=x.entries[_].subsamples,V+=x.entries[_].sample_delta,_++)):A.is_sync=!0,Ge.process_sdtp(t.mdia.minf.stbl.sdtp,A,A.number),p?A.degradation_priority=p.priority[i]:A.degradation_priority=0,x&&x.entries[_].sample_delta+V===i&&(A.subsamples=x.entries[_].subsamples,V+=x.entries[_].sample_delta),(S.length>0||w.length>0)&&Ge.setSampleGroupProperties(t,A,i,t.sample_groups_info)}i>0&&(t.samples[i-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[i-1].dts,0),t.samples_duration+=t.samples[i-1].duration)}}updateSampleLists(){let t,i,s,n,r;if(this.moov!==void 0)for(;this.lastMoofIndex<this.moofs.length;){const a=this.moofs[this.lastMoofIndex];if(this.lastMoofIndex++,a.type==="moof"){const o=a;for(let l=0;l<o.trafs.length;l++){const d=o.trafs[l],c=this.getTrackById(d.tfhd.track_id),f=this.getTrexById(d.tfhd.track_id);d.tfhd.flags&_i?t=d.tfhd.default_sample_description_index:t=f?f.default_sample_description_index:1,d.tfhd.flags&vi?i=d.tfhd.default_sample_duration:i=f?f.default_sample_duration:0,d.tfhd.flags&wi?s=d.tfhd.default_sample_size:s=f?f.default_sample_size:0,d.tfhd.flags&Si?n=d.tfhd.default_sample_flags:n=f?f.default_sample_flags:0,d.sample_number=0,d.sbgps.length>0&&Ge.initSampleGroups(c,d,d.sbgps,c.mdia.minf.stbl.sgpds,d.sgpds);for(let u=0;u<d.truns.length;u++){const h=d.truns[u];for(let m=0;m<h.sample_count;m++){const x=t-1;let p=n;h.flags&Mt?p=h.sample_flags[m]:m===0&&h.flags&Ii&&(p=h.first_sample_flags);let S=s;h.flags&zt&&(S=h.sample_size[m]),c.samples_size+=S;let w=i;h.flags&Rt&&(w=h.sample_duration[m]),c.samples_duration+=w;let C;c.first_traf_merged||m>0?C=c.samples[c.samples.length-1].dts+c.samples[c.samples.length-1].duration:(d.tfdt?C=d.tfdt.baseMediaDecodeTime:C=0,c.first_traf_merged=!0);let U=C;h.flags&Gt&&(U=C+h.sample_composition_time_offset[m]);const F=!!(d.tfhd.flags&bi),I=!!(d.tfhd.flags&ir),P=!!(h.flags&Nt);let _=0;F?_=d.tfhd.base_data_offset:I||u===0?_=o.start:_=r;let V;u===0&&m===0?P?V=_+h.data_offset:V=_:V=r,r=V+S;const A=d.sample_number;d.sample_number++;const Ee={cts:U,description_index:x,description:c.mdia.minf.stbl.stsd.entries[x],dts:C,duration:w,moof_number:this.lastMoofIndex,number_in_traf:A,number:c.samples.length,offset:V,size:S,timescale:c.mdia.mdhd.timescale,track_id:c.tkhd.track_id,is_sync:!(p>>16&1),is_leading:p>>26&3,depends_on:p>>24&3,is_depended_on:p>>22&3,has_redundancy:p>>20&3,degradation_priority:p&65535};d.first_sample_index=c.samples.length,c.samples.push(Ee),(d.sbgps.length>0||d.sgpds.length>0||c.mdia.minf.stbl.sbgps.length>0||c.mdia.minf.stbl.sgpds.length>0)&&Ge.setSampleGroupProperties(c,Ee,Ee.number_in_traf,d.sample_groups_info)}}if(d.subs){c.has_fragment_subsamples=!0;let u=d.first_sample_index;for(let h=0;h<d.subs.entries.length;h++){u+=d.subs.entries[h].sample_delta;const m=c.samples[u-1];m.subsamples=d.subs.entries[h].subsamples}}}}}}getSample(t,i){const s=t.samples[i];if(this.moov){if(!s.data)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.samplesDataSize+=s.size,$.debug("ISOFile","Allocating sample #"+i+" on track #"+t.tkhd.track_id+" of size "+s.size+" (total: "+this.samplesDataSize+")");else if(s.alreadyRead===s.size)return s;for(;;){let n=this.stream,r=n.findPosition(!0,s.offset+s.alreadyRead,!1),a,o;if(r>-1)a=n.buffers[r],o=a.fileStart;else for(const l of this.mdats){if(!l.stream){$.debug("ISOFile","mdat stream not yet fully read for #"+this.mdats.indexOf(l)+" mdat");continue}if(r=l.stream.findPosition(!0,s.offset+s.alreadyRead-l.start-l.hdr_size,!1),r>-1){n=l.stream,a=l.stream.buffers[r],o=l.start+l.hdr_size+a.fileStart;break}}if(a){const l=a.byteLength-(s.offset+s.alreadyRead-o);if(s.size-s.alreadyRead<=l)return $.debug("ISOFile","Getting sample #"+i+" data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-o)+" read size: "+(s.size-s.alreadyRead)+" full size: "+s.size+")"),ye.memcpy(s.data.buffer,s.alreadyRead,a,s.offset+s.alreadyRead-o,s.size-s.alreadyRead),a.usedBytes+=s.size-s.alreadyRead,n.logBufferLevel(),s.alreadyRead=s.size,s;if(l===0)return;$.debug("ISOFile","Getting sample #"+i+" partial data (alreadyRead: "+s.alreadyRead+" offset: "+(s.offset+s.alreadyRead-o)+" read size: "+l+" full size: "+s.size+")"),ye.memcpy(s.data.buffer,s.alreadyRead,a,s.offset+s.alreadyRead-o,l),s.alreadyRead+=l,a.usedBytes+=l,n.logBufferLevel()}else return}}}releaseSample(t,i){const s=t.samples[i];return s.data?(this.samplesDataSize-=s.size,s.data=void 0,s.alreadyRead=0,s.size):0}getAllocatedSampleDataSize(){return this.samplesDataSize}getCodecs(){let t="";for(let i=0;i<this.moov.traks.length;i++){const s=this.moov.traks[i];i>0&&(t+=","),t+=s.mdia.minf.stbl.stsd.entries[0].getCodec()}return t}getTrexById(t){if(!(!this.moov||!this.moov.mvex))for(let i=0;i<this.moov.mvex.trexs.length;i++){const s=this.moov.mvex.trexs[i];if(s.track_id===t)return s}}getTrackById(t){if(this.moov)for(let i=0;i<this.moov.traks.length;i++){const s=this.moov.traks[i];if(s.tkhd.track_id===t)return s}}flattenItemInfo(){const t=this.items,i=this.entity_groups,s=this.meta;if(!(!s||!s.hdlr||!s.iinf)){for(let n=0;n<s.iinf.item_infos.length;n++){const r=s.iinf.item_infos[n].item_ID;t[r]={id:r,name:s.iinf.item_infos[n].item_name,ref_to:[],content_type:s.iinf.item_infos[n].content_type,content_encoding:s.iinf.item_infos[n].content_encoding,item_uri_type:s.iinf.item_infos[n].item_uri_type,type:s.iinf.item_infos[n].item_type?s.iinf.item_infos[n].item_type:"mime",protection:s.iinf.item_infos[n].item_protection_index>0?s.ipro.protections[s.iinf.item_infos[n].item_protection_index-1]:void 0}}if(s.grpl)for(let n=0;n<s.grpl.boxes.length;n++){const r=s.grpl.boxes[n];i[r.group_id]={id:r.group_id,entity_ids:r.entity_ids,type:r.type}}if(s.iloc)for(let n=0;n<s.iloc.items.length;n++){const r=s.iloc.items[n],a=t[r.item_ID];r.data_reference_index!==0&&($.warn("Item storage with reference to other files: not supported"),a.source=s.dinf.boxes[r.data_reference_index-1]),a.extents=[],a.size=0;for(let o=0;o<r.extents.length;o++)a.extents[o]={offset:r.extents[o].extent_offset+r.base_offset,length:r.extents[o].extent_length,alreadyRead:0},r.construction_method===1&&(a.extents[o].offset+=s.idat.start+s.idat.hdr_size),a.size+=a.extents[o].length}if(s.pitm&&(t[s.pitm.item_id].primary=!0),s.iref)for(let n=0;n<s.iref.references.length;n++){const r=s.iref.references[n];for(let a=0;a<r.references.length;a++)t[r.from_item_ID].ref_to.push({type:r.type,id:r.references[a]})}if(s.iprp)for(let n=0;n<s.iprp.ipmas.length;n++){const r=s.iprp.ipmas[n];for(let a=0;a<r.associations.length;a++){const o=r.associations[a],l=t[o.id]??i[o.id];if(l){l.properties===void 0&&(l.properties={boxes:[]});for(let d=0;d<o.props.length;d++){const c=o.props[d];if(c.property_index>0&&c.property_index-1<s.iprp.ipco.boxes.length){const f=s.iprp.ipco.boxes[c.property_index-1];l.properties[f.type]=f,l.properties.boxes.push(f)}}}}}}}getItem(t){if(!this.meta)return;const i=this.items[t];if(!i.data&&i.size)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.itemsDataSize+=i.size,$.debug("ISOFile","Allocating item #"+t+" of size "+i.size+" (total: "+this.itemsDataSize+")");else if(i.alreadyRead===i.size)return i;for(let s=0;s<i.extents.length;s++){const n=i.extents[s];if(n.alreadyRead!==n.length){const r=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(r>-1){const a=this.stream.buffers[r],o=a.byteLength-(n.offset+n.alreadyRead-a.fileStart);if(n.length-n.alreadyRead<=o)$.debug("ISOFile","Getting item #"+t+" extent #"+s+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-a.fileStart)+" read size: "+(n.length-n.alreadyRead)+" full extent size: "+n.length+" full item size: "+i.size+")"),ye.memcpy(i.data.buffer,i.alreadyRead,a,n.offset+n.alreadyRead-a.fileStart,n.length-n.alreadyRead),(!this.parsingMdat||this.discardMdatData)&&(a.usedBytes+=n.length-n.alreadyRead),this.stream.logBufferLevel(),i.alreadyRead+=n.length-n.alreadyRead,n.alreadyRead=n.length;else{$.debug("ISOFile","Getting item #"+t+" extent #"+s+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-a.fileStart)+" read size: "+o+" full extent size: "+n.length+" full item size: "+i.size+")"),ye.memcpy(i.data.buffer,i.alreadyRead,a,n.offset+n.alreadyRead-a.fileStart,o),n.alreadyRead+=o,i.alreadyRead+=o,(!this.parsingMdat||this.discardMdatData)&&(a.usedBytes+=o),this.stream.logBufferLevel();return}}else return}}if(i.alreadyRead===i.size)return i}releaseItem(t){const i=this.items[t];if(i.data){this.itemsDataSize-=i.size,i.data=void 0,i.alreadyRead=0;for(let s=0;s<i.extents.length;s++){const n=i.extents[s];n.alreadyRead=0}return i.size}else return 0}processItems(t){for(const i in this.items){const s=this.items[i];this.getItem(s.id),t&&!s.sent&&(t(s),s.sent=!0,s.data=void 0)}}hasItem(t){for(const i in this.items){const s=this.items[i];if(s.name===t)return s.id}return-1}getMetaHandler(){if(this.meta)return this.meta.hdlr.handler}getPrimaryItem(){if(this.meta&&this.meta.pitm)return this.getItem(this.meta.pitm.item_id)}itemToFragmentedTrackFile({itemId:t}={}){let i;if(t?i=this.getItem(t):i=this.getPrimaryItem(),!i)return;const s=new Ge;s.discardMdatData=!1;const n={type:i.type,description_boxes:i.properties.boxes};i.properties.ispe&&(n.width=i.properties.ispe.image_width,n.height=i.properties.ispe.image_height);const r=s.addTrack(n);if(r)return s.addSample(r,i.data),s}processIncompleteBox(t){if(t.type==="mdat"){const i=new Fi(t.size);return this.parsingMdat=i,this.boxes.push(i),this.mdats.push(i),i.start=t.start,i.hdr_size=t.hdr_size,i.original_size=t.original_size,this.stream.addUsedBytes(i.hdr_size),this.lastBoxStartPosition=i.start+i.size,this.stream.seek(i.start+i.size,!1,this.discardMdatData)?(this.transferMdatData(),this.parsingMdat=void 0,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=i.start+i.size,!1)}else return t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),(this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1)?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1)}hasIncompleteMdat(){return this.parsingMdat!==void 0}transferMdatData(t){const i=t??this.parsingMdat;if(this.discardMdatData){$.debug("ISOFile","Discarding 'mdat' data, not transferring it to the mdat box stream");return}if(!i){$.warn("ISOFile","Cannot transfer 'mdat' data, no mdat box is being parsed");return}const s=this.stream.findPosition(!0,i.start+i.hdr_size,!1),n=this.stream.findPosition(!0,i.start+i.size,!1);if(s===-1||n===-1){console.trace(i,s,n),$.warn("ISOFile","Cannot transfer 'mdat' data, start or end buffer not found");return}i.stream=new Ti;for(let r=s;r<=n;r++){const a=this.stream.buffers[r],o=r===s?i.start+i.hdr_size-a.fileStart:0,l=r===n?i.start+i.size-a.fileStart:a.byteLength;if(l>o){$.debug("ISOFile","Transferring 'mdat' data from buffer #"+r+" ("+o+" to "+l+")");const d=l-o,c=new Ve(d),f=i.stream.getAbsoluteEndPosition();ye.memcpy(c,0,a,o,d),c.fileStart=f,i.stream.insertBuffer(c),a.usedBytes+=d}}}processIncompleteMdat(){const t=this.parsingMdat;return this.stream.seek(t.start+t.size,!1,this.discardMdatData)?($.debug("ISOFile","Found 'mdat' end in buffered data"),this.transferMdatData(),this.parsingMdat=void 0,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)}restoreParsePosition(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)}saveParsePosition(){this.lastBoxStartPosition=this.stream.getPosition()}updateUsedBytes(t,i){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))}addBox(t){return v.prototype.addBox.call(this,t)}init(t={}){const i=this.addBox(new ba);i.major_brand=t.brands&&t.brands[0]||"iso4",i.minor_version=0,i.compatible_brands=t.brands||["iso4"];const s=this.addBox(new Vs);s.addBox(new Ws);const n=s.addBox(new Ta);return n.timescale=t.timescale||600,n.rate=t.rate||65536,n.creation_time=0,n.modification_time=0,n.duration=t.duration||0,n.volume=t.width?0:256,n.matrix=[65536,0,0,0,65536,0,0,0,1073741824],n.next_track_id=1,this}addTrack(t={}){this.moov||this.init(t);const i=t||{};i.width=i.width||320,i.height=i.height||320,i.id=i.id||this.moov.mvhd.next_track_id,i.type=i.type||"avc1";const s=this.moov.addBox(new ca);this.moov.mvhd.next_track_id=i.id+1;const n=s.addBox(new za);n.flags=Gd|Vd|Wd,n.creation_time=0,n.modification_time=0,n.track_id=i.id,n.duration=i.duration||0,n.layer=i.layer||0,n.alternate_group=0,n.volume=1,n.matrix=[65536,0,0,0,65536,0,0,0,1073741824],n.width=i.width<<16,n.height=i.height<<16;const r=s.addBox(new ua),a=r.addBox(new wa);a.creation_time=0,a.modification_time=0,a.timescale=i.timescale||1,a.duration=i.media_duration||0,a.language=i.language||"und";const o=r.addBox(new _a);o.handler=i.hdlr||"vide",o.name=i.name||"Track created with MP4Box.js";const l=r.addBox(new ya);l.extended_language=i.language||"fr-FR";const d=r.addBox(new ha),c=me.sampleEntry[i.type];if(!c)return;const f=new c;if(f.data_reference_index=1,f instanceof H){const I=f,P=d.addBox(new Va);P.graphicsmode=0,P.opcolor=[0,0,0],I.width=i.width,I.height=i.height,I.horizresolution=72<<16,I.vertresolution=72<<16,I.frame_count=1,I.compressorname=i.type+" Compressor",I.depth=24,i.avcDecoderConfigRecord?I.addBox(new da(i.avcDecoderConfigRecord.byteLength)).parse(new ye(i.avcDecoderConfigRecord)):i.hevcDecoderConfigRecord&&I.addBox(new va(i.hevcDecoderConfigRecord.byteLength)).parse(new ye(i.hevcDecoderConfigRecord))}else if(f instanceof ge){const I=f,P=d.addBox(new ka);P.balance=i.balance||0,I.channel_count=i.channel_count||2,I.samplesize=i.samplesize||16,I.samplerate=i.samplerate||65536}else f instanceof or?d.addBox(new fa):f instanceof lt?(d.addBox(new Aa),f instanceof Ua&&(f.namespace=i.namespace||"nonamespace",f.schema_location=i.schema_location||"",f.auxiliary_mime_types=i.auxiliary_mime_types||"")):f instanceof vt?d.addBox(new Ci):f instanceof an?d.addBox(new Ci):d.addBox(new Ci);i.description&&f.addBox.call(f,i.description),i.description_boxes&&i.description_boxes.forEach(function(I){f.addBox.call(f,I)});const h=d.addBox(new pa).addBox(new xa),m=new Ga;m.flags=1,h.addEntry(m);const x=d.addBox(new ma);x.addBox(new Pa).addEntry(f);const S=x.addBox(new La);S.sample_counts=[],S.sample_deltas=[];const w=x.addBox(new Oa);w.first_chunk=[],w.samples_per_chunk=[],w.sample_description_index=[];const C=x.addBox(new Ba);C.chunk_offsets=[];const U=x.addBox(new Da);U.sample_sizes=[];const F=this.moov.mvex.addBox(new Hs);return F.track_id=i.id,F.default_sample_description_index=i.default_sample_description_index||1,F.default_sample_duration=i.default_sample_duration||0,F.default_sample_size=i.default_sample_size||0,F.default_sample_flags=i.default_sample_flags||0,this.buildTrakSampleLists(s),i.id}addSample(t,i,{sample_description_index:s,duration:n=1,cts:r=0,dts:a=0,is_sync:o=!1,is_leading:l=0,depends_on:d=0,is_depended_on:c=0,has_redundancy:f=0,degradation_priority:u=0,subsamples:h,offset:m=0}={}){const x=this.getTrackById(t);if(x===void 0)return;const p=s?s-1:0,S={number:x.samples.length,track_id:x.tkhd.track_id,timescale:x.mdia.mdhd.timescale,description_index:p,description:x.mdia.minf.stbl.stsd.entries[p],data:i,size:i.byteLength,alreadyRead:i.byteLength,duration:n,cts:r,dts:a,is_sync:o,is_leading:l,depends_on:d,is_depended_on:c,has_redundancy:f,degradation_priority:u,offset:m,subsamples:h};x.samples.push(S),x.samples_size+=S.size,x.samples_duration+=S.duration,x.first_dts===void 0&&(x.first_dts=a),this.processSamples();const w=this.addBox(this.createMoof([S]));w.computeSize(),w.trafs[0].truns[0].data_offset=w.size+8;const C=this.addBox(new Fi);return C.data=new Uint8Array(i),S}createMoof(t){if(t.length===0)return;if(t.some(c=>c.track_id!==t[0].track_id))throw new Error("Cannot create moof for samples from different tracks: "+t.map(c=>c.track_id).join(", "));const i=t[0].track_id,s=this.getTrackById(i);if(!s)throw new Error("Cannot create moof for non-existing track: "+i);const n=new $a,r=n.addBox(new Ea);r.sequence_number=++this.nextMoofNumber;const a=n.addBox(new ga),o=a.addBox(new Ra);o.track_id=i,o.flags=ir;const l=a.addBox(new Na);l.baseMediaDecodeTime=t[0].dts-(s.first_dts||0);const d=a.addBox(new Ma);d.flags=Nt|Rt|zt|Mt|Gt,d.data_offset=0,d.first_sample_flags=0,d.sample_count=t.length;for(const c of t){let f=0;c.is_sync?f=1<<25:f=65536,d.sample_duration.push(c.duration),d.sample_size.push(c.size),d.sample_flags.push(f),d.sample_composition_time_offset.push(c.cts-c.dts)}return n}print(t){t.indent="";for(let i=0;i<this.boxes.length;i++)this.boxes[i]&&this.boxes[i].print(t)}};function jc(e=!1,t){return new qc(t,!e)}var Wa={};ra(Wa,{Descriptor:()=>ht,ES_Descriptor:()=>Xa,MPEG4DescriptorParser:()=>Zc});var Ha=3,Wi=4,on=5,qa=6,ht=class ja{constructor(t,i){this.tag=t,this.size=i,this.descs=[]}parse(t){this.data=t.readUint8Array(this.size)}findDescriptor(t){for(let i=0;i<this.descs.length;i++)if(this.descs[i].tag===t)return this.descs[i]}parseOneDescriptor(t){let i=0;const s=t.readUint8();let n=t.readUint8();for(;n&128;)i=(i<<7)+(n&127),n=t.readUint8();i=(i<<7)+(n&127),$.debug("Descriptor","Found "+(Ui[s]||"Descriptor "+s)+", size "+i+" at position "+t.getPosition());const r=Ui[s]?new Jc[Ui[s]](i):new ja(i);return r.parse(t),r}parseRemainingDescriptors(t){const i=t.getPosition();for(;t.getPosition()<i+this.size;){const s=this.parseOneDescriptor?.(t);this.descs.push(s)}}},Xa=class extends ht{constructor(e){super(Ha,e)}parse(e){if(this.ES_ID=e.readUint16(),this.flags=e.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=e.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){const t=e.readUint8();this.URL=e.readString(t),this.size-=t+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=e.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(e)}getOTI(){const e=this.findDescriptor(Wi);return e?e.oti:0}getAudioConfig(){const e=this.findDescriptor(Wi);if(!e)return;const t=e.findDescriptor(on);if(t&&t.data){let i=(t.data[0]&248)>>3;return i===31&&t.data.length>=2&&(i=32+((t.data[0]&7)<<3)+((t.data[1]&224)>>5)),i}}},Xc=class extends ht{constructor(e){super(Wi,e)}parse(e){this.oti=e.readUint8(),this.streamType=e.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=e.readUint24(),this.maxBitrate=e.readUint32(),this.avgBitrate=e.readUint32(),this.size-=13,this.parseRemainingDescriptors(e)}},Yc=class extends ht{constructor(e){super(on,e)}},Kc=class extends ht{constructor(e){super(qa,e)}},Jc={Descriptor:ht,ES_Descriptor:Xa,DecoderConfigDescriptor:Xc,DecoderSpecificInfo:Yc,SLConfigDescriptor:Kc},Ui={[Ha]:"ES_Descriptor",[Wi]:"DecoderConfigDescriptor",[on]:"DecoderSpecificInfo",[qa]:"SLConfigDescriptor"},Zc=class{constructor(){this.parseOneDescriptor=ht.prototype.parseOneDescriptor}getDescriptorName(e){return Ui[e]}},Ya={};ra(Ya,{CoLLBox:()=>cu,ItemContentIDPropertyBox:()=>Rp,OpusSampleEntry:()=>Sc,SmDmBox:()=>Lh,a1lxBox:()=>Qc,a1opBox:()=>eu,ac_3SampleEntry:()=>_c,ac_4SampleEntry:()=>vc,aebrBox:()=>Cu,afbrBox:()=>Uu,albcBox:()=>ku,alstSampleGroupEntry:()=>pp,altrBox:()=>Bu,auxCBox:()=>tu,av01SampleEntry:()=>Kf,av1CBox:()=>Mf,avc1SampleEntry:()=>qf,avc2SampleEntry:()=>jf,avc3SampleEntry:()=>Xf,avc4SampleEntry:()=>Yf,avcCBox:()=>da,avllSampleGroupEntry:()=>mp,avs3SampleEntry:()=>hc,avssSampleGroupEntry:()=>$p,brstBox:()=>Au,btrtBox:()=>iu,bxmlBox:()=>cf,ccstBox:()=>su,cdefBox:()=>nu,clapBox:()=>ru,clefBox:()=>_h,clliBox:()=>au,cmexBox:()=>ou,cminBox:()=>lu,cmpdBox:()=>du,co64Box:()=>fu,colrBox:()=>Hf,coviBox:()=>pu,cprtBox:()=>mu,cschBox:()=>$u,cslgBox:()=>gu,cttsBox:()=>xu,dOpsBox:()=>Iu,dac3Box:()=>yu,dataBox:()=>Pt,dav1SampleEntry:()=>Jf,dec3Box:()=>bu,dfLaBox:()=>_u,dimmBox:()=>vu,dinfBox:()=>pa,dmax:()=>wu,dmedBox:()=>Su,dobrBox:()=>Ou,drefBox:()=>xa,drepBox:()=>Eu,dtrtSampleGroupEntry:()=>gp,dvh1SampleEntry:()=>rc,dvheSampleEntry:()=>ac,ec_3SampleEntry:()=>wc,edtsBox:()=>hf,elngBox:()=>ya,elstBox:()=>Tu,emsgBox:()=>Fu,encaSampleEntry:()=>kc,encmSampleEntry:()=>Dc,encsSampleEntry:()=>Ac,enctSampleEntry:()=>Pc,encuSampleEntry:()=>Bc,encvSampleEntry:()=>Uc,enofBox:()=>wh,eqivBox:()=>Pu,esdsBox:()=>Gf,etypBox:()=>Uf,fLaCSampleEntry:()=>Cc,favcBox:()=>Du,fielBox:()=>qu,fobrBox:()=>Lu,freeBox:()=>of,frmaBox:()=>ju,ftypBox:()=>ba,grplBox:()=>Ff,hdlrBox:()=>_a,hev1SampleEntry:()=>ec,hev2SampleEntry:()=>tc,hinfBox:()=>xf,hmhdBox:()=>fa,hntiBox:()=>gf,hvc1SampleEntry:()=>Zf,hvc2SampleEntry:()=>Qf,hvcCBox:()=>va,hvt1SampleEntry:()=>ic,iaugBox:()=>Nu,idatBox:()=>af,iinfBox:()=>Af,ilocBox:()=>Of,ilstBox:()=>Sh,imirBox:()=>Xu,infeBox:()=>Bf,iodsBox:()=>df,ipcoBox:()=>Tf,ipmaBox:()=>Yu,iproBox:()=>uf,iprpBox:()=>Ef,irefBox:()=>Df,irotBox:()=>Ku,ispeBox:()=>Ju,itaiBox:()=>Zu,j2kHBox:()=>Cf,j2kiSampleEntry:()=>pc,keysBox:()=>Ih,kindBox:()=>Qu,levaBox:()=>eh,lhe1SampleEntry:()=>sc,lhv1SampleEntry:()=>nc,lhvCBox:()=>th,lselBox:()=>ih,m4aeSampleEntry:()=>bc,maxrBox:()=>sh,mdatBox:()=>Fi,mdcvBox:()=>nh,mdhdBox:()=>wa,mdiaBox:()=>ua,mecoBox:()=>$f,mehdBox:()=>Sa,metaBox:()=>Nf,mettSampleEntry:()=>Rf,metxSampleEntry:()=>zf,mfhdBox:()=>Ea,mfraBox:()=>mf,mfroBox:()=>rh,mha1SampleEntry:()=>Ic,mha2SampleEntry:()=>Ec,mhm1SampleEntry:()=>Tc,mhm2SampleEntry:()=>Fc,minfBox:()=>ha,mjp2SampleEntry:()=>mc,mjpgSampleEntry:()=>$c,moofBox:()=>$a,moovBox:()=>Vs,mp4aSampleEntry:()=>yc,mp4sSampleEntry:()=>Oc,mp4vSampleEntry:()=>xc,mskCBox:()=>ah,msrcTrackGroupTypeBox:()=>ip,mvexBox:()=>Ws,mvhdBox:()=>Ta,mvifSampleGroupEntry:()=>xp,nmhdBox:()=>Ci,npckBox:()=>oh,numpBox:()=>lh,padbBox:()=>fh,panoBox:()=>Ru,paspBox:()=>ch,paylBox:()=>uh,paytBox:()=>hh,pdinBox:()=>ph,piffLsmBox:()=>Ap,piffPsshBox:()=>Op,piffSencBox:()=>Pp,piffTencBox:()=>Dp,piffTfrfBox:()=>Lp,piffTfxdBox:()=>Np,pitmBox:()=>Lf,pixiBox:()=>mh,pmaxBox:()=>$h,povdBox:()=>kf,prdiBox:()=>gh,prfrBox:()=>xh,prftBox:()=>yh,prgrBox:()=>Wu,profBox:()=>Eh,prolSampleGroupEntry:()=>yp,psshBox:()=>bh,pymdBox:()=>Hu,rapSampleGroupEntry:()=>bp,rashSampleGroupEntry:()=>_p,resvSampleEntry:()=>Lc,rinfBox:()=>vf,rollSampleGroupEntry:()=>vp,rtp_Box:()=>Ch,saioBox:()=>Uh,saizBox:()=>kh,sbgpBox:()=>Gc,sbpmBox:()=>Ah,sbttSampleEntry:()=>Nc,schiBox:()=>wf,schmBox:()=>Oh,scifSampleGroupEntry:()=>wp,scnmSampleGroupEntry:()=>Sp,sdp_Box:()=>Ph,sdtpBox:()=>Vc,seigSampleGroupEntry:()=>Ip,sencBox:()=>Dh,sgpdBox:()=>Wc,sidxBox:()=>Hc,sinfBox:()=>_f,skipBox:()=>lf,slidBox:()=>zu,smhdBox:()=>ka,ssixBox:()=>Nh,stblBox:()=>ma,stcoBox:()=>Ba,stdpBox:()=>Rh,sterBox:()=>Mu,sthdBox:()=>Aa,stppSampleEntry:()=>Ua,strdBox:()=>bf,striBox:()=>zh,strkBox:()=>yf,stsaSampleGroupEntry:()=>Ep,stscBox:()=>Oa,stsdBox:()=>Pa,stsgBox:()=>Mh,stshBox:()=>Gh,stssBox:()=>Vh,stszBox:()=>Da,sttsBox:()=>La,stviBox:()=>Wh,stxtSampleEntry:()=>Rc,stypBox:()=>Hh,stz2Box:()=>qh,subsBox:()=>jh,syncSampleGroupEntry:()=>Tp,taicBox:()=>Xh,taptBox:()=>Th,teleSampleGroupEntry:()=>Fp,tencBox:()=>Yh,tfdtBox:()=>Na,tfhdBox:()=>Ra,tfraBox:()=>Kh,tkhdBox:()=>za,tmaxBox:()=>Jh,tminBox:()=>Zh,totlBox:()=>Qh,tpayBox:()=>ep,tpylBox:()=>tp,trafBox:()=>ga,trakBox:()=>ca,trefBox:()=>sp,trepBox:()=>np,trexBox:()=>Hs,trgrBox:()=>Sf,trpyBox:()=>rp,trunBox:()=>Ma,tsasSampleGroupEntry:()=>Cp,tsclSampleGroupEntry:()=>Up,tselBox:()=>ap,tsynBox:()=>Gu,tx3gSampleEntry:()=>zc,txtcBox:()=>op,tycoBox:()=>lp,udesBox:()=>dp,udtaBox:()=>If,uncCBox:()=>fp,uncvSampleEntry:()=>gc,urlBox:()=>Ga,urnBox:()=>cp,viprSampleGroupEntry:()=>kp,vmhdBox:()=>Va,vp08SampleEntry:()=>cc,vp09SampleEntry:()=>uc,vpcCBox:()=>Vf,vttCBox:()=>up,vttcBox:()=>pf,vvc1SampleEntry:()=>oc,vvcCBox:()=>Wf,vvcNSampleEntry:()=>fc,vvi1SampleEntry:()=>lc,vvnCBox:()=>hp,vvs1SampleEntry:()=>dc,waveBox:()=>Fh,wbbrBox:()=>Vu,wvttSampleEntry:()=>Mc,xmlBox:()=>ff});var Qc=class extends v{constructor(){super(...arguments),this.box_name="AV1LayeredImageIndexingProperty"}static{this.fourcc="a1lx"}parse(e){const i=((e.readUint8()&1&1)+1)*16;this.layer_size=[];for(let s=0;s<3;s++)i===16?this.layer_size[s]=e.readUint16():this.layer_size[s]=e.readUint32()}},eu=class extends v{constructor(){super(...arguments),this.box_name="OperatingPointSelectorProperty"}static{this.fourcc="a1op"}parse(e){this.op_index=e.readUint8()}},tu=class extends y{constructor(){super(...arguments),this.box_name="AuxiliaryTypeProperty"}static{this.fourcc="auxC"}parse(e){this.parseFullHeader(e),this.aux_type=e.readCString();const t=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=e.readUint8Array(t)}},iu=class extends v{constructor(){super(...arguments),this.box_name="BitRateBox"}static{this.fourcc="btrt"}parse(e){this.bufferSizeDB=e.readUint32(),this.maxBitrate=e.readUint32(),this.avgBitrate=e.readUint32()}},su=class extends y{constructor(){super(...arguments),this.box_name="CodingConstraintsBox"}static{this.fourcc="ccst"}parse(e){this.parseFullHeader(e);const t=e.readUint8();this.all_ref_pics_intra=(t&128)===128,this.intra_pred_used=(t&64)===64,this.max_ref_per_pic=(t&63)>>2,e.readUint24()}},nu=class extends v{constructor(){super(...arguments),this.box_name="ComponentDefinitionBox"}static{this.fourcc="cdef"}parse(e){this.channel_count=e.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[];for(let t=0;t<this.channel_count;t++)this.channel_indexes.push(e.readUint16()),this.channel_types.push(e.readUint16()),this.channel_associations.push(e.readUint16())}},ru=class extends v{constructor(){super(...arguments),this.box_name="CleanApertureBox"}static{this.fourcc="clap"}parse(e){this.cleanApertureWidthN=e.readUint32(),this.cleanApertureWidthD=e.readUint32(),this.cleanApertureHeightN=e.readUint32(),this.cleanApertureHeightD=e.readUint32(),this.horizOffN=e.readUint32(),this.horizOffD=e.readUint32(),this.vertOffN=e.readUint32(),this.vertOffD=e.readUint32()}},au=class extends v{constructor(){super(...arguments),this.box_name="ContentLightLevelBox"}static{this.fourcc="clli"}parse(e){this.max_content_light_level=e.readUint16(),this.max_pic_average_light_level=e.readUint16()}},ou=class extends v{constructor(){super(...arguments),this.box_name="CameraExtrinsicMatrixProperty"}static{this.fourcc="cmex"}parse(e){this.flags&1&&(this.pos_x=e.readInt32()),this.flags&2&&(this.pos_y=e.readInt32()),this.flags&4&&(this.pos_z=e.readInt32()),this.flags&8&&(this.version===0?this.flags&16?(this.quat_x=e.readInt32(),this.quat_y=e.readInt32(),this.quat_z=e.readInt32()):(this.quat_x=e.readInt16(),this.quat_y=e.readInt16(),this.quat_z=e.readInt16()):this.version),this.flags&32&&(this.id=e.readUint32())}},lu=class extends v{constructor(){super(...arguments),this.box_name="CameraIntrinsicMatrixProperty"}static{this.fourcc="cmin"}parse(e){this.focal_length_x=e.readInt32(),this.principal_point_x=e.readInt32(),this.principal_point_y=e.readInt32(),this.flags&1&&(this.focal_length_y=e.readInt32(),this.skew_factor=e.readInt32())}},du=class extends v{constructor(){super(...arguments),this.box_name="ComponentDefinitionBox"}static{this.fourcc="cmpd"}parse(e){this.component_count=e.readUint32(),this.component_types=[],this.component_type_urls=[];for(let t=0;t<this.component_count;t++){const i=e.readUint16();this.component_types.push(i),i>=32768&&this.component_type_urls.push(e.readCString())}}},fu=class extends y{constructor(){super(...arguments),this.box_name="ChunkLargeOffsetBox"}static{this.fourcc="co64"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.chunk_offsets=[],this.version===0)for(let i=0;i<t;i++)this.chunk_offsets.push(e.readUint64())}write(e){this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length);for(let t=0;t<this.chunk_offsets.length;t++)e.writeUint64(this.chunk_offsets[t])}},cu=class extends y{constructor(){super(...arguments),this.box_name="ContentLightLevelBox"}static{this.fourcc="CoLL"}parse(e){this.parseFullHeader(e),this.maxCLL=e.readUint16(),this.maxFALL=e.readUint16()}},uu=class{toString(){let e="centre_azimuth: ";return e+=this.centre_azimuth,e+=" (",e+=this.centre_azimuth*2**-16,e+="Â°), centre_elevation: ",e+=this.centre_elevation,e+=" (",e+=this.centre_elevation*2**-16,e+="Â°), centre_tilt: ",e+=this.centre_tilt,e+=" (",e+=this.centre_tilt*2**-16,e+="Â°)",this.range_included_flag&&(e+=", azimuth_range: ",e+=this.azimuth_range,e+=" (",e+=this.azimuth_range*2**-16,e+="Â°), elevation_range: ",e+=this.elevation_range,e+=" (",e+=this.elevation_range*2**-16,e+="Â°)"),this.interpolate_included_flag&&(e+=", interpolate: ",e+=this.interpolate),e}},hu=class{toString(){let e="";return this.view_idc&&(e+="view_idc: ",e+=this.view_idc,e+=", "),e+="sphere_region: {",e+=this.sphere_region,e+="}",e}},pu=class extends y{constructor(){super(...arguments),this.box_name="CoverageInformationBox"}static{this.fourcc="covi"}parse(e){this.parseFullHeader(e),this.coverage_shape_type=e.readUint8();const t=e.readUint8(),i=e.readInt8(),s=i&128;s&&(this.default_view_idc=(i&96)>>5),this.coverage_regions=new Array;for(let n=0;n<t;n++){const r=new hu;s&&(r.view_idc=e.readUint8()>>6),r.sphere_region=this.parseSphereRegion(e,!0,!0),this.coverage_regions.push(r)}}parseSphereRegion(e,t,i){const s=new uu;return s.centre_azimuth=e.readInt32(),s.centre_elevation=e.readInt32(),s.centre_tilt=e.readInt32(),s.range_included_flag=t,t&&(s.azimuth_range=e.readUint32(),s.elevation_range=e.readUint32()),s.interpolate_included_flag=i,i&&(s.interpolate=(e.readUint8()&128)===128),s}},mu=class extends y{constructor(){super(...arguments),this.box_name="CopyrightBox"}static{this.fourcc="cprt"}parse(e){this.parseFullHeader(e),this.parseLanguage(e),this.notice=e.readCString()}},$u=class extends y{constructor(){super(...arguments),this.box_name="CompatibleSchemeTypeBox"}static{this.fourcc="csch"}parse(e){this.parseFullHeader(e),this.scheme_type=e.readString(4),this.scheme_version=e.readUint32(),this.flags&1&&(this.scheme_uri=e.readCString())}},Bt=2147483647,gu=class extends y{constructor(){super(...arguments),this.box_name="CompositionToDecodeBox"}static{this.fourcc="cslg"}parse(e){this.parseFullHeader(e),this.version===0?(this.compositionToDTSShift=e.readInt32(),this.leastDecodeToDisplayDelta=e.readInt32(),this.greatestDecodeToDisplayDelta=e.readInt32(),this.compositionStartTime=e.readInt32(),this.compositionEndTime=e.readInt32()):this.version===1&&(this.compositionToDTSShift=e.readInt64(),this.leastDecodeToDisplayDelta=e.readInt64(),this.greatestDecodeToDisplayDelta=e.readInt64(),this.compositionStartTime=e.readInt64(),this.compositionEndTime=e.readInt64())}write(e){this.version=0,(this.compositionToDTSShift>Bt||this.leastDecodeToDisplayDelta>Bt||this.greatestDecodeToDisplayDelta>Bt||this.compositionStartTime>Bt||this.compositionEndTime>Bt)&&(this.version=1),this.flags=0,this.version===0?(this.size=4*5,this.writeHeader(e),e.writeInt32(this.compositionToDTSShift),e.writeInt32(this.leastDecodeToDisplayDelta),e.writeInt32(this.greatestDecodeToDisplayDelta),e.writeInt32(this.compositionStartTime),e.writeInt32(this.compositionEndTime)):this.version===1&&(this.size=8*5,this.writeHeader(e),e.writeInt64(this.compositionToDTSShift),e.writeInt64(this.leastDecodeToDisplayDelta),e.writeInt64(this.greatestDecodeToDisplayDelta),e.writeInt64(this.compositionStartTime),e.writeInt64(this.compositionEndTime))}},xu=class extends y{constructor(){super(...arguments),this.box_name="CompositionOffsetBox"}static{this.fourcc="ctts"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.sample_counts=[],this.sample_offsets=[],this.version===0)for(let i=0;i<t;i++){this.sample_counts.push(e.readUint32());const s=e.readInt32();s<0&&$.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(this.version===1)for(let i=0;i<t;i++)this.sample_counts.push(e.readUint32()),this.sample_offsets.push(e.readInt32())}write(e){this.version=this.sample_offsets.some(t=>t<0)?1:0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length);for(let t=0;t<this.sample_counts.length;t++)e.writeUint32(this.sample_counts[t]),this.version===1?e.writeInt32(this.sample_offsets[t]):e.writeUint32(this.sample_offsets[t])}unpack(e){let t=0;for(let i=0;i<this.sample_counts.length;i++)for(let s=0;s<this.sample_counts[i];s++)e[t].pts=e[t].dts+this.sample_offsets[i],t++}},yu=class extends v{constructor(){super(...arguments),this.box_name="AC3SpecificBox"}static{this.fourcc="dac3"}parse(e){const t=e.readUint8(),i=e.readUint8(),s=e.readUint8();this.fscod=t>>6,this.bsid=t>>1&31,this.bsmod=(t&1)<<2|i>>6&3,this.acmod=i>>3&7,this.lfeon=i>>2&1,this.bit_rate_code=i&3|s>>5&7}},bu=class extends v{constructor(){super(...arguments),this.box_name="EC3SpecificBox"}static{this.fourcc="dec3"}parse(e){const t=e.readUint16();this.data_rate=t>>3,this.num_ind_sub=t&7,this.ind_subs=[];for(let i=0;i<this.num_ind_sub+1;i++){const s=e.readUint8(),n=e.readUint8(),r=e.readUint8(),a={fscod:s>>6,bsid:s>>1&31,bsmod:(s&1)<<4|n>>4&15,acmod:n>>1&7,lfeon:n&1,num_dep_sub:r>>1&15};this.ind_subs.push(a),a.num_dep_sub>0&&(a.chan_loc=(r&1)<<8|e.readUint8())}}},_u=class extends y{constructor(){super(...arguments),this.box_name="FLACSpecificBox"}static{this.fourcc="dfLa"}parse(e){this.parseFullHeader(e);const t=127,i=128,s=[],n=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];let r;do{r=e.readUint8();const a=Math.min(r&t,n.length-1);a?e.readUint8Array(e.readUint24()):(e.readUint8Array(13),this.samplerate=e.readUint32()>>12,e.readUint8Array(20)),s.push(n[a])}while(r&i);this.numMetadataBlocks=s.length+" ("+s.join(", ")+")"}},vu=class extends v{constructor(){super(...arguments),this.box_name="hintimmediateBytesSent"}static{this.fourcc="dimm"}parse(e){this.bytessent=e.readUint64()}},wu=class extends v{constructor(){super(...arguments),this.box_name="hintlongestpacket"}static{this.fourcc="dmax"}parse(e){this.time=e.readUint32()}},Su=class extends v{constructor(){super(...arguments),this.box_name="hintmediaBytesSent"}static{this.fourcc="dmed"}parse(e){this.bytessent=e.readUint64()}},Iu=class extends v{constructor(){super(...arguments),this.box_name="OpusSpecificBox"}static{this.fourcc="dOps"}parse(e){if(this.Version=e.readUint8(),this.OutputChannelCount=e.readUint8(),this.PreSkip=e.readUint16(),this.InputSampleRate=e.readUint32(),this.OutputGain=e.readInt16(),this.ChannelMappingFamily=e.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=e.readUint8(),this.CoupledCount=e.readUint8(),this.ChannelMapping=[];for(let t=0;t<this.OutputChannelCount;t++)this.ChannelMapping[t]=e.readUint8()}}write(e){if(this.size=11,this.ChannelMappingFamily!==0&&(this.size+=2+this.OutputChannelCount),this.writeHeader(e),e.writeUint8(this.Version),e.writeUint8(this.OutputChannelCount),e.writeUint16(this.PreSkip),e.writeUint32(this.InputSampleRate),e.writeInt16(this.OutputGain),e.writeUint8(this.ChannelMappingFamily),this.ChannelMappingFamily!==0){e.writeUint8(this.StreamCount),e.writeUint8(this.CoupledCount);for(let t=0;t<this.OutputChannelCount;t++)e.writeUint8(this.ChannelMapping[t])}}},Eu=class extends v{constructor(){super(...arguments),this.box_name="hintrepeatedBytesSent"}static{this.fourcc="drep"}parse(e){this.bytessent=e.readUint64()}},Tu=class extends y{constructor(){super(...arguments),this.box_name="EditListBox"}static{this.fourcc="elst"}parse(e){this.parseFullHeader(e),this.entries=[];const t=e.readUint32();for(let i=0;i<t;i++){const s={segment_duration:this.version===1?e.readUint64():e.readUint32(),media_time:this.version===1?e.readInt64():e.readInt32(),media_rate_integer:e.readInt16(),media_rate_fraction:e.readInt16()};this.entries.push(s)}}write(e){const t=this.entries.some(i=>i.segment_duration>ie||i.media_time>ie)||this.version===1;this.version=t?1:0,this.size=4+12*this.entries.length,this.size+=t?2*4*this.entries.length:0,this.writeHeader(e),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++){const s=this.entries[i];t?(e.writeUint64(s.segment_duration),e.writeInt64(s.media_time)):(e.writeUint32(s.segment_duration),e.writeInt32(s.media_time)),e.writeInt16(s.media_rate_integer),e.writeInt16(s.media_rate_fraction)}}},Fu=class extends y{constructor(){super(...arguments),this.box_name="EventMessageBox"}static{this.fourcc="emsg"}parse(e){this.parseFullHeader(e),this.version===1?(this.timescale=e.readUint32(),this.presentation_time=e.readUint64(),this.event_duration=e.readUint32(),this.id=e.readUint32(),this.scheme_id_uri=e.readCString(),this.value=e.readCString()):(this.scheme_id_uri=e.readCString(),this.value=e.readCString(),this.timescale=e.readUint32(),this.presentation_time_delta=e.readUint32(),this.event_duration=e.readUint32(),this.id=e.readUint32());let t=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version===1&&(t-=4),this.message_data=e.readUint8Array(t)}write(e){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(e),e.writeCString(this.scheme_id_uri),e.writeCString(this.value),e.writeUint32(this.timescale),e.writeUint32(this.presentation_time_delta),e.writeUint32(this.event_duration),e.writeUint32(this.id),e.writeUint8Array(this.message_data)}},re=class extends y{parse(e){this.parseFullHeader(e),this.group_id=e.readUint32(),this.num_entities_in_group=e.readUint32(),this.entity_ids=[];for(let t=0;t<this.num_entities_in_group;t++){const i=e.readUint32();this.entity_ids.push(i)}}},Cu=class extends re{constructor(){super(...arguments),this.box_name="Auto exposure bracketing"}static{this.fourcc="aebr"}},Uu=class extends re{constructor(){super(...arguments),this.box_name="Flash exposure information"}static{this.fourcc="afbr"}},ku=class extends re{constructor(){super(...arguments),this.box_name="Album collection"}static{this.fourcc="albc"}},Bu=class extends re{constructor(){super(...arguments),this.box_name="Alternative entity"}static{this.fourcc="altr"}},Au=class extends re{constructor(){super(...arguments),this.box_name="Burst image"}static{this.fourcc="brst"}},Ou=class extends re{constructor(){super(...arguments),this.box_name="Depth of field bracketing"}static{this.fourcc="dobr"}},Pu=class extends re{constructor(){super(...arguments),this.box_name="Equivalent entity"}static{this.fourcc="eqiv"}},Du=class extends re{constructor(){super(...arguments),this.box_name="Favorites collection"}static{this.fourcc="favc"}},Lu=class extends re{constructor(){super(...arguments),this.box_name="Focus bracketing"}static{this.fourcc="fobr"}},Nu=class extends re{constructor(){super(...arguments),this.box_name="Image item with an audio track"}static{this.fourcc="iaug"}},Ru=class extends re{constructor(){super(...arguments),this.box_name="Panorama"}static{this.fourcc="pano"}},zu=class extends re{constructor(){super(...arguments),this.box_name="Slideshow"}static{this.fourcc="slid"}},Mu=class extends re{constructor(){super(...arguments),this.box_name="Stereo"}static{this.fourcc="ster"}},Gu=class extends re{constructor(){super(...arguments),this.box_name="Time-synchronized capture"}static{this.fourcc="tsyn"}},Vu=class extends re{constructor(){super(...arguments),this.box_name="White balance bracketing"}static{this.fourcc="wbbr"}},Wu=class extends re{constructor(){super(...arguments),this.box_name="Progressive rendering"}static{this.fourcc="prgr"}},Hu=class extends re{constructor(){super(...arguments),this.box_name="Image pyramid"}static{this.fourcc="pymd"}parse(e){this.parseFullHeader(e),this.group_id=e.readUint32(),this.num_entities_in_group=e.readUint32(),this.entity_ids=[];for(let t=0;t<this.num_entities_in_group;t++){const i=e.readUint32();this.entity_ids.push(i)}this.tile_size_x=e.readUint16(),this.tile_size_y=e.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[];for(let t=0;t<this.num_entities_in_group;t++)this.layer_binning[t]=e.readUint16(),this.tiles_in_layer_row_minus1[t]=e.readUint16(),this.tiles_in_layer_column_minus1[t]=e.readUint16()}},qu=class extends v{constructor(){super(...arguments),this.box_name="FieldHandlingBox"}static{this.fourcc="fiel"}parse(e){this.fieldCount=e.readUint8(),this.fieldOrdering=e.readUint8()}},ju=class extends v{constructor(){super(...arguments),this.box_name="OriginalFormatBox"}static{this.fourcc="frma"}parse(e){this.data_format=e.readString(4)}},Xu=class extends v{constructor(){super(...arguments),this.box_name="ImageMirror"}static{this.fourcc="imir"}parse(e){const t=e.readUint8();this.reserved=t>>7,this.axis=t&1}},Yu=class extends y{constructor(){super(...arguments),this.box_name="ItemPropertyAssociationBox"}static{this.fourcc="ipma"}parse(e){this.parseFullHeader(e);const t=e.readUint32();this.associations=[];for(let i=0;i<t;i++){const s=this.version<1?e.readUint16():e.readUint32(),n=[],r=e.readUint8();for(let a=0;a<r;a++){const o=e.readUint8();n.push({essential:(o&128)>>7===1,property_index:this.flags&1?(o&127)<<8|e.readUint8():o&127})}this.associations.push({id:s,props:n})}}},Ku=class extends v{constructor(){super(...arguments),this.box_name="ImageRotation"}static{this.fourcc="irot"}parse(e){this.angle=e.readUint8()&3}},Ju=class extends y{constructor(){super(...arguments),this.box_name="ImageSpatialExtentsProperty"}static{this.fourcc="ispe"}parse(e){this.parseFullHeader(e),this.image_width=e.readUint32(),this.image_height=e.readUint32()}},Zu=class extends y{constructor(){super(...arguments),this.box_name="TAITimestampBox"}static{this.fourcc="itai"}parse(e){this.TAI_timestamp=e.readUint64();const t=e.readUint8();this.sychronization_state=t>>7&1,this.timestamp_generation_failure=t>>6&1,this.timestamp_is_modified=t>>5&1}},Qu=class extends y{constructor(){super(...arguments),this.box_name="KindBox"}static{this.fourcc="kind"}parse(e){this.parseFullHeader(e),this.schemeURI=e.readCString(),this.isEndOfBox(e)||(this.value=e.readCString())}write(e){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value?this.value.length+1:0),this.writeHeader(e),e.writeCString(this.schemeURI),this.value&&e.writeCString(this.value)}},eh=class extends y{constructor(){super(...arguments),this.box_name="LevelAssignmentBox"}static{this.fourcc="leva"}parse(e){this.parseFullHeader(e);const t=e.readUint8();this.levels=[];for(let i=0;i<t;i++){const s={};this.levels[i]=s,s.track_ID=e.readUint32();const n=e.readUint8();switch(s.padding_flag=n>>7,s.assignment_type=n&127,s.assignment_type){case 0:s.grouping_type=e.readString(4);break;case 1:s.grouping_type=e.readString(4),s.grouping_type_parameter=e.readUint32();break;case 2:break;case 3:break;case 4:s.sub_track_id=e.readUint32();break;default:$.warn("BoxParser",`Unknown level assignment type: ${s.assignment_type}`)}}}},th=class extends v{constructor(){super(...arguments),this.box_name="LHEVCConfigurationBox"}static{this.fourcc="lhvC"}parse(e){this.configurationVersion=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3;let t=e.readUint8();this.numTemporalLayers=(t&13)>>3,this.temporalIdNested=(t&4)>>2,this.lengthSizeMinusOne=t&3,this.nalu_arrays=[];const i=e.readUint8();for(let s=0;s<i;s++){const n=[];this.nalu_arrays.push(n),t=e.readUint8(),n.completeness=(t&128)>>7,n.nalu_type=t&63;const r=e.readUint16();for(let a=0;a<r;a++){const o=e.readUint16();n.push({data:e.readUint8Array(o)})}}}},ih=class extends v{constructor(){super(...arguments),this.box_name="LayerSelectorProperty"}static{this.fourcc="lsel"}parse(e){this.layer_id=e.readUint16()}},sh=class extends v{constructor(){super(...arguments),this.box_name="hintmaxrate"}static{this.fourcc="maxr"}parse(e){this.period=e.readUint32(),this.bytes=e.readUint32()}},pi=class{constructor(e,t){this.x=e,this.y=t}toString(){return"("+this.x+","+this.y+")"}},nh=class extends v{constructor(){super(...arguments),this.box_name="MasteringDisplayColourVolumeBox"}static{this.fourcc="mdcv"}parse(e){this.display_primaries=[],this.display_primaries[0]=new pi(e.readUint16(),e.readUint16()),this.display_primaries[1]=new pi(e.readUint16(),e.readUint16()),this.display_primaries[2]=new pi(e.readUint16(),e.readUint16()),this.white_point=new pi(e.readUint16(),e.readUint16()),this.max_display_mastering_luminance=e.readUint32(),this.min_display_mastering_luminance=e.readUint32()}},rh=class extends y{constructor(){super(...arguments),this.box_name="MovieFragmentRandomAccessOffsetBox"}static{this.fourcc="mfro"}parse(e){this.parseFullHeader(e),this._size=e.readUint32()}},ah=class extends y{constructor(){super(...arguments),this.box_name="MaskConfigurationProperty"}static{this.fourcc="mskC"}parse(e){this.parseFullHeader(e),this.bits_per_pixel=e.readUint8()}},oh=class extends v{constructor(){super(...arguments),this.box_name="hintPacketsSent"}static{this.fourcc="npck"}parse(e){this.packetssent=e.readUint32()}},lh=class extends v{constructor(){super(...arguments),this.box_name="hintPacketsSent"}static{this.fourcc="nump"}parse(e){this.packetssent=e.readUint64()}},dh=class{constructor(e,t){this.pad1=e,this.pad2=t}},fh=class extends y{constructor(){super(...arguments),this.box_name="PaddingBitsBox"}static{this.fourcc="padb"}parse(e){this.parseFullHeader(e);const t=e.readUint32();this.padbits=[];for(let i=0;i<Math.floor((t+1)/2);i++){const s=e.readUint8(),n=(s&112)>>4,r=s&7;this.padbits.push(new dh(n,r))}}},ch=class extends v{constructor(){super(...arguments),this.box_name="PixelAspectRatioBox"}static{this.fourcc="pasp"}parse(e){this.hSpacing=e.readUint32(),this.vSpacing=e.readUint32()}},uh=class extends v{constructor(){super(...arguments),this.box_name="CuePayloadBox"}static{this.fourcc="payl"}parse(e){this.text=e.readString(this.size-this.hdr_size)}},hh=class extends v{constructor(){super(...arguments),this.box_name="hintpayloadID"}static{this.fourcc="payt"}parse(e){this.payloadID=e.readUint32();const t=e.readUint8();this.rtpmap_string=e.readString(t)}},ph=class extends y{constructor(){super(...arguments),this.box_name="ProgressiveDownloadInfoBox",this.rate=[],this.initial_delay=[]}static{this.fourcc="pdin"}parse(e){this.parseFullHeader(e);const t=(this.size-this.hdr_size)/8;for(let i=0;i<t;i++)this.rate[i]=e.readUint32(),this.initial_delay[i]=e.readUint32()}},mh=class extends y{constructor(){super(...arguments),this.box_name="PixelInformationProperty"}static{this.fourcc="pixi"}parse(e){this.parseFullHeader(e),this.num_channels=e.readUint8(),this.bits_per_channels=[];for(let t=0;t<this.num_channels;t++)this.bits_per_channels[t]=e.readUint8()}},$h=class extends v{constructor(){super(...arguments),this.box_name="hintlargestpacket"}static{this.fourcc="pmax"}parse(e){this.bytes=e.readUint32()}},gh=class extends y{constructor(){super(...arguments),this.box_name="ProgressiveDerivedImageItemInformationProperty"}static{this.fourcc="prdi"}parse(e){if(this.parseFullHeader(e),this.step_count=e.readUint16(),this.item_count=[],this.flags&2)for(let t=0;t<this.step_count;t++)this.item_count[t]=e.readUint16()}},xh=class extends y{constructor(){super(...arguments),this.box_name="ProjectionFormatBox"}static{this.fourcc="prfr"}parse(e){this.parseFullHeader(e),this.projection_type=e.readUint8()&31}},yh=class extends y{constructor(){super(...arguments),this.box_name="ProducerReferenceTimeBox"}static{this.fourcc="prft"}parse(e){this.parseFullHeader(e),this.ref_track_id=e.readUint32(),this.ntp_timestamp=e.readUint64(),this.version===0?this.media_time=e.readUint32():this.media_time=e.readUint64()}},bh=class extends y{constructor(){super(...arguments),this.box_name="ProtectionSystemSpecificHeaderBox"}static{this.fourcc="pssh"}parse(e){if(this.parseFullHeader(e),this.system_id=ot(e),this.version>0){const i=e.readUint32();this.kid=[];for(let s=0;s<i;s++)this.kid[s]=ot(e)}const t=e.readUint32();t>0&&(this.protection_data=e.readUint8Array(t))}},_h=class extends y{constructor(){super(...arguments),this.box_name="TrackCleanApertureDimensionsBox"}static{this.fourcc="clef"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};function vh(e,t){if(e===Pt.Types.UTF8)return new TextDecoder("utf-8").decode(t);const i=new DataView(t.buffer);if(e===Pt.Types.BE_UNSIGNED_INT){if(t.length===1)return i.getUint8(0);if(t.length===2)return i.getUint16(0,!1);if(t.length===4)return i.getUint32(0,!1);if(t.length===8)return i.getBigUint64(0,!1);throw new Error("Unsupported ITIF_TYPE_BE_UNSIGNED_INT length "+t.length)}else if(e===Pt.Types.BE_SIGNED_INT){if(t.length===1)return i.getInt8(0);if(t.length===2)return i.getInt16(0,!1);if(t.length===4)return i.getInt32(0,!1);if(t.length===8)return i.getBigInt64(0,!1);throw new Error("Unsupported ITIF_TYPE_BE_SIGNED_INT length "+t.length)}else if(e===Pt.Types.BE_FLOAT32)return i.getFloat32(0,!1);$.warn("DataBox","Unsupported or unimplemented itif data type: "+e)}var Pt=class extends v{constructor(){super(...arguments),this.box_name="DataBox"}static{this.fourcc="data"}static{this.Types={RESERVED:0,UTF8:1,UTF16:2,SJIS:3,UTF8_SORT:4,UTF16_SORT:5,JPEG:13,PNG:14,BE_SIGNED_INT:21,BE_UNSIGNED_INT:22,BE_FLOAT32:23,BE_FLOAT64:24,BMP:27,QT_ATOM:28,BE_SIGNED_INT8:65,BE_SIGNED_INT16:66,BE_SIGNED_INT32:67,BE_FLOAT32_POINT:70,BE_FLOAT32_DIMENSIONS:71,BE_FLOAT32_RECT:72,BE_SIGNED_INT64:74,BE_UNSIGNED_INT8:75,BE_UNSIGNED_INT16:76,BE_UNSIGNED_INT32:77,BE_UNSIGNED_INT64:78,BE_FLOAT64_AFFINE_TRANSFORM:79}}parse(e){this.valueType=e.readUint32(),this.country=e.readUint16(),this.country>255&&(e.seek(e.getPosition()-2),this.countryString=e.readString(2)),this.language=e.readUint16(),this.language>255&&(e.seek(e.getPosition()-2),this.parseLanguage(e)),this.raw=e.readUint8Array(this.size-this.hdr_size-8),this.value=vh(this.valueType,this.raw)}},wh=class extends y{constructor(){super(...arguments),this.box_name="TrackEncodedPixelsDimensionsBox"}static{this.fourcc="enof"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}},Sh=class extends v{constructor(){super(...arguments),this.box_name="IlstBox"}static{this.fourcc="ilst"}parse(e){this.list={};let t=this.size-this.hdr_size;for(;t>0;){const i=e.readUint32(),s=e.readUint32(),n=Ue(e,!1,i-8);n.code===be&&(this.list[s]=n.box),t-=i}}},Ih=class extends y{constructor(){super(...arguments),this.box_name="KeysBox"}static{this.fourcc="keys"}parse(e){this.parseFullHeader(e),this.count=e.readUint32(),this.keys={};for(let t=0;t<this.count;t++){const i=e.readUint32();this.keys[t+1]=e.readString(i-4)}}},Eh=class extends y{constructor(){super(...arguments),this.box_name="TrackProductionApertureDimensionsBox"}static{this.fourcc="prof"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}},Th=class extends L{constructor(){super(...arguments),this.box_name="TrackApertureModeDimensionsBox",this.clefs=[],this.profs=[],this.enofs=[],this.subBoxNames=["clef","prof","enof"]}static{this.fourcc="tapt"}},Fh=class extends L{constructor(){super(...arguments),this.box_name="siDecompressionParamBox"}static{this.fourcc="wave"}},Ch=class extends v{constructor(){super(...arguments),this.box_name="rtpmoviehintinformation"}static{this.fourcc="rtp "}parse(e){this.descriptionformat=e.readString(4),this.sdptext=e.readString(this.size-this.hdr_size-4)}},Uh=class extends y{constructor(){super(...arguments),this.box_name="SampleAuxiliaryInformationOffsetsBox"}static{this.fourcc="saio"}parse(e){this.parseFullHeader(e),this.flags&1&&(this.aux_info_type=e.readString(4),this.aux_info_type_parameter=e.readUint32());const t=e.readUint32();this.offset=[];for(let i=0;i<t;i++)this.version===0?this.offset[i]=e.readUint32():this.offset[i]=e.readUint64()}},kh=class extends y{constructor(){super(...arguments),this.box_name="SampleAuxiliaryInformationSizesBox"}static{this.fourcc="saiz"}parse(e){if(this.parseFullHeader(e),this.flags&1&&(this.aux_info_type=e.readString(4),this.aux_info_type_parameter=e.readUint32()),this.default_sample_info_size=e.readUint8(),this.sample_count=e.readUint32(),this.sample_info_size=[],this.default_sample_info_size===0)for(let t=0;t<this.sample_count;t++)this.sample_info_size[t]=e.readUint8()}},Bh=class{constructor(e,t){this.bad_pixel_row=e,this.bad_pixel_column=t}toString(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"}},Ah=class extends y{constructor(){super(...arguments),this.box_name="SensorBadPixelsMapBox"}static{this.fourcc="sbpm"}parse(e){this.parseFullHeader(e),this.component_count=e.readUint16(),this.component_index=[];for(let i=0;i<this.component_count;i++)this.component_index.push(e.readUint16());const t=e.readUint8();this.correction_applied=(t&128)===128,this.num_bad_rows=e.readUint32(),this.num_bad_cols=e.readUint32(),this.num_bad_pixels=e.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[];for(let i=0;i<this.num_bad_rows;i++)this.bad_rows.push(e.readUint32());for(let i=0;i<this.num_bad_cols;i++)this.bad_columns.push(e.readUint32());for(let i=0;i<this.num_bad_pixels;i++){const s=e.readUint32(),n=e.readUint32();this.bad_pixels.push(new Bh(s,n))}}},Oh=class extends y{constructor(){super(...arguments),this.box_name="SchemeTypeBox"}static{this.fourcc="schm"}parse(e){this.parseFullHeader(e),this.scheme_type=e.readString(4),this.scheme_version=e.readUint32(),this.flags&1&&(this.scheme_uri=e.readString(this.size-this.hdr_size-8))}},Ph=class extends v{constructor(){super(...arguments),this.box_name="rtptracksdphintinformation"}static{this.fourcc="sdp "}parse(e){this.sdptext=e.readString(this.size-this.hdr_size)}},Dh=class extends y{constructor(){super(...arguments),this.box_name="SampleEncryptionBox"}static{this.fourcc="senc"}},Lh=class extends y{constructor(){super(...arguments),this.box_name="SMPTE2086MasteringDisplayMetadataBox"}static{this.fourcc="SmDm"}parse(e){this.parseFullHeader(e),this.primaryRChromaticity_x=e.readUint16(),this.primaryRChromaticity_y=e.readUint16(),this.primaryGChromaticity_x=e.readUint16(),this.primaryGChromaticity_y=e.readUint16(),this.primaryBChromaticity_x=e.readUint16(),this.primaryBChromaticity_y=e.readUint16(),this.whitePointChromaticity_x=e.readUint16(),this.whitePointChromaticity_y=e.readUint16(),this.luminanceMax=e.readUint32(),this.luminanceMin=e.readUint32()}},Nh=class extends y{constructor(){super(...arguments),this.box_name="CompressedSubsegmentIndexBox"}static{this.fourcc="ssix"}parse(e){this.parseFullHeader(e),this.subsegments=[];const t=e.readUint32();for(let i=0;i<t;i++){const s={};this.subsegments.push(s),s.ranges=[];const n=e.readUint32();for(let r=0;r<n;r++){const a={};s.ranges.push(a),a.level=e.readUint8(),a.range_size=e.readUint24()}}}},Rh=class extends y{constructor(){super(...arguments),this.box_name="DegradationPriorityBox"}static{this.fourcc="stpd"}parse(e){this.parseFullHeader(e);const t=(this.size-this.hdr_size)/2;this.priority=[];for(let i=0;i<t;i++)this.priority[i]=e.readUint16()}},zh=class extends y{constructor(){super(...arguments),this.box_name="SubTrackInformationBox"}static{this.fourcc="stri"}parse(e){this.parseFullHeader(e),this.switch_group=e.readUint16(),this.alternate_group=e.readUint16(),this.sub_track_id=e.readUint32();const t=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(let i=0;i<t;i++)this.attribute_list[i]=e.readUint32()}},Mh=class extends y{constructor(){super(...arguments),this.box_name="SubTrackSampleGroupBox"}static{this.fourcc="stsg"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readUint32();const t=e.readUint16();this.group_description_index=[];for(let i=0;i<t;i++)this.group_description_index[i]=e.readUint32()}},Gh=class extends y{constructor(){super(...arguments),this.box_name="ShadowSyncSampleBox"}static{this.fourcc="stsh"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(let i=0;i<t;i++)this.shadowed_sample_numbers.push(e.readUint32()),this.sync_sample_numbers.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(e),e.writeUint32(this.shadowed_sample_numbers.length);for(let t=0;t<this.shadowed_sample_numbers.length;t++)e.writeUint32(this.shadowed_sample_numbers[t]),e.writeUint32(this.sync_sample_numbers[t])}},Vh=class extends y{constructor(){super(...arguments),this.box_name="SyncSampleBox"}static{this.fourcc="stss"}parse(e){this.parseFullHeader(e);const t=e.readUint32();if(this.version===0){this.sample_numbers=[];for(let i=0;i<t;i++)this.sample_numbers.push(e.readUint32())}}write(e){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(e),e.writeUint32(this.sample_numbers.length),e.writeUint32Array(this.sample_numbers)}},Wh=class extends y{constructor(){super(...arguments),this.box_name="StereoVideoBox"}static{this.fourcc="stvi"}parse(e){this.parseFullHeader(e);const t=e.readUint32();this.single_view_allowed=t&3,this.stereo_scheme=e.readUint32();const i=e.readUint32();for(this.stereo_indication_type=e.readString(i),this.boxes=[];e.getPosition()<this.start+this.size;){const s=Ue(e,!1,this.size-(e.getPosition()-this.start));if(s.code===be){const n=s.box;this.boxes.push(n),this[n.type]=n}else return}}},Hh=class extends v{constructor(){super(...arguments),this.box_name="SegmentTypeBox"}static{this.fourcc="styp"}parse(e){let t=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),t-=8,this.compatible_brands=[];let i=0;for(;t>=4;)this.compatible_brands[i]=e.readString(4),t-=4,i++}write(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,void 0,4),e.writeUint32(this.minor_version);for(let t=0;t<this.compatible_brands.length;t++)e.writeString(this.compatible_brands[t],void 0,4)}},qh=class extends y{constructor(){super(...arguments),this.box_name="CompactSampleSizeBox"}static{this.fourcc="stz2"}parse(e){if(this.parseFullHeader(e),this.sample_sizes=[],this.version===0){this.reserved=e.readUint24(),this.field_size=e.readUint8();const t=e.readUint32();if(this.field_size===4)for(let i=0;i<t;i+=2){const s=e.readUint8();this.sample_sizes[i]=s>>4&15,this.sample_sizes[i+1]=s&15}else if(this.field_size===8)for(let i=0;i<t;i++)this.sample_sizes[i]=e.readUint8();else if(this.field_size===16)for(let i=0;i<t;i++)this.sample_sizes[i]=e.readUint16();else $.error("BoxParser","Error in length field in stz2 box",e.isofile)}}},jh=class extends y{constructor(){super(...arguments),this.box_name="SubSampleInformationBox"}static{this.fourcc="subs"}parse(e){this.parseFullHeader(e);const t=e.readUint32();this.entries=[];let i;for(let s=0;s<t;s++){const n={};if(this.entries[s]=n,n.sample_delta=e.readUint32(),n.subsamples=[],i=e.readUint16(),i>0)for(let r=0;r<i;r++){const a={};n.subsamples.push(a),this.version===1?a.size=e.readUint32():a.size=e.readUint16(),a.priority=e.readUint8(),a.discardable=e.readUint8(),a.codec_specific_parameters=e.readUint32()}}}},Xh=class extends y{constructor(){super(...arguments),this.box_name="TAIClockInfoBox"}static{this.fourcc="taic"}parse(e){this.time_uncertainty=e.readUint64(),this.clock_resolution=e.readUint32(),this.clock_drift_rate=e.readInt32();const t=e.readUint8();this.clock_type=(t&192)>>6}},Yh=class extends y{constructor(){super(...arguments),this.box_name="TrackEncryptionBox"}static{this.fourcc="tenc"}parse(e){if(this.parseFullHeader(e),e.readUint8(),this.version===0)e.readUint8();else{const t=e.readUint8();this.default_crypt_byte_block=t>>4&15,this.default_skip_byte_block=t&15}this.default_isProtected=e.readUint8(),this.default_Per_Sample_IV_Size=e.readUint8(),this.default_KID=ot(e),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=e.readUint8(),this.default_constant_IV=e.readUint8Array(this.default_constant_IV_size))}},Kh=class extends y{constructor(){super(...arguments),this.box_name="TrackFragmentRandomAccessBox"}static{this.fourcc="tfra"}parse(e){this.parseFullHeader(e),this.track_ID=e.readUint32(),e.readUint24();const t=e.readUint8();this.length_size_of_traf_num=t>>4&3,this.length_size_of_trun_num=t>>2&3,this.length_size_of_sample_num=t&3,this.entries=[];const i=e.readUint32();for(let s=0;s<i;s++)this.version===1?(this.time=e.readUint64(),this.moof_offset=e.readUint64()):(this.time=e.readUint32(),this.moof_offset=e.readUint32()),this.traf_number=e["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=e["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=e["readUint"+8*(this.length_size_of_sample_num+1)]()}},Jh=class extends v{constructor(){super(...arguments),this.box_name="hintmaxrelativetime"}static{this.fourcc="tmax"}parse(e){this.time=e.readUint32()}},Zh=class extends v{constructor(){super(...arguments),this.box_name="hintminrelativetime"}static{this.fourcc="tmin"}parse(e){this.time=e.readUint32()}},Qh=class extends v{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="totl"}parse(e){this.bytessent=e.readUint32()}},ep=class extends v{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="tpay"}parse(e){this.bytessent=e.readUint32()}},tp=class extends v{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="tpyl"}parse(e){this.bytessent=e.readUint64()}},ip=class extends qd{static{this.fourcc="msrc"}},sp=class Ka extends v{constructor(){super(...arguments),this.box_name="TrackReferenceBox",this.references=[]}static{this.fourcc="tref"}static{this.allowed_types=["hint","cdsc","font","hind","vdep","vplx","subt","thmb","auxl","cdtg","shsc","aest"]}parse(t){for(;t.getPosition()<this.start+this.size;){const i=Ue(t,!0,this.size-(t.getPosition()-this.start));if(i.code===be){Ka.allowed_types.includes(i.type)||$.warn("BoxParser",`Unknown track reference type: '${i.type}'`);const s=new Yd(i.type,i.size,i.hdr_size,i.start);s.write===v.prototype.write&&s.type!=="mdat"&&($.info("BoxParser","TrackReference "+s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.references.push(s)}else return}}},np=class extends y{constructor(){super(...arguments),this.box_name="TrackExtensionPropertiesBox"}static{this.fourcc="trep"}parse(e){for(this.parseFullHeader(e),this.track_ID=e.readUint32(),this.boxes=[];e.getPosition()<this.start+this.size;){const t=Ue(e,!1,this.size-(e.getPosition()-this.start));if(t.code===be){const i=t.box;this.boxes.push(i)}else return}}},rp=class extends v{constructor(){super(...arguments),this.box_name="hintBytesSent"}static{this.fourcc="trpy"}parse(e){this.bytessent=e.readUint64()}},ap=class extends y{constructor(){super(...arguments),this.box_name="TrackSelectionBox"}static{this.fourcc="tsel"}parse(e){this.parseFullHeader(e),this.switch_group=e.readUint32();const t=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(let i=0;i<t;i++)this.attribute_list[i]=e.readUint32()}},op=class extends y{constructor(){super(...arguments),this.box_name="TextConfigBox"}static{this.fourcc="txtc"}parse(e){this.parseFullHeader(e),this.config=e.readCString()}},lp=class extends v{constructor(){super(...arguments),this.box_name="TypeCombinationBox"}static{this.fourcc="tyco"}parse(e){const t=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(let i=0;i<t;i++)this.compatible_brands[i]=e.readString(4)}},dp=class extends y{constructor(){super(...arguments),this.box_name="UserDescriptionProperty"}static{this.fourcc="udes"}parse(e){this.parseFullHeader(e),this.lang=e.readCString(),this.name=e.readCString(),this.description=e.readCString(),this.tags=e.readCString()}},fp=class extends y{constructor(){super(...arguments),this.box_name="UncompressedFrameConfigBox"}static{this.fourcc="uncC"}parse(e){if(this.parseFullHeader(e),this.profile=e.readString(4),this.version!==1){if(this.version===0){this.component_count=e.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[];for(let i=0;i<this.component_count;i++)this.component_index.push(e.readUint16()),this.component_bit_depth_minus_one.push(e.readUint8()),this.component_format.push(e.readUint8()),this.component_align_size.push(e.readUint8());this.sampling_type=e.readUint8(),this.interleave_type=e.readUint8(),this.block_size=e.readUint8();const t=e.readUint8();this.component_little_endian=t>>7&1,this.block_pad_lsb=t>>6&1,this.block_little_endian=t>>5&1,this.block_reversed=t>>4&1,this.pad_unknown=t>>3&1,this.pixel_size=e.readUint32(),this.row_align_size=e.readUint32(),this.tile_align_size=e.readUint32(),this.num_tile_cols_minus_one=e.readUint32(),this.num_tile_rows_minus_one=e.readUint32()}}}},cp=class extends y{constructor(){super(...arguments),this.box_name="DataEntryUrnBox"}static{this.fourcc="urn "}parse(e){this.parseFullHeader(e),this.name=e.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=e.readCString())}write(e){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(e),e.writeCString(this.name),this.location&&e.writeCString(this.location)}},up=class extends v{constructor(){super(...arguments),this.box_name="WebVTTConfigurationBox"}static{this.fourcc="vttC"}parse(e){this.text=e.readString(this.size-this.hdr_size)}},hp=class extends y{constructor(){super(...arguments),this.box_name="VvcNALUConfigBox"}static{this.fourcc="vvnC"}parse(e){this.parseFullHeader(e);const t=e.readUint8();this.lengthSizeMinusOne=t&3}},pp=class extends ee{static{this.grouping_type="alst"}parse(e){const t=e.readUint16();this.first_output_sample=e.readUint16(),this.sample_offset=[];for(let s=0;s<t;s++)this.sample_offset[s]=e.readUint32();const i=this.description_length-4-4*t;this.num_output_samples=[],this.num_total_samples=[];for(let s=0;s<i/4;s++)this.num_output_samples[s]=e.readUint16(),this.num_total_samples[s]=e.readUint16()}},mp=class extends ee{static{this.grouping_type="avll"}parse(e){this.layerNumber=e.readUint8(),this.accurateStatisticsFlag=e.readUint8(),this.avgBitRate=e.readUint16(),this.avgFrameRate=e.readUint16()}},$p=class extends ee{static{this.grouping_type="avss"}parse(e){this.subSequenceIdentifier=e.readUint16(),this.layerNumber=e.readUint8();const t=e.readUint8();this.durationFlag=t>>7,this.avgRateFlag=t>>6&1,this.durationFlag&&(this.duration=e.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=e.readUint8(),this.avgBitRate=e.readUint16(),this.avgFrameRate=e.readUint16()),this.dependency=[];const i=e.readUint8();for(let s=0;s<i;s++)this.dependency.push({subSeqDirectionFlag:e.readUint8(),layerNumber:e.readUint8(),subSequenceIdentifier:e.readUint16()})}},gp=class extends ee{static{this.grouping_type="dtrt"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},xp=class extends ee{static{this.grouping_type="mvif"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},yp=class extends ee{static{this.grouping_type="prol"}parse(e){this.roll_distance=e.readInt16()}},bp=class extends ee{static{this.grouping_type="rap "}parse(e){const t=e.readUint8();this.num_leading_samples_known=t>>7,this.num_leading_samples=t&127}},_p=class extends ee{static{this.grouping_type="rash"}parse(e){if(this.operation_point_count=e.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)$.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=e.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=e.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(let t=0;t<this.operation_point_count;t++)this.available_bitrate[t]=e.readUint32(),this.target_rate_share[t]=e.readUint16()}this.maximum_bitrate=e.readUint32(),this.minimum_bitrate=e.readUint32(),this.discard_priority=e.readUint8()}}},vp=class extends ee{static{this.grouping_type="roll"}parse(e){this.roll_distance=e.readInt16()}},wp=class extends ee{static{this.grouping_type="scif"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},Sp=class extends ee{static{this.grouping_type="scnm"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},Ip=class extends ee{static{this.grouping_type="seig"}parse(e){this.reserved=e.readUint8();const t=e.readUint8();this.crypt_byte_block=t>>4,this.skip_byte_block=t&15,this.isProtected=e.readUint8(),this.Per_Sample_IV_Size=e.readUint8(),this.KID=ot(e),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=e.readUint8(),this.constant_IV=e.readUint8Array(this.constant_IV_size))}},Ep=class extends ee{static{this.grouping_type="stsa"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},Tp=class extends ee{static{this.grouping_type="sync"}parse(e){const t=e.readUint8();this.NAL_unit_type=t&63}},Fp=class extends ee{static{this.grouping_type="tele"}parse(e){const t=e.readUint8();this.level_independently_decodable=t>>7}},Cp=class extends ee{static{this.grouping_type="tsas"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},Up=class extends ee{static{this.grouping_type="tscl"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},kp=class extends ee{static{this.grouping_type="vipr"}parse(e){$.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}},Bp=class extends v{static{this.fourcc="uuid"}},Ft=class extends y{static{this.fourcc="uuid"}},Ap=class extends Ft{constructor(){super(...arguments),this.box_name="LiveServerManifestBox"}static{this.uuid="a5d40b30e81411ddba2f0800200c9a66"}parse(e){this.parseFullHeader(e),this.LiveServerManifest=e.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}},Op=class extends Ft{constructor(){super(...arguments),this.box_name="PiffProtectionSystemSpecificHeaderBox"}static{this.uuid="d08a4f1810f34a82b6c832d8aba183d3"}parse(e){this.parseFullHeader(e),this.system_id=ot(e);const t=e.readUint32();t>0&&(this.data=e.readUint8Array(t))}},Pp=class extends Ft{constructor(){super(...arguments),this.box_name="PiffSampleEncryptionBox"}static{this.uuid="a2394f525a9b4f14a2446c427c648df4"}},Dp=class extends Ft{constructor(){super(...arguments),this.box_name="PiffTrackEncryptionBox"}static{this.uuid="8974dbce7be74c5184f97148f9882554"}parse(e){this.parseFullHeader(e),this.default_AlgorithmID=e.readUint24(),this.default_IV_size=e.readUint8(),this.default_KID=ot(e)}},Lp=class extends Ft{constructor(){super(...arguments),this.box_name="TfrfBox"}static{this.uuid="d4807ef2ca3946958e5426cb9e46a79f"}parse(e){this.parseFullHeader(e),this.fragment_count=e.readUint8(),this.entries=[];for(let t=0;t<this.fragment_count;t++){let i=0,s=0;this.version===1?(i=e.readUint64(),s=e.readUint64()):(i=e.readUint32(),s=e.readUint32()),this.entries.push({absolute_time:i,absolute_duration:s})}}},Np=class extends Ft{constructor(){super(...arguments),this.box_name="TfxdBox"}static{this.uuid="6d1d9b0542d544e680e2141daff757b2"}parse(e){this.parseFullHeader(e),this.version===1?(this.absolute_time=e.readUint64(),this.duration=e.readUint64()):(this.absolute_time=e.readUint32(),this.duration=e.readUint32())}},Rp=class extends Bp{constructor(){super(...arguments),this.box_name="ItemContentIDProperty"}static{this.uuid="261ef3741d975bbaacbd9d2c8ea73522"}parse(e){this.content_id=e.readCString()}};tf(Ya);sf(Wa);const Hi=e=>{const t=e.lastIndexOf(".");return t==-1?[e,void 0]:t==0?[e,void 0]:[e.slice(0,t),e.slice(t+1)]},zp=new Intl.Segmenter("und",{granularity:"grapheme"}),ys=(e,t,i)=>e.slice(t,i),bs=(e,t,i)=>[...zp.segment(e)].slice(t,i).map(s=>s.segment).join(""),Ja=e=>{let[t,i]=Hi(e);i&&(i="."+i),t.normalize("NFC");let s="";const n=/\(\d+\)$/.exec(t);n&&(t=t.slice(0,-1*n[0].length),s=n[0]);const r=46,a=".supplemental-metadata";function o(){return`${`${t}${i}`}${s}.json`}function l(f){let u=`${t}${i}`;return`${f(u,0,r)}${s}.json`}function d(f){const u=`${t}${i}${a}`;return`${f(u,0,r)}${s}.json`}function c(f){const u=`${t}${s}${i}${a}`;return`${f(u,0,r)}.json`}return[o(),l(ys),l(bs),d(ys),d(bs),c(ys),c(bs)]};window.getPotentialMetaFileNames=Ja;function Mp(e){return e.parents.map(t=>t.name).join("/")+"/"+e.handle.name}function xt(e){return`${Mp(e.folder)}/${e.handle.name}`}const Gp=["heic","heif","jpeg","jpg","png","gif","bmp","tiff","webp"],Vp=["mov","mp4","m4v","avi","wmv","flv","mkv","webm","3gp","3g2","avi","ogv","mpg","mp"];function Wp(e){const t=Hi(e)[1]?.toLocaleLowerCase();if(t){if(Gp.includes(t))return"image";if(Vp.includes(t))return"video"}return"other"}async function Hp(e){const t=await Ld.parse(e);return t&&t.CreateDate instanceof Date?t.CreateDate:null}async function qp(e,t){return new Promise(i=>{const s=jc();s.onReady=r=>{try{if(r.created){i(r.created);return}i(null)}catch(a){console.warn("MP4Box error:",e.handle.name,a),i(null)}};const n=new FileReader;n.onload=r=>{try{const o=(r.target?.result).slice(0);o.fileStart=0,o.fileStart=0,s.appendBuffer(o),s.flush()}catch(a){console.warn("MP4Box error:",t.name,a),i(null)}},n.readAsArrayBuffer(t)})}function _s(e,t,i){if(!t)return null;const s=t.replace(/^(\d{4}):(\d{2}):(\d{2})/,"$1-$2-$3"),n=new Date(s);if(!isNaN(n.getTime()))return n;const r=new Date(t);return isNaN(r.getTime())?(console.log("Could not parse date",xt(e),": ",t),i("warning","Could not parse date "+xt(e)+": "+t),null):r}async function jp(e,t,i){try{const s=await md(t,{args:["-json","-n"],transform:r=>JSON.parse(r)});if(!s.success)return console.warn("ExifTool unsuccessful error:",e.handle.name,s.error),null;const n=_s(e,s.data[0]?.CreationDate,i)??_s(e,s.data[0]?.CreateDate,i)??_s(e,s.data[0]?.DateTimeOriginal,i)??null;return n||console.log("Could not get exiftool date:",s.data),n}catch(s){return console.warn("ExifTool throw error:",e.handle.name,s),null}}async function dr(e,t){let i=null;const s=await e.handle.getFile();try{const n=s.name.split(".").pop()?.toLowerCase(),r=["jpg","jpeg","tif","tiff","png","heic","webp"],a=["mp4","mov","mkv","avi","webm"];if(n&&r.includes(n))i=await Hp(s);else if(n&&a.includes(n)){const o=await qp(e,s);o&&(i=o)}}catch(n){console.warn(`Error while parsing create date for ${e.handle.name}. Fallback to exiftool:`,n)}return(!i||i<new Date("1972-01-01"))&&(i=await jp(e,s,t),i),i}async function Xp(e){return(await e.handle.getFile()).size<20971520?"possibly-live":"large"}async function Yp(e){const t=new Map;for(const i of e){const s=await Xp(i.file);t.has(s)||t.set(s,[]),t.get(s).push(i)}return t}async function Kp(e,t){const i=Map.groupBy(e,p=>Wp(p.file.handle.name)),s=i.get("video")??[],n=i.get("image")??[],r=i.get("other")??[];if(s.length===0||n.length===0)return e;const a=await Yp(s),o=a.get("possibly-live")??[],l=a.get("large")??[];if(o.length===0)return e;const d=1e3*60*60*24,c=await Promise.all(o.map(p=>dr(p.file,t))),f=await Promise.all(n.map(p=>dr(p.file,t))),u=[];o.forEach((p,S)=>{const w=c[S];w&&n.forEach((C,U)=>{const F=f[U];if(!F)return;const I=Math.abs(w.getTime()-F.getTime());u.push({video:p,image:C,diff:I})})}),u.sort((p,S)=>p.diff-S.diff);let h=new Set(o);const m=new Set,x=new Set;for(const p of u){if(p.diff>d)break;!m.has(p.video)&&!x.has(p.image)&&(p.image.liveVideo=p.video.file,h.delete(p.video),m.add(p.video),x.add(p.image))}return[...h,...n,...r,...l]}async function Jp(e,t,i){const s=new Map,n=Array.from(e.entries());let r=0,a=0;const o=n.length;async function l(){for(;r<o;){const c=r++,[f,u]=n[c],h=await Kp(u,i);h&&s.set(f,h),a++,t(a/o)}}const d=Array.from({length:128},()=>l());return await Promise.all(d),s}function fr(e){return/.json$/i.test(e)}function Za(e){const t=/^(.+?)(\(\d+\))?(?:\.([^.]+))$/,i=e.match(t);return i?{baseName:i[1],dup:i[2]??"",ext:i[3]??""}:{baseName:e,dup:"",ext:""}}function Zp(e){const t=new Map;for(const i of e){const s=Za(i.file.handle.name).baseName;t.has(s)||t.set(s,[]),t.get(s).push(i)}return t}async function Qp(e,t,i){const s=[];let n=0;for(const a of e){t(n/e.length);const o=[a,...e.filter(l=>l!==a)];for await(const[l,d]of a.handle.entries()){if(d.kind!=="file"||fr(l))continue;Za(l);const c=Ja(l);let f=null;for(const u of o){if(f)break;for(const h of c){if(f)break;try{f={handle:await u.handle.getFileHandle(h),folder:u}}catch(m){if(!(m instanceof DOMException&&m.name==="NotFoundError"))throw m}}}s.push({file:{handle:d,folder:a},meta:f,liveVideo:null})}n++}const r=new Set(s.map(a=>a.meta?xt(a.meta):null));for(const a of e)for await(const[o,l]of a.handle.entries())l.kind!=="file"||!fr(o)||o==="Metadata.json"||o==="Metadaten.json"||r.has(xt({handle:l,folder:a}))||(console.warn("Unused metadata file:",xt({handle:l,folder:a})),i("warning","Unused metadata file: "+xt({handle:l,folder:a})));return t(1),s}async function em(e){let t=0;for await(const i of e)t++;return t}async function tm(e,t,i,s,n,r,a){i(0),s("Initializing...");const o=await e.getDirectoryHandle("Prepared_Photos",{create:!0});if(await em(o.entries())>0)throw new Error("Output folder 'Prepared_Photos' is not empty");let l=0,d=0;const c=new Map;for(const[f,u]of t){n(0),console.log("Processing album:",f),r(f+": Matching files with metadata");const h=await Qp(u,p=>n(Math.round(p*.3*100)),a);console.log("after metadata merge",h),r(f+": Grouping files with similar names");const m=Zp(h);console.log("after base name grouping",m),r(f+": Matching live photos with videos");const x=await Jp(m,p=>n(Math.round((.3+p*.7)*100)),a);console.log("after live photo matching",x),l++,d=l/t.size,i(Math.round(d*100)),c.set(f,x)}return c}async function vs(e,t){const s=(await e.getFile()).stream(),n=await t.createWritable();await s.pipeTo(n)}function im(e,t){if(t.exportMode==="all")return e;const i=new Map([...e.entries()].map(([s,n])=>[s,new Map([...n.entries()].filter(([r,a])=>a.some(o=>o.liveVideo)))]).filter(([s,n])=>n.size>0));return t.exportMode==="live-and-confusing"?i:new Map([...i.entries()].map(([s,n])=>[s,new Map([...n.entries()].map(([r,a])=>[r,a.filter(o=>o.liveVideo)]))]).filter(([s,n])=>n.size>0))}async function sm(e,t,i,s){const n=await e.getDirectoryHandle("Prepared_Photos",{create:!0}),r=im(t,s);let a=0;for(const[l,d]of r)a+=d.size;let o=0;for(const[l,d]of r){const c=await n.getDirectoryHandle(l,{create:!0}),f=Array.from(d.keys());let u=0;async function h(){for(;u<f.length;){const x=u++,p=f[x],S=d.get(p);S&&(await nm(c,p,S),o++,i(o/a))}}const m=Array.from({length:16},()=>h());await Promise.all(m)}}async function nm(e,t,i){let s=0;for(const n of i){const r=Hi(n.file.handle.name)[1],a=s===0?`${t}`:`${t}_${s}`,o=`${a}.${r}`,l=await e.getFileHandle(o,{create:!0});if(await vs(n.file.handle,l),n.meta!=null){const c=`${o}.supplemental-metadata`.slice(0,46)+".json",f=await e.getFileHandle(c,{create:!0});await vs(n.meta.handle,f)}if(n.liveVideo!=null){const d=Hi(n.liveVideo.handle.name)[1],c=`${a}.${d}`,f=await e.getFileHandle(c,{create:!0});await vs(n.liveVideo.handle,f)}s++}}function rm(){const e="showDirectoryPicker"in window,[t,i]=M(1),[s,n]=M(!1),[r,a]=M(null),[o,l]=M(null),[d,c]=M([]),[f,u]=M(0),[h,m]=M(""),[x,p]=M(0),[S,w]=M(""),[C,U]=M("all");let F=null,I=null,P=null,_=null;async function V(){c([]),P=null,n(!1);try{const G=await window.showDirectoryPicker();I=G,ke(),P=await G.getFileHandle("gphoto-prepare-duck-log.txt",{create:!0}),await Ze();const k=await Zl(G);a(k.map(mt=>mt.name));const we=await ed(k);F=we,l([...we.keys()].sort()),n(!0)}catch(G){console.error(G),fe("error",G)}finally{await Te()}}let A=null;async function Ee(){try{await Ze(),u(0),m("Initializing..."),p(0),w("..."),ke(),A=await tm(I,F,u,m,p,w,fe),ke()}catch(G){console.error(G),fe("error",G)}finally{await Te()}}async function pt(){try{await Ze(),u(0),m("Exporting..."),p(0),w("..."),ke(),await sm(I,A,G=>u(Math.round(G*100)),{exportMode:C()}),ke()}catch(G){console.error(G),fe("error",G)}finally{await Te()}}function ke(){i(G=>G+1)}async function Ze(){_=await P?.createWritable({keepExistingData:!0})??null}async function Te(){await _?.close()}const fe=async(G,k)=>{let we;typeof k=="string"?we=k:k instanceof Error?we=k.message:we=String(k);const mt={message:we,type:G};c(ei=>[mt,...ei].slice(0,25)),_?.write(G+" at "+new Date().toISOString()+": "+we+`
`)};return{startViaSelectFolder:V,browserSupportsApi:e,takeoutFolders:r,step:t,nextStep:ke,confirmFoldersStart:Ee,albums:o,finishedLoadingFolders:s,progress:f,progressMessage:h,writeFiles:pt,albumProgress:x,albumProgressMessage:S,exportMode:C,setExportMode:U,recentLog:d,addLogEntry:fe}}const Qa=dt();function eo(){const e=ft(Qa);if(!e)throw new Error("usePrepStore must be used within a PrepStoreProvider");return e}function am(e){return(...t)=>{for(const i of e)i&&i(...t)}}const he=e=>typeof e=="function"&&!e.length?e():e;function om(e,...t){return typeof e=="function"?e(...t):e}const lm=/((?:--)?(?:\w+-?)+)\s*:\s*([^;]*)/g;function cr(e){const t={};let i;for(;i=lm.exec(e);)t[i[1]]=i[2];return t}function ln(e,t){if(typeof e=="string"){if(typeof t=="string")return`${e};${t}`;e=cr(e)}else typeof t=="string"&&(t=cr(t));return{...e,...t}}function Yt(...e){return am(e)}function dm(e){return Object.prototype.toString.call(e)==="[object String]"}function fm(e){return typeof e=="function"}function is(e){return t=>`${e()}-${t}`}var to=(e=>(e.Escape="Escape",e.Enter="Enter",e.Tab="Tab",e.Space=" ",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight",e.ArrowUp="ArrowUp",e.End="End",e.Home="Home",e.PageDown="PageDown",e.PageUp="PageUp",e))(to||{});function _t(e,t){return t&&(fm(t)?t(e):t[0](t[1],e)),e?.defaultPrevented}function io(e,t=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY){return Math.min(Math.max(e,t),i)}function le(e,t){return D(e,t)}var At=new Map,ur=new Set;function hr(){if(typeof window>"u")return;const e=i=>{if(!i.target)return;let s=At.get(i.target);s||(s=new Set,At.set(i.target,s),i.target.addEventListener("transitioncancel",t)),s.add(i.propertyName)},t=i=>{if(!i.target)return;const s=At.get(i.target);if(s&&(s.delete(i.propertyName),s.size===0&&(i.target.removeEventListener("transitioncancel",t),At.delete(i.target)),At.size===0)){for(const n of ur)n();ur.clear()}};document.body.addEventListener("transitionrun",e),document.body.addEventListener("transitionend",t)}typeof document<"u"&&(document.readyState!=="loading"?hr():document.addEventListener("DOMContentLoaded",hr));var cm={border:"0",clip:"rect(0 0 0 0)","clip-path":"inset(50%)",height:"1px",margin:"0 -1px -1px 0",overflow:"hidden",padding:"0",position:"absolute",width:"1px","white-space":"nowrap"};function so(e,t){const[i,s]=M(pr(t?.()));return $e(()=>{s(e()?.tagName.toLowerCase()||pr(t?.()))}),i}function pr(e){return dm(e)?e:void 0}function de(e){const[t,i]=Y(e,["as"]);if(!t.as)throw new Error("[kobalte]: Polymorphic is missing the required `as` prop.");return g(ol,D(i,{get component(){return t.as}}))}var um=Object.defineProperty,dn=(e,t)=>{for(var i in t)um(e,i,{get:t[i],enumerable:!0})},hm={};dn(hm,{Button:()=>$m,Root:()=>fn});var pm=["button","color","file","image","reset","submit"];function mm(e){const t=e.tagName.toLowerCase();return t==="button"?!0:t==="input"&&e.type?pm.indexOf(e.type)!==-1:!1}function fn(e){let t;const i=le({type:"button"},e),[s,n]=Y(i,["ref","type","disabled"]),r=so(()=>t,()=>"button"),a=R(()=>{const d=r();return d==null?!1:mm({tagName:d,type:s.type})}),o=R(()=>r()==="input"),l=R(()=>r()==="a"&&t?.getAttribute("href")!=null);return g(de,D({as:"button",ref(d){var c=Yt(f=>t=f,s.ref);typeof c=="function"&&c(d)},get type(){return a()||o()?s.type:void 0},get role(){return!a()&&!l()?"button":void 0},get tabIndex(){return!a()&&!l()&&!s.disabled?0:void 0},get disabled(){return a()||o()?s.disabled:void 0},get"aria-disabled"(){return!a()&&!o()&&s.disabled?!0:void 0},get"data-disabled"(){return s.disabled?"":void 0}},n))}var $m=fn;const mr=e=>typeof e=="boolean"?`${e}`:e===0?"0":e,$r=Ur,gm=(e,t)=>i=>{var s;if(t?.variants==null)return $r(e,i?.class,i?.className);const{variants:n,defaultVariants:r}=t,a=Object.keys(n).map(d=>{const c=i?.[d],f=r?.[d];if(c===null)return null;const u=mr(c)||mr(f);return n[d][u]}),o=i&&Object.entries(i).reduce((d,c)=>{let[f,u]=c;return u===void 0||(d[f]=u),d},{}),l=t==null||(s=t.compoundVariants)===null||s===void 0?void 0:s.reduce((d,c)=>{let{class:f,className:u,...h}=c;return Object.entries(h).every(m=>{let[x,p]=m;return Array.isArray(p)?p.includes({...r,...o}[x]):{...r,...o}[x]===p})?[...d,f,u]:d},[]);return $r(e,a,l,i?.class,i?.className)},xm=gm("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 px-3 text-xs",lg:"h-11 px-8",icon:"size-10"}},defaultVariants:{variant:"default",size:"default"}}),ki=e=>{const[t,i]=Y(e,["variant","size","class"]);return g(fn,D({get class(){return It(xm({variant:t.variant,size:t.size}),t.class)}},i))};var ym=q('<div class="shadow rounded-2xl p-4 border"><h2 class="text-xl font-bold pb-2">/8. '),bm=q("<div class=pt-2>");function ze(e){const t=eo();return g(Pe,{get when(){return t.step()==e.step},get children(){var i=ym(),s=i.firstChild,n=s.firstChild;return z(s,()=>e.step,n),z(s,()=>e.title,null),z(i,()=>e.children,null),z(i,g(Pe,{get when(){return e.hasNextButton},get children(){return g(Bi,{get children(){return g(_m,{})}})}}),null),i}})}function Bi(e){return(()=>{var t=bm();return z(t,()=>e.children),t})()}function _m(e){const t=eo();return g(ki,{get onClick(){return t.nextStep},get children(){return e.title??"Next"}})}let ws=new Map,qs=!1;try{qs=new Intl.NumberFormat("de-DE",{signDisplay:"exceptZero"}).resolvedOptions().signDisplay==="exceptZero"}catch{}let qi=!1;try{qi=new Intl.NumberFormat("de-DE",{style:"unit",unit:"degree"}).resolvedOptions().style==="unit"}catch{}const no={degree:{narrow:{default:"Â°","ja-JP":" åº¦","zh-TW":"åº¦","sl-SI":" Â°"}}};class vm{format(t){let i="";if(!qs&&this.options.signDisplay!=null?i=Sm(this.numberFormatter,this.options.signDisplay,t):i=this.numberFormatter.format(t),this.options.style==="unit"&&!qi){var s;let{unit:n,unitDisplay:r="short",locale:a}=this.resolvedOptions();if(!n)return i;let o=(s=no[n])===null||s===void 0?void 0:s[r];i+=o[a]||o.default}return i}formatToParts(t){return this.numberFormatter.formatToParts(t)}formatRange(t,i){if(typeof this.numberFormatter.formatRange=="function")return this.numberFormatter.formatRange(t,i);if(i<t)throw new RangeError("End date must be >= start date");return`${this.format(t)} â€“ ${this.format(i)}`}formatRangeToParts(t,i){if(typeof this.numberFormatter.formatRangeToParts=="function")return this.numberFormatter.formatRangeToParts(t,i);if(i<t)throw new RangeError("End date must be >= start date");let s=this.numberFormatter.formatToParts(t),n=this.numberFormatter.formatToParts(i);return[...s.map(r=>({...r,source:"startRange"})),{type:"literal",value:" â€“ ",source:"shared"},...n.map(r=>({...r,source:"endRange"}))]}resolvedOptions(){let t=this.numberFormatter.resolvedOptions();return!qs&&this.options.signDisplay!=null&&(t={...t,signDisplay:this.options.signDisplay}),!qi&&this.options.style==="unit"&&(t={...t,style:"unit",unit:this.options.unit,unitDisplay:this.options.unitDisplay}),t}constructor(t,i={}){this.numberFormatter=wm(t,i),this.options=i}}function wm(e,t={}){let{numberingSystem:i}=t;if(i&&e.includes("-nu-")&&(e.includes("-u-")||(e+="-u-"),e+=`-nu-${i}`),t.style==="unit"&&!qi){var s;let{unit:a,unitDisplay:o="short"}=t;if(!a)throw new Error('unit option must be provided with style: "unit"');if(!(!((s=no[a])===null||s===void 0)&&s[o]))throw new Error(`Unsupported unit ${a} with unitDisplay = ${o}`);t={...t,style:"decimal"}}let n=e+(t?Object.entries(t).sort((a,o)=>a[0]<o[0]?-1:1).join():"");if(ws.has(n))return ws.get(n);let r=new Intl.NumberFormat(e,t);return ws.set(n,r),r}function Sm(e,t,i){if(t==="auto")return e.format(i);if(t==="never")return e.format(Math.abs(i));{let s=!1;if(t==="always"?s=i>0||Object.is(i,0):t==="exceptZero"&&(Object.is(i,-0)||Object.is(i,0)?i=Math.abs(i):s=i>0),s){let n=e.format(-i),r=e.format(i),a=n.replace(r,"").replace(/\u200e|\u061C/,"");return[...a].length!==1&&console.warn("@react-aria/i18n polyfill for NumberFormat signDisplay: Unsupported case"),n.replace(r,"!!!").replace(a,"+").replace("!!!",r)}else return e.format(i)}}var Im=new Set(["Avst","Arab","Armi","Syrc","Samr","Mand","Thaa","Mend","Nkoo","Adlm","Rohg","Hebr"]),Em=new Set(["ae","ar","arc","bcc","bqi","ckb","dv","fa","glk","he","ku","mzn","nqo","pnb","ps","sd","ug","ur","yi"]);function Tm(e){if(Intl.Locale){const i=new Intl.Locale(e).maximize().script??"";return Im.has(i)}const t=e.split("-")[0];return Em.has(t)}function Fm(e){return Tm(e)?"rtl":"ltr"}function ro(){let e=typeof navigator<"u"&&(navigator.language||navigator.userLanguage)||"en-US";try{Intl.DateTimeFormat.supportedLocalesOf([e])}catch{e="en-US"}return{locale:e,direction:Fm(e)}}var js=ro(),Dt=new Set;function gr(){js=ro();for(const e of Dt)e(js)}function Cm(){const[e,t]=M(js),i=R(()=>e());return wo(()=>{Dt.size===0&&window.addEventListener("languagechange",gr),Dt.add(t),ve(()=>{Dt.delete(t),Dt.size===0&&window.removeEventListener("languagechange",gr)})}),{locale:()=>i().locale,direction:()=>i().direction}}var Um=dt();function km(){const e=Cm();return ft(Um)||e}function ao(e){const{locale:t}=km();return R(()=>new vm(t(),he(e)))}function De(e){return t=>(e(t),()=>e(void 0))}var oo=dt();function ss(){const e=ft(oo);if(e===void 0)throw new Error("[kobalte]: `useMeterContext` must be used within a `Meter.Root` component");return e}function Bm(e){const t=ss(),[i,s]=Y(e,["style"]);return g(de,D({as:"div",get style(){return ln({"--kb-meter-fill-width":t.meterFillWidth()},i.style)}},()=>t.dataset(),s))}function Am(e){const t=ss(),i=le({id:t.generateId("label")},e),[s,n]=Y(i,["id"]);return $e(()=>ve(t.registerLabelId(s.id))),g(de,D({as:"span",get id(){return s.id}},()=>t.dataset(),n))}function Om(e){const t=`meter-${Xt()}`,i=le({id:t,value:0,minValue:0,maxValue:100,role:"meter",indeterminate:!1},e),[s,n]=Y(i,["value","minValue","maxValue","getValueLabel","role","aria-valuetext","aria-labelledby","aria-valuemax","aria-valuemin","aria-valuenow","indeterminate"]),[r,a]=M(),o=ao(()=>({style:"percent"})),l=()=>io(s.value,s.minValue,s.maxValue),d=()=>(l()-s.minValue)/(s.maxValue-s.minValue),c=()=>{if(!s.indeterminate)return s.getValueLabel?s.getValueLabel({value:l(),min:s.minValue,max:s.maxValue}):o().format(d())},f=()=>`${d()*100}%`,u=R(()=>({})),h={dataset:u,value:l,valuePercent:d,valueLabel:c,labelId:r,meterFillWidth:f,generateId:is(()=>n.id),registerLabelId:De(a)};return g(oo.Provider,{value:h,get children(){return g(de,D({as:"div",get role(){return s.role||"meter"},get"aria-valuenow"(){return R(()=>!!s.indeterminate)()?void 0:l()},get"aria-valuemin"(){return s.minValue},get"aria-valuemax"(){return s.maxValue},get"aria-valuetext"(){return c()},get"aria-labelledby"(){return r()}},u,n))}})}function Pm(e){const t=ss();return g(de,D({as:"div"},()=>t.dataset(),e))}function Dm(e){const t=ss();return g(de,D({as:"div"},()=>t.dataset(),e,{get children(){return t.valueLabel()}}))}var Kt=Object.assign(Om,{Fill:Bm,Label:Am,Track:Pm,ValueLabel:Dm}),Lm={};dn(Lm,{Fill:()=>cn,Label:()=>un,Progress:()=>Nm,Root:()=>hn,Track:()=>pn,ValueLabel:()=>mn,useProgressContext:()=>Jt});var lo=dt();function Jt(){const e=ft(lo);if(e===void 0)throw new Error("[kobalte]: `useProgressContext` must be used within a `Progress.Root` component");return e}function cn(e){const t=Jt(),[i,s]=Y(e,["style"]);return g(Kt.Fill,D({get style(){return ln({"--kb-progress-fill-width":t.progressFillWidth()},i.style)}},()=>t.dataset(),s))}function un(e){const t=Jt(),i=le({id:t.generateId("label")},e),[s,n]=Y(i,["id"]);return $e(()=>ve(t.registerLabelId(s.id))),g(Kt.Label,D({get id(){return s.id}},()=>t.dataset(),n))}function hn(e){const t=`progress-${Xt()}`,i=le({id:t,value:0,minValue:0,maxValue:100},e),[s,n]=Y(i,["value","minValue","maxValue","indeterminate","getValueLabel"]),[r,a]=M(),o=ao(()=>({style:"percent"})),l=()=>io(s.value,s.minValue,s.maxValue),d=()=>(l()-s.minValue)/(s.maxValue-s.minValue),c=()=>{if(!s.indeterminate)return s.getValueLabel?s.getValueLabel({value:l(),min:s.minValue,max:s.maxValue}):o().format(d())},f=()=>s.indeterminate?void 0:`${d()*100}%`,u=R(()=>{let m;return s.indeterminate||(m=d()===1?"complete":"loading"),{"data-progress":m,"data-indeterminate":s.indeterminate?"":void 0}}),h={dataset:u,value:l,valuePercent:d,valueLabel:c,labelId:r,progressFillWidth:f,generateId:is(()=>n.id),registerLabelId:De(a)};return g(lo.Provider,{value:h,get children(){return g(Kt,D({role:"progressbar",get indeterminate(){return s.indeterminate||!1}},u,i))}})}function pn(e){const t=Jt();return g(Kt.Track,D(()=>t.dataset(),e))}function mn(e){const t=Jt();return g(Kt.ValueLabel,D(()=>t.dataset(),e))}var Nm=Object.assign(hn,{Fill:cn,Label:un,Track:pn,ValueLabel:mn}),Rm=q("<label>");const fo=e=>{const[t,i]=Y(e,["class"]);return(()=>{var s=Rm();return Fr(s,D({get class(){return It("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",t.class)}},i),!1,!1),s})()},Ss=e=>{const[t,i]=Y(e,["children"]);return g(hn,D(i,{get children(){return[R(()=>t.children),g(pn,{class:"relative h-2 w-full overflow-hidden rounded-full bg-secondary",get children(){return g(cn,{class:"h-full w-[var(--kb-progress-fill-width)] flex-1 bg-primary transition-all"})}})]}}))},Is=e=>g(un,D({as:fo},e)),Es=e=>g(mn,D({as:fo},e));var zm=["id","name","validationState","required","disabled","readOnly"];function Mm(e){const t=`form-control-${Xt()}`,i=le({id:t},e),[s,n]=M(),[r,a]=M(),[o,l]=M(),[d,c]=M(),f=(x,p,S)=>{const w=S!=null||s()!=null;return[S,s(),w&&p!=null?x:void 0].filter(Boolean).join(" ")||void 0},u=x=>[o(),d(),x].filter(Boolean).join(" ")||void 0,h=R(()=>({"data-valid":he(i.validationState)==="valid"?"":void 0,"data-invalid":he(i.validationState)==="invalid"?"":void 0,"data-required":he(i.required)?"":void 0,"data-disabled":he(i.disabled)?"":void 0,"data-readonly":he(i.readOnly)?"":void 0}));return{formControlContext:{name:()=>he(i.name)??he(i.id),dataset:h,validationState:()=>he(i.validationState),isRequired:()=>he(i.required),isDisabled:()=>he(i.disabled),isReadOnly:()=>he(i.readOnly),labelId:s,fieldId:r,descriptionId:o,errorMessageId:d,getAriaLabelledBy:f,getAriaDescribedBy:u,generateId:is(()=>he(i.id)),registerLabel:De(n),registerField:De(a),registerDescription:De(l),registerErrorMessage:De(c)}}}var co=dt();function Zt(){const e=ft(co);if(e===void 0)throw new Error("[kobalte]: `useFormControlContext` must be used within a `FormControlContext.Provider` component");return e}function uo(e){const t=Zt(),i=le({id:t.generateId("description")},e);return $e(()=>ve(t.registerDescription(i.id))),g(de,D({as:"div"},()=>t.dataset(),i))}function Gm(e){let t;const i=Zt(),s=le({id:i.generateId("label")},e),[n,r]=Y(s,["ref"]),a=so(()=>t,()=>"label");return $e(()=>ve(i.registerLabel(r.id))),g(de,D({as:"label",ref(o){var l=Yt(d=>t=d,n.ref);typeof l=="function"&&l(o)},get for(){return R(()=>a()==="label")()?i.fieldId():void 0}},()=>i.dataset(),r))}function Vm(e,t){$e(_r(e,i=>{if(i==null)return;const s=Wm(i);s!=null&&(s.addEventListener("reset",t,{passive:!0}),ve(()=>{s.removeEventListener("reset",t)}))}))}function Wm(e){return Hm(e)?e.form:e.closest("form")}function Hm(e){return e.matches("textarea, input, select, button")}function ho(e){const t=Zt(),i=le({id:t.generateId("error-message")},e),[s,n]=Y(i,["forceMount"]),r=()=>t.validationState()==="invalid";return $e(()=>{r()&&ve(t.registerErrorMessage(n.id))}),g(Pe,{get when(){return s.forceMount||r()},get children(){return g(de,D({as:"div"},()=>t.dataset(),n))}})}function qm(e){const[t,i]=M(e.defaultValue?.()),s=R(()=>e.value?.()!==void 0),n=R(()=>s()?e.value?.():t());return[n,a=>{_e(()=>{const o=om(a,n());return Object.is(o,n())||(s()||i(o),e.onChange?.(o)),o})}]}var mi=e=>typeof e=="function"?e():e,jm=e=>{const t=R(()=>{const a=mi(e.element);if(a)return getComputedStyle(a)}),i=()=>t()?.animationName??"none",[s,n]=M(mi(e.show)?"present":"hidden");let r="none";return $e(a=>{const o=mi(e.show);return _e(()=>{if(a===o)return o;const l=r,d=i();o?n("present"):d==="none"||t()?.display==="none"?n("hidden"):n(a===!0&&l!==d?"hiding":"hidden")}),o}),$e(()=>{const a=mi(e.element);if(!a)return;const o=d=>{d.target===a&&(r=i())},l=d=>{const f=i().includes(d.animationName);d.target===a&&f&&s()==="hiding"&&n("hidden")};a.addEventListener("animationstart",o),a.addEventListener("animationcancel",l),a.addEventListener("animationend",l),ve(()=>{a.removeEventListener("animationstart",o),a.removeEventListener("animationcancel",l),a.removeEventListener("animationend",l)})}),{present:()=>s()==="present"||s()==="hiding",state:s,setState:n}},Xm=jm,Ym=Xm,Km={};dn(Km,{Description:()=>uo,ErrorMessage:()=>ho,Item:()=>gn,ItemControl:()=>xn,ItemDescription:()=>$o,ItemIndicator:()=>yn,ItemInput:()=>bn,ItemLabel:()=>_n,Label:()=>go,RadioGroup:()=>Jm,Root:()=>vn,useRadioGroupContext:()=>$n});var po=dt();function $n(){const e=ft(po);if(e===void 0)throw new Error("[kobalte]: `useRadioGroupContext` must be used within a `RadioGroup` component");return e}var mo=dt();function Qt(){const e=ft(mo);if(e===void 0)throw new Error("[kobalte]: `useRadioGroupItemContext` must be used within a `RadioGroup.Item` component");return e}function gn(e){const t=Zt(),i=$n(),s=`${t.generateId("item")}-${Xt()}`,n=le({id:s},e),[r,a]=Y(n,["value","disabled","onPointerDown"]),[o,l]=M(),[d,c]=M(),[f,u]=M(),[h,m]=M(),[x,p]=M(!1),S=R(()=>i.isDefaultValue(r.value)),w=R(()=>i.isSelectedValue(r.value)),C=R(()=>r.disabled||t.isDisabled()||!1),U=P=>{_t(P,r.onPointerDown),x()&&P.preventDefault()},F=R(()=>({...t.dataset(),"data-disabled":C()?"":void 0,"data-checked":w()?"":void 0})),I={value:()=>r.value,dataset:F,isDefault:S,isSelected:w,isDisabled:C,inputId:o,labelId:d,descriptionId:f,inputRef:h,select:()=>i.setSelectedValue(r.value),generateId:is(()=>a.id),registerInput:De(l),registerLabel:De(c),registerDescription:De(u),setIsFocused:p,setInputRef:m};return g(mo.Provider,{value:I,get children(){return g(de,D({as:"div",role:"group",onPointerDown:U},F,a))}})}function xn(e){const t=Qt(),i=le({id:t.generateId("control")},e),[s,n]=Y(i,["onClick","onKeyDown"]);return g(de,D({as:"div",onClick:o=>{_t(o,s.onClick),t.select(),t.inputRef()?.focus()},onKeyDown:o=>{_t(o,s.onKeyDown),o.key===to.Space&&(t.select(),t.inputRef()?.focus())}},()=>t.dataset(),n))}function $o(e){const t=Qt(),i=le({id:t.generateId("description")},e);return $e(()=>ve(t.registerDescription(i.id))),g(de,D({as:"div"},()=>t.dataset(),i))}function yn(e){const t=Qt(),i=le({id:t.generateId("indicator")},e),[s,n]=Y(i,["ref","forceMount"]),[r,a]=M(),{present:o}=Ym({show:()=>s.forceMount||t.isSelected(),element:()=>r()??null});return g(Pe,{get when(){return o()},get children(){return g(de,D({as:"div",ref(l){var d=Yt(a,s.ref);typeof d=="function"&&d(l)}},()=>t.dataset(),n))}})}function bn(e){const t=Zt(),i=$n(),s=Qt(),n=le({id:s.generateId("input")},e),[r,a]=Y(n,["ref","style","aria-labelledby","aria-describedby","onChange","onFocus","onBlur"]),o=()=>[r["aria-labelledby"],s.labelId(),r["aria-labelledby"]!=null&&a["aria-label"]!=null?a.id:void 0].filter(Boolean).join(" ")||void 0,l=()=>[r["aria-describedby"],s.descriptionId(),i.ariaDescribedBy()].filter(Boolean).join(" ")||void 0,[d,c]=M(!1),f=m=>{if(_t(m,r.onChange),m.stopPropagation(),!d()){i.setSelectedValue(s.value());const x=m.target;x.checked=s.isSelected()}c(!1)},u=m=>{_t(m,r.onFocus),s.setIsFocused(!0)},h=m=>{_t(m,r.onBlur),s.setIsFocused(!1)};return $e(_r([()=>s.isSelected(),()=>s.value()],m=>{if(!m[0]&&m[1]===s.value())return;c(!0);const x=s.inputRef();x?.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),x?.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))},{defer:!0})),$e(()=>ve(s.registerInput(a.id))),g(de,D({as:"input",ref(m){var x=Yt(s.setInputRef,r.ref);typeof x=="function"&&x(m)},type:"radio",get name(){return t.name()},get value(){return s.value()},get checked(){return s.isSelected()},get required(){return t.isRequired()},get disabled(){return s.isDisabled()},get readonly(){return t.isReadOnly()},get style(){return ln({...cm},r.style)},get"aria-labelledby"(){return o()},get"aria-describedby"(){return l()},onChange:f,onFocus:u,onBlur:h},()=>s.dataset(),a))}function _n(e){const t=Qt(),i=le({id:t.generateId("label")},e);return $e(()=>ve(t.registerLabel(i.id))),g(de,D({as:"label",get for(){return t.inputId()}},()=>t.dataset(),i))}function go(e){return g(Gm,D({as:"span"},e))}function vn(e){let t;const i=`radiogroup-${Xt()}`,s=le({id:i,orientation:"vertical"},e),[n,r,a]=Y(s,["ref","value","defaultValue","onChange","orientation","aria-labelledby","aria-describedby"],zm),[o,l]=qm({value:()=>n.value,defaultValue:()=>n.defaultValue,onChange:p=>n.onChange?.(p)}),{formControlContext:d}=Mm(r);Vm(()=>t,()=>l(n.defaultValue??""));const c=()=>d.getAriaLabelledBy(he(r.id),a["aria-label"],n["aria-labelledby"]),f=()=>d.getAriaDescribedBy(n["aria-describedby"]),u=p=>p===e.defaultValue,h=p=>p===o(),x={ariaDescribedBy:f,isDefaultValue:u,isSelectedValue:h,setSelectedValue:p=>{if(!(d.isReadOnly()||d.isDisabled())&&(l(p),t))for(const S of t.querySelectorAll("[type='radio']")){const w=S;w.checked=h(w.value)}}};return g(co.Provider,{value:d,get children(){return g(po.Provider,{value:x,get children(){return g(de,D({as:"div",ref(p){var S=Yt(w=>t=w,n.ref);typeof S=="function"&&S(p)},role:"radiogroup",get id(){return he(r.id)},get"aria-invalid"(){return d.validationState()==="invalid"||void 0},get"aria-required"(){return d.isRequired()||void 0},get"aria-disabled"(){return d.isDisabled()||void 0},get"aria-readonly"(){return d.isReadOnly()||void 0},get"aria-orientation"(){return n.orientation},get"aria-labelledby"(){return c()},get"aria-describedby"(){return f()}},()=>d.dataset(),a))}})}})}var Jm=Object.assign(vn,{Description:uo,ErrorMessage:ho,Item:gn,ItemControl:xn,ItemDescription:$o,ItemIndicator:yn,ItemInput:bn,ItemLabel:_n,Label:go}),Zm=q('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"fill=none stroke=currentColor stroke-width=2 stroke-linecap=round stroke-linejoin=round class="size-2.5 fill-current text-current"><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0">');const Qm=e=>{const[t,i]=Y(e,["class"]);return g(vn,D({get class(){return It("grid gap-2",t.class)}},i))},Ts=e=>{const[t,i]=Y(e,["class","children"]);return g(gn,D({get class(){return It("flex items-center space-x-2",t.class)}},i,{get children(){return[g(bn,{}),g(xn,{class:"aspect-square size-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",get children(){return g(yn,{class:"flex h-full items-center justify-center ",get children(){return Zm()}})}}),R(()=>t.children)]}}))},Fs=e=>{const[t,i]=Y(e,["class"]);return g(_n,D({get class(){return It("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",t.class)}},i))};var e$=q("<a href=https://takeout.google.com/ class=underline>Google Takeout"),t$=q('<p>Extract each .zip file into its own folder. The exact takeout folder names are not important. Each takeout folder may either directly contain a folder for each album, or may contain a single folder (e.g. "Google Photos") that contains all albums.'),i$=q(`<div class="border-2 border-red-500 rounded-2xl p-4 my-4"><p class="text-red-500 pb-2">DON'T: Place albums directly inside the root folder. There must be takeout folders wrapping the albums.`),s$=q("<p>These are your takeout folders? One per .zip file?"),n$=q("<p>These are all your albums?"),Cs=q('<div class="flex justify-between">'),r$=q("<p>Your photos have been successfully exported! Find them in the ./Prepared_Photos/ folder located inside the previously selected Google Photos takeout folder. You can drop this ./Prepared_Photos/ folder into Ente Photos to import it."),a$=q(`<div class="flex flex-col gap-2"><h2 class="text-lg font-semibold">Recent Log Messages</h2><p>For the full log see the 'gphoto-prepare-duck-log.txt' file inside the selected folder.`),o$=q('<div class="max-w-[90ch] mx-auto p-4 flex flex-col gap-2"><h1 class="text-2xl font-black">GPhoto-Prepare-Duck ðŸ¦†'),l$=q('<div class="border-red-500 border-2 p-4 rounded-2xl"><p class=text-red-500>Your browser currently does not support the file system access api. Please use Brave, Chrome or a different Chromium based browser.</p><p>In Brave you may need to enable this feature here manually. Open: brave://flags/#file-system-access-api'),d$=q("<p>Loading albums...");const f$=()=>{const e=rm();return g(Qa.Provider,{value:e,get children(){var t=o$();return t.firstChild,z(t,g(Pe,{get when(){return e.step()===1},get children(){return g(Jl,{})}}),null),z(t,g(Pe,{get when(){return e.browserSupportsApi},get fallback(){return l$()},get children(){return[g(ze,{step:1,title:"Download your images from Google as .zip files",hasNextButton:!0,get children(){return["Use"," ",e$()," ","to download your images. You should get multiple .zip files. If your Photo library is small you may just have one. Place all .zip files in a folder."]}}),g(ze,{step:2,title:"Extract each .zip file",hasNextButton:!0,get children(){return[t$(),g(Ot,{get children(){return g(ae,{name:"Export",get children(){return[g(ae,{name:"Takeout 1 (from the first .zip file)",get children(){return g(ae,{name:"Google Photos",get children(){return[g(ae,{name:"Album 1"}),g(ae,{name:"Album 2"}),g(ae,{name:"Album 3"})]}})}}),g(ae,{name:"Takeout 2 (from the second .zip file)",get children(){return[g(ae,{name:"Album 2"}),g(ae,{name:"Album 3"}),g(ae,{name:"Album 4"})]}}),g(ae,{name:"..."})]}})}}),(()=>{var i=i$();return i.firstChild,z(i,g(Ot,{get children(){return g(ae,{name:"Export",get children(){return[g(ae,{name:"Album 1"}),g(ae,{name:"Album 2"})]}})}}),null),i})()]}}),g(ze,{step:3,title:"Select the folder containing all takeout folders",get children(){return g(Bi,{get children(){return g(ki,{get onClick(){return e.startViaSelectFolder},children:"Select Google Photos import"})}})}}),g(ze,{step:4,title:"Confirm found folders",get children(){return g(Pe,{get when(){return e.finishedLoadingFolders()},get fallback(){return d$()},get children(){return[s$(),g(Ot,{get children(){return g(ls,{get each(){return e.takeoutFolders()},children:i=>g(ae,{name:i})})}}),n$(),g(Ot,{get children(){return g(ls,{get each(){return e.albums()},children:i=>g(ae,{name:i})})}}),g(Bi,{get children(){return g(ki,{get onClick(){return e.confirmFoldersStart},children:"Confirm"})}})]}})}}),g(ze,{step:5,title:"Grouping files. Matching live photos with videos...",get children(){return[g(Ss,{get value(){return e.progress()},minValue:0,maxValue:100,getValueLabel:({value:i,max:s})=>`${i}% completed`,class:"w-full space-y-1",get children(){var i=Cs();return z(i,g(Is,{children:"Total Progress"}),null),z(i,g(Es,{}),null),i}}),g(Ss,{get value(){return e.albumProgress()},minValue:0,maxValue:100,getValueLabel:({value:i,max:s})=>`${i}% completed`,class:"w-full space-y-1",get children(){var i=Cs();return z(i,g(Is,{get children(){return["Album Progress:"," ",R(()=>e.albumProgressMessage())]}}),null),z(i,g(Es,{}),null),i}})]}}),g(ze,{step:6,title:"Grouping finished. Start export?",get children(){return[g(Qm,{get value(){return e.exportMode()},class:"mt-4",get onChange(){return e.setExportMode},get children(){return[g(Ts,{value:"all",id:"radio-all",get children(){return g(Fs,{children:"All photos and videos"})}}),g(Ts,{value:"live-and-confusing",id:"radio-live-and-confusing",get children(){return g(Fs,{children:"Live photos and files with same names as live photos (I.e. all files that might have been confused in a previous import)"})}}),g(Ts,{value:"live",id:"radio-live",get children(){return g(Fs,{children:"Live photos only"})}})]}}),g(Bi,{get children(){return g(ki,{get onClick(){return e.writeFiles},children:"Start Export"})}})]}}),g(ze,{step:7,title:"Export running...",get children(){return g(Ss,{get value(){return e.progress()},minValue:0,maxValue:100,getValueLabel:({value:i,max:s})=>`${i}% completed`,class:"w-full space-y-1",get children(){var i=Cs();return z(i,g(Is,{get children(){return e.progressMessage()}}),null),z(i,g(Es,{}),null),i}})}}),g(ze,{step:8,title:"Export Complete!",get children(){return r$()}})]}}),null),z(t,g(Pe,{get when(){return e.recentLog().length>0},get children(){var i=a$(),s=i.firstChild;return s.nextSibling,z(i,g(ls,{get each(){return e.recentLog()},children:n=>g(Hl,{logMessage:n})}),null),i}}),null),t}})},c$=document.getElementById("root");Ho(()=>g(f$,{}),c$);
